"use strict";(self.webpackChunk_automattic_woocommerce_analytics=self.webpackChunk_automattic_woocommerce_analytics||[]).push([[956],{19:(e,s,i)=>{i.d(s,{j:()=>c});var t=i(941),n=i.n(t),o=i(339),a=i(269),r=i(338);const d=n()("wc-analytics:analytics");class c{constructor(e,{eventQueue:s=[],commonProps:i={},features:t={},pages:n={}}){this.isInitialized=!1,this.sessionManager=e,this.apiClient=new o.O,this.eventQueue=s,this.commonProps=i,this.features=t,this.pages=n}init=()=>{if(!this.isInitialized){if(this.features.proxy&&this.apiClient.init(),this.features.sessionTracking){a.K.addConsentChangeListener(this.handleConsentChange),this.sessionManager.init();const{sessionId:e,landingPage:s,isNewSession:i}=this.sessionManager;this.features.proxy||(this.commonProps={...this.commonProps,session_id:e,landing_page:s}),i?this.maybeRecordSessionStartedEvent():this.maybeRecordEngagementEvent(),this.recordEvent("page_view")}this.processEventQueue(),this.initListeners(),this.isInitialized=!0}};initListeners=()=>{this.pages.isAccountPage&&i.e(613).then(i.bind(i,358)).then(({initListeners:e})=>{e(this.recordEvent)})};processEventQueue=()=>{for(const e of this.eventQueue)this.recordEvent(e.eventName,e.props)};recordEvent=(e,s={})=>{if(!a.K.hasAnalyticsConsent())return void d("Skipping event recording due to lack of statistics consent: %s",e);if("string"!=typeof e||!r.bm.test(e))return void d("Skipping event recording because event name is not valid");const i={...this.commonProps,...s};this.features.proxy?(this.addClientProperties(i),this.apiClient.addEvent(e,i)):this.fireDirectPixel(e,i),this.isInitialized&&this.maybeRecordEngagementEvent()};fireDirectPixel=(e,s)=>{window._wca?(this.features.ch&&r.S6.includes(e)?s.ch=1:delete s.ch,d('Recording event via _wca: "%s" with props %o',e,s),s._en=`${r.CS}${e}`,window._wca.push(s)):d("Skipping event recording because _wca is not defined")};addClientProperties=e=>{const s=new Date;e._ts=s.getTime(),e._tz=s.getTimezoneOffset()/60;const i=window.navigator,t=window.screen;e._lg=i.language,e._pf=navigator?.platform,e._ht=t.height,e._wd=t.width;const n=void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body).scrollLeft,o=void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body).scrollTop;e._sx=void 0!==n?n:0,e._sy=void 0!==o?o:0,void 0!==document.location&&(e._dl=document.location.toString()),void 0!==document.referrer&&(e._dr=document.referrer)};maybeRecordSessionStartedEvent=()=>{this.features.sessionTracking&&this.sessionManager.isNewSession&&this.sessionManager.sessionId&&this.recordEvent("session_started")};maybeRecordEngagementEvent=()=>{this.features.sessionTracking&&!this.sessionManager.isEngaged&&this.sessionManager.sessionId&&(this.sessionManager.setEngaged(),this.recordEvent("session_engagement"))};handleConsentChange=e=>{e?this.sessionManager.sessionId||this.sessionManager.init():this.sessionManager.clearSession()}}},338:(e,s,i)=>{i.d(s,{BU:()=>d,CS:()=>n,Op:()=>c,RV:()=>a,S6:()=>h,bm:()=>o,xE:()=>r,z4:()=>t});const t="woocommerceanalytics_session",n="woocommerceanalytics_",o=/^[a-z_][a-z0-9_]*$/,a="woocommerce-analytics/v1",r="track",d=10,c=1e3,h=["session_started","session_engagement","product_view","cart_view","add_to_cart","remove_from_cart","checkout_view","product_checkout","product_purchase","order_confirmation_view","search","page_view"]},339:(e,s,i)=>{i.d(s,{O:()=>c});var t=i(455),n=i.n(t),o=i(941),a=i.n(o),r=i(338);const d=a()("wc-analytics:api-client");class c{eventQueue=[];debounceTimer=null;isInitialized=!1;init=()=>{this.isInitialized||(d("API client initialized"),window.addEventListener("beforeunload",this.flush),window.addEventListener("pagehide",this.flush),this.isInitialized=!0)};addEvent=(e,s={})=>{if(!this.isInitialized)return void d("API client not initialized, skipping event: %s",e);d('Recording event via API: "%s" with props %o',e,s);const i={event_name:e,properties:s};this.eventQueue.push(i),d("Event added to queue: %s (queue size: %d)",e,this.eventQueue.length),this.debouncedSend(),this.eventQueue.length>=r.BU&&this.flush()};debouncedSend=()=>{this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=window.setTimeout(()=>{this.flush()},r.Op)};flush=()=>{if(this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),0===this.eventQueue.length)return;const e=[...this.eventQueue];this.eventQueue=[],this.sendEvents(e)};sendEvents=async e=>{if(0!==e.length)try{d("Sending %d events to API",e.length);const s=await n()({path:`/${r.RV}/${r.xE}`,method:"POST",data:e});d("API response received: %o",s),s.success||d("Some events failed to send: %o",s.results)}catch(s){d("Failed to send events to API: %o",s),this.eventQueue.unshift(...e)}}}},633:(e,s,i)=>{i.r(s);var t=i(19),n=i(841);!function(){const e=new n.A;new t.j(e,{eventQueue:window.wcAnalytics.eventQueue,commonProps:window.wcAnalytics.commonProps,features:window.wcAnalytics.features,pages:window.wcAnalytics.pages}).init()}()},841:(e,s,i)=>{i.d(s,{A:()=>n});var t=i(338);class n{sessionId=null;landingPage=null;isEngaged=!1;isNewSession=!1;isInitialized=!1;init=()=>{this.isInitialized||(this.loadOrCreateSession(),this.isInitialized=!0)};loadOrCreateSession(){const e=this.getSessionCookie();e&&e.session_id?(this.sessionId=e.session_id,this.landingPage=e.landing_page||null,this.isEngaged=e.is_engaged||!1,this.isNewSession=!1):this.createNewSession()}createNewSession(){this.isNewSession=!0;const e={session_id:this.generateRandomUuid(),landing_page:JSON.stringify(window.wcAnalytics?.breadcrumbs||[]),expires:this.getSessionExpirationTime()};this.setSessionCookie(e)&&(this.sessionId=e.session_id,this.landingPage=e.landing_page,this.isEngaged=!1)}getSessionCookie(){const e=this.getCookie(t.z4);if(!e)return null;try{return JSON.parse(decodeURIComponent(e))}catch(e){return console.error("Error parsing session cookie",e),null}}getCookie(e){const s=`; ${document.cookie}`.split(`; ${e}=`);return 2===s.length&&s.pop()?.split(";").shift()||null}setSessionCookie(e){const s=encodeURIComponent(JSON.stringify(e)),i=e.expires||this.getSessionExpirationTime();document.cookie=`${t.z4}=${s}; expires=${i}; path=/; secure; samesite=strict`;return this.getCookie(t.z4)===s}getSessionExpirationTime(){const e=Date.now()+18e5,s=new Date;s.setUTCDate(s.getUTCDate()+1),s.setUTCHours(0,0,0,0);const i=Math.min(e,s.getTime());return new Date(i).toUTCString()}generateRandomUuid(){if("undefined"!=typeof crypto&&crypto.randomUUID)return crypto.randomUUID();if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;const s=Array.from(e,e=>e.toString(16).padStart(2,"0")).join("");return[s.slice(0,8),s.slice(8,12),s.slice(12,16),s.slice(16,20),s.slice(20,32)].join("-")}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const s=Math.floor(16*Math.random());return("x"===e?s:s%4+8).toString(16)})}setEngaged(){if(this.isEngaged)return;const e=this.getSessionCookie();e&&e.session_id&&(e.is_engaged=!0,this.setSessionCookie(e)),this.isEngaged=!0}clearSession(){document.cookie=`${t.z4}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; secure; samesite=strict`,this.sessionId=null,this.landingPage=null,this.isEngaged=!1,this.isNewSession=!1,this.isInitialized=!1}}}}]);