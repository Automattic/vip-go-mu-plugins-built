/* Do not modify this file directly. It is compiled from other files. */
/* global jpConnect */
jQuery(document).ready(function(n){var e=n(".jp-connect-button"),t=n(".jp-connect-full__tos-blurb");e.click(function(n){n.preventDefault(),a.isRegistering||("original"===jpConnect.forceVariation?a.handleOriginalFlow():"in_place"===jpConnect.forceVariation?a.handleConnectInPlaceFlow():a.startConnectionFlow())});var o=n('<iframe class="jp-jetpack-connect__iframe" />'),a={isRegistering:!1,isPaidPlan:!1,startConnectionFlow:function(){n.ajax({url:"https://public-api.wordpress.com/wpcom/v2/abtest/jetpack_connect_in_place",type:"GET",error:a.handleConnectionError,success:function(n){n&&"in_place"===n.variation?a.handleConnectInPlaceFlow():a.handleOriginalFlow()}})},handleOriginalFlow:function(){window.location=e.attr("href")},handleConnectInPlaceFlow:function(){a.isRegistering=!0,t.hide(),e.text(jpConnect.buttonTextRegistering).attr("disabled",!0).blur(),n.ajax({url:jpConnect.apiBaseUrl+"/connection/register",type:"POST",data:{registration_nonce:jpConnect.registrationNonce,_wpnonce:jpConnect.apiNonce},error:a.handleConnectionError,success:function(e){a.fetchPlanType(),window.addEventListener("message",a.receiveData),o.attr("src",e.authorizeUrl),n(".jp-connect-full__button-container").html(o)}})},fetchPlanType:function(){n.ajax({url:jpConnect.apiBaseUrl+"/site",type:"GET",data:{_wpnonce:jpConnect.apiSiteDataNonce},success:function(n){var e=JSON.parse(n.data);a.isPaidPlan=!e.plan.is_free}})},receiveData:function(n){n.origin===jpConnect.jetpackApiDomain&&n.source===o.get(0).contentWindow&&"close"===n.data&&(window.removeEventListener("message",this.receiveData),a.handleAuthorizationComplete())},handleAuthorizationComplete:function(){a.isRegistering=!1,a.isPaidPlan?window.location.assign(jpConnect.dashboardUrl):window.location.assign(jpConnect.plansPromptUrl),window.location.reload(!0)},handleConnectionError:function(n){console.warn("Connection failed. Falling back to the regular flow",n),a.isRegistering=!1,a.handleOriginalFlow()}}});