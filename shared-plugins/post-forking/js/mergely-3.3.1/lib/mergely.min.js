/**
 * Copyright (c) 2013 by Jamie Peabody, http://www.mergely.com
 * All rights reserved.
 * Version: 3.3.1 2013-05-12
 */
Mgly={},Mgly.Timer=function(){var a=this;a.start=function(){a.t0=(new Date).getTime()},a.stop=function(){var b=(new Date).getTime(),c=b-a.t0;return a.t0=b,c},a.start()},Mgly.ChangeExpression=RegExp(/(\d+(?:,\d+)?)([acd])(\d+(?:,\d+)?)/),Mgly.DiffParser=function(a){for(var b=[],c=0,d=a.split(/\n/),e=0;d.length>e;++e)if(0!=d[e].length){var f={},g=Mgly.ChangeExpression.exec(d[e]);if(null!=g){var h=g[1].split(",");f["lhs-line-from"]=h[0]-1,f["lhs-line-to"]=1==h.length?h[0]-1:h[1]-1;var i=g[3].split(",");f["rhs-line-from"]=i[0]-1,f["rhs-line-to"]=1==i.length?i[0]-1:i[1]-1,0>f["lhs-line-from"]&&(f["lhs-line-from"]=0),0>f["lhs-line-to"]&&(f["lhs-line-to"]=0),0>f["rhs-line-from"]&&(f["rhs-line-from"]=0),0>f["rhs-line-to"]&&(f["rhs-line-to"]=0),f.op=g[2],b[c++]=f}}return b},Mgly.sizeOf=function(a){var c,b=0;for(c in a)a.hasOwnProperty(c)&&b++;return b},Mgly.LCS=function(a,b){this.x=a.replace(/ /g,"\n"),this.y=b.replace(/ /g,"\n")},jQuery.extend(Mgly.LCS.prototype,{clear:function(){this.ready=0},diff:function(a,b){for(var c=new Mgly.diff(this.x,this.y,retain_lines=!0,ignore_ws=!1),d=Mgly.DiffParser(c.normal_form()),e=0,f=0,g=0,h=0,i=0,j=0,k=0;d.length>k;++k){var l=d[k];e+=c.lhs_lines.slice(g,l["lhs-line-from"]).join(" ").length,e>j&&(e+=1),g=l["lhs-line-to"]+1;var m=c.lhs_lines.slice(l["lhs-line-from"],g).join(" ");b(e,e+m.length),e+=m.length+1,j=e,f+=c.rhs_lines.slice(h,l["rhs-line-from"]).join(" ").length,f>i&&(f+=1),h=l["rhs-line-to"]+1;var n=c.rhs_lines.slice(l["rhs-line-from"],h).join(" ");a(f,f+n.length),f+=n.length+1,i=f}}}),Mgly.diff=function(a,b,c,d){this.diff_codes={},this.max_code=0;var e=a.split("\n"),f=b.split("\n");0==a.length&&(e=[]),0==b.length&&(f=[]);var g=Object();g.data=this._diff_codes(e,d),g.modified={},g.length=Mgly.sizeOf(g.data);var h=Object();h.data=this._diff_codes(f,d),h.modified={},h.length=Mgly.sizeOf(h.data);var i=g.length+h.length+1,j=Array(2*i+2),k=Array(2*i+2);this._lcs(g,0,g.length,h,0,h.length,k,j),this._optimize(g),this._optimize(h),this.items=this._create_diffs(g,h),c&&(this.lhs_lines=e,this.rhs_lines=f)},jQuery.extend(Mgly.diff.prototype,{changes:function(){return this.items},normal_form:function(){for(var a="",b=0;this.items.length>b;++b){var c=this.items[b],d="",e="",f="c";if(0==c.lhs_deleted_count&&c.rhs_inserted_count>0?f="a":c.lhs_deleted_count>0&&0==c.rhs_inserted_count&&(f="d"),d=1==c.lhs_deleted_count?c.lhs_start+1:0==c.lhs_deleted_count?c.lhs_start:c.lhs_start+1+","+(c.lhs_start+c.lhs_deleted_count),e=1==c.rhs_inserted_count?c.rhs_start+1:0==c.rhs_inserted_count?c.rhs_start:c.rhs_start+1+","+(c.rhs_start+c.rhs_inserted_count),a+=d+f+e+"\n",this.rhs_lines&&this.lhs_lines){for(var g=c.lhs_start;c.lhs_start+c.lhs_deleted_count>g;++g)a+="< "+this.lhs_lines[g]+"\n";c.rhs_inserted_count&&c.lhs_deleted_count&&(a+="---\n");for(var g=c.rhs_start;c.rhs_start+c.rhs_inserted_count>g;++g)a+="> "+this.rhs_lines[g]+"\n"}}return a},_diff_codes:function(a,b){this.max_code;for(var d={},e=0;a.length>e;++e){var f=a[e];b&&(f=f.replace(/\s+/g,""));var g=this.diff_codes[f];void 0!=g?d[e]=g:(this.max_code++,this.diff_codes[f]=this.max_code,d[e]=this.max_code)}return d},_lcs:function(a,b,c,d,e,f,g,h){for(;c>b&&f>e&&a.data[b]==d.data[e];)++b,++e;for(;c>b&&f>e&&a.data[c-1]==d.data[f-1];)--c,--f;if(b==c)for(;f>e;)d.modified[e++]=!0;else if(e==f)for(;c>b;)a.modified[b++]=!0;else{var i=this._sms(a,b,c,d,e,f,g,h);this._lcs(a,b,i.x,d,e,i.y,g,h),this._lcs(a,i.x,c,d,i.y,f,g,h)}},_sms:function(a,b,c,d,e,f,g,h){var i=a.length+d.length+1,j=b-e,k=c-f,l=c-b-(f-e),m=0!=(1&l),n=i-j,o=i-k,p=(c-b+f-e)/2+1;h[n+j+1]=b,g[o+k-1]=c;for(var q={x:0,y:0},r=0;p>=r;++r){for(var s=j-r;j+r>=s;s+=2){var t,u;for(s==j-r?t=h[n+s+1]:(t=h[n+s-1]+1,j+r>s&&h[n+s+1]>=t&&(t=h[n+s+1])),u=t-s;c>t&&f>u&&a.data[t]==d.data[u];)t++,u++;if(h[n+s]=t,m&&s>k-r&&k+r>s&&g[o+s]<=h[n+s])return q.x=h[n+s],q.y=h[n+s]-s,q}for(var s=k-r;k+r>=s;s+=2){var t,u;for(s==k+r?t=g[o+s-1]:(t=g[o+s+1]-1,s>k-r&&t>g[o+s-1]&&(t=g[o+s-1])),u=t-s;t>b&&u>e&&a.data[t-1]==d.data[u-1];)t--,u--;if(g[o+s]=t,!m&&s>=j-r&&j+r>=s&&g[o+s]<=h[n+s])return q.x=h[n+s],q.y=h[n+s]-s,q}}throw"the algorithm should never come here."},_optimize:function(a){for(var b=0,c=0;a.length>b;){for(;a.length>b&&(void 0==a.modified[b]||0==a.modified[b]);)b++;for(c=b;a.length>c&&1==a.modified[c];)c++;a.length>c&&a.data[b]==a.data[c]?(a.modified[b]=!1,a.modified[c]=!0):b=c}},_create_diffs:function(a,b){for(var c=[],d=0,e=0,f=0,g=0;a.length>f||b.length>g;)if(a.length>f&&!a.modified[f]&&b.length>g&&!b.modified[g])f++,g++;else{for(d=f,e=g;a.length>f&&(g>=b.length||a.modified[f]);)f++;for(;b.length>g&&(f>=a.length||b.modified[g]);)g++;if(f>d||g>e){var h=Object();h.lhs_start=d,h.rhs_start=e,h.lhs_deleted_count=f-d,h.rhs_inserted_count=g-e,c.push(h)}}return c}}),Mgly.mergely=function(a,b){CodeMirror.defineExtension("centerOnCursor",function(){var a=this.cursorCoords(null,"local");this.scrollTo(null,(a.y+a.yBot)/2-this.getScrollerElement().clientHeight/2)}),a&&this.init(a,b)},jQuery.extend(Mgly.mergely.prototype,{name:"mergely",init:function(a,b){this.settings={autoupdate:!0,autoresize:!0,lcs:!0,sidebar:!0,ignorews:!1,fadein:"fast",editor_width:"400px",editor_height:"400px",resize_timeout:500,change_timeout:150,fgcolor:{a:"#4ba3fa",c:"#a3a3a3",d:"#ff7f7f"},bgcolor:"#eee",vpcolor:"rgba(0, 0, 200, 0.5)",lhs:function(){},rhs:function(){},loaded:function(){},_auto_width:function(a){return a},resize:function(){var b=jQuery(a).parent().width(),c=jQuery(window).height();"auto"==this.width?b=this._auto_width(b):(b=this.width,this.editor_width=b),"auto"==this.height?c=jQuery(a).parent().height():(c=this.height,this.editor_height=c);var d=b/2-16-8,e=c,f=jQuery(a);f.find(".mergely-column").css({width:d+"px"}),f.find(".mergely-column, .mergely-canvas, .mergely-margin, .mergely-column textarea, .CodeMirror-scroll, .cm-s-default").css({height:e+"px"}),f.find(".mergely-canvas").css({height:e+"px"}),f.find(".mergely-column textarea").css({width:d+"px"}),f.css({width:b,height:c,clear:"both"}),"none"==f.css("display")&&(0!=this.fadein?f.fadeIn(this.fadein):f.show(),this.loaded&&this.loaded()),this.resized&&this.resized()},_debug:"change",resized:function(){}};var c={mode:"text/plain",readOnly:!1,lineWrapping:!1,lineNumbers:!0,gutters:["merge","CodeMirror-linenumbers"]};this.lhs_cmsettings={},this.rhs_cmsettings={},this.element=jQuery(a),b&&b.cmsettings&&jQuery.extend(this.lhs_cmsettings,c,b.cmsettings,b.lhs_cmsettings),b&&b.cmsettings&&jQuery.extend(this.rhs_cmsettings,c,b.cmsettings,b.rhs_cmsettings),b&&jQuery.extend(this.settings,b),this.element.bind("destroyed",jQuery.proxy(this.teardown,this)),jQuery.data(a,this.name,this),this._setup(a)},bind:function(){var a=jQuery("#"+this.id+"-rhs").get(0);if(!a)return console.error("rhs textarea not defined - Mergely not initialized properly"),void 0;var b=jQuery("#"+this.id+"-lhs").get(0);if(!a)return console.error("lhs textarea not defined - Mergely not initialized properly"),void 0;var c=this;if(this.editor=[],this.editor[this.id+"-lhs"]=CodeMirror.fromTextArea(b,this.lhs_cmsettings),this.editor[this.id+"-rhs"]=CodeMirror.fromTextArea(a,this.rhs_cmsettings),this.editor[this.id+"-lhs"].on("change",function(){c.settings.autoupdate&&c._changing(c.id+"-lhs",c.id+"-rhs")}),this.editor[this.id+"-lhs"].on("scroll",function(){c._scrolling(c.id+"-lhs")}),this.editor[this.id+"-rhs"].on("change",function(){c.settings.autoupdate&&c._changing(c.id+"-lhs",c.id+"-rhs")}),this.editor[this.id+"-rhs"].on("scroll",function(){c._scrolling(c.id+"-rhs")}),this.settings.autoresize){var d=null,e=function(){c.settings.resize&&c.settings.resize(),c.editor[c.id+"-lhs"].refresh(),c.editor[c.id+"-rhs"].refresh(),c._changing(c.id+"-lhs",c.id+"-rhs")};jQuery(window).resize(function(){d&&clearTimeout(d),d=setTimeout(e,c.settings.resize_timeout)}),e()}},unbind:function(){null!=this.changed_timeout&&clearTimeout(this.changed_timeout),this.editor[this.id+"-lhs"].toTextArea(),this.editor[this.id+"-rhs"].toTextArea()},destroy:function(){this.element.unbind("destroyed",this.teardown),this.teardown()},teardown:function(){this.unbind()},lhs:function(a){this.editor[this.id+"-lhs"].setValue(a)},rhs:function(a){this.editor[this.id+"-rhs"].setValue(a)},update:function(){this._changing(this.id+"-lhs",this.id+"-rhs")},unmarkup:function(){this._clear()},scrollTo:function(a,b){var c=this.editor[this.id+"-lhs"],d=this.editor[this.id+"-rhs"];"lhs"==a?(c.setCursor(b),c.centerOnCursor()):(d.setCursor(b),d.centerOnCursor())},options:function(a){return a?(jQuery.extend(this.settings,a),this.settings.autoresize&&this.resize(),void 0):this.settings},swap:function(){if(!this.lhs_cmsettings.readOnly&&!this.rhs_cmsettings.readOnly){var a=this.editor[this.id+"-lhs"],b=this.editor[this.id+"-rhs"],c=b.getValue();b.setValue(a.getValue()),a.setValue(c)}},merge:function(a){var b=this.editor[this.id+"-lhs"],c=this.editor[this.id+"-rhs"];"lhs"!=a||this.lhs_cmsettings.readOnly?this.rhs_cmsettings.readOnly||c.setValue(b.getValue()):b.setValue(c.getValue())},get:function(a){var b=this.editor[this.id+"-"+a],c=b.getValue();return void 0==c?"":c},clear:function(a){if(!("lhs"==a&&this.lhs_cmsettings.readOnly||"rhs"==a&&this.rhs_cmsettings.readOnly)){var b=this.editor[this.id+"-"+a];b.setValue("")}},cm:function(a){return this.editor[this.id+"-"+a]},search:function(a,b){var e,c=this.editor[this.id+"-lhs"],d=this.editor[this.id+"-rhs"];e="lhs"==a?c:d,(0==e.getSelection().length||this.prev_query[a]!=b)&&(this.cursor[this.id]=e.getSearchCursor(b,{line:0,ch:0},!1),this.prev_query[a]=b),this.cursor[this.id].findNext()?e.setSelection(this.cursor[this.id].from(),this.cursor[this.id].to()):this.cursor[this.id]=e.getSearchCursor(b,{line:0,ch:0},!1)},resize:function(){this.settings.resize(),this._changing(this.id+"-lhs",this.id+"-rhs")},diff:function(){var a=this.editor[this.id+"-lhs"].getValue(),b=this.editor[this.id+"-rhs"].getValue(),c=new Mgly.diff(a,b,retain_lines=!0,ignore_ws=this.settings.ignorews);return c.normal_form()},_setup:function(a){jQuery(this.element).hide(),this.id=jQuery(a).attr("id");var b=this.settings.editor_height,c=this.settings.editor_width;this.changed_timeout=null,this.chfns={},this.chfns[this.id+"-lhs"]=[],this.chfns[this.id+"-rhs"]=[],this.prev_query=[],this.cursor=[],this._skipscroll={},this.change_exp=RegExp(/(\d+(?:,\d+)?)([acd])(\d+(?:,\d+)?)/);var d,e;if(void 0!=jQuery.button)d='<button title="Merge left"></button>',e='<button title="Merge right"></button>';else{var f="opacity:0.4;width:10px;height:15px;background-color:#888;cursor:pointer;text-align:center;color:#eee;border:1px solid: #222;margin-right:5px;";d='<div style="'+f+'" title="Merge left">&lt;</div>',e='<div style="'+f+'" title="Merge right">&gt;</div>'}this.merge_rhs_button=jQuery(e),this.merge_lhs_button=jQuery(d),jQuery(this.element).append(jQuery('<div class="mergely-margin" style="height: '+b+'"><canvas id="'+this.id+'-lhs-margin" width="8px" height="'+b+'"></canvas></div>')),jQuery(this.element).append(jQuery('<div style="width:'+c+"; height:"+b+'" id="'+this.id+'-editor-lhs" class="mergely-column"><textarea style="" id="'+this.id+'-lhs"></textarea></div>')),jQuery(this.element).append(jQuery('<div class="mergely-canvas" style="height: '+b+'"><canvas id="'+this.id+"-lhs-"+this.id+'-rhs-canvas" style="width:28px" width="28px" height="'+b+'"></canvas></div>')),jQuery(this.element).append(jQuery('<div style="width:'+c+"; height:"+b+'" id="'+this.id+'-editor-rhs" class="mergely-column"><textarea style="" id="'+this.id+'-rhs"></textarea></div>')),jQuery(this.element).append(jQuery('<div class="mergely-margin" style="height: '+b+'"><canvas id="'+this.id+'-rhs-margin" width="8px" height="'+b+'"></canvas></div>'));var g="#"+this.id+" .CodeMirror-gutter-text { padding: 5px 0 0 0; }"+"#"+this.id+" .CodeMirror-lines pre, "+"#"+this.id+" .CodeMirror-gutter-text pre { line-height: 18px; }"+".CodeMirror-linewidget { overflow: hidden; };";if(this.settings.autoresize&&(g+=this.id+" .CodeMirror-scroll { height: 100%; overflow: auto; }"),jQuery('<style type="text/css">'+g+"</style>").appendTo("head"),this.bind(),this.settings.lhs){var h=this.editor[this.id+"-lhs"].getDoc().setValue;this.settings.lhs(h.bind(this.editor[this.id+"-lhs"].getDoc()))}if(this.settings.rhs){var h=this.editor[this.id+"-rhs"].getDoc().setValue;this.settings.rhs(h.bind(this.editor[this.id+"-rhs"].getDoc()))}this.settings.resize()},_scrolling:function(a){if(this._skipscroll[a]===!0)return this._skipscroll[a]=!1,void 0;var b=jQuery(this.editor[a].getScrollerElement());void 0==this.midway&&(this.midway=(b.height()/2+b.offset().top).toFixed(2));var c=this.editor[a].coordsChar({left:0,top:this.midway}),d=b.scrollTop(),e=b.scrollLeft();this.trace("scroll","side",a),this.trace("scroll","midway",this.midway),this.trace("scroll","midline",c),this.trace("scroll","top_to",d),this.trace("scroll","left_to",e);var f=this.id+"-lhs",g=this.id+"-rhs";for(var h in this.editor)if(this.editor.hasOwnProperty(h)&&a!=h){for(var i=a.replace(this.id+"-",""),j=h.replace(this.id+"-",""),k=0,l=null,m=!1,n=0;this.changes.length>n;++n){var o=this.changes[n];c.line>=o[i+"-line-from"]&&(l=o,c.line>=l[i+"-line-to"]&&(o.hasOwnProperty(i+"-y-start")&&o.hasOwnProperty(i+"-y-end")&&o.hasOwnProperty(j+"-y-start")&&o.hasOwnProperty(j+"-y-end")?k+=o[i+"-y-end"]-o[i+"-y-start"]-(o[j+"-y-end"]-o[j+"-y-start"]):m=!0))}var p=this.editor[h].getViewport(),q=!0;if(l&&(this.trace("scroll","last change before midline",l),c.line>=p.from&&p.to>=c&&(q=!1)),this.trace("scroll","scroll",q),q||m){this.trace("scroll","scrolling other side",d-k);var b=jQuery(this.editor[h].getScrollerElement());this._skipscroll[h]=!0,b.scrollTop(d-k).scrollLeft(e)}else this.trace("scroll","not scrolling other side");var r=new Mgly.Timer;this._calculate_offsets(f,g,this.changes),this.trace("change","offsets time",r.stop()),this._markup_changes(f,g,this.changes),this.trace("change","markup time",r.stop()),this._draw_diff(f,g,this.changes),this.trace("change","draw time",r.stop()),this.trace("scroll","scrolled")}},_changing:function(a,b){this.trace("change","changing-timeout",this.changed_timeout);var c=this;null!=this.changed_timeout&&clearTimeout(this.changed_timeout),this.changed_timeout=setTimeout(function(){var d=new Mgly.Timer;c._changed(a,b),c.trace("change","total time",d.stop())},this.settings.change_timeout)},_changed:function(a,b){this._clear(),this._diff(a,b)},_clear:function(){var a=this;for(var b in this.editor)if(this.editor.hasOwnProperty(b)){var c=this.editor[b],d=a.chfns[b];c.operation(function(){for(var b=new Mgly.Timer,e=0,f=c.lineCount();f>e;++e)c.removeLineClass(e,"background");for(var e=0;d.length>e;++e){var g=d[e];g.lines.length&&a.trace("change","clear text",g.lines[0].text),g.clear()}c.clearGutter("merge"),a.trace("change","clear time",b.stop())})}a.chfns[b]=[];var e=this._draw_info(this.id+"-lhs",this.id+"-rhs"),f=e.clhs.get(0).getContext("2d"),g=e.crhs.get(0).getContext("2d"),h=e.dcanvas.getContext("2d");f.beginPath(),f.fillStyle=this.settings.bgcolor,f.strokeStyle="#888",f.fillRect(0,0,6.5,e.visible_page_height),f.strokeRect(0,0,6.5,e.visible_page_height),g.beginPath(),g.fillStyle=this.settings.bgcolor,g.strokeStyle="#888",g.fillRect(0,0,6.5,e.visible_page_height),g.strokeRect(0,0,6.5,e.visible_page_height),h.beginPath(),h.fillStyle="#fff",h.fillRect(0,0,this.draw_mid_width,e.visible_page_height)},_diff:function(a,b){var c=this.editor[a].getValue(),d=this.editor[b].getValue(),e=new Mgly.Timer,f=new Mgly.diff(c,d,!1,this.settings.ignorews);this.trace("change","diff time",e.stop()),this.changes=Mgly.DiffParser(f.normal_form()),this.trace("change","parse time",e.stop()),this._calculate_offsets(a,b,this.changes),this.trace("change","offsets time",e.stop()),this._markup_changes(a,b,this.changes),this.trace("change","markup time",e.stop()),this._draw_diff(a,b,this.changes),this.trace("change","draw time",e.stop())},_parse_diff:function(a,b,c){this.trace("diff","diff results:\n",c);for(var d=[],e=0,f=c.split(/\n/),g=0;f.length>g;++g)if(0!=f[g].length){var h={},i=this.change_exp.exec(f[g]);if(null!=i){var j=i[1].split(",");h["lhs-line-from"]=j[0]-1,h["lhs-line-to"]=1==j.length?j[0]-1:j[1]-1;var k=i[3].split(",");h["rhs-line-from"]=k[0]-1,h["rhs-line-to"]=1==k.length?k[0]-1:k[1]-1,0>h["lhs-line-from"]&&(h["lhs-line-from"]=0),0>h["lhs-line-to"]&&(h["lhs-line-to"]=0),0>h["rhs-line-from"]&&(h["rhs-line-from"]=0),0>h["rhs-line-to"]&&(h["rhs-line-to"]=0),h.op=i[2],d[e++]=h,this.trace("diff","change",h)}}return d},_get_viewport:function(a,b){var c=this.editor[a].getViewport(),d=this.editor[b].getViewport();return{from:Math.min(c.from,d.from),to:Math.max(c.to,d.to)}},_is_change_in_view:function(a,b){return b["lhs-line-from"]<a.from&&b["lhs-line-to"]<a.to||b["lhs-line-from"]>a.from&&b["lhs-line-to"]>a.to||b["rhs-line-from"]<a.from&&b["rhs-line-to"]<a.to||b["rhs-line-from"]>a.from&&b["rhs-line-to"]>a.to?!1:!0},_calculate_offsets:function(a,b,c){if(null==this.em_height){var d=jQuery("#"+this.id+" .CodeMirror-measure").first(),e=d.offset().top-4;if(!e)return;this.draw_top_offset=.5-e,this.em_height=this.editor[a].defaultTextHeight(),this.em_height||(console.warn("Failed to calculate offsets, using 18 by default"),this.em_height=18),this.draw_lhs_min=.5;var f=jQuery("#"+a+"-"+b+"-canvas");if(f.length||console.error("failed to find canvas","#"+a+"-"+b+"-canvas"),!f.width())return console.error("canvas width is 0"),void 0;this.draw_mid_width=jQuery("#"+a+"-"+b+"-canvas").width(),this.draw_rhs_max=this.draw_mid_width-.5,this.draw_lhs_width=5,this.draw_rhs_width=5,this.trace("calc","change offsets calculated",{top_offset:e,lhs_min:this.draw_lhs_min,rhs_max:this.draw_rhs_max,lhs_width:this.draw_lhs_width,rhs_width:this.draw_rhs_width})}for(var g=this.editor[a].charCoords({line:0}),h=this.editor[b].charCoords({line:0}),i=this._get_viewport(a,b),j=0;c.length>j;++j){var k=c[j];if(this.settings.sidebar||this._is_change_in_view(i,k)){var l,m,n,o;if(this.editor[a].getOption("lineWrapping")||this.editor[a].getOption("lineWrapping")){var p=this.editor[a].cursorCoords({line:k["lhs-line-from"],ch:0},"page"),q=this.editor[a].getLineHandle(k["lhs-line-from"]);l={top:p.top,bottom:p.top+q.height};var r=this.editor[a].cursorCoords({line:k["lhs-line-to"],ch:0},"page"),s=this.editor[a].getLineHandle(k["lhs-line-to"]);m={top:r.top,bottom:r.top+s.height};var p=this.editor[b].cursorCoords({line:k["rhs-line-from"],ch:0},"page"),t=this.editor[b].getLineHandle(k["rhs-line-from"]);n={top:p.top,bottom:p.top+t.height};var r=this.editor[b].cursorCoords({line:k["rhs-line-to"],ch:0},"page"),u=this.editor[b].getLineHandle(k["rhs-line-to"]);o={top:r.top,bottom:r.top+u.height}}else l={top:g.top+k["lhs-line-from"]*this.em_height,bottom:g.bottom+k["lhs-line-from"]*this.em_height+2},m={top:g.top+k["lhs-line-to"]*this.em_height,bottom:g.bottom+k["lhs-line-to"]*this.em_height+2},n={top:h.top+k["rhs-line-from"]*this.em_height,bottom:h.bottom+k["rhs-line-from"]*this.em_height+2},o={top:h.top+k["rhs-line-to"]*this.em_height,bottom:h.bottom+k["rhs-line-to"]*this.em_height+2};"a"==k.op?k["rhs-line-from"]>0&&(l.top=l.bottom,l.bottom+=this.em_height,m=l):"d"==k.op&&k["lhs-line-from"]>0&&(n.top=n.bottom,n.bottom+=this.em_height,o=n),k["lhs-y-start"]=this.draw_top_offset+l.top,k["lhs-y-end"]="c"==k.op||"d"==k.op?this.draw_top_offset+m.bottom:this.draw_top_offset+m.top,k["rhs-y-start"]=this.draw_top_offset+n.top,k["rhs-y-end"]="c"==k.op||"a"==k.op?this.draw_top_offset+o.bottom:this.draw_top_offset+o.top,this.trace("calc","change calculated",j,k)}else delete k["lhs-y-start"],delete k["lhs-y-end"],delete k["rhs-y-start"],delete k["rhs-y-end"]}return c},_markup_changes:function(a,b,c){jQuery(".merge-button").remove();var d=this,e=this.editor[a],f=this.editor[b],g=new Mgly.Timer;e.operation(function(){for(var a=0;c.length>a;++a){var b=c[a],g=["mergely","lhs",b.op,"cid-"+a];if(e.addLineClass(b["lhs-line-from"],"background","start"),e.addLineClass(b["lhs-line-to"],"background","end"),0==b["lhs-line-from"]&&0==b["lhs-line-to"])e.addLineClass(b["lhs-line-from"],"background",g.join(" ")),e.addLineClass(b["lhs-line-from"],"background","first");else for(var h=b["lhs-line-from"];b["lhs-line-to"]>=h;++h)e.addLineClass(h,"background",g.join(" ")),e.addLineClass(h,"background",g.join(" "));if(!f.getOption("readOnly")){var i=d.merge_rhs_button.clone();i.button&&i.button({icons:{primary:"ui-icon-triangle-1-e"},text:!1}),i.addClass("merge-button"),i.attr("id","merge-rhs-"+a),e.setGutterMarker(b["lhs-line-from"],"merge",i.get(0))}}});var h=this._get_viewport(a,b);this.trace("change","markup lhs-editor time",g.stop()),f.operation(function(){for(var a=0;c.length>a;++a){var b=c[a];if(d._is_change_in_view(h,b)){var g=["mergely","rhs",b.op,"cid-"+a];if(f.addLineClass(b["rhs-line-from"],"background","start"),f.addLineClass(b["rhs-line-to"],"background","end"),0==b["rhs-line-from"]&&0==b["rhs-line-to"])f.addLineClass(b["rhs-line-from"],"background",g.join(" ")),f.addLineClass(b["rhs-line-from"],"background","first");else for(var i=b["rhs-line-from"];b["rhs-line-to"]>=i;++i)f.addLineClass(i,"background",g.join(" ")),f.addLineClass(i,"background",g.join(" "));if(!e.getOption("readOnly")){var j=d.merge_lhs_button.clone();j.button&&j.button({icons:{primary:"ui-icon-triangle-1-w"},text:!1}),j.addClass("merge-button"),j.attr("id","merge-lhs-"+a),f.setGutterMarker(b["rhs-line-from"],"merge",j.get(0))}}}}),this.trace("change","markup rhs-editor time",g.stop());for(var i=[],j=0;this.settings.lcs&&c.length>j;++j){var k=c[j];if(this._is_change_in_view(h,k))if("d"==k.op){var l=k["lhs-line-from"],m=k["lhs-line-to"],n=e.lineInfo(m);n&&i.push([e,{line:l,ch:0},{line:m,ch:n.text.length},{className:"mergely ch d lhs"}])}else if("c"==k.op)for(var o=k["lhs-line-from"],p=k["rhs-line-from"],q=0;o>=0&&k["lhs-line-to"]>=o||p>=0&&k["rhs-line-to"]>=p;++o,++p)if(p+q>k["rhs-line-to"]){var r=e.getLine(o);i.push([e,{line:o,ch:0},{line:o,ch:r.length},{className:"mergely ch d lhs"}])}else if(o+q>k["lhs-line-to"]){var s=f.getLine(p);i.push([f,{line:p,ch:0},{line:p,ch:s.length},{className:"mergely ch a rhs"}])}else{var r=e.getLine(o),s=f.getLine(p),x=new Mgly.LCS(r,s);x.diff(function(a,b){i.push([f,{line:p,ch:a},{line:p,ch:b},{className:"mergely ch a rhs"}])},removed=function(a,b){i.push([e,{line:o,ch:a},{line:o,ch:b},{className:"mergely ch d lhs"}])})}}this.trace("change","LCS marktext time",g.stop()),e.operation(function(){for(var a=0;i.length>a;++a){var b=i[a];b[0].doc.id==e.getDoc().id&&d.chfns[d.id+"-lhs"].push(b[0].markText(b[1],b[2],b[3]))}}),f.operation(function(){for(var a=0;i.length>a;++a){var b=i[a];b[0].doc.id==f.getDoc().id&&d.chfns[d.id+"-rhs"].push(b[0].markText(b[1],b[2],b[3]))}}),this.trace("change","LCS markup time",g.stop());var y={lhs:e,rhs:f};jQuery(".merge-button").on("click",function(a){var b="rhs",c="lhs",e=jQuery(this).parents("#"+d.id+"-editor-lhs");e.length&&(b="lhs",c="rhs");var f=y[b].coordsChar({left:a.pageX,top:a.pageY}),g=null,h=y[b].lineInfo(f.line);jQuery.each(h.bgClass.split(" "),function(a,b){return 0==b.indexOf("cid-")?(g=parseInt(b.split("-")[1]),!1):void 0});var i=d.changes[g],j={lhs:y.lhs.lineInfo(i["lhs-line-to"]),rhs:y.rhs.lineInfo(i["rhs-line-to"])},k=y[b].getRange({line:i[b+"-line-from"],ch:0},{line:i[b+"-line-to"],ch:j[b].text.length});if("rhs"==b)if("c"==i.op)y[c].replaceRange(k,{line:i[c+"-line-from"],ch:0},{line:i[c+"-line-to"],ch:j[c].text.length});else if("a"==i.op)y[c].replaceRange(k+"\n",{line:i[c+"-line-from"],ch:0},{line:i[c+"-line-to"],ch:0});else for(var l=parseInt(i[c+"-line-from"]),m=parseInt(i[c+"-line-to"]),n=m;n>=l;--n)y[c].removeLine(n);else if("c"==i.op)y[c].replaceRange(k,{line:i[c+"-line-from"],ch:0},{line:i[c+"-line-to"],ch:j[c].text.length});else if("a"==i.op)for(var l=parseInt(i[c+"-line-from"]),m=parseInt(i[c+"-line-to"]),n=m;n>=l;--n)y[c].removeLine(n);else{var l=parseInt(i[c+"-line-from"]),m=parseInt(i[c+"-line-to"]);y[c].replaceRange("\n"+k,{line:i[c+"-line-from"],ch:j[c].text.length},{line:i[c+"-line-to"],ch:j[c].text.length})}return y.lhs.setValue(y.lhs.getValue()),y.rhs.setValue(y.rhs.getValue()),!1}),this.trace("change","markup buttons time",g.stop())},_draw_info:function(a,b){var c=jQuery(this.editor[a].getScrollerElement()).height(),d=jQuery(this.editor[a].getScrollerElement()).children(":first-child").height(),e=document.getElementById(a+"-"+b+"-canvas");if(void 0==e)throw"Failed to find: "+a+"-"+b+"-canvas";var f=jQuery("#"+this.id+"-lhs-margin"),g=jQuery("#"+this.id+"-rhs-margin");return{visible_page_height:c,gutter_height:d,visible_page_ratio:c/d,margin_ratio:c/d,lhs_scroller:jQuery(this.editor[a].getScrollerElement()),rhs_scroller:jQuery(this.editor[b].getScrollerElement()),lhs_lines:this.editor[a].lineCount(),rhs_lines:this.editor[b].lineCount(),dcanvas:e,clhs:f,crhs:g,lhs_xyoffset:jQuery(f).offset(),rhs_xyoffset:jQuery(g).offset()}},_draw_diff:function(a,b,c){var d=this._draw_info(a,b),e=d.clhs.get(0),f=d.crhs.get(0),g=d.dcanvas.getContext("2d"),h=e.getContext("2d"),i=f.getContext("2d");this.trace("draw","visible_page_height",d.visible_page_height),this.trace("draw","gutter_height",d.gutter_height),this.trace("draw","visible_page_ratio",d.visible_page_ratio),this.trace("draw","lhs-scroller-top",d.lhs_scroller.scrollTop()),this.trace("draw","rhs-scroller-top",d.rhs_scroller.scrollTop()),jQuery.each(jQuery.find("#"+this.id+" canvas"),function(){jQuery(this).get(0).height=d.visible_page_height}),d.clhs.unbind("click"),d.crhs.unbind("click"),h.beginPath(),h.fillStyle=this.settings.bgcolor,h.strokeStyle="#888",h.fillRect(0,0,6.5,d.visible_page_height),h.strokeRect(0,0,6.5,d.visible_page_height),i.beginPath(),i.fillStyle=this.settings.bgcolor,i.strokeStyle="#888",i.fillRect(0,0,6.5,d.visible_page_height),i.strokeRect(0,0,6.5,d.visible_page_height);for(var j=this._get_viewport(a,b),k=0;c.length>k;++k){var l=c[k];this.trace("draw",l);var m=(l["lhs-y-start"]+d.lhs_scroller.scrollTop())*d.visible_page_ratio,n=(l["lhs-y-end"]+d.lhs_scroller.scrollTop())*d.visible_page_ratio+1,o=(l["rhs-y-start"]+d.rhs_scroller.scrollTop())*d.visible_page_ratio,p=(l["rhs-y-end"]+d.rhs_scroller.scrollTop())*d.visible_page_ratio+1;if(this.trace("draw","marker calculated",m,n,o,p),h.beginPath(),h.fillStyle=this.settings.fgcolor[l.op],h.strokeStyle="#000",h.lineWidth=.5,h.fillRect(1.5,m,4.5,Math.max(n-m,5)),h.strokeRect(1.5,m,4.5,Math.max(n-m,5)),i.beginPath(),i.fillStyle=this.settings.fgcolor[l.op],i.strokeStyle="#000",i.lineWidth=.5,i.fillRect(1.5,o,4.5,Math.max(p-o,5)),i.strokeRect(1.5,o,4.5,Math.max(p-o,5)),this._is_change_in_view(j,l)){m=l["lhs-y-start"],n=l["lhs-y-end"],o=l["rhs-y-start"],p=l["rhs-y-end"];var q=3;g.beginPath(),g.strokeStyle=this.settings.fgcolor[l.op],g.lineWidth=1;var r=this.draw_lhs_width,s=n-m-1,t=this.draw_lhs_min,u=m;g.moveTo(t,u),"Microsoft Internet Explorer"==navigator.appName?(g.lineTo(this.draw_lhs_min+this.draw_lhs_width,m),g.lineTo(this.draw_lhs_min+this.draw_lhs_width,n+1),g.lineTo(this.draw_lhs_min,n+1)):(0>=s?g.lineTo(t+r,u):(g.arcTo(t+r,u,t+r,u+q,q),g.arcTo(t+r,u+s,t+r-q,u+s,q)),g.lineTo(t,u+s)),g.stroke(),r=this.draw_rhs_width,s=p-o-1,t=this.draw_rhs_max,u=o,g.moveTo(t,u),"Microsoft Internet Explorer"==navigator.appName?(g.lineTo(this.draw_rhs_max-this.draw_rhs_width,o),g.lineTo(this.draw_rhs_max-this.draw_rhs_width,p+1),g.lineTo(this.draw_rhs_max,p+1)):(0>=s?g.lineTo(t-r,u):(g.arcTo(t-r,u,t-r,u+q,q),g.arcTo(t-r,u+s,t-q,u+s,q)),g.lineTo(t,u+s)),g.stroke();var v=this.draw_lhs_min+this.draw_lhs_width,w=m+(n+1-m)/2,x=this.draw_rhs_max-this.draw_rhs_width,y=o+(p+1-o)/2;g.moveTo(v,w),w==y?g.lineTo(x,y):g.bezierCurveTo(v+12,w-3,x-12,y-3,x,y),g.stroke()}}h.fillStyle=this.settings.vpcolor,i.fillStyle=this.settings.vpcolor;var z=d.clhs.height()*d.visible_page_ratio,A=d.lhs_scroller.scrollTop()/d.gutter_height*d.clhs.height();this.trace("draw","cls.height",d.clhs.height()),this.trace("draw","lhs_scroller.scrollTop()",d.lhs_scroller.scrollTop()),this.trace("draw","gutter_height",d.gutter_height),this.trace("draw","visible_page_ratio",d.visible_page_ratio),this.trace("draw","from",A,"to",z),h.fillRect(1.5,A,4.5,z),i.fillRect(1.5,A,4.5,z),d.clhs.click(function(a){var b=a.pageY-lhs_xyoffset.top-z/2,c=Math.max(0,b/d.mcanvas_lhs.height*d.lhs_scroller.get(0).scrollHeight);d.lhs_scroller.scrollTop(c)}),d.crhs.click(function(a){var b=a.pageY-rhs_xyoffset.top-z/2,c=Math.max(0,b/d.mcanvas_rhs.height*d.rhs_scroller.get(0).scrollHeight);d.rhs_scroller.scrollTop(c)})},trace:function(a){this.settings._debug.indexOf(a)>=0&&(arguments[0]=a+":",console.log([].slice.apply(arguments)))}}),jQuery.pluginMaker=function(a){jQuery.fn[a.prototype.name]=function(b){var c=jQuery.makeArray(arguments),d=c.slice(1),e=void 0;return this.each(function(){var f=jQuery.data(this,a.prototype.name);if(f){if("string"==typeof b)e=f[b].apply(f,d);else if(f.update)return f.update.apply(f,c)}else new a(this,b)}),void 0!=e?e:void 0}},jQuery.pluginMaker(Mgly.mergely);