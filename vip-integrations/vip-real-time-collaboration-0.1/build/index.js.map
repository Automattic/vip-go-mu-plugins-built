{"version":3,"file":"index.js","mappings":"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","sources":["webpack://vip-real-time-collaboration/webpack/bootstrap","webpack://vip-real-time-collaboration/webpack/runtime/compat get default export","webpack://vip-real-time-collaboration/webpack/runtime/define property getters","webpack://vip-real-time-collaboration/webpack/runtime/hasOwnProperty shorthand","webpack://vip-real-time-collaboration/external window [\"wp\",\"hooks\"]","webpack://vip-real-time-collaboration/external window [\"wp\",\"plugins\"]","webpack://vip-real-time-collaboration/external window [\"wp\",\"data\"]","webpack://vip-real-time-collaboration/external window [\"wp\",\"editPost\"]","webpack://vip-real-time-collaboration/external window [\"wp\",\"element\"]","webpack://vip-real-time-collaboration/external window \"ReactJSXRuntime\"","webpack://vip-real-time-collaboration/external window [\"wp\",\"blockEditor\"]","webpack://vip-real-time-collaboration/external window [\"wp\",\"components\"]","webpack://vip-real-time-collaboration/external window [\"wp\",\"editor\"]","webpack://vip-real-time-collaboration/external window [\"wp\",\"i18n\"]","webpack://vip-real-time-collaboration/external window [\"wp\",\"privateApis\"]","webpack://vip-real-time-collaboration/./src/components/avatar.tsx","webpack://vip-real-time-collaboration/external window [\"wp\",\"notices\"]","webpack://vip-real-time-collaboration/./src/utilities/config.ts","webpack://vip-real-time-collaboration/./src/utilities/logger.ts","webpack://vip-real-time-collaboration/./src/utilities/local-storage.ts","webpack://vip-real-time-collaboration/./src/store/settings-store.ts","webpack://vip-real-time-collaboration/./src/utilities/notifications.ts","webpack://vip-real-time-collaboration/external window [\"wp\",\"coreData\"]","webpack://vip-real-time-collaboration/./src/yjs-shim.ts","webpack://vip-real-time-collaboration/./src/utilities/selection.ts","webpack://vip-real-time-collaboration/./src/utilities/user.ts","webpack://vip-real-time-collaboration/./src/store/awareness-store.ts","webpack://vip-real-time-collaboration/./src/hooks/use-sorted-awareness-users.tsx","webpack://vip-real-time-collaboration/./src/components/avatars.tsx","webpack://vip-real-time-collaboration/external window [\"wp\",\"blocks\"]","webpack://vip-real-time-collaboration/./src/components/debug-tools.tsx","webpack://vip-real-time-collaboration/external window [\"wp\",\"primitives\"]","webpack://vip-real-time-collaboration/./node_modules/@wordpress/icons/build-module/library/error.js","webpack://vip-real-time-collaboration/external window [\"wp\",\"compose\"]","webpack://vip-real-time-collaboration/./src/components/post-locked-modal.tsx","webpack://vip-real-time-collaboration/./src/hooks/use-copy-post-content-to-clipboard.ts","webpack://vip-real-time-collaboration/./src/hooks/use-is-disconnected.ts","webpack://vip-real-time-collaboration/./src/hooks/use-block-highlighting.ts","webpack://vip-real-time-collaboration/./src/utilities/browser.ts","webpack://vip-real-time-collaboration/./src/utilities/entity.ts","webpack://vip-real-time-collaboration/./src/utilities/user-color.ts","webpack://vip-real-time-collaboration/./src/hooks/use-render-cursors.ts","webpack://vip-real-time-collaboration/./src/awareness-manager.ts","webpack://vip-real-time-collaboration/./src/components/rtc-overlay.tsx","webpack://vip-real-time-collaboration/./src/components/rtc-settings-panel.tsx","webpack://vip-real-time-collaboration/external window [\"wp\",\"apiFetch\"]","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/map.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/set.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/string.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/storage.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/array.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/environment.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/conditions.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/function.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/buffer.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/broadcastchannel.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/time.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/math.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/binary.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/encoding.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/number.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/error.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/decoding.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/node_modules/lib0/math.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/node_modules/lib0/binary.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/node_modules/lib0/string.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/node_modules/lib0/encoding.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/node_modules/lib0/number.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/node_modules/lib0/error.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/node_modules/lib0/decoding.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/sync.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/node_modules/lib0/time.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/node_modules/lib0/map.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/node_modules/lib0/set.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/node_modules/lib0/array.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/node_modules/lib0/observable.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/node_modules/lib0/object.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/node_modules/lib0/traits.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/node_modules/lib0/function.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/awareness.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/observable.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/object.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/src/y-websocket.js","webpack://vip-real-time-collaboration/./node_modules/y-protocols/auth.js","webpack://vip-real-time-collaboration/./node_modules/y-websocket/node_modules/lib0/url.js","webpack://vip-real-time-collaboration/./src/utilities/error.ts","webpack://vip-real-time-collaboration/./src/utilities/crypto.ts","webpack://vip-real-time-collaboration/./src/websocket-client.ts","webpack://vip-real-time-collaboration/./src/utilities/function.ts","webpack://vip-real-time-collaboration/./src/index.ts","webpack://vip-real-time-collaboration/./src/components/read-only-code-editor.tsx"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"wp\"][\"hooks\"];","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"wp\"][\"plugins\"];","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"wp\"][\"data\"];","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"wp\"][\"editPost\"];","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"wp\"][\"element\"];","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"ReactJSXRuntime\"];","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"wp\"][\"blockEditor\"];","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"wp\"][\"components\"];","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"wp\"][\"editor\"];","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"wp\"][\"i18n\"];","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"wp\"][\"privateApis\"];","import { UserInfo } from '@/store/awareness-store';\n\n/**\n * Renders a circular avatar bubble for a user with an optional border.\n */\nexport function Avatar( {\n\tuserInfo,\n\tshowUserColorBorder,\n}: {\n\tuserInfo: UserInfo;\n\tshowUserColorBorder?: boolean;\n} ) {\n\tconst style = {\n\t\tborder: showUserColorBorder === true ? `2px solid ${ userInfo.color }` : undefined,\n\t\topacity: userInfo.isConnected ? 1 : 0.5,\n\t};\n\n\treturn (\n\t\t<div className=\"vip-real-time-collaboration-avatar\">\n\t\t\t<img\n\t\t\t\talt={ userInfo.name }\n\t\t\t\tsrc={ userInfo.avatarUrl }\n\t\t\t\tstyle={ style }\n\t\t\t\ttitle={ userInfo.name }\n\t\t\t/>\n\t\t</div>\n\t);\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"wp\"][\"notices\"];","export const AWARENESS_CURSOR_UPDATE_DEBOUNCE_IN_MS = 50;\nexport const LOCAL_CURSOR_UPDATE_DEBOUNCE_IN_MS = 5;\n\nexport const DISCONNECTED_THRESHOLD_IN_MS = 5000;\nexport const REMOVAL_DELAY_IN_MS = 5000;\n\nexport const WEBSOCKET_PROVIDER_MAX_BACKOFF_IN_MS = 15000;\nexport const WEBSOCKET_URL = getVipConfigFromWindow( 'wsUrl' );\n\nexport const BLOG_ID = getVipConfigFromWindow( 'blogId' );\n\n// Exporting this as a function allows for easier testing/mocking.\nexport function isDevelopment(): boolean {\n\treturn 'development' === process.env.NODE_ENV;\n}\n\nfunction getVipConfigFromWindow< Key extends keyof VIPRTCConfig >(\n\tkey: Key\n): VIPRTCConfig[ Key ] | null {\n\tif ( 'undefined' === typeof window || 'undefined' === typeof window.VIP_RTC ) {\n\t\treturn null;\n\t}\n\n\t// eslint-disable-next-line security/detect-object-injection\n\treturn window.VIP_RTC[ key ];\n}\n","import { isDevelopment } from '@/utilities/config';\n\nexport enum LogLevel {\n\tCRITICAL = 5,\n\tERROR = 4,\n\tWARNING = 3,\n\tINFO = 2,\n\tDEBUG = 1,\n}\n\nconst DEFAULT_LOG_THRESHOLD = isDevelopment() ? LogLevel.DEBUG : LogLevel.WARNING;\n\nexport class Logger {\n\tprivate namespace: string;\n\n\tpublic constructor(\n\t\tlocalNamespace: string = '',\n\t\tprivate threshold: LogLevel = DEFAULT_LOG_THRESHOLD\n\t) {\n\t\tthis.namespace = `vip-rtc${ localNamespace ? `:${ localNamespace }` : '' }`;\n\t}\n\n\tprotected log( level: LogLevel, ...args: unknown[] ): void {\n\t\tif ( level < this.threshold ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// eslint-disable-next-line security/detect-object-injection\n\t\tconst levelStr = LogLevel[ level ];\n\n\t\t// eslint-disable-next-line no-console\n\t\tconsole.log( `[${ this.namespace }][${ levelStr }]`, ...args );\n\t}\n\n\tpublic debug( ...args: unknown[] ): void {\n\t\tthis.log( LogLevel.DEBUG, ...args );\n\t}\n\n\tpublic info( ...args: unknown[] ): void {\n\t\tthis.log( LogLevel.INFO, ...args );\n\t}\n\n\tpublic warn( ...args: unknown[] ): void {\n\t\tthis.log( LogLevel.WARNING, ...args );\n\t}\n\n\tpublic error( ...args: unknown[] ): void {\n\t\tthis.log( LogLevel.ERROR, ...args );\n\t}\n\n\tpublic critical( ...args: unknown[] ): void {\n\t\tthis.log( LogLevel.CRITICAL, ...args );\n\t}\n}\n","import { Logger } from '@/utilities/logger';\n\nconst logger = new Logger( 'local-storage' );\n\n/**\n * Load data from localStorage with error handling\n * @param key - The localStorage key to read from\n * @param defaultValue - The default value to return if loading fails or key doesn't exist\n * @returns The parsed data from localStorage or the default value\n */\nexport const loadFromLocalStorage = < T >( key: string, defaultValue: T ): T => {\n\ttry {\n\t\tconst saved = localStorage.getItem( key );\n\t\tif ( saved ) {\n\t\t\tconst parsed = JSON.parse( saved ) as T;\n\t\t\t// If the parsed value is an object (and not null or array), merge with defaultValue\n\t\t\tif ( typeof parsed === 'object' && parsed !== null && ! Array.isArray( parsed ) ) {\n\t\t\t\treturn { ...defaultValue, ...( parsed as Partial< T > ) };\n\t\t\t}\n\t\t\t// For primitive values (string, number, boolean, null), return directly\n\t\t\treturn parsed;\n\t\t}\n\t} catch ( error ) {\n\t\tlogger.warn( `Failed to load data from localStorage (key: ${ key }):`, error );\n\t}\n\treturn defaultValue;\n};\n\n/**\n * Save data to localStorage with error handling\n * @param key - The localStorage key to write to\n * @param data - The data to save\n */\nexport const saveToLocalStorage = < T >( key: string, data: T ): void => {\n\ttry {\n\t\tlocalStorage.setItem( key, JSON.stringify( data ) );\n\t} catch ( error ) {\n\t\tlogger.warn( `Failed to save data to localStorage (key: ${ key }):`, error );\n\t}\n};\n","import { register, createReduxStore, StoreDescriptor } from '@wordpress/data';\n\nimport { isDevelopment } from '@/utilities/config';\nimport { loadFromLocalStorage, saveToLocalStorage } from '@/utilities/local-storage';\n\nconst STORE_NAME = 'vip-real-time-collaboration/settings';\nconst LOCAL_STORAGE_KEY = 'vip-rtc-settings';\n\nexport enum Setting {\n\tAWARENESS_AVATARS = 'Awareness_Avatars',\n\tAWARENESS_CURSORS = 'Awareness_Cursors',\n\tDEBUG_TOOLS = 'Debug_Tools',\n\tSELF_AWARENESS = 'Self_Awareness',\n\tUSER_ENTER_NOTIFICATION = 'User_Enter_Notification',\n\tUSER_EXIT_NOTIFICATION = 'User_Exit_Notification',\n}\n\ninterface SettingsState {\n\t[ Setting.AWARENESS_AVATARS ]: boolean;\n\t[ Setting.AWARENESS_CURSORS ]: boolean;\n\t[ Setting.DEBUG_TOOLS ]: boolean;\n\t[ Setting.SELF_AWARENESS ]: boolean;\n\t[ Setting.USER_ENTER_NOTIFICATION ]: boolean;\n\t[ Setting.USER_EXIT_NOTIFICATION ]: boolean;\n}\n\nconst DEFAULT_STATE: SettingsState = {\n\t[ Setting.AWARENESS_AVATARS ]: true,\n\t[ Setting.AWARENESS_CURSORS ]: true,\n\t[ Setting.DEBUG_TOOLS ]: false,\n\t[ Setting.SELF_AWARENESS ]: false,\n\t[ Setting.USER_ENTER_NOTIFICATION ]: true,\n\t[ Setting.USER_EXIT_NOTIFICATION ]: false,\n};\n\nconst actions = {\n\tsetSetting: ( setting: Setting, enabled: boolean ): SettingsAction => ( {\n\t\ttype: 'SET_SETTING',\n\t\tpayload: { setting, enabled },\n\t} ),\n};\n\nconst reducer = (\n\tstate = loadFromLocalStorage( LOCAL_STORAGE_KEY, DEFAULT_STATE ),\n\taction: SettingsAction\n): SettingsState => {\n\tswitch ( action.type ) {\n\t\tcase 'SET_SETTING': {\n\t\t\tconst newState = {\n\t\t\t\t...state,\n\t\t\t\t[ action.payload.setting ]: action.payload.enabled,\n\t\t\t};\n\n\t\t\tsaveToLocalStorage( LOCAL_STORAGE_KEY, newState );\n\t\t\treturn newState;\n\t\t}\n\t\tdefault:\n\t\t\treturn state;\n\t}\n};\n\nconst selectors = {\n\tgetSetting( state: SettingsState, setting: Setting ): boolean {\n\t\t// Special handling for debug tools - only available in development\n\t\tif ( setting === Setting.DEBUG_TOOLS ) {\n\t\t\treturn isDevelopment() ? state[ setting ] : false;\n\t\t}\n\t\treturn state[ setting ];\n\t},\n};\n\ntype SettingsAction = {\n\ttype: 'SET_SETTING';\n\tpayload: {\n\t\tsetting: Setting;\n\t\tenabled: boolean;\n\t};\n};\n\nexport const store = createReduxStore( STORE_NAME, {\n\treducer,\n\tactions,\n\tselectors,\n} );\n\n( register as ( store: StoreDescriptor ) => void )( store );\n\nexport type { SettingsState };\n\nexport type SettingsStoreActions = {\n\tsetSetting: ( setting: Setting, enabled: boolean ) => void;\n};\n\nexport type SettingsStoreSelectors = {\n\tgetSetting: ( setting: Setting ) => boolean;\n};\n","import { dispatch, select } from '@wordpress/data';\nimport { store as noticesStore } from '@wordpress/notices';\n\nimport { store as settingsStore, Setting } from '@/store/settings-store';\n\nimport type { UserInfo } from '@/store/awareness-store';\n\nexport enum NotificationType {\n\tPostRestored = 'remote-user-post-restored',\n\tPostUpdated = 'remote-user-post-updated',\n\tUserEntered = 'remote-user-user-entered',\n\tUserExited = 'remote-user-user-exited',\n}\n\n/**\n * Get the content of a post restored notification.\n *\n * @param userInfo the user info of the user related to the notification\n * @returns the content of the post restored notification\n */\nfunction getPostRestoredNotificationContent( userInfo: UserInfo ): string {\n\tlet predicate = `${ userInfo.name } restored`;\n\tif ( userInfo.isMe ) {\n\t\tpredicate = 'Restored';\n\t}\n\n\treturn `${ predicate } newer content from the server.`;\n}\n\n/**\n * Get the content of a post updated or draft saved notification.\n *\n * @param userInfo the user info of the user related to the notification\n * @param status the status of the post\n * @returns the content of the post updated or draft saved notification\n */\nfunction getPostUpdatedNotificationContent( userInfo: UserInfo, status: string ): string {\n\tlet noun = 'Draft';\n\tlet verb = 'saved';\n\n\tif ( [ 'future', 'private', 'publish' ].includes( status ) ) {\n\t\tnoun = 'Post';\n\t\tverb = 'updated';\n\t}\n\n\treturn `${ noun } ${ verb } by ${ userInfo.name }.`;\n}\n\n/**\n * Get the content of a user presence notification, based on the type.\n *\n * @param userInfo the user info of the user related to the notification\n * @param type the type of notification\n * @returns the content of the user presence notification\n */\nfunction getUserPresenceNotificationContent( userInfo: UserInfo, type: NotificationType ): string {\n\tconst action = type === NotificationType.UserEntered ? 'entered' : 'exited';\n\treturn `${ userInfo.name } has ${ action } the post.`;\n}\n\nfunction shouldSendNotification(\n\tuserInfo: UserInfo,\n\ttype: NotificationType,\n\tcontent: string\n): boolean {\n\t// If content is empty, skip.\n\tif ( ! content ) {\n\t\treturn false;\n\t}\n\n\t// If notifications for user joining is disabled, skip.\n\tif (\n\t\ttype === NotificationType.UserEntered &&\n\t\t! select( settingsStore ).getSetting( Setting.USER_ENTER_NOTIFICATION )\n\t) {\n\t\treturn false;\n\t}\n\n\t// If notifications for user leaving is disabled, skip.\n\tif (\n\t\ttype === NotificationType.UserExited &&\n\t\t! select( settingsStore ).getSetting( Setting.USER_EXIT_NOTIFICATION )\n\t) {\n\t\treturn false;\n\t}\n\n\t// If the current user is the one who joined/left, skip.\n\tif (\n\t\t( type === NotificationType.UserEntered || type === NotificationType.UserExited ) &&\n\t\tuserInfo.isMe\n\t) {\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nfunction getContentForNotificationType(\n\tuserInfo: UserInfo,\n\ttype: NotificationType,\n\tstatus?: string\n): string {\n\tswitch ( type ) {\n\t\tcase NotificationType.PostRestored:\n\t\t\treturn getPostRestoredNotificationContent( userInfo );\n\t\tcase NotificationType.PostUpdated:\n\t\t\treturn getPostUpdatedNotificationContent( userInfo, status ?? '' );\n\t\tcase NotificationType.UserEntered:\n\t\tcase NotificationType.UserExited:\n\t\t\treturn getUserPresenceNotificationContent( userInfo, type );\n\t\tdefault:\n\t\t\treturn '';\n\t}\n}\n\n/**\n * Send a notification to the editor.\n *\n * Certain notifications can be skipped based on user settings, or scenarios.\n *\n * @param content the notification content\n * @param userInfo the user info of the user related to the notification\n * @param type the type of notification\n */\nexport function sendNotification(\n\ttype: NotificationType,\n\tuserInfo: UserInfo,\n\tstatus?: string\n): void {\n\t// This is done on purpose, to allow tests to be written without noticesStore.\n\tconst { createNotice } = dispatch( noticesStore );\n\n\t// Get the content for the notification type.\n\tconst content = getContentForNotificationType( userInfo, type, status );\n\n\t// Skip notifications for certain cases.\n\tif ( ! shouldSendNotification( userInfo, type, content ) ) {\n\t\treturn;\n\t}\n\n\t// Send the notification, via a notice.\n\tvoid createNotice( 'info', content, {\n\t\tid: `${ type }-${ userInfo.clientId }`,\n\t\tisDismissible: false,\n\t\ttype: 'snackbar',\n\t} );\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"wp\"][\"coreData\"];","/**\n * This file is a shim for loading Yjs from a browser global provided by the\n * `@wordpress/sync` package. This is done primarily to avoid packaging and\n * importing two different Yjs instances, which would result in this conflict:\n *\n * https://github.com/yjs/yjs/issues/438\n *\n * It also allows us to align on the same Yjs version automatically.\n *\n * Scripts in this repo should directly import 'yjs' which will resolve to this\n * file via Webpack.\n *\n * This (unused) import of `@wordpress/core-data` is important to ensure that\n * `wp.sync` is loaded and available. It results in `core-data` being added to\n * our script's dependencies (see `build/index.asset.php`), which influences the\n * load order. We cannot use `@wordpress/sync` for this purpose because it is\n * not yet a public package.\n */\nimport '@wordpress/core-data';\n\n// To avoid issues with default exports, you must individually export the\n// properties you need, including those used by dependencies.\nexport const applyUpdate = window.wp.sync.Y.applyUpdate;\nexport const applyUpdateV2 = window.wp.sync.Y.applyUpdateV2;\nexport const encodeStateVector = window.wp.sync.Y.encodeStateVector;\nexport const encodeStateAsUpdate = window.wp.sync.Y.encodeStateAsUpdate;\nexport const encodeStateAsUpdateV2 = window.wp.sync.Y.encodeStateAsUpdateV2;\nexport const createRelativePositionFromTypeIndex =\n\twindow.wp.sync.Y.createRelativePositionFromTypeIndex;\nexport const createAbsolutePositionFromRelativePosition =\n\twindow.wp.sync.Y.createAbsolutePositionFromRelativePosition;\nexport const Doc = window.wp.sync.Y.Doc;\n","import { store as coreStore } from '@wordpress/core-data';\nimport { dispatch, select } from '@wordpress/data';\nimport { store as editorStore } from '@wordpress/editor';\nimport { type WPBlockSelection } from '@wordpress/editor/build-types/store/selectors';\nimport * as Y from 'yjs';\n\nimport { Logger } from './logger';\n\nconst logger = new Logger( 'selection' );\n\n// Convenience types to manage block values with a clientId, attributes, and innerBlocks.\ntype BlockClientId = string;\ntype BlockInnerBlocks = Y.Array< SelectableBlock >;\ntype BlockAttributes = Y.Map< Y.Text >;\nexport type SelectableBlock = Y.Map< BlockClientId | BlockAttributes | BlockInnerBlocks >;\n\nexport enum SelectionType {\n\tNone = 'none',\n\tCursor = 'cursor',\n\tSelectionInOneBlock = 'selection-in-one-block',\n\tSelectionInMultipleBlocks = 'selection-in-multiple-blocks',\n\tWholeBlock = 'whole-block',\n}\n\nexport type CursorPosition = {\n\trelativePosition: Y.RelativePosition;\n\n\t// Also store the absolute offset index of the cursor from the perspective\n\t// of the user who is updating the selection.\n\t//\n\t// Do not use this value directly, instead use `createAbsolutePositionFromRelativePosition()`\n\t// on relativePosition for the most up-to-date positioning.\n\t//\n\t// This is used because local Y.Text changes (e.g. adding or deleting a character)\n\t// can result in the same relative position if it is pinned to an unchanged\n\t// character. With both of these values as editor state, a change in perceived\n\t// position will always result in a redraw.\n\tabsoluteOffset: number;\n};\n\nexport type SelectionNone = {\n\t// The user has not made a selection.\n\ttype: SelectionType.None;\n};\n\nexport type SelectionCursor = {\n\t// The user has a cursor position in a block with no text highlighted.\n\ttype: SelectionType.Cursor;\n\tblockId: string;\n\tcursorPosition: CursorPosition;\n};\n\nexport type SelectionInOneBlock = {\n\t// The user has highlighted text in a single block.\n\ttype: SelectionType.SelectionInOneBlock;\n\tblockId: string;\n\tcursorStartPosition: CursorPosition;\n\tcursorEndPosition: CursorPosition;\n};\n\nexport type SelectionInMultipleBlocks = {\n\t// The user has highlighted text over multiple blocks.\n\ttype: SelectionType.SelectionInMultipleBlocks;\n\tblockStartId: string;\n\tblockEndId: string;\n\tcursorStartPosition: CursorPosition;\n\tcursorEndPosition: CursorPosition;\n};\n\nexport type SelectionWholeBlock = {\n\t// The user has a non-text block selected, like an image block.\n\ttype: SelectionType.WholeBlock;\n\tblockId: string;\n};\n\nexport type SelectionState =\n\t| SelectionNone\n\t| SelectionCursor\n\t| SelectionInOneBlock\n\t| SelectionInMultipleBlocks\n\t| SelectionWholeBlock;\n\n/**\n * Converts WordPress block editor selection to a SelectionState.\n *\n * @param selectionStart - The start position of the selection\n * @param selectionEnd - The end position of the selection\n * @returns The SelectionState\n */\nexport function getSelectionState(\n\tselectionStart: WPBlockSelection,\n\tselectionEnd: WPBlockSelection,\n\tyBlocks: Y.Array< SelectableBlock >\n): SelectionState {\n\tconst isSelectionEmpty = Object.keys( selectionStart ).length === 0;\n\tconst noSelection: SelectionNone = {\n\t\ttype: SelectionType.None,\n\t};\n\n\tif ( isSelectionEmpty ) {\n\t\t// Case 1: No selection\n\t\treturn noSelection;\n\t}\n\n\t// When the page initially loads, selectionStart can contain an empty object `{}`.\n\tconst isSelectionInOneBlock = selectionStart.clientId === selectionEnd.clientId;\n\tconst isCursorOnly = isSelectionInOneBlock && selectionStart.offset === selectionEnd.offset;\n\tconst isSelectionAWholeBlock =\n\t\tisSelectionInOneBlock &&\n\t\tselectionStart.offset === undefined &&\n\t\tselectionEnd.offset === undefined;\n\n\tif ( isSelectionAWholeBlock ) {\n\t\t// Case 2: A whole block is selected.\n\t\treturn {\n\t\t\ttype: SelectionType.WholeBlock,\n\t\t\tblockId: selectionStart.clientId,\n\t\t};\n\t} else if ( isCursorOnly ) {\n\t\t// Case 3: Cursor only, no text selected\n\t\tconst cursorPosition = getCursorPosition( selectionStart, yBlocks );\n\n\t\tif ( ! cursorPosition ) {\n\t\t\t// If we can't find the cursor position in block text, treat it as a non-selection.\n\t\t\treturn noSelection;\n\t\t}\n\n\t\treturn {\n\t\t\ttype: SelectionType.Cursor,\n\t\t\tblockId: selectionStart.clientId,\n\t\t\tcursorPosition,\n\t\t};\n\t} else if ( isSelectionInOneBlock ) {\n\t\t// Case 4: Selection in a single block\n\t\tconst cursorStartPosition = getCursorPosition( selectionStart, yBlocks );\n\t\tconst cursorEndPosition = getCursorPosition( selectionEnd, yBlocks );\n\n\t\tif ( ! cursorStartPosition || ! cursorEndPosition ) {\n\t\t\t// If we can't find the cursor positions in block text, treat it as a non-selection.\n\t\t\treturn noSelection;\n\t\t}\n\n\t\treturn {\n\t\t\ttype: SelectionType.SelectionInOneBlock,\n\t\t\tblockId: selectionStart.clientId,\n\t\t\tcursorStartPosition,\n\t\t\tcursorEndPosition,\n\t\t};\n\t}\n\n\t// Caes 5: Selection in multiple blocks\n\tconst cursorStartPosition = getCursorPosition( selectionStart, yBlocks );\n\tconst cursorEndPosition = getCursorPosition( selectionEnd, yBlocks );\n\tif ( ! cursorStartPosition || ! cursorEndPosition ) {\n\t\t// If we can't find the cursor positions in block text, treat it as a non-selection.\n\t\treturn noSelection;\n\t}\n\n\treturn {\n\t\ttype: SelectionType.SelectionInMultipleBlocks,\n\t\tblockStartId: selectionStart.clientId,\n\t\tblockEndId: selectionEnd.clientId,\n\t\tcursorStartPosition,\n\t\tcursorEndPosition,\n\t};\n}\n\n/**\n * Update the entity record with the current user's selection.\n *\n * @param start - The start position of the selection\n * @param end - The end position of the selection\n */\nexport async function updateSelectionInEntityRecord(\n\tselectionStart: WPBlockSelection,\n\tselectionEnd: WPBlockSelection,\n\tinitialPosition: number | null\n): Promise< void > {\n\tconst { editEntityRecord } = dispatch( coreStore );\n\tconst { getCurrentPostId, getCurrentPostType } = select( editorStore );\n\n\tconst postId = getCurrentPostId();\n\tconst postType = getCurrentPostType();\n\n\tif ( ! postId || ! postType || ! selectionStart.clientId ) {\n\t\treturn;\n\t}\n\n\t// Send an entityRecord `selection` update if we have a selection.\n\t//\n\t// Normally WordPress updates the `selection` property of the post when changes are made to blocks.\n\t// In a multi-user setup, block changes can occur from other users. When an entity is updated from another\n\t// user's changes, useBlockSync() in Gutenberg will reset the user's selection to the last saved selection.\n\t//\n\t// Manually adding an edit for each movement ensures that other user's changes to the document will\n\t// not cause the local user's selection to reset to the last local change location.\n\tconst edits = {\n\t\tselection: { selectionStart, selectionEnd, initialPosition },\n\t};\n\n\tawait editEntityRecord( 'postType', postType, postId, edits, {\n\t\tundoIgnore: true,\n\t} );\n}\n\nexport function getCursorPosition(\n\tselection: WPBlockSelection,\n\tblocks: Y.Array< SelectableBlock >\n): CursorPosition | null {\n\tconst block = findBlockByClientId( selection.clientId, blocks );\n\tif ( ! block ) {\n\t\treturn null;\n\t}\n\n\tconst attributes = block.get( 'attributes' ) as Y.Map< Y.Text >;\n\tconst currentYText = attributes.get( selection.attributeKey ) as Y.Text;\n\n\tconst relativePosition = Y.createRelativePositionFromTypeIndex( currentYText, selection.offset );\n\n\treturn {\n\t\trelativePosition,\n\t\tabsoluteOffset: selection.offset,\n\t};\n}\n\nfunction findBlockByClientId(\n\tblockId: string,\n\tblocks: Y.Array< SelectableBlock >\n): SelectableBlock | null {\n\tfor ( const block of blocks ) {\n\t\tif ( block.get( 'clientId' ) === blockId ) {\n\t\t\treturn block;\n\t\t}\n\n\t\tconst innerBlocks = block.get( 'innerBlocks' ) as BlockInnerBlocks;\n\n\t\tif ( innerBlocks.length > 0 ) {\n\t\t\tconst innerBlock = findBlockByClientId(\n\t\t\t\tblockId,\n\t\t\t\tblock.get( 'innerBlocks' ) as Y.Array< SelectableBlock >\n\t\t\t);\n\n\t\t\tif ( innerBlock ) {\n\t\t\t\treturn innerBlock;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn null;\n}\n\nexport function areSelectionsEqual(\n\tselection1: SelectionState,\n\tselection2: SelectionState\n): boolean {\n\tif ( selection1.type !== selection2.type ) {\n\t\treturn false;\n\t}\n\n\tswitch ( selection1.type ) {\n\t\tcase SelectionType.None:\n\t\t\treturn true;\n\n\t\tcase SelectionType.Cursor:\n\t\t\treturn (\n\t\t\t\tselection1.blockId === ( selection2 as SelectionCursor ).blockId &&\n\t\t\t\tareCursorPositionsEqual(\n\t\t\t\t\tselection1.cursorPosition,\n\t\t\t\t\t( selection2 as SelectionCursor ).cursorPosition\n\t\t\t\t)\n\t\t\t);\n\n\t\tcase SelectionType.SelectionInOneBlock:\n\t\t\treturn (\n\t\t\t\tselection1.blockId === ( selection2 as SelectionInOneBlock ).blockId &&\n\t\t\t\tareCursorPositionsEqual(\n\t\t\t\t\tselection1.cursorStartPosition,\n\t\t\t\t\t( selection2 as SelectionInOneBlock ).cursorStartPosition\n\t\t\t\t) &&\n\t\t\t\tareCursorPositionsEqual(\n\t\t\t\t\tselection1.cursorEndPosition,\n\t\t\t\t\t( selection2 as SelectionInOneBlock ).cursorEndPosition\n\t\t\t\t)\n\t\t\t);\n\n\t\tcase SelectionType.SelectionInMultipleBlocks:\n\t\t\treturn (\n\t\t\t\tselection1.blockStartId === ( selection2 as SelectionInMultipleBlocks ).blockStartId &&\n\t\t\t\tselection1.blockEndId === ( selection2 as SelectionInMultipleBlocks ).blockEndId &&\n\t\t\t\tareCursorPositionsEqual(\n\t\t\t\t\tselection1.cursorStartPosition,\n\t\t\t\t\t( selection2 as SelectionInMultipleBlocks ).cursorStartPosition\n\t\t\t\t) &&\n\t\t\t\tareCursorPositionsEqual(\n\t\t\t\t\tselection1.cursorEndPosition,\n\t\t\t\t\t( selection2 as SelectionInMultipleBlocks ).cursorEndPosition\n\t\t\t\t)\n\t\t\t);\n\t\tcase SelectionType.WholeBlock:\n\t\t\treturn selection1.blockId === ( selection2 as SelectionWholeBlock ).blockId;\n\n\t\tdefault:\n\t\t\tlogger.error( 'Unable to compare selection types:', selection1, selection2 );\n\t\t\treturn false;\n\t}\n}\n\nfunction areCursorPositionsEqual(\n\tcursorPosition1: CursorPosition,\n\tcursorPosition2: CursorPosition\n): boolean {\n\tconst isRelativePositionEqual =\n\t\tJSON.stringify( cursorPosition1.relativePosition ) ===\n\t\tJSON.stringify( cursorPosition2.relativePosition );\n\n\t// Ensure a change in calculated absolute offset results in a treating the cursor as modified.\n\t// This is necessary because Y.Text relative positions can remain the same after text changes.\n\tconst isAbsoluteOffsetEqual = cursorPosition1.absoluteOffset === cursorPosition2.absoluteOffset;\n\n\treturn isRelativePositionEqual && isAbsoluteOffsetEqual;\n}\n","import { areSelectionsEqual } from '@/utilities/selection';\n\nimport type { EditorState, UserInfo, UserState } from '@/store/awareness-store';\n\nexport function areUserStatesEqual( userState1: UserState, userState2: UserState ): boolean {\n\treturn (\n\t\tareUserInfosEqual( userState1.userInfo, userState2.userInfo ) &&\n\t\tareEditorStatesEqual( userState1.editorState, userState2.editorState )\n\t);\n}\n\nexport function areUserInfosEqual( userInfo1: UserInfo, userInfo2: UserInfo ): boolean {\n\tif ( Object.keys( userInfo1 ).length !== Object.keys( userInfo2 ).length ) {\n\t\treturn false;\n\t}\n\n\treturn Object.entries( userInfo1 ).every( ( [ key, value ] ) => {\n\t\t// Update this function with any non-primitive fields added to UserInfo.\n\t\treturn value === userInfo2[ key as keyof UserInfo ];\n\t} );\n}\n\nexport function areEditorStatesEqual( state1?: EditorState, state2?: EditorState ): boolean {\n\treturn Boolean( state1 && state2 && areSelectionsEqual( state1.selection, state2.selection ) );\n}\n","import { User } from '@wordpress/core-data';\nimport { register, createReduxStore, StoreDescriptor } from '@wordpress/data';\n\nimport { NotificationType, sendNotification } from '@/utilities/notifications';\nimport { type SelectionState } from '@/utilities/selection';\nimport { areEditorStatesEqual, areUserInfosEqual, areUserStatesEqual } from '@/utilities/user';\n\nconst STORE_NAME = 'vip-real-time-collaboration/awareness';\n\nexport type WordPressUserInfo = Pick< User, 'id' | 'name' > & { avatarUrl?: string };\n\nexport interface UserState {\n\teditorState?: EditorState;\n\tuserInfo: UserInfo;\n}\n\nexport interface UserInfo extends WordPressUserInfo {\n\tclientId: number;\n\tbrowserType: string;\n\tcolor: string;\n\tisConnected: boolean;\n\tisMe: boolean;\n}\n\nexport interface EditorState {\n\tselection: SelectionState;\n}\n\nexport interface AwarenessStore {\n\tuserMap: Map< number, UserState >;\n}\n\ninterface PatchUserInfoAction {\n\ttype: 'PATCH_USER_INFO';\n\tpayload: { clientId: number; userInfo: Partial< UserInfo > };\n}\n\ninterface RemoveUserAction {\n\ttype: 'REMOVE_USER';\n\tpayload: { clientId: number };\n}\n\ninterface UpdateEditorStateAction {\n\ttype: 'UPDATE_EDITOR_STATE';\n\tpayload: { clientId: number; editorState: EditorState };\n}\n\ninterface UpsertUserAction {\n\ttype: 'UPSERT_USER';\n\tpayload: { clientId: number; userState: UserState };\n}\n\ntype AwarenessAction =\n\t| PatchUserInfoAction\n\t| RemoveUserAction\n\t| UpdateEditorStateAction\n\t| UpsertUserAction;\n\nconst DEFAULT_STATE: AwarenessStore = {\n\tuserMap: new Map< number, UserState >(),\n};\n\nconst actions = {\n\tpatchUserInfo: ( clientId: number, userInfo: Partial< UserInfo > ): AwarenessAction => ( {\n\t\ttype: 'PATCH_USER_INFO',\n\t\tpayload: { clientId, userInfo },\n\t} ),\n\n\t// Call when a user leaves the editor (after a delay)\n\tremoveUser: ( clientId: number ): AwarenessAction => ( {\n\t\ttype: 'REMOVE_USER',\n\t\tpayload: { clientId },\n\t} ),\n\n\tupdateEditorState: ( clientId: number, editorState: EditorState ): AwarenessAction => ( {\n\t\ttype: 'UPDATE_EDITOR_STATE',\n\t\tpayload: { clientId, editorState },\n\t} ),\n\n\tupsertUser: ( clientId: number, userState: UserState ): AwarenessAction => ( {\n\t\ttype: 'UPSERT_USER',\n\t\tpayload: { clientId, userState },\n\t} ),\n};\n\nconst reducer = ( state = DEFAULT_STATE, action: AwarenessAction ): AwarenessStore => {\n\tswitch ( action.type ) {\n\t\tcase 'PATCH_USER_INFO': {\n\t\t\tif ( ! state.userMap.has( action.payload.clientId ) ) {\n\t\t\t\treturn state;\n\t\t\t}\n\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n\t\t\tconst existingState = state.userMap.get( action.payload.clientId )!;\n\t\t\tconst updatedState = {\n\t\t\t\t...existingState,\n\t\t\t\tuserInfo: {\n\t\t\t\t\t...existingState.userInfo,\n\t\t\t\t\t...action.payload.userInfo,\n\t\t\t\t},\n\t\t\t};\n\n\t\t\tif ( areUserInfosEqual( existingState.userInfo, updatedState.userInfo ) ) {\n\t\t\t\t// No changes, don't update the state.\n\t\t\t\treturn state;\n\t\t\t}\n\n\t\t\tstate.userMap.set( action.payload.clientId, updatedState );\n\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tuserMap: new Map( state.userMap ),\n\t\t\t};\n\t\t}\n\n\t\tcase 'REMOVE_USER': {\n\t\t\tconst existingState = state.userMap.get( action.payload.clientId );\n\n\t\t\tif ( existingState?.userInfo ) {\n\t\t\t\tsendNotification( NotificationType.UserExited, existingState.userInfo );\n\t\t\t}\n\n\t\t\tstate.userMap.delete( action.payload.clientId );\n\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tuserMap: new Map( state.userMap ),\n\t\t\t};\n\t\t}\n\n\t\tcase 'UPDATE_EDITOR_STATE': {\n\t\t\tif ( ! state.userMap.has( action.payload.clientId ) ) {\n\t\t\t\treturn state;\n\t\t\t}\n\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n\t\t\tconst existingState = state.userMap.get( action.payload.clientId )!;\n\t\t\tconst updatedState = {\n\t\t\t\t...existingState,\n\t\t\t\teditorState: action.payload.editorState,\n\t\t\t};\n\n\t\t\tif ( areEditorStatesEqual( existingState.editorState, updatedState.editorState ) ) {\n\t\t\t\t// No changes, don't update the state.\n\t\t\t\treturn state;\n\t\t\t}\n\n\t\t\tstate.userMap.set( action.payload.clientId, updatedState );\n\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tuserMap: new Map( state.userMap ),\n\t\t\t};\n\t\t}\n\n\t\tcase 'UPSERT_USER': {\n\t\t\tif ( state.userMap.has( action.payload.clientId ) ) {\n\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n\t\t\t\tconst existingState = state.userMap.get( action.payload.clientId )!;\n\n\t\t\t\tif ( areUserStatesEqual( existingState, action.payload.userState ) ) {\n\t\t\t\t\t// No changes, don't update the state.\n\t\t\t\t\treturn state;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconst { userInfo } = action.payload.userState;\n\t\t\t\tsendNotification( NotificationType.UserEntered, userInfo );\n\t\t\t}\n\n\t\t\tstate.userMap.set( action.payload.clientId, action.payload.userState );\n\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tuserMap: new Map( state.userMap ),\n\t\t\t};\n\t\t}\n\n\t\tdefault:\n\t\t\treturn state;\n\t}\n};\n\nconst selectors = {\n\tgetActiveClientIds( state: AwarenessStore ): number[] {\n\t\treturn Array.from( state.userMap.keys() );\n\t},\n\tgetActiveUsers( state: AwarenessStore ): Map< number, UserState > {\n\t\treturn state.userMap;\n\t},\n\tisDisconnected( state: AwarenessStore ): boolean {\n\t\treturn (\n\t\t\tArray.from( selectors.getActiveUsers( state ).values() ).findIndex(\n\t\t\t\tuser => user.userInfo.isMe && false === user.userInfo.isConnected\n\t\t\t) !== -1\n\t\t);\n\t},\n};\n\nexport const store = createReduxStore( STORE_NAME, {\n\treducer,\n\tactions,\n\tselectors,\n} );\n\n( register as ( storeDescriptor: StoreDescriptor ) => void )( store );\n\nexport interface AwarenessStoreSelectors {\n\tgetActiveClientIds: () => number[];\n\tgetActiveUsers: () => Map< number, UserState >;\n\tisDisconnected: () => boolean;\n}\n","import { useSelect } from '@wordpress/data';\nimport { useMemo } from '@wordpress/element';\n\nimport {\n\tAwarenessStoreSelectors,\n\tUserState,\n\tstore as awarenessStore,\n} from '@/store/awareness-store';\n\n/**\n * Selects active users in the awareness store with the current user sorted to the front of the list.\n */\nexport function useSortedAwarenessUsers(): UserState[] {\n\tconst activeUsers = useSelect< AwarenessStoreSelectors, Map< number, UserState > >( select => {\n\t\treturn select( awarenessStore ).getActiveUsers();\n\t} );\n\n\treturn useMemo( () => {\n\t\treturn Array.from( activeUsers.values() ).sort( ( user1: UserState, user2: UserState ) => {\n\t\t\tif ( user1.userInfo.isMe && ! user2.userInfo.isMe ) {\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\tif ( ! user1.userInfo.isMe && user2.userInfo.isMe ) {\n\t\t\t\treturn 1;\n\t\t\t}\n\t\t\treturn 0;\n\t\t} );\n\t}, [ activeUsers ] );\n}\n","import { useSelect } from '@wordpress/data';\n\nimport { Avatar } from '@/components/avatar';\nimport { useSortedAwarenessUsers } from '@/hooks/use-sorted-awareness-users';\nimport {\n\tstore as rtcSettingsStore,\n\tSetting,\n\ttype SettingsStoreSelectors,\n} from '@/store/settings-store';\n\n/**\n * Renders a list of avatars for the active users, with a maximum of 3 visible avatars.\n */\nexport function Avatars() {\n\tconst activeUsers = useSortedAwarenessUsers();\n\tconst isSelfAwarenessEnabled = useSelect< SettingsStoreSelectors, boolean >(\n\t\tselect => select( rtcSettingsStore ).getSetting( Setting.SELF_AWARENESS ),\n\t\t[]\n\t);\n\n\tif ( activeUsers.length <= 1 && ! isSelfAwarenessEnabled ) {\n\t\t// Hide avatars when there's only one user.\n\t\t// This also avoids showing a single user when navigating away from the editor\n\t\t// after the connection is closed but before the page reloads.\n\t\treturn null;\n\t}\n\n\tconst visibleUsers = activeUsers.slice( 0, 3 );\n\tconst remainingUsers = activeUsers.slice( 3 );\n\tconst remainingUsersText = remainingUsers.map( ( { userInfo } ) => userInfo.name ).join( ', ' );\n\n\treturn visibleUsers.length > 1 ? (\n\t\t<>\n\t\t\t{ visibleUsers.map( userState => (\n\t\t\t\t<Avatar\n\t\t\t\t\tkey={ userState.userInfo.clientId }\n\t\t\t\t\tuserInfo={ userState.userInfo }\n\t\t\t\t\tshowUserColorBorder={ false }\n\t\t\t\t/>\n\t\t\t) ) }\n\n\t\t\t{ remainingUsers.length > 0 && (\n\t\t\t\t<div className=\"vip-real-time-collaboration-avatar-remaining\" title={ remainingUsersText }>\n\t\t\t\t\t+{ remainingUsers.length }\n\t\t\t\t</div>\n\t\t\t) }\n\t\t</>\n\t) : null;\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"wp\"][\"blocks\"];","import {\n\tstore as blockEditorStore,\n\ttype BlockEditorStoreSelectors,\n\ttype BlockEditorStoreActions,\n} from '@wordpress/block-editor';\nimport { createBlock } from '@wordpress/blocks';\nimport { useSelect, useDispatch } from '@wordpress/data';\nimport { useState, useEffect, useRef } from '@wordpress/element';\n\ninterface DebugToolsProps {\n\tiframeDocument: Document;\n}\n\nfunction findEditableElement(\n\tiframeDocument: Document,\n\ttargetBlockId: string\n): HTMLElement | null {\n\tconst blockElement = iframeDocument.querySelector( `[data-block=\"${ targetBlockId }\"]` );\n\n\tif ( blockElement && blockElement.getAttribute( 'contenteditable' ) === 'true' ) {\n\t\treturn blockElement as HTMLElement;\n\t}\n\n\treturn null;\n}\n\nfunction typeCharacter(\n\ttargetElement: HTMLElement,\n\tcharacter: string,\n\tiframeDocument: Document\n): void {\n\t// Because we're editing a contenteditable, we need to manually\n\t// insert actual text nodes to simulate typing.\n\tconst selection = iframeDocument.getSelection();\n\tif ( selection && selection.rangeCount > 0 ) {\n\t\tconst range = selection.getRangeAt( 0 );\n\t\trange.deleteContents();\n\t\tconst textNode = iframeDocument.createTextNode( character );\n\t\trange.insertNode( textNode );\n\t\trange.setStartAfter( textNode );\n\t\trange.setEndAfter( textNode );\n\t\tselection.removeAllRanges();\n\t\tselection.addRange( range );\n\t} else {\n\t\t// If no selection exists, fall back to end of element\n\t\tconst range = iframeDocument.createRange();\n\t\trange.selectNodeContents( targetElement );\n\t\trange.collapse( false );\n\t\tconst textNode = iframeDocument.createTextNode( character );\n\t\trange.insertNode( textNode );\n\t\trange.setStartAfter( textNode );\n\t\trange.setEndAfter( textNode );\n\t\tselection?.removeAllRanges();\n\t\tselection?.addRange( range );\n\t}\n}\n\nexport function DebugTools( { iframeDocument }: DebugToolsProps ) {\n\tconst [ isTyping, setIsTyping ] = useState( false );\n\tconst [ lastSelectedBlock, setLastSelectedBlock ] = useState< string | null >( null );\n\tconst [ typingSpeed, setTypingSpeed ] = useState< number >( 100 ); // Default 100ms per character\n\tconst typingIntervalRef = useRef< NodeJS.Timeout | null >( null );\n\n\tconst getSelectedBlockClientId = useSelect< BlockEditorStoreSelectors, () => string | null >(\n\t\tselect => select( blockEditorStore ).getSelectedBlockClientId\n\t);\n\tconst selectedBlockClientId = getSelectedBlockClientId();\n\n\tconst { selectBlock, insertBlock } = useDispatch< BlockEditorStoreActions >( blockEditorStore );\n\n\t// Keep track of the last selected block when it changes\n\tuseEffect( () => {\n\t\tif ( selectedBlockClientId && ! isTyping ) {\n\t\t\tsetLastSelectedBlock( selectedBlockClientId );\n\t\t}\n\t}, [ selectedBlockClientId, isTyping ] );\n\n\t// Helper function to ensure we have a block to type in\n\tconst ensureBlockExists = async (): Promise< string | null > => {\n\t\t// If we have a last selected block, use it\n\t\tif ( lastSelectedBlock ) {\n\t\t\treturn lastSelectedBlock;\n\t\t}\n\n\t\t// If we have a currently selected block, use it\n\t\tif ( selectedBlockClientId ) {\n\t\t\tsetLastSelectedBlock( selectedBlockClientId );\n\t\t\treturn selectedBlockClientId;\n\t\t}\n\n\t\t// Create a new paragraph block\n\t\tconst newBlock = createBlock( 'core/paragraph' );\n\t\tinsertBlock( newBlock );\n\n\t\t// The block should now be selected, so we can get its ID\n\t\t// We need to wait a tick for the selection to update\n\t\treturn new Promise( resolve => {\n\t\t\tsetTimeout( () => {\n\t\t\t\tconst currentSelection = getSelectedBlockClientId();\n\n\t\t\t\tif ( currentSelection ) {\n\t\t\t\t\tsetLastSelectedBlock( currentSelection );\n\t\t\t\t\tresolve( currentSelection );\n\t\t\t\t} else {\n\t\t\t\t\tresolve( null );\n\t\t\t\t}\n\t\t\t}, 10 );\n\t\t} );\n\t};\n\n\tconst startTypingInterval = ( targetBlockId: string ) => {\n\t\tlet charIndex = 0;\n\t\tlet currentLineIndex = 0;\n\t\tlet currentLine: string =\n\t\t\tloremIpsumLines[ Math.floor( Math.random() * loremIpsumLines.length ) ] || '';\n\n\t\t// Re-select the block when we start typing\n\t\tselectBlock( targetBlockId );\n\n\t\ttypingIntervalRef.current = setInterval( () => {\n\t\t\t// Find the editable element\n\t\t\tconst targetElement = findEditableElement( iframeDocument, targetBlockId );\n\n\t\t\tif ( ! targetElement ) {\n\t\t\t\tsetIsTyping( false );\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Focus the element if it's not already focused\n\t\t\tif ( iframeDocument.activeElement !== targetElement ) {\n\t\t\t\ttargetElement.focus();\n\t\t\t}\n\n\t\t\t// Get the next character from the current line\n\t\t\tlet nextChar = currentLine[ charIndex ];\n\n\t\t\t// If we've reached the end of the current line, pick a new random line\n\t\t\tif ( ! nextChar ) {\n\t\t\t\tcurrentLine = loremIpsumLines[ Math.floor( Math.random() * loremIpsumLines.length ) ] || '';\n\t\t\t\tcharIndex = 0;\n\t\t\t\tnextChar = currentLine[ charIndex ];\n\n\t\t\t\t// Add a space between sentences\n\t\t\t\tif ( currentLineIndex > 0 ) {\n\t\t\t\t\ttypeCharacter( targetElement, ' ', iframeDocument );\n\t\t\t\t}\n\t\t\t\tcurrentLineIndex++;\n\t\t\t}\n\n\t\t\tif ( ! nextChar ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Type the character\n\t\t\ttypeCharacter( targetElement, nextChar, iframeDocument );\n\t\t\tcharIndex++;\n\t\t}, typingSpeed );\n\t};\n\n\tuseEffect( () => {\n\t\tif ( isTyping ) {\n\t\t\t// Ensure we have a block to type in\n\t\t\tensureBlockExists()\n\t\t\t\t.then( targetBlockId => {\n\t\t\t\t\tif ( ! targetBlockId ) {\n\t\t\t\t\t\tsetIsTyping( false );\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tstartTypingInterval( targetBlockId );\n\t\t\t\t} )\n\t\t\t\t.catch( () => {\n\t\t\t\t\tsetIsTyping( false );\n\t\t\t\t} );\n\t\t} else if ( typingIntervalRef.current ) {\n\t\t\tclearInterval( typingIntervalRef.current );\n\t\t\ttypingIntervalRef.current = null;\n\t\t}\n\n\t\treturn () => {\n\t\t\tif ( typingIntervalRef.current ) {\n\t\t\t\tclearInterval( typingIntervalRef.current );\n\t\t\t}\n\t\t};\n\t}, [ isTyping, typingSpeed, iframeDocument, selectBlock, insertBlock ] );\n\n\tconst toggleTyping = () => {\n\t\tsetIsTyping( ! isTyping );\n\t};\n\n\tconst handleSpeedChange = ( event: React.ChangeEvent< HTMLInputElement > ) => {\n\t\tsetTypingSpeed( parseInt( event.target.value, 10 ) );\n\t};\n\n\tconst handleSpeedReset = () => {\n\t\tsetTypingSpeed( 100 );\n\t};\n\n\treturn (\n\t\t<div className=\"vip-real-time-collaboration-debug-interface\">\n\t\t\t<div className=\"vip-real-time-collaboration-debug-header\">Debug Tools</div>\n\t\t\t<button\n\t\t\t\ttype=\"button\"\n\t\t\t\tonClick={ toggleTyping }\n\t\t\t\tclassName=\"vip-real-time-collaboration-debug-reset\"\n\t\t\t>\n\t\t\t\t{ isTyping ? 'Stop typing' : 'Start typing' }\n\t\t\t</button>\n\t\t\t{ isTyping && (\n\t\t\t\t<div className=\"vip-real-time-collaboration-debug-speed\">\n\t\t\t\t\t<div className=\"vip-real-time-collaboration-debug-speed-header\">\n\t\t\t\t\t\t<span>Speed:</span>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"button\"\n\t\t\t\t\t\t\tonClick={ handleSpeedReset }\n\t\t\t\t\t\t\tclassName=\"vip-real-time-collaboration-debug-reset\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tReset\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t<input\n\t\t\t\t\t\ttype=\"range\"\n\t\t\t\t\t\tmin=\"20\"\n\t\t\t\t\t\tmax=\"1000\"\n\t\t\t\t\t\tvalue={ typingSpeed }\n\t\t\t\t\t\tonChange={ handleSpeedChange }\n\t\t\t\t\t\tclassName=\"vip-real-time-collaboration-debug-slider\"\n\t\t\t\t\t/>\n\t\t\t\t\t<div className=\"vip-real-time-collaboration-debug-speed-value\">\n\t\t\t\t\t\t{ typingSpeed }ms per character\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t) }\n\t\t</div>\n\t);\n}\n\nconst loremIpsumLines = [\n\t'Lorem ipsum dolor sit amet, consectetur adipiscing elit. ',\n\t'Suspendisse sem leo, gravida id nulla at, blandit laoreet risus. ',\n\t'Pellentesque velit justo, ullamcorper a ante nec, efficitur vulputate tortor. ',\n\t'Etiam sem dui, mollis vitae felis nec, sagittis facilisis libero. ',\n\t'Fusce justo tellus, consequat id enim eu, lacinia euismod lorem. ',\n\t'Donec faucibus varius aliquam. ',\n\t'Maecenas sit amet nisl ac sem pulvinar consequat vel a metus. ',\n\t'Suspendisse potenti. ',\n\t'Morbi blandit, enim vitae blandit malesuada, enim lorem accumsan nibh, nec maximus tellus quam vitae dui. ',\n\t'Curabitur lacinia, lectus et eleifend pretium, leo ante tincidunt quam, nec cursus tellus sem id odio. ',\n\t'Morbi eget nisl ligula. ',\n\t'Proin eget neque eget felis interdum dignissim. ',\n\t'Ut justo augue, accumsan eu efficitur et, placerat non ex. ',\n\t'Nullam id gravida risus. ',\n\t'Etiam vitae tortor vel nisl imperdiet mollis sed quis tortor. ',\n\t'Donec velit quam, elementum eu nibh in, convallis vehicula erat. ',\n\t'Sed viverra accumsan justo, eu egestas quam vehicula non. ',\n\t'Cras egestas consequat erat, ut laoreet massa ornare ut. ',\n\t'Vivamus vitae consequat arcu. ',\n\t'In at mollis libero, quis convallis elit. ',\n\t'Mauris bibendum mauris odio, et condimentum nisi convallis eu. ',\n\t'Mauris pharetra metus id laoreet tempor. ',\n\t'Sed gravida massa quis risus laoreet iaculis. ',\n\t'Donec non eros gravida nisl sodales porta. ',\n\t'Nullam a pellentesque tortor. ',\n\t'Curabitur rhoncus consectetur mauris ut ornare. ',\n\t'Vestibulum quis posuere enim. ',\n\t'Fusce id orci pharetra enim vestibulum imperdiet et ut nunc. ',\n\t'Mauris tempus arcu et est aliquet, sit amet tincidunt felis ultricies. ',\n\t'Curabitur in lorem lorem. ',\n];\n","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"wp\"][\"primitives\"];","/**\n * WordPress dependencies\n */\nimport { SVG, Path } from '@wordpress/primitives';\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nconst error = /*#__PURE__*/_jsx(SVG, {\n  viewBox: \"0 0 24 24\",\n  xmlns: \"http://www.w3.org/2000/svg\",\n  children: /*#__PURE__*/_jsx(Path, {\n    fillRule: \"evenodd\",\n    clipRule: \"evenodd\",\n    d: \"M12.218 5.377a.25.25 0 0 0-.436 0l-7.29 12.96a.25.25 0 0 0 .218.373h14.58a.25.25 0 0 0 .218-.372l-7.29-12.96Zm-1.743-.735c.669-1.19 2.381-1.19 3.05 0l7.29 12.96a1.75 1.75 0 0 1-1.525 2.608H4.71a1.75 1.75 0 0 1-1.525-2.608l7.29-12.96ZM12.75 17.46h-1.5v-1.5h1.5v1.5Zm-1.5-3h1.5v-5h-1.5v5Z\"\n  })\n});\nexport default error;\n//# sourceMappingURL=error.js.map","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"wp\"][\"compose\"];","import {\n\tModal,\n\tButton,\n\t__experimentalHStack as HStack,\n\t__experimentalVStack as VStack,\n\tIcon,\n} from '@wordpress/components';\nimport { __ } from '@wordpress/i18n';\nimport { error } from '@wordpress/icons';\n\nimport { useCopyPostContentToClipboard } from '@/hooks/use-copy-post-content-to-clipboard';\nimport { useIsDisconnected } from '@/hooks/use-is-disconnected';\nimport '@/components/post-locked-modal.scss';\n\nexport function PostLockedModal() {\n\tconst buttonRef = useCopyPostContentToClipboard();\n\tconst isDisconnected = useIsDisconnected();\n\n\tif ( ! isDisconnected ) {\n\t\treturn null;\n\t}\n\n\treturn (\n\t\t<Modal\n\t\t\t__experimentalHideHeader={ true }\n\t\t\ticon={ error }\n\t\t\tisDismissible={ false }\n\t\t\tisFullScreen={ false }\n\t\t\tonRequestClose={ () => {} }\n\t\t\tshouldCloseOnClickOutside={ false }\n\t\t\tshouldCloseOnEsc={ false }\n\t\t>\n\t\t\t<div className=\"vip-rtc-post-locked-modal__container\">\n\t\t\t\t<VStack alignment=\"center\" justify=\"center\" spacing={ 2 }>\n\t\t\t\t\t<Icon fill=\"#ccc\" icon={ error } size={ 64 } />\n\t\t\t\t\t<h1>{ __( 'Disconnected', 'vip-real-time-collaboration' ) }</h1>\n\t\t\t\t\t<p className=\"vip-rtc-post-locked-modal__p\">\n\t\t\t\t\t\t{ __(\n\t\t\t\t\t\t\t'You are currently disconnected from the collaborative editing server.',\n\t\t\t\t\t\t\t'vip-real-time-collaboration'\n\t\t\t\t\t\t) }{ ' ' }\n\t\t\t\t\t\t{ __(\n\t\t\t\t\t\t\t'Editing is temporarily disabled to prevent conflicts with other users.',\n\t\t\t\t\t\t\t'vip-real-time-collaboration'\n\t\t\t\t\t\t) }\n\t\t\t\t\t</p>\n\t\t\t\t\t<HStack spacing={ 2 } justify=\"center\">\n\t\t\t\t\t\t<Button ref={ buttonRef } variant=\"primary\">\n\t\t\t\t\t\t\t{ __( 'Copy post content', 'vip-real-time-collaboration' ) }\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t\t<Button href=\"edit.php\" isDestructive={ true } variant=\"secondary\">\n\t\t\t\t\t\t\t{ __( 'Edit another post', 'vip-real-time-collaboration' ) }\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</HStack>\n\t\t\t\t</VStack>\n\t\t\t</div>\n\t\t</Modal>\n\t);\n}\n","import { useCopyToClipboard } from '@wordpress/compose';\nimport { useSelect } from '@wordpress/data';\nimport { type EditorStoreSelectors, store as editorStore } from '@wordpress/editor';\n\nexport function useCopyPostContentToClipboard( onSuccess: () => void = () => {} ) {\n\tconst postContent = useSelect< EditorStoreSelectors, string | null >( select => {\n\t\tconst { getEditedPostContent } = select( editorStore );\n\t\treturn getEditedPostContent();\n\t} );\n\n\treturn useCopyToClipboard( postContent ?? '', onSuccess );\n}\n","import { useSelect } from '@wordpress/data';\nimport { useEffect, useRef, useState } from '@wordpress/element';\n\nimport { AwarenessStoreSelectors, store as awarenessStore } from '@/store/awareness-store';\nimport { DISCONNECTED_THRESHOLD_IN_MS } from '@/utilities/config';\n\nexport function useIsDisconnected(): boolean {\n\tconst [ disconnectedPastThreshold, setDisconnectedPastThreshold ] = useState< boolean >( false );\n\tconst timeoutRef = useRef< NodeJS.Timeout | null >( null );\n\n\tconst isDisconnected = useSelect< AwarenessStoreSelectors, boolean >( select => {\n\t\treturn select( awarenessStore ).isDisconnected();\n\t} );\n\n\tuseEffect( () => {\n\t\tif ( isDisconnected ) {\n\t\t\ttimeoutRef.current = setTimeout( () => {\n\t\t\t\tsetDisconnectedPastThreshold( true );\n\t\t\t}, DISCONNECTED_THRESHOLD_IN_MS );\n\t\t} else {\n\t\t\tsetDisconnectedPastThreshold( false );\n\t\t\tclearTimeout( timeoutRef.current ?? undefined );\n\t\t}\n\n\t\treturn () => clearTimeout( timeoutRef.current ?? undefined );\n\t}, [ isDisconnected ] );\n\n\treturn disconnectedPastThreshold;\n}\n","import { useSelect } from '@wordpress/data';\nimport { useEffect, useRef } from '@wordpress/element';\n\nimport {\n\tstore as rtcSettingsStore,\n\tSetting,\n\tSettingsStoreSelectors,\n} from '../store/settings-store';\nimport {\n\tAwarenessStoreSelectors,\n\tUserState,\n\tstore as awarenessStore,\n} from '@/store/awareness-store';\nimport { SelectionType, type SelectionWholeBlock } from '@/utilities/selection';\n\n/**\n * Custom hook for highlighting selected blocks in the editor\n * @param blockEditorDocument - Ref to the block editor document, used to directly style block elements.\n */\nexport function useBlockHighlighting( blockEditorDocument: Document | null ) {\n\tconst highlightedBlockIds = useRef< Set< string > >( new Set() );\n\tconst userStates = useSelect< AwarenessStoreSelectors, UserState[] >( select => {\n\t\treturn Array.from( select( awarenessStore ).getActiveUsers().values() );\n\t} );\n\n\tconst { isAwarenessCursorsEnabled, isSelfAwarenessEnabled } = useSelect<\n\t\tSettingsStoreSelectors,\n\t\t{ isAwarenessCursorsEnabled: boolean; isSelfAwarenessEnabled: boolean }\n\t>( select => {\n\t\tconst { getSetting } = select( rtcSettingsStore );\n\t\treturn {\n\t\t\tisAwarenessCursorsEnabled: getSetting( Setting.AWARENESS_CURSORS ),\n\t\t\tisSelfAwarenessEnabled: getSetting( Setting.SELF_AWARENESS ),\n\t\t};\n\t}, [] );\n\n\t// Draw block highlights\n\tuseEffect( () => {\n\t\t// Don't do anything if editor is not rendered yet.\n\t\tif ( blockEditorDocument === null ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst unhighlightBlocks = ( blockIds: string[] ) => {\n\t\t\tblockIds.forEach( blockId => {\n\t\t\t\tconst blockElement = getBlockElementById( blockEditorDocument, blockId );\n\n\t\t\t\tif ( blockElement ) {\n\t\t\t\t\tblockElement.style.boxShadow = '';\n\t\t\t\t\tblockElement.style.borderRadius = '';\n\t\t\t\t}\n\n\t\t\t\thighlightedBlockIds.current.delete( blockId );\n\t\t\t} );\n\t\t};\n\n\t\tconst blocksToHighlight = userStates\n\t\t\t.map( userState => {\n\t\t\t\tconst isWholeBlockSelected =\n\t\t\t\t\tuserState.editorState?.selection?.type === SelectionType.WholeBlock;\n\t\t\t\tconst shouldDrawUser = userState.userInfo.isMe ? isSelfAwarenessEnabled : true;\n\n\t\t\t\tif ( isWholeBlockSelected && shouldDrawUser ) {\n\t\t\t\t\tconst selection = userState.editorState?.selection as SelectionWholeBlock;\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tblockId: selection.blockId,\n\t\t\t\t\t\tcolor: userState.userInfo.color,\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t} )\n\t\t\t.filter( block => block !== null );\n\n\t\tif ( ! isAwarenessCursorsEnabled ) {\n\t\t\t// If the overlay is disabled, remove all highlights.\n\t\t\tunhighlightBlocks( Array.from( highlightedBlockIds.current ) );\n\t\t\treturn;\n\t\t}\n\n\t\t// Unhighlight blocks that are no longer highlighted.\n\t\tconst selectedBlockIds = blocksToHighlight.map( block => block.blockId );\n\t\tconst blocksIdsToUnhighlight = Array.from( highlightedBlockIds.current ).filter(\n\t\t\tblockId => ! selectedBlockIds.includes( blockId )\n\t\t);\n\n\t\tunhighlightBlocks( blocksIdsToUnhighlight );\n\n\t\t// Highlight blocks that are currently highlighted.\n\t\tblocksToHighlight.forEach( blockColorPair => {\n\t\t\tconst { color, blockId } = blockColorPair;\n\t\t\tconst blockElement = getBlockElementById( blockEditorDocument, blockId );\n\n\t\t\tif ( ! blockElement ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif ( blockElement ) {\n\t\t\t\tblockElement.style.boxShadow = `${ color } 0 0 0 2px`;\n\t\t\t\tblockElement.style.borderRadius = '4px';\n\t\t\t\thighlightedBlockIds.current.add( blockId );\n\t\t\t}\n\t\t} );\n\t}, [ userStates, isAwarenessCursorsEnabled, isSelfAwarenessEnabled, blockEditorDocument ] );\n}\n\nconst getBlockElementById = (\n\tblockEditorDocument: Document,\n\tblockId: string\n): HTMLElement | null => {\n\treturn blockEditorDocument.querySelector( `[data-block=\"${ blockId }\"]` );\n};\n","export function getBrowserName() {\n\tconst userAgent = window.navigator.userAgent;\n\tlet browserName = 'Unknown';\n\n\tif ( userAgent.includes( 'Firefox' ) ) {\n\t\tbrowserName = 'Firefox';\n\t} else if ( userAgent.includes( 'Edg' ) ) {\n\t\tbrowserName = 'Microsoft Edge';\n\t} else if ( userAgent.includes( 'Chrome' ) && ! userAgent.includes( 'Edg' ) ) {\n\t\tbrowserName = 'Chrome';\n\t} else if ( userAgent.includes( 'Safari' ) && ! userAgent.includes( 'Chrome' ) ) {\n\t\tbrowserName = 'Safari';\n\t} else if ( userAgent.includes( 'MSIE' ) || userAgent.includes( 'Trident' ) ) {\n\t\tbrowserName = 'Internet Explorer';\n\t} else if ( userAgent.includes( 'Opera' ) || userAgent.includes( 'OPR' ) ) {\n\t\tbrowserName = 'Opera';\n\t}\n\n\treturn browserName;\n}\n","import { store as coreStore } from '@wordpress/core-data';\nimport { select } from '@wordpress/data';\n\nimport type { WordPressUserInfo } from '@/store/awareness-store';\n\nexport async function getCurrentUserInfo(): Promise< WordPressUserInfo > {\n\tconst { avatar_urls: avatarUrls, id, name, slug } = select( coreStore ).getCurrentUser() ?? {};\n\n\tif ( ! id ) {\n\t\t// getCurrentUser() returns an empty user object for a short time after load.\n\t\t// In that case, wait and try again.\n\t\tawait new Promise( resolve => setTimeout( resolve, 100 ) );\n\t\treturn await getCurrentUserInfo();\n\t}\n\tconst avatarUrl = avatarUrls?.[ 24 ] || avatarUrls?.[ 48 ] || avatarUrls?.[ 96 ];\n\n\treturn { avatarUrl, id, name: name ?? slug };\n}\n","import { loadFromLocalStorage, saveToLocalStorage } from './local-storage';\n\n// From Material UI's metro colors\n// https://materialui.co/metrocolors\nconst METRO_COLORS = [\n\t'#A4C400',\n\t'#60A917',\n\t'#008A00',\n\t'#00ABA9',\n\t'#1BA1E2',\n\t'#0050EF',\n\t'#6A00FF',\n\t'#AA00FF',\n\t'#F472D0',\n\t'#D80073',\n\t'#A20025',\n\t'#E51400',\n\t'#FA6800',\n\t'#F0A30A',\n\t'#E3C800',\n\t// '#825A2C', (Brown)\n\t// '#6D8764', (Olive)\n\t'#647687',\n\t// '#76608A', (Mauve)\n\t// '#A0522D', (Sienna)\n];\n\nconst USER_HIGHLIGHT_ALPHA = 0.7; // 0-1.0 to represent opacity\nconst LOCAL_STORAGE_KEY = 'vip-rtc-preferred-color';\n\n/**\n * Get a unique user color from the list of available metro colors, or generate a random color if none are available.\n * If the previously used color is available from localStorage, use it.\n *\n * @param existingColors - Colors that are already in use.\n * @returns The new user color, in #RGBA or HSL format.\n */\nconst getNewUserColor = ( existingColors: string[] ) => {\n\t// Remove the alpha value from the colors.\n\texistingColors = existingColors.map( color => color.slice( 0, -2 ) );\n\tconst availableColors = METRO_COLORS.filter( color => ! existingColors.includes( color ) );\n\n\tif ( availableColors.length === 0 ) {\n\t\t// If all colors are used, generate one at random\n\t\tconst hue = generateRandomInt( 0, 360 );\n\t\tconst saturation = generateRandomInt( 50, 100 );\n\t\tconst lightness = generateRandomInt( 45, 95 );\n\t\treturn `hsla(${ hue }, ${ saturation }%, ${ lightness }%, ${ USER_HIGHLIGHT_ALPHA })`;\n\t}\n\n\tlet hexColor = null;\n\n\tconst preferredColor = loadFromLocalStorage< string | null >( LOCAL_STORAGE_KEY, null );\n\n\tif ( preferredColor && availableColors.includes( preferredColor ) ) {\n\t\thexColor = preferredColor;\n\t} else {\n\t\tconst randomIndex = generateRandomInt( 0, availableColors.length - 1 );\n\t\thexColor = availableColors[ `${ randomIndex }` ];\n\t\tsaveToLocalStorage( LOCAL_STORAGE_KEY, hexColor );\n\t}\n\n\t// Convert alpha to hex value between 00 and FF, e.g. 0.7 -> 'B3'\n\tconst alphaHex = Math.round( USER_HIGHLIGHT_ALPHA * 0xff )\n\t\t.toString( 16 )\n\t\t.padStart( 2, '0' )\n\t\t.toUpperCase();\n\n\treturn `${ hexColor }${ alphaHex }`;\n};\n\n/**\n * Generate a random integer between min and max, inclusive.\n *\n * @param min - The minimum value.\n * @param max - The maximum value.\n * @returns A random integer between min and max.\n */\nconst generateRandomInt = ( min: number, max: number ) => {\n\treturn Math.floor( Math.random() * ( max - min + 1 ) ) + min;\n};\n\nexport { getNewUserColor };\n","import { useSelect } from '@wordpress/data';\nimport { useEffect, useRef } from '@wordpress/element';\n\nimport { AwarenessManager } from '@/awareness-manager';\nimport { useSortedAwarenessUsers } from '@/hooks/use-sorted-awareness-users';\nimport { store as rtcSettingsStore, Setting, SettingsStoreSelectors } from '@/store/settings-store';\nimport { Logger } from '@/utilities/logger';\nimport { type SelectionCursor, type SelectionState, SelectionType } from '@/utilities/selection';\n\nimport type { MutableRefObject } from 'react';\n\nenum DrawType {\n\tNone,\n\tOtherUsers,\n\tAll,\n}\n\nconst logger = new Logger( 'use-render-cursors' );\n\n/**\n * Custom hook for rendering cursors for each user in the editor.\n * @param overlayRef - The ref to the overlay element\n * @param blockEditorDocument - The block editor document\n * @returns A ref to the render function. Can be used by parent to trigger a re-render.\n */\nexport function useRenderCursors(\n\toverlayRef: MutableRefObject< HTMLElement | null >,\n\tblockEditorDocument: Document | null\n) {\n\tconst renderCursorsRef = useRef< () => void >();\n\n\tconst drawType = useSelect< SettingsStoreSelectors, DrawType >( select => {\n\t\tconst { getSetting } = select( rtcSettingsStore );\n\t\tif ( getSetting( Setting.AWARENESS_CURSORS ) ) {\n\t\t\tif ( getSetting( Setting.SELF_AWARENESS ) ) {\n\t\t\t\treturn DrawType.All;\n\t\t\t}\n\n\t\t\treturn DrawType.OtherUsers;\n\t\t}\n\n\t\treturn DrawType.None;\n\t}, [] );\n\n\tconst sortedUsers = useSortedAwarenessUsers();\n\n\t// Draw user cursors in the overlay.\n\tuseEffect( () => {\n\t\trenderCursorsRef.current = () => {\n\t\t\tconst userSelections = sortedUsers.map( user => ( {\n\t\t\t\tuserName: user.userInfo.name,\n\t\t\t\t// Replace local user's selection with the current selection from the editor state.\n\t\t\t\tselection: user.editorState?.selection ?? { type: SelectionType.None },\n\t\t\t\tcolor: user.userInfo.color,\n\t\t\t\tisMe: user.userInfo.isMe,\n\t\t\t} ) );\n\n\t\t\tdrawUserSelections( overlayRef.current, blockEditorDocument, userSelections, drawType );\n\t\t};\n\n\t\t// Render cursors immediately when data changes\n\t\trenderCursorsRef.current();\n\t}, [ drawType, sortedUsers, overlayRef.current, blockEditorDocument ] );\n\n\treturn renderCursorsRef;\n}\n\n/**\n * Draws user selections on the overlay.\n *\n * @param overlay - The overlay element\n * @param editorDocument - The editor document\n * @param userSelections - The user selections\n */\nconst drawUserSelections = (\n\toverlay: HTMLElement | null,\n\teditorDocument: Document | null,\n\tuserSelections: { userName: string; selection: SelectionState; color: string; isMe: boolean }[],\n\tdrawType: DrawType\n) => {\n\tif ( ! overlay || ! editorDocument ) {\n\t\treturn;\n\t}\n\n\t// Clear up previous state\n\tconst userContainers = overlay.querySelectorAll( '.vip-real-time-collaboration-user' );\n\tuserContainers.forEach( container => {\n\t\tcontainer.remove();\n\t} );\n\n\tif ( drawType === DrawType.None ) {\n\t\treturn;\n\t}\n\n\t// Draw cursors\n\tuserSelections.forEach( ( { userName, selection, color, isMe } ) => {\n\t\tif ( isMe && drawType === DrawType.OtherUsers ) {\n\t\t\t// Skip drawing the local user's cursor.\n\t\t\treturn;\n\t\t}\n\n\t\tlet coords: { x: number; y: number; height: number } | null = null;\n\n\t\tif ( selection.type === SelectionType.None ) {\n\t\t\t// Nothing selected.\n\t\t} else if ( selection.type === SelectionType.WholeBlock ) {\n\t\t\t// Don't draw a cursor for a whole block selection.\n\t\t} else if ( selection.type === SelectionType.Cursor ) {\n\t\t\tcoords = getCursorPosition( selection, editorDocument, overlay );\n\t\t} else if ( selection.type === SelectionType.SelectionInOneBlock ) {\n\t\t\t// Until selection logic is implemented, render a selection as a cursor at the beginning of the selection.\n\t\t\tconst selectionAsCursor: SelectionCursor = {\n\t\t\t\ttype: SelectionType.Cursor,\n\t\t\t\tblockId: selection.blockId,\n\t\t\t\tcursorPosition: selection.cursorStartPosition,\n\t\t\t};\n\n\t\t\tcoords = getCursorPosition( selectionAsCursor, editorDocument, overlay );\n\t\t} else if ( selection.type === SelectionType.SelectionInMultipleBlocks ) {\n\t\t\t// Until selection logic is implemented, render a selection as a cursor at the beginning of the selection.\n\t\t\tconst selectionAsCursor: SelectionCursor = {\n\t\t\t\ttype: SelectionType.Cursor,\n\t\t\t\tblockId: selection.blockStartId,\n\t\t\t\tcursorPosition: selection.cursorStartPosition,\n\t\t\t};\n\n\t\t\tcoords = getCursorPosition( selectionAsCursor, editorDocument, overlay );\n\t\t}\n\n\t\tif ( coords ) {\n\t\t\t// Create parent container\n\t\t\t// Use `document` instead of `editorDocument` because the overlay is in the parent document.\n\t\t\tconst userContainer = document.createElement( 'div' );\n\t\t\tuserContainer.className = 'vip-real-time-collaboration-user';\n\t\t\tuserContainer.style.left = `${ coords.x }px`;\n\t\t\tuserContainer.style.top = `${ coords.y }px`;\n\n\t\t\t// Create cursor element\n\t\t\tconst cursor = document.createElement( 'div' );\n\t\t\tcursor.className = 'vip-real-time-collaboration-user-cursor';\n\t\t\tcursor.style.backgroundColor = color;\n\t\t\tcursor.style.height = `${ coords.height }px`;\n\n\t\t\t// Create label\n\t\t\tconst label = document.createElement( 'div' );\n\t\t\tlabel.className = 'vip-real-time-collaboration-user-label';\n\t\t\tlabel.textContent = userName;\n\t\t\tlabel.style.backgroundColor = color;\n\n\t\t\t// Append cursor and label to the container\n\t\t\tuserContainer.appendChild( cursor );\n\t\t\tuserContainer.appendChild( label );\n\n\t\t\toverlay.appendChild( userContainer );\n\t\t}\n\t} );\n};\n\n/**\n * Given a selection, returns the coordinates of the cursor in the block.\n *\n * @param selection - The selection\n * @param editorDocument - The editor document\n * @param overlay - The overlay element\n * @returns The position of the cursor\n */\nconst getCursorPosition = (\n\tselection: SelectionCursor,\n\teditorDocument: Document,\n\toverlay: HTMLElement\n): { x: number; y: number; height: number } | null => {\n\tconst absolutePosition = AwarenessManager.convertRelativePositionToAbsolutePosition(\n\t\tselection.cursorPosition.relativePosition\n\t);\n\n\tif ( absolutePosition === null ) {\n\t\t// An absolute position can be null if a cursor was set in a block that\n\t\t// has since been deleted.\n\t\t// Return null so we don't try to draw it.\n\t\treturn null;\n\t}\n\n\tconst blockElement = editorDocument.querySelector(\n\t\t`[data-block=\"${ selection.blockId }\"]`\n\t) as HTMLElement;\n\n\tif ( ! blockElement ) {\n\t\treturn null;\n\t}\n\n\tconst coords = getOffsetPositionInBlock(\n\t\tblockElement,\n\t\tabsolutePosition.index,\n\t\teditorDocument,\n\t\toverlay\n\t);\n\n\treturn coords ?? null;\n};\n\n/**\n * Given a block element and a character offset, returns the coordinates for drawing a visual cursor in the block.\n *\n * @param blockElement - The block element\n * @param charOffset - The character offset\n * @param editorDocument - The editor document\n * @param overlay - The overlay element\n * @returns The position of the cursor\n */\nconst getOffsetPositionInBlock = (\n\tblockElement: HTMLElement,\n\tcharOffset: number,\n\teditorDocument: Document,\n\toverlay: HTMLElement\n) => {\n\tconst { node, offset } = findInnerBlockOffset( blockElement, charOffset, editorDocument );\n\n\tconst cursorRange = editorDocument.createRange();\n\n\ttry {\n\t\tcursorRange.setStart( node, offset );\n\t} catch ( error ) {\n\t\tlogger.error( 'Failed to create a range for cursor:', { error, node, offset } );\n\t\treturn null;\n\t}\n\n\t// Ensure the range only represents single point in the DOM.\n\tcursorRange.collapse( true );\n\n\tconst cursorRect = cursorRange.getBoundingClientRect();\n\tconst overlayRect = overlay.getBoundingClientRect();\n\tconst blockRect = blockElement.getBoundingClientRect();\n\n\tlet cursorX = 0;\n\tlet cursorY = 0;\n\n\tif (\n\t\tcursorRect.x === 0 &&\n\t\tcursorRect.y === 0 &&\n\t\tcursorRect.width === 0 &&\n\t\tcursorRect.height === 0\n\t) {\n\t\t// This can happen for empty blocks.\n\t\tcursorX = blockRect.left - overlayRect.left;\n\t\tcursorY = blockRect.top - overlayRect.top;\n\t} else {\n\t\tcursorX = cursorRect.left - overlayRect.left;\n\t\tcursorY = cursorRect.top - overlayRect.top;\n\t}\n\n\tlet cursorHeight = cursorRect.height;\n\tif ( cursorHeight === 0 ) {\n\t\tcursorHeight =\n\t\t\tparseInt( window.getComputedStyle( blockElement ).lineHeight, 10 ) || blockRect.height;\n\t}\n\n\treturn {\n\t\tx: cursorX,\n\t\ty: cursorY,\n\t\theight: cursorHeight,\n\t};\n};\n\nconst MAX_NODE_OFFSET_COUNT = 1000;\n\n/**\n * Given a block element and a character offset, returns an exact inner node and offset for use in a range.\n *\n * @param blockElement - The block element\n * @param offset - The character offset\n * @param editorDocument - The editor document\n * @returns The node and offset of the character at the offset\n */\nconst findInnerBlockOffset = (\n\tblockElement: HTMLElement,\n\toffset: number,\n\teditorDocument: Document\n) => {\n\tconst treeWalker = editorDocument.createTreeWalker(\n\t\tblockElement,\n\t\tNodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT // eslint-disable-line no-bitwise\n\t);\n\n\tlet currentOffset = 0;\n\tlet lastTextNode: Node | null = null;\n\n\tlet node: Node | null = null;\n\tlet nodeCount = 1;\n\n\twhile ( ( node = treeWalker.nextNode() ) ) {\n\t\tnodeCount++;\n\n\t\tif ( nodeCount > MAX_NODE_OFFSET_COUNT ) {\n\t\t\t// If we've walked too many nodes, return the last text node or the beginning of the block.\n\t\t\tif ( lastTextNode ) {\n\t\t\t\treturn { node: lastTextNode, offset: 0 };\n\t\t\t}\n\t\t\treturn { node: blockElement, offset: 0 };\n\t\t}\n\n\t\tconst nodeLength = node.nodeValue?.length ?? 0;\n\n\t\tif ( node.nodeType === Node.ELEMENT_NODE ) {\n\t\t\tif ( node.nodeName === 'BR' ) {\n\t\t\t\t// Treat <br> as a single \"\\n\" character.\n\n\t\t\t\tif ( currentOffset + 1 >= offset ) {\n\t\t\t\t\t// If the <br> occurs right on the target offset, return the next text node.\n\t\t\t\t\tconst nodeAfterBr = treeWalker.nextNode();\n\n\t\t\t\t\tif ( nodeAfterBr?.nodeType === Node.TEXT_NODE ) {\n\t\t\t\t\t\treturn { node: nodeAfterBr, offset: 0 };\n\t\t\t\t\t} else if ( lastTextNode ) {\n\t\t\t\t\t\t// If there's no text node after the <br>, return the end offset of the last text node.\n\t\t\t\t\t\treturn { node: lastTextNode, offset: lastTextNode.nodeValue?.length ?? 0 };\n\t\t\t\t\t}\n\t\t\t\t\t// Just in case, if there's no last text node, return the beginning of the block.\n\t\t\t\t\treturn { node: blockElement, offset: 0 };\n\t\t\t\t}\n\n\t\t\t\t// The <br> is before the target offset. Count it as a single character.\n\t\t\t\tcurrentOffset += 1;\n\t\t\t\tcontinue;\n\t\t\t} else {\n\t\t\t\t// Skip other element types.\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\n\t\tif ( nodeLength === 0 ) {\n\t\t\t// Skip empty nodes.\n\t\t\tcontinue;\n\t\t}\n\n\t\tif ( currentOffset + nodeLength >= offset ) {\n\t\t\t// This node exceeds the target offset. Return the node and the position of the offset within it.\n\t\t\treturn { node, offset: offset - currentOffset };\n\t\t}\n\n\t\tcurrentOffset += nodeLength;\n\n\t\tif ( node.nodeType === Node.TEXT_NODE ) {\n\t\t\tlastTextNode = node;\n\t\t}\n\t}\n\n\tif ( lastTextNode && lastTextNode.nodeValue?.length ) {\n\t\t// We didn't reach the target offset. Return the last text node's last character.\n\t\treturn { node: lastTextNode, offset: lastTextNode.nodeValue.length };\n\t}\n\n\t// We didn't find any text nodes. Return the beginning of the block.\n\treturn { node: blockElement, offset: 0 };\n};\n","/**\n * External dependencies\n */\nimport { type BlockEditorStoreSelectors, store as blockEditorStore } from '@wordpress/block-editor';\nimport { dispatch, select, subscribe } from '@wordpress/data';\nimport { WPBlockSelection } from '@wordpress/editor/build-types/store/selectors';\nimport * as Y from 'yjs';\n\n/**\n * Internal dependencies\n */\nimport {\n\ttype UserInfo,\n\ttype UserState,\n\ttype WordPressUserInfo,\n\tstore as awarenessStore,\n} from '@/store/awareness-store';\nimport { getBrowserName } from '@/utilities/browser';\nimport {\n\tAWARENESS_CURSOR_UPDATE_DEBOUNCE_IN_MS,\n\tLOCAL_CURSOR_UPDATE_DEBOUNCE_IN_MS,\n\tREMOVAL_DELAY_IN_MS,\n} from '@/utilities/config';\nimport { getCurrentUserInfo } from '@/utilities/entity';\nimport { Logger } from '@/utilities/logger';\nimport { NotificationType, sendNotification } from '@/utilities/notifications';\nimport {\n\tgetSelectionState,\n\tSelectableBlock,\n\tupdateSelectionInEntityRecord,\n} from '@/utilities/selection';\nimport { getNewUserColor } from '@/utilities/user-color';\n\nimport type { Awareness } from 'y-protocols/awareness';\n\ntype AwarenessClientID = number;\n\ninterface AwarenessStateChange {\n\tadded: AwarenessClientID[];\n\tupdated: AwarenessClientID[];\n\tremoved: AwarenessClientID[];\n}\n\nexport class AwarenessManager {\n\tprivate static __instance: AwarenessManager;\n\tprivate logger: Logger = new Logger( 'awareness-manager' );\n\n\tprivate constructor( private awareness: Awareness, private userInfo: WordPressUserInfo ) {\n\t\tthis.setCurrentUserState();\n\t\tthis.refreshAwareness();\n\t\tthis.subscribeToCRDTChanges();\n\t\tthis.subscribeToSelectionChanges();\n\t\tthis.subscribeToUserChanges();\n\t}\n\n\tpublic static async initialize( awareness: Awareness ): Promise< void > {\n\t\tif ( AwarenessManager.__instance ) {\n\t\t\tAwarenessManager.__instance.logger.error(\n\t\t\t\t`AwarenessManager was created more than once for client ID ${ awareness.clientID }.`\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\tAwarenessManager.__instance = new AwarenessManager( awareness, await getCurrentUserInfo() );\n\t}\n\n\tpublic static setConnectionStatus( clientId: number, isConnected: boolean ): void {\n\t\tif ( clientId !== AwarenessManager.__instance?.awareness.clientID ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst { patchUserInfo } = dispatch( awarenessStore );\n\t\tvoid patchUserInfo( clientId, { isConnected } );\n\t}\n\n\tpublic static convertRelativePositionToAbsolutePosition(\n\t\tposition: Y.RelativePosition\n\t): Y.AbsolutePosition | null {\n\t\tif ( ! AwarenessManager.__instance?.awareness?.doc ) {\n\t\t\tconsole.error( 'convertRelativePositionToAbsolutePosition() awareness document not found' );\n\t\t\treturn null;\n\t\t}\n\n\t\treturn Y.createAbsolutePositionFromRelativePosition(\n\t\t\tposition,\n\t\t\tAwarenessManager.__instance.awareness.doc\n\t\t);\n\t}\n\n\tprivate setCurrentUserState(): void {\n\t\tconst states = this.getStates();\n\t\tconst otherUserColors = Array.from( states.values() )\n\t\t\t.filter( userState => userState.userInfo && ! userState.userInfo.isMe )\n\t\t\t.map( userState => userState.userInfo.color )\n\t\t\t.filter( Boolean );\n\n\t\tconst userInfo: UserInfo = {\n\t\t\t...this.userInfo,\n\t\t\tbrowserType: getBrowserName(),\n\t\t\tclientId: this.awareness.clientID,\n\t\t\tcolor: getNewUserColor( otherUserColors ),\n\t\t\tisConnected: true,\n\t\t\tisMe: true,\n\t\t};\n\n\t\tthis.setLocalStateField( 'userInfo', userInfo );\n\t}\n\n\t/**\n\t * Get the states from an awareness document.\n\t */\n\tprivate getStates(): Map< number, UserState > {\n\t\treturn this.awareness.getStates() as Map< number, UserState >;\n\t}\n\n\t/**\n\t * Set a local state field on an awareness document.\n\t */\n\tprivate setLocalStateField< FieldName extends keyof UserState >(\n\t\tfield: FieldName,\n\t\tvalue: UserState[ FieldName ]\n\t): void {\n\t\tthis.awareness.setLocalStateField( field, value );\n\t}\n\n\tprivate refreshAwareness(): void {\n\t\tconst { removeUser, upsertUser } = dispatch( awarenessStore );\n\t\tconst { getActiveClientIds } = select( awarenessStore );\n\n\t\tconst clientIdsFromStore = new Set< number >( getActiveClientIds() );\n\t\tconst clientIdsFromAwareness = new Set< number >();\n\n\t\tthis.getStates().forEach( ( userState, clientId ) => {\n\t\t\t// The initial state may contain invalid state, so we validate it and\n\t\t\t// skip logging since the origin of the state is not from us.\n\t\t\tif ( ! this.validateUserState( userState ) ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tuserState.userInfo.isMe = userState.userInfo.clientId === this.awareness.clientID;\n\n\t\t\tvoid upsertUser( clientId, userState );\n\t\t\tclientIdsFromAwareness.add( clientId );\n\t\t} );\n\n\t\t// Remove users that are in the store but not in the awareness instance.\n\t\tclientIdsFromStore.forEach( clientId => {\n\t\t\tif ( ! clientIdsFromAwareness.has( clientId ) ) {\n\t\t\t\tvoid removeUser( clientId );\n\t\t\t}\n\t\t} );\n\t}\n\n\tprivate subscribeToCRDTChanges(): void {\n\t\tconst now = Date.now();\n\t\tconst recordMap = this.awareness.doc.getMap( 'document' );\n\t\tconst stateMap = this.awareness.doc.getMap( 'state' );\n\n\t\tstateMap.observe( ( event: Y.YMapEvent< unknown >, transaction: Y.Transaction ) => {\n\t\t\tevent.keysChanged.forEach( ( key: string ) => {\n\t\t\t\tswitch ( key ) {\n\t\t\t\t\t// A remote user has persisted the document (saved).\n\t\t\t\t\tcase 'persistedAt': {\n\t\t\t\t\t\tif ( transaction.local ) {\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst remoteClientId = stateMap.get( 'persistedBy' ) as number;\n\t\t\t\t\t\tconst userState = this.getStates().get( remoteClientId );\n\t\t\t\t\t\tthis.logger.debug( `Document was persisted by client ID ${ remoteClientId }.`, {\n\t\t\t\t\t\t\tremoteClientId,\n\t\t\t\t\t\t\tuserState,\n\t\t\t\t\t\t\tstateMap,\n\t\t\t\t\t\t} );\n\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t// Ignore if the persistedAt timestamp is older than our session\n\t\t\t\t\t\t\tnow > ( stateMap.get( 'persistedAt' ) as number ) ||\n\t\t\t\t\t\t\t// Ignore if we don't have a user state for the client ID\n\t\t\t\t\t\t\t! userState ||\n\t\t\t\t\t\t\t// Ignore if this is our own persisted event (can happen on refresh or reconnect)\n\t\t\t\t\t\t\tuserState.userInfo.id === this.userInfo.id\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst status = recordMap.get( 'status' ) as string;\n\t\t\t\t\t\tsendNotification( NotificationType.PostUpdated, userState.userInfo, status );\n\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t\t// A remote user has restored the document (restored a revision or loaded newer content).\n\t\t\t\t\tcase 'restoredAt': {\n\t\t\t\t\t\tconst remoteClientId = stateMap.get( 'restoredBy' ) as number;\n\t\t\t\t\t\tconst userState = this.getStates().get( remoteClientId );\n\t\t\t\t\t\tthis.logger.debug( `Document was restored by client ID ${ remoteClientId }.`, {\n\t\t\t\t\t\t\tremoteClientId,\n\t\t\t\t\t\t\tuserState,\n\t\t\t\t\t\t\tstateMap,\n\t\t\t\t\t\t} );\n\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t// Ignore if the restoredAt timestamp is older than our session\n\t\t\t\t\t\t\tnow > ( stateMap.get( 'restoredAt' ) as number ) ||\n\t\t\t\t\t\t\t// Ignore if we don't have a user state for the client ID\n\t\t\t\t\t\t\t! userState\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tsendNotification( NotificationType.PostRestored, userState.userInfo );\n\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} );\n\t\t} );\n\t}\n\n\tprivate subscribeToSelectionChanges(): void {\n\t\tconst { getSelectionStart, getSelectionEnd, getSelectedBlocksInitialCaretPosition } = select(\n\t\t\tblockEditorStore\n\t\t) as BlockEditorStoreSelectors;\n\n\t\t// Keep track of the current selection in the outer scope so we can compare\n\t\t// in the subscription.\n\t\tlet selectionStart = getSelectionStart();\n\t\tlet selectionEnd = getSelectionEnd();\n\t\tlet localCursorTimeout: NodeJS.Timeout | null = null;\n\n\t\tsubscribe( () => {\n\t\t\tconst newSelectionStart = getSelectionStart();\n\t\t\tconst newSelectionEnd = getSelectionEnd();\n\n\t\t\tif ( newSelectionStart === selectionStart && newSelectionEnd === selectionEnd ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tselectionStart = newSelectionStart;\n\t\t\tselectionEnd = newSelectionEnd;\n\n\t\t\t// Typically selection position is only persisted after typing in a block, which\n\t\t\t// can cause selection position to be reset by other users making block updates.\n\t\t\t// Ensure we update the controlled selection right away, persisting our cursor position locally.\n\t\t\tvoid updateSelectionInEntityRecord(\n\t\t\t\tselectionStart,\n\t\t\t\tselectionEnd,\n\t\t\t\tgetSelectedBlocksInitialCaretPosition()\n\t\t\t);\n\n\t\t\t// We receive two selection changes in quick succession\n\t\t\t// from local selection events:\n\t\t\t//   { clientId: \"123...\", attributeKey: \"content\", offset: undefined }\n\t\t\t//   { clientId: \"123...\", attributeKey: \"content\", offset: 554 }\n\t\t\t// Add a short debounce to avoid sending the first selection change.\n\t\t\tif ( localCursorTimeout ) {\n\t\t\t\tclearTimeout( localCursorTimeout );\n\t\t\t}\n\n\t\t\tlocalCursorTimeout = setTimeout( () => {\n\t\t\t\tthis.updateSelectionState( selectionStart, selectionEnd );\n\t\t\t}, LOCAL_CURSOR_UPDATE_DEBOUNCE_IN_MS );\n\t\t} );\n\t}\n\n\tprivate updateSelectionState(\n\t\tselectionStart: WPBlockSelection,\n\t\tselectionEnd: WPBlockSelection\n\t): void {\n\t\tconst { updateEditorState } = dispatch( awarenessStore );\n\n\t\tconst ydocument = this.awareness.doc.getMap( 'document' );\n\t\tconst yBlocks = ydocument.get( 'blocks' ) as Y.Array< SelectableBlock >;\n\t\tconst editorState = {\n\t\t\tselection: getSelectionState( selectionStart, selectionEnd, yBlocks ),\n\t\t};\n\n\t\t// Update local state with the new selection state.\n\t\tvoid updateEditorState( this.awareness.clientID, editorState );\n\n\t\t// Throttle awareness updates.\n\t\tlet awarenessCursorTimeout: NodeJS.Timeout | null = null;\n\t\tlet pendingEditorState: { selection: ReturnType< typeof getSelectionState > } | null = null;\n\n\t\t// Store the most recent editor state for awareness throttle\n\t\tpendingEditorState = editorState;\n\n\t\t// Throttle awareness updates - only set timeout if one isn't already running\n\t\tif ( ! awarenessCursorTimeout ) {\n\t\t\tawarenessCursorTimeout = setTimeout( () => {\n\t\t\t\tif ( pendingEditorState ) {\n\t\t\t\t\tthis.setLocalStateField( 'editorState', pendingEditorState );\n\t\t\t\t\tpendingEditorState = null;\n\t\t\t\t}\n\t\t\t\tawarenessCursorTimeout = null;\n\t\t\t}, AWARENESS_CURSOR_UPDATE_DEBOUNCE_IN_MS );\n\t\t}\n\t}\n\n\tprivate subscribeToUserChanges(): void {\n\t\tconst userRemovalTimeouts = new Map< number, NodeJS.Timeout >();\n\t\tconst { patchUserInfo, removeUser, upsertUser } = dispatch( awarenessStore );\n\n\t\tthis.awareness.on( 'change', ( { added, removed, updated }: AwarenessStateChange ) => {\n\t\t\tconst updatedUserStates = this.getStates();\n\n\t\t\t[ ...added, ...updated ].forEach( id => {\n\t\t\t\tconst userState = updatedUserStates.get( id );\n\n\t\t\t\tif ( userRemovalTimeouts.has( id ) ) {\n\t\t\t\t\tclearTimeout( userRemovalTimeouts.get( id ) );\n\t\t\t\t\tuserRemovalTimeouts.delete( id );\n\t\t\t\t}\n\n\t\t\t\tif ( ! this.validateUserState( userState ) ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// If this is the current user, ignore most state updates. We handle our own state locally.\n\t\t\t\tif ( userState.userInfo.clientId === this.awareness.clientID ) {\n\t\t\t\t\t// Except reconnection updates, which we receive from awareness.\n\t\t\t\t\t// This is necessary when reconnecting after a short timeout, where we\n\t\t\t\t\t// receive back-to-back 'removed' and 'added' events for ourselves.\n\t\t\t\t\tif ( userState.userInfo.isConnected === true ) {\n\t\t\t\t\t\tvoid patchUserInfo( id, {\n\t\t\t\t\t\t\tisConnected: true,\n\t\t\t\t\t\t} );\n\t\t\t\t\t}\n\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tuserState.userInfo.isConnected = true;\n\t\t\t\tuserState.userInfo.isMe = false;\n\n\t\t\t\tvoid upsertUser( id, userState );\n\t\t\t} );\n\n\t\t\tremoved.forEach( id => {\n\t\t\t\t// When a user is removed, we don't want to immediately remove their\n\t\t\t\t// state. Instead, we set a timeout to remove it after a short delay.\n\t\t\t\tif ( userRemovalTimeouts.has( id ) ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tvoid patchUserInfo( id, {\n\t\t\t\t\tisConnected: false,\n\t\t\t\t} );\n\n\t\t\t\tuserRemovalTimeouts.set(\n\t\t\t\t\tid,\n\t\t\t\t\tsetTimeout( () => {\n\t\t\t\t\t\tuserRemovalTimeouts.delete( id );\n\t\t\t\t\t\tvoid removeUser( id );\n\t\t\t\t\t}, REMOVAL_DELAY_IN_MS )\n\t\t\t\t);\n\t\t\t} );\n\t\t} );\n\t}\n\n\tprivate validateUserState( userState: UserState | undefined ): userState is UserState {\n\t\t// User state can be set to an empty object by the Yjs awareness protocol\n\t\t// when the user disconnects.\n\t\tif ( ! userState?.userInfo?.clientId || ! userState?.userInfo?.id ) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n}\n","import { useResizeObserver, useMergeRefs } from '@wordpress/compose';\nimport { useRef, useState, useEffect } from '@wordpress/element';\n\nimport { useBlockHighlighting } from '@/hooks/use-block-highlighting';\nimport { useRenderCursors } from '@/hooks/use-render-cursors';\n\nimport '@/components/rtc-overlay.scss';\n\ninterface RTCOverlayProps {\n\tcontainerRef: React.MutableRefObject< HTMLElement | null >;\n}\n\n/**\n * This component is responsible for rendering awareness components within the editor iframe.\n */\nexport function RTCOverlay( { containerRef }: RTCOverlayProps ) {\n\tconst overlayRef = useRef< HTMLDivElement >( null );\n\tconst [ document, setDocument ] = useState< Document | null >( null );\n\n\tuseEffect( () => {\n\t\tconst ownerDocument = containerRef.current?.ownerDocument ?? null;\n\t\t// Update iframe document on mount, which can happen when switching\n\t\t// between iframed and non-iframed editors in preview mode.\n\t\tsetDocument( ownerDocument );\n\n\t\tif ( ownerDocument ) {\n\t\t\t// Redraw cursors after a short delay to ensure cursors are in the correct position\n\t\t\t// after frame-changing animations (e.g. Desktop -> Tablet view) have completed.\n\t\t\tsetTimeout( () => {\n\t\t\t\trenderCursorsRef.current?.();\n\t\t\t}, 500 );\n\t\t}\n\t}, [] );\n\n\tconst renderCursorsRef = useRenderCursors( overlayRef, document );\n\n\t// Detect layout changes on overlay (e.g. turning on \"Show Template\") and window\n\t// resizes, and re-render the cursors.\n\tconst resizeObserverRef = useResizeObserver( () => {\n\t\trenderCursorsRef.current?.();\n\t} );\n\n\t// Merge the refs to use the same element for both overlay and resize observation\n\tconst mergedRef = useMergeRefs( [ overlayRef, resizeObserverRef ] );\n\n\tuseBlockHighlighting( document );\n\n\treturn (\n\t\t<>\n\t\t\t{ /* This is a full overlay that covers the entire iframe document.\n\t\t\t\tGood for scrollable elements like cursor indicators */ }\n\t\t\t<div className=\"vip-real-time-collaboration-overlay-full\" ref={ mergedRef } />\n\t\t</>\n\t);\n}\n","import { BlockCanvasCover } from '@wordpress/block-editor';\nimport {\n\tFlex,\n\tFlexItem,\n\tToggleControl,\n\t__experimentalHeading as Heading,\n\t__experimentalText as Text,\n} from '@wordpress/components';\nimport { useSelect, useDispatch } from '@wordpress/data';\nimport { PluginDocumentSettingPanel, privateApis as editorPrivateApis } from '@wordpress/editor';\nimport { __ } from '@wordpress/i18n';\nimport { __dangerousOptInToUnstableAPIsOnlyForCoreModules } from '@wordpress/private-apis';\n\nimport { Avatar } from './avatar';\nimport { Avatars } from './avatars';\nimport { DebugTools } from './debug-tools';\nimport { PostLockedModal } from './post-locked-modal';\nimport { RTCOverlay } from './rtc-overlay';\nimport {\n\tstore as rtcSettingsStore,\n\tSetting,\n\tSettingsStoreActions,\n\ttype SettingsStoreSelectors,\n} from '../store/settings-store';\nimport { useSortedAwarenessUsers } from '@/hooks/use-sorted-awareness-users';\nimport { isDevelopment } from '@/utilities/config';\n\nconst { unlock } = __dangerousOptInToUnstableAPIsOnlyForCoreModules(\n\t'I acknowledge private features are not for use in themes or plugins and doing so will break in the next version of WordPress.',\n\t'@wordpress/editor'\n);\n\nconst { EditorPresence } = unlock( editorPrivateApis );\n\nexport function RTCSettingsPanel() {\n\tconst {\n\t\tisAvatarsEnabled,\n\t\tisCursorsEnabled,\n\t\tisDebugToolsEnabled,\n\t\tisSelfAwarenessEnabled,\n\t\tisUserEnterNotificationEnabled,\n\t\tisUserExitNotificationEnabled,\n\t} = useSelect<\n\t\tSettingsStoreSelectors,\n\t\t{\n\t\t\tisAvatarsEnabled: boolean;\n\t\t\tisCursorsEnabled: boolean;\n\t\t\tisDebugToolsEnabled: boolean;\n\t\t\tisSelfAwarenessEnabled: boolean;\n\t\t\tisUserEnterNotificationEnabled: boolean;\n\t\t\tisUserExitNotificationEnabled: boolean;\n\t\t}\n\t>( select => {\n\t\tconst { getSetting } = select( rtcSettingsStore );\n\t\treturn {\n\t\t\tisAvatarsEnabled: getSetting( Setting.AWARENESS_AVATARS ),\n\t\t\tisCursorsEnabled: getSetting( Setting.AWARENESS_CURSORS ),\n\t\t\tisDebugToolsEnabled: getSetting( Setting.DEBUG_TOOLS ),\n\t\t\tisSelfAwarenessEnabled: getSetting( Setting.SELF_AWARENESS ),\n\t\t\tisUserEnterNotificationEnabled: getSetting( Setting.USER_ENTER_NOTIFICATION ),\n\t\t\tisUserExitNotificationEnabled: getSetting( Setting.USER_EXIT_NOTIFICATION ),\n\t\t};\n\t}, [] );\n\n\tconst { setSetting } = useDispatch< SettingsStoreActions >( rtcSettingsStore );\n\n\tconst activeUsers = useSortedAwarenessUsers();\n\n\treturn (\n\t\t<>\n\t\t\t{ isAvatarsEnabled && (\n\t\t\t\t<EditorPresence>\n\t\t\t\t\t<Avatars />\n\t\t\t\t</EditorPresence>\n\t\t\t) }\n\t\t\t<BlockCanvasCover.Fill>\n\t\t\t\t{ ( { containerRef }: { containerRef: React.MutableRefObject< HTMLElement | null > } ) => (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<RTCOverlay containerRef={ containerRef } />\n\t\t\t\t\t\t{ isDebugToolsEnabled && containerRef.current?.ownerDocument && (\n\t\t\t\t\t\t\t<DebugTools iframeDocument={ containerRef.current?.ownerDocument } />\n\t\t\t\t\t\t) }\n\t\t\t\t\t\t<PostLockedModal />\n\t\t\t\t\t</>\n\t\t\t\t) }\n\t\t\t</BlockCanvasCover.Fill>\n\t\t\t<PostLockedModal />\n\t\t\t<PluginDocumentSettingPanel\n\t\t\t\tname=\"vip-real-time-collaboration\"\n\t\t\t\ttitle=\"Real-time collaboration\"\n\t\t\t\tclassName=\"vip-real-time-collaboration-settings\"\n\t\t\t>\n\t\t\t\t<div>\n\t\t\t\t\t<ToggleControl\n\t\t\t\t\t\tlabel=\"Enable avatars\"\n\t\t\t\t\t\tchecked={ isAvatarsEnabled }\n\t\t\t\t\t\tonChange={ ( enabled: boolean ) => setSetting( Setting.AWARENESS_AVATARS, enabled ) }\n\t\t\t\t\t/>\n\n\t\t\t\t\t<ToggleControl\n\t\t\t\t\t\tlabel=\"Enable cursors\"\n\t\t\t\t\t\tchecked={ isCursorsEnabled }\n\t\t\t\t\t\tonChange={ ( enabled: boolean ) => setSetting( Setting.AWARENESS_CURSORS, enabled ) }\n\t\t\t\t\t/>\n\n\t\t\t\t\t<ToggleControl\n\t\t\t\t\t\tlabel=\"Show my awareness\"\n\t\t\t\t\t\tchecked={ isSelfAwarenessEnabled }\n\t\t\t\t\t\tonChange={ ( enabled: boolean ) => setSetting( Setting.SELF_AWARENESS, enabled ) }\n\t\t\t\t\t/>\n\n\t\t\t\t\t{ isDevelopment() && (\n\t\t\t\t\t\t<ToggleControl\n\t\t\t\t\t\t\tlabel=\"Show debug tools\"\n\t\t\t\t\t\t\tchecked={ isDebugToolsEnabled }\n\t\t\t\t\t\t\tonChange={ ( enabled: boolean ) => setSetting( Setting.DEBUG_TOOLS, enabled ) }\n\t\t\t\t\t\t/>\n\t\t\t\t\t) }\n\n\t\t\t\t\t<Heading level={ 3 } style={ { marginTop: '24px' } }>\n\t\t\t\t\t\t{ __( 'Notifications', 'vip-real-time-collaboration' ) }\n\t\t\t\t\t</Heading>\n\n\t\t\t\t\t<Heading level={ 2 } style={ { marginBottom: '2px' } }>\n\t\t\t\t\t\t{ __( 'Collaborators', 'vip-real-time-collaboration' ) }\n\t\t\t\t\t</Heading>\n\n\t\t\t\t\t<ToggleControl\n\t\t\t\t\t\tlabel=\"Enters\"\n\t\t\t\t\t\tchecked={ isUserEnterNotificationEnabled }\n\t\t\t\t\t\tonChange={ ( enabled: boolean ) =>\n\t\t\t\t\t\t\tsetSetting( Setting.USER_ENTER_NOTIFICATION, enabled )\n\t\t\t\t\t\t}\n\t\t\t\t\t/>\n\n\t\t\t\t\t<ToggleControl\n\t\t\t\t\t\tlabel=\"Exits\"\n\t\t\t\t\t\tchecked={ isUserExitNotificationEnabled }\n\t\t\t\t\t\tonChange={ ( enabled: boolean ) =>\n\t\t\t\t\t\t\tsetSetting( Setting.USER_EXIT_NOTIFICATION, enabled )\n\t\t\t\t\t\t}\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\n\t\t\t\t<Heading level={ 3 } style={ { marginTop: '24px' } }>\n\t\t\t\t\t{ __( 'Collaborators', 'vip-real-time-collaboration' ) }\n\t\t\t\t</Heading>\n\n\t\t\t\t<Flex direction=\"column\" className=\"vip-real-time-collaboration-sidebar-users\" gap={ 0 }>\n\t\t\t\t\t{ activeUsers.map( userState => (\n\t\t\t\t\t\t<FlexItem key={ userState.userInfo.clientId }>\n\t\t\t\t\t\t\t<Flex\n\t\t\t\t\t\t\t\tdirection=\"row\"\n\t\t\t\t\t\t\t\tjustify=\"flex-start\"\n\t\t\t\t\t\t\t\tclassName=\"vip-real-time-collaboration-sidebar-user-row\"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<Avatar\n\t\t\t\t\t\t\t\t\tkey={ userState.userInfo.clientId }\n\t\t\t\t\t\t\t\t\tshowUserColorBorder={ true }\n\t\t\t\t\t\t\t\t\tuserInfo={ userState.userInfo }\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<Text>{ userState.userInfo.name }</Text>\n\t\t\t\t\t\t\t</Flex>\n\t\t\t\t\t\t</FlexItem>\n\t\t\t\t\t) ) }\n\t\t\t\t</Flex>\n\t\t\t\t<div className=\"vip-telemetry-target\"></div>\n\t\t\t</PluginDocumentSettingPanel>\n\t\t</>\n\t);\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = window[\"wp\"][\"apiFetch\"];","/**\n * Utility module to work with key-value stores.\n *\n * @module map\n */\n\n/**\n * Creates a new Map instance.\n *\n * @function\n * @return {Map<any, any>}\n *\n * @function\n */\nexport const create = () => new Map()\n\n/**\n * Copy a Map object into a fresh Map object.\n *\n * @function\n * @template K,V\n * @param {Map<K,V>} m\n * @return {Map<K,V>}\n */\nexport const copy = m => {\n  const r = create()\n  m.forEach((v, k) => { r.set(k, v) })\n  return r\n}\n\n/**\n * Get map property. Create T if property is undefined and set T on map.\n *\n * ```js\n * const listeners = map.setIfUndefined(events, 'eventName', set.create)\n * listeners.add(listener)\n * ```\n *\n * @function\n * @template {Map<any, any>} MAP\n * @template {MAP extends Map<any,infer V> ? function():V : unknown} CF\n * @param {MAP} map\n * @param {MAP extends Map<infer K,any> ? K : unknown} key\n * @param {CF} createT\n * @return {ReturnType<CF>}\n */\nexport const setIfUndefined = (map, key, createT) => {\n  let set = map.get(key)\n  if (set === undefined) {\n    map.set(key, set = createT())\n  }\n  return set\n}\n\n/**\n * Creates an Array and populates it with the content of all key-value pairs using the `f(value, key)` function.\n *\n * @function\n * @template K\n * @template V\n * @template R\n * @param {Map<K,V>} m\n * @param {function(V,K):R} f\n * @return {Array<R>}\n */\nexport const map = (m, f) => {\n  const res = []\n  for (const [key, value] of m) {\n    res.push(f(value, key))\n  }\n  return res\n}\n\n/**\n * Tests whether any key-value pairs pass the test implemented by `f(value, key)`.\n *\n * @todo should rename to some - similarly to Array.some\n *\n * @function\n * @template K\n * @template V\n * @param {Map<K,V>} m\n * @param {function(V,K):boolean} f\n * @return {boolean}\n */\nexport const any = (m, f) => {\n  for (const [key, value] of m) {\n    if (f(value, key)) {\n      return true\n    }\n  }\n  return false\n}\n\n/**\n * Tests whether all key-value pairs pass the test implemented by `f(value, key)`.\n *\n * @function\n * @template K\n * @template V\n * @param {Map<K,V>} m\n * @param {function(V,K):boolean} f\n * @return {boolean}\n */\nexport const all = (m, f) => {\n  for (const [key, value] of m) {\n    if (!f(value, key)) {\n      return false\n    }\n  }\n  return true\n}\n","/**\n * Utility module to work with sets.\n *\n * @module set\n */\n\nexport const create = () => new Set()\n\n/**\n * @template T\n * @param {Set<T>} set\n * @return {Array<T>}\n */\nexport const toArray = set => Array.from(set)\n\n/**\n * @template T\n * @param {Set<T>} set\n * @return {T|undefined}\n */\nexport const first = set => set.values().next().value\n\n/**\n * @template T\n * @param {Iterable<T>} entries\n * @return {Set<T>}\n */\nexport const from = entries => new Set(entries)\n","import * as array from './array.js'\n\n/**\n * Utility module to work with strings.\n *\n * @module string\n */\n\nexport const fromCharCode = String.fromCharCode\nexport const fromCodePoint = String.fromCodePoint\n\n/**\n * The largest utf16 character.\n * Corresponds to Uint8Array([255, 255]) or charcodeof(2x2^8)\n */\nexport const MAX_UTF16_CHARACTER = fromCharCode(65535)\n\n/**\n * @param {string} s\n * @return {string}\n */\nconst toLowerCase = s => s.toLowerCase()\n\nconst trimLeftRegex = /^\\s*/g\n\n/**\n * @param {string} s\n * @return {string}\n */\nexport const trimLeft = s => s.replace(trimLeftRegex, '')\n\nconst fromCamelCaseRegex = /([A-Z])/g\n\n/**\n * @param {string} s\n * @param {string} separator\n * @return {string}\n */\nexport const fromCamelCase = (s, separator) => trimLeft(s.replace(fromCamelCaseRegex, match => `${separator}${toLowerCase(match)}`))\n\n/**\n * Compute the utf8ByteLength\n * @param {string} str\n * @return {number}\n */\nexport const utf8ByteLength = str => unescape(encodeURIComponent(str)).length\n\n/**\n * @param {string} str\n * @return {Uint8Array}\n */\nexport const _encodeUtf8Polyfill = str => {\n  const encodedString = unescape(encodeURIComponent(str))\n  const len = encodedString.length\n  const buf = new Uint8Array(len)\n  for (let i = 0; i < len; i++) {\n    buf[i] = /** @type {number} */ (encodedString.codePointAt(i))\n  }\n  return buf\n}\n\n/* c8 ignore next */\nexport const utf8TextEncoder = /** @type {TextEncoder} */ (typeof TextEncoder !== 'undefined' ? new TextEncoder() : null)\n\n/**\n * @param {string} str\n * @return {Uint8Array}\n */\nexport const _encodeUtf8Native = str => utf8TextEncoder.encode(str)\n\n/**\n * @param {string} str\n * @return {Uint8Array}\n */\n/* c8 ignore next */\nexport const encodeUtf8 = utf8TextEncoder ? _encodeUtf8Native : _encodeUtf8Polyfill\n\n/**\n * @param {Uint8Array} buf\n * @return {string}\n */\nexport const _decodeUtf8Polyfill = buf => {\n  let remainingLen = buf.length\n  let encodedString = ''\n  let bufPos = 0\n  while (remainingLen > 0) {\n    const nextLen = remainingLen < 10000 ? remainingLen : 10000\n    const bytes = buf.subarray(bufPos, bufPos + nextLen)\n    bufPos += nextLen\n    // Starting with ES5.1 we can supply a generic array-like object as arguments\n    encodedString += String.fromCodePoint.apply(null, /** @type {any} */ (bytes))\n    remainingLen -= nextLen\n  }\n  return decodeURIComponent(escape(encodedString))\n}\n\n/* c8 ignore next */\nexport let utf8TextDecoder = typeof TextDecoder === 'undefined' ? null : new TextDecoder('utf-8', { fatal: true, ignoreBOM: true })\n\n/* c8 ignore start */\nif (utf8TextDecoder && utf8TextDecoder.decode(new Uint8Array()).length === 1) {\n  // Safari doesn't handle BOM correctly.\n  // This fixes a bug in Safari 13.0.5 where it produces a BOM the first time it is called.\n  // utf8TextDecoder.decode(new Uint8Array()).length === 1 on the first call and\n  // utf8TextDecoder.decode(new Uint8Array()).length === 1 on the second call\n  // Another issue is that from then on no BOM chars are recognized anymore\n  /* c8 ignore next */\n  utf8TextDecoder = null\n}\n/* c8 ignore stop */\n\n/**\n * @param {Uint8Array} buf\n * @return {string}\n */\nexport const _decodeUtf8Native = buf => /** @type {TextDecoder} */ (utf8TextDecoder).decode(buf)\n\n/**\n * @param {Uint8Array} buf\n * @return {string}\n */\n/* c8 ignore next */\nexport const decodeUtf8 = utf8TextDecoder ? _decodeUtf8Native : _decodeUtf8Polyfill\n\n/**\n * @param {string} str The initial string\n * @param {number} index Starting position\n * @param {number} remove Number of characters to remove\n * @param {string} insert New content to insert\n */\nexport const splice = (str, index, remove, insert = '') => str.slice(0, index) + insert + str.slice(index + remove)\n\n/**\n * @param {string} source\n * @param {number} n\n */\nexport const repeat = (source, n) => array.unfold(n, () => source).join('')\n\n/**\n * Escape HTML characters &,<,>,',\" to their respective HTML entities &amp;,&lt;,&gt;,&#39;,&quot;\n *\n * @param {string} str\n */\nexport const escapeHTML = str =>\n  str.replace(/[&<>'\"]/g, r => /** @type {string} */ ({\n    '&': '&amp;',\n    '<': '&lt;',\n    '>': '&gt;',\n    \"'\": '&#39;',\n    '\"': '&quot;'\n  }[r]))\n\n/**\n * Reverse of `escapeHTML`\n *\n * @param {string} str\n */\nexport const unescapeHTML = str =>\n  str.replace(/&amp;|&lt;|&gt;|&#39;|&quot;/g, r => /** @type {string} */ ({\n    '&amp;': '&',\n    '&lt;': '<',\n    '&gt;': '>',\n    '&#39;': \"'\",\n    '&quot;': '\"'\n  }[r]))\n","/* eslint-env browser */\n\n/**\n * Isomorphic variable storage.\n *\n * Uses LocalStorage in the browser and falls back to in-memory storage.\n *\n * @module storage\n */\n\n/* c8 ignore start */\nclass VarStoragePolyfill {\n  constructor () {\n    this.map = new Map()\n  }\n\n  /**\n   * @param {string} key\n   * @param {any} newValue\n   */\n  setItem (key, newValue) {\n    this.map.set(key, newValue)\n  }\n\n  /**\n   * @param {string} key\n   */\n  getItem (key) {\n    return this.map.get(key)\n  }\n}\n/* c8 ignore stop */\n\n/**\n * @type {any}\n */\nlet _localStorage = new VarStoragePolyfill()\nlet usePolyfill = true\n\n/* c8 ignore start */\ntry {\n  // if the same-origin rule is violated, accessing localStorage might thrown an error\n  if (typeof localStorage !== 'undefined' && localStorage) {\n    _localStorage = localStorage\n    usePolyfill = false\n  }\n} catch (e) { }\n/* c8 ignore stop */\n\n/**\n * This is basically localStorage in browser, or a polyfill in nodejs\n */\n/* c8 ignore next */\nexport const varStorage = _localStorage\n\n/**\n * A polyfill for `addEventListener('storage', event => {..})` that does nothing if the polyfill is being used.\n *\n * @param {function({ key: string, newValue: string, oldValue: string }): void} eventHandler\n * @function\n */\n/* c8 ignore next */\nexport const onChange = eventHandler => usePolyfill || addEventListener('storage', /** @type {any} */ (eventHandler))\n\n/**\n * A polyfill for `removeEventListener('storage', event => {..})` that does nothing if the polyfill is being used.\n *\n * @param {function({ key: string, newValue: string, oldValue: string }): void} eventHandler\n * @function\n */\n/* c8 ignore next */\nexport const offChange = eventHandler => usePolyfill || removeEventListener('storage', /** @type {any} */ (eventHandler))\n","/**\n * Utility module to work with Arrays.\n *\n * @module array\n */\n\nimport * as set from './set.js'\n\n/**\n * Return the last element of an array. The element must exist\n *\n * @template L\n * @param {ArrayLike<L>} arr\n * @return {L}\n */\nexport const last = arr => arr[arr.length - 1]\n\n/**\n * @template C\n * @return {Array<C>}\n */\nexport const create = () => /** @type {Array<C>} */ ([])\n\n/**\n * @template D\n * @param {Array<D>} a\n * @return {Array<D>}\n */\nexport const copy = a => /** @type {Array<D>} */ (a.slice())\n\n/**\n * Append elements from src to dest\n *\n * @template M\n * @param {Array<M>} dest\n * @param {Array<M>} src\n */\nexport const appendTo = (dest, src) => {\n  for (let i = 0; i < src.length; i++) {\n    dest.push(src[i])\n  }\n}\n\n/**\n * Transforms something array-like to an actual Array.\n *\n * @function\n * @template T\n * @param {ArrayLike<T>|Iterable<T>} arraylike\n * @return {T}\n */\nexport const from = Array.from\n\n/**\n * True iff condition holds on every element in the Array.\n *\n * @function\n * @template {ArrayLike<any>} ARR\n *\n * @param {ARR} arr\n * @param {ARR extends ArrayLike<infer S> ? ((value:S, index:number, arr:ARR) => boolean) : any} f\n * @return {boolean}\n */\nexport const every = (arr, f) => {\n  for (let i = 0; i < arr.length; i++) {\n    if (!f(arr[i], i, arr)) {\n      return false\n    }\n  }\n  return true\n}\n\n/**\n * True iff condition holds on some element in the Array.\n *\n * @function\n * @template {ArrayLike<any>} ARR\n *\n * @param {ARR} arr\n * @param {ARR extends ArrayLike<infer S> ? ((value:S, index:number, arr:ARR) => boolean) : never} f\n * @return {boolean}\n */\nexport const some = (arr, f) => {\n  for (let i = 0; i < arr.length; i++) {\n    if (f(arr[i], i, arr)) {\n      return true\n    }\n  }\n  return false\n}\n\n/**\n * @template ELEM\n *\n * @param {ArrayLike<ELEM>} a\n * @param {ArrayLike<ELEM>} b\n * @return {boolean}\n */\nexport const equalFlat = (a, b) => a.length === b.length && every(a, (item, index) => item === b[index])\n\n/**\n * @template ELEM\n * @param {Array<Array<ELEM>>} arr\n * @return {Array<ELEM>}\n */\nexport const flatten = arr => fold(arr, /** @type {Array<ELEM>} */ ([]), (acc, val) => acc.concat(val))\n\n/**\n * @template T\n * @param {number} len\n * @param {function(number, Array<T>):T} f\n * @return {Array<T>}\n */\nexport const unfold = (len, f) => {\n  const array = new Array(len)\n  for (let i = 0; i < len; i++) {\n    array[i] = f(i, array)\n  }\n  return array\n}\n\n/**\n * @template T\n * @template RESULT\n * @param {Array<T>} arr\n * @param {RESULT} seed\n * @param {function(RESULT, T, number):RESULT} folder\n */\nexport const fold = (arr, seed, folder) => arr.reduce(folder, seed)\n\nexport const isArray = Array.isArray\n\n/**\n * @template T\n * @param {Array<T>} arr\n * @return {Array<T>}\n */\nexport const unique = arr => from(set.from(arr))\n\n/**\n * @template T\n * @template M\n * @param {ArrayLike<T>} arr\n * @param {function(T):M} mapper\n * @return {Array<T>}\n */\nexport const uniqueBy = (arr, mapper) => {\n  /**\n   * @type {Set<M>}\n   */\n  const happened = set.create()\n  /**\n   * @type {Array<T>}\n   */\n  const result = []\n  for (let i = 0; i < arr.length; i++) {\n    const el = arr[i]\n    const mapped = mapper(el)\n    if (!happened.has(mapped)) {\n      happened.add(mapped)\n      result.push(el)\n    }\n  }\n  return result\n}\n\n/**\n * @template {ArrayLike<any>} ARR\n * @template {function(ARR extends ArrayLike<infer T> ? T : never, number, ARR):any} MAPPER\n * @param {ARR} arr\n * @param {MAPPER} mapper\n * @return {Array<MAPPER extends function(...any): infer M ? M : never>}\n */\nexport const map = (arr, mapper) => {\n  /**\n   * @type {Array<any>}\n   */\n  const res = Array(arr.length)\n  for (let i = 0; i < arr.length; i++) {\n    res[i] = mapper(/** @type {any} */ (arr[i]), i, /** @type {any} */ (arr))\n  }\n  return /** @type {any} */ (res)\n}\n\n/**\n * This function bubble-sorts a single item to the correct position. The sort happens in-place and\n * might be useful to ensure that a single item is at the correct position in an otherwise sorted\n * array.\n *\n * @example\n *  const arr = [3, 2, 5]\n *  arr.sort((a, b) => a - b)\n *  arr // => [2, 3, 5]\n *  arr.splice(1, 0, 7)\n *  array.bubbleSortItem(arr, 1, (a, b) => a - b)\n *  arr // => [2, 3, 5, 7]\n *\n * @template T\n * @param {Array<T>} arr\n * @param {number} i\n * @param {(a:T,b:T) => number} compareFn\n */\nexport const bubblesortItem = (arr, i, compareFn) => {\n  const n = arr[i]\n  let j = i\n  // try to sort to the right\n  while (j + 1 < arr.length && compareFn(n, arr[j + 1]) > 0) {\n    arr[j] = arr[j + 1]\n    arr[++j] = n\n  }\n  if (i === j && j > 0) { // no change yet\n    // sort to the left\n    while (j > 0 && compareFn(arr[j - 1], n) > 0) {\n      arr[j] = arr[j - 1]\n      arr[--j] = n\n    }\n  }\n  return j\n}\n","/**\n * Isomorphic module to work access the environment (query params, env variables).\n *\n * @module environment\n */\n\nimport * as map from './map.js'\nimport * as string from './string.js'\nimport * as conditions from './conditions.js'\nimport * as storage from './storage.js'\nimport * as f from './function.js'\n\n/* c8 ignore next 2 */\n// @ts-ignore\nexport const isNode = typeof process !== 'undefined' && process.release && /node|io\\.js/.test(process.release.name) && Object.prototype.toString.call(typeof process !== 'undefined' ? process : 0) === '[object process]'\n\n/* c8 ignore next */\nexport const isBrowser = typeof window !== 'undefined' && typeof document !== 'undefined' && !isNode\n/* c8 ignore next 3 */\nexport const isMac = typeof navigator !== 'undefined'\n  ? /Mac/.test(navigator.platform)\n  : false\n\n/**\n * @type {Map<string,string>}\n */\nlet params\nconst args = []\n\n/* c8 ignore start */\nconst computeParams = () => {\n  if (params === undefined) {\n    if (isNode) {\n      params = map.create()\n      const pargs = process.argv\n      let currParamName = null\n      for (let i = 0; i < pargs.length; i++) {\n        const parg = pargs[i]\n        if (parg[0] === '-') {\n          if (currParamName !== null) {\n            params.set(currParamName, '')\n          }\n          currParamName = parg\n        } else {\n          if (currParamName !== null) {\n            params.set(currParamName, parg)\n            currParamName = null\n          } else {\n            args.push(parg)\n          }\n        }\n      }\n      if (currParamName !== null) {\n        params.set(currParamName, '')\n      }\n      // in ReactNative for example this would not be true (unless connected to the Remote Debugger)\n    } else if (typeof location === 'object') {\n      params = map.create(); // eslint-disable-next-line no-undef\n      (location.search || '?').slice(1).split('&').forEach((kv) => {\n        if (kv.length !== 0) {\n          const [key, value] = kv.split('=')\n          params.set(`--${string.fromCamelCase(key, '-')}`, value)\n          params.set(`-${string.fromCamelCase(key, '-')}`, value)\n        }\n      })\n    } else {\n      params = map.create()\n    }\n  }\n  return params\n}\n/* c8 ignore stop */\n\n/**\n * @param {string} name\n * @return {boolean}\n */\n/* c8 ignore next */\nexport const hasParam = (name) => computeParams().has(name)\n\n/**\n * @param {string} name\n * @param {string} defaultVal\n * @return {string}\n */\n/* c8 ignore next 2 */\nexport const getParam = (name, defaultVal) =>\n  computeParams().get(name) || defaultVal\n\n/**\n * @param {string} name\n * @return {string|null}\n */\n/* c8 ignore next 4 */\nexport const getVariable = (name) =>\n  isNode\n    ? conditions.undefinedToNull(process.env[name.toUpperCase().replaceAll('-', '_')])\n    : conditions.undefinedToNull(storage.varStorage.getItem(name))\n\n/**\n * @param {string} name\n * @return {string|null}\n */\n/* c8 ignore next 2 */\nexport const getConf = (name) =>\n  computeParams().get('--' + name) || getVariable(name)\n\n/**\n * @param {string} name\n * @return {string}\n */\n/* c8 ignore next 5 */\nexport const ensureConf = (name) => {\n  const c = getConf(name)\n  if (c == null) throw new Error(`Expected configuration \"${name.toUpperCase().replaceAll('-', '_')}\"`)\n  return c\n}\n\n/**\n * @param {string} name\n * @return {boolean}\n */\n/* c8 ignore next 2 */\nexport const hasConf = (name) =>\n  hasParam('--' + name) || getVariable(name) !== null\n\n/* c8 ignore next */\nexport const production = hasConf('production')\n\n/* c8 ignore next 2 */\nconst forceColor = isNode &&\n  f.isOneOf(process.env.FORCE_COLOR, ['true', '1', '2'])\n\n/* c8 ignore start */\n/**\n * Color is enabled by default if the terminal supports it.\n *\n * Explicitly enable color using `--color` parameter\n * Disable color using `--no-color` parameter or using `NO_COLOR=1` environment variable.\n * `FORCE_COLOR=1` enables color and takes precedence over all.\n */\nexport const supportsColor = forceColor || (\n  !hasParam('--no-colors') && // @todo deprecate --no-colors\n  !hasConf('no-color') &&\n  (!isNode || process.stdout.isTTY) && (\n    !isNode ||\n    hasParam('--color') ||\n    getVariable('COLORTERM') !== null ||\n    (getVariable('TERM') || '').includes('color')\n  )\n)\n/* c8 ignore stop */\n","/**\n * Often used conditions.\n *\n * @module conditions\n */\n\n/**\n * @template T\n * @param {T|null|undefined} v\n * @return {T|null}\n */\n/* c8 ignore next */\nexport const undefinedToNull = v => v === undefined ? null : v\n","/**\n * Common functions and function call helpers.\n *\n * @module function\n */\n\nimport * as array from './array.js'\nimport * as object from './object.js'\nimport * as traits from './traits.js'\n\n/**\n * Calls all functions in `fs` with args. Only throws after all functions were called.\n *\n * @param {Array<function>} fs\n * @param {Array<any>} args\n */\nexport const callAll = (fs, args, i = 0) => {\n  try {\n    for (; i < fs.length; i++) {\n      fs[i](...args)\n    }\n  } finally {\n    if (i < fs.length) {\n      callAll(fs, args, i + 1)\n    }\n  }\n}\n\nexport const nop = () => {}\n\n/**\n * @template T\n * @param {function():T} f\n * @return {T}\n */\nexport const apply = f => f()\n\n/**\n * @template A\n *\n * @param {A} a\n * @return {A}\n */\nexport const id = a => a\n\n/**\n * @template T\n *\n * @param {T} a\n * @param {T} b\n * @return {boolean}\n */\nexport const equalityStrict = (a, b) => a === b\n\n/**\n * @template T\n *\n * @param {Array<T>|object} a\n * @param {Array<T>|object} b\n * @return {boolean}\n */\nexport const equalityFlat = (a, b) => a === b || (a != null && b != null && a.constructor === b.constructor && ((array.isArray(a) && array.equalFlat(a, /** @type {Array<T>} */ (b))) || (typeof a === 'object' && object.equalFlat(a, b))))\n\n/* c8 ignore start */\n\n/**\n * @param {any} a\n * @param {any} b\n * @return {boolean}\n */\nexport const equalityDeep = (a, b) => {\n  if (a === b) {\n    return true\n  }\n  if (a == null || b == null || a.constructor !== b.constructor) {\n    return false\n  }\n  if (a[traits.EqualityTraitSymbol] != null) {\n    return a[traits.EqualityTraitSymbol](b)\n  }\n  switch (a.constructor) {\n    case ArrayBuffer:\n      a = new Uint8Array(a)\n      b = new Uint8Array(b)\n    // eslint-disable-next-line no-fallthrough\n    case Uint8Array: {\n      if (a.byteLength !== b.byteLength) {\n        return false\n      }\n      for (let i = 0; i < a.length; i++) {\n        if (a[i] !== b[i]) {\n          return false\n        }\n      }\n      break\n    }\n    case Set: {\n      if (a.size !== b.size) {\n        return false\n      }\n      for (const value of a) {\n        if (!b.has(value)) {\n          return false\n        }\n      }\n      break\n    }\n    case Map: {\n      if (a.size !== b.size) {\n        return false\n      }\n      for (const key of a.keys()) {\n        if (!b.has(key) || !equalityDeep(a.get(key), b.get(key))) {\n          return false\n        }\n      }\n      break\n    }\n    case Object:\n      if (object.length(a) !== object.length(b)) {\n        return false\n      }\n      for (const key in a) {\n        if (!object.hasProperty(a, key) || !equalityDeep(a[key], b[key])) {\n          return false\n        }\n      }\n      break\n    case Array:\n      if (a.length !== b.length) {\n        return false\n      }\n      for (let i = 0; i < a.length; i++) {\n        if (!equalityDeep(a[i], b[i])) {\n          return false\n        }\n      }\n      break\n    default:\n      return false\n  }\n  return true\n}\n\n/**\n * @template V\n * @template {V} OPTS\n *\n * @param {V} value\n * @param {Array<OPTS>} options\n */\n// @ts-ignore\nexport const isOneOf = (value, options) => options.includes(value)\n/* c8 ignore stop */\n\nexport const isArray = array.isArray\n\n/**\n * @param {any} s\n * @return {s is String}\n */\nexport const isString = (s) => s && s.constructor === String\n\n/**\n * @param {any} n\n * @return {n is Number}\n */\nexport const isNumber = n => n != null && n.constructor === Number\n\n/**\n * @template {abstract new (...args: any) => any} TYPE\n * @param {any} n\n * @param {TYPE} T\n * @return {n is InstanceType<TYPE>}\n */\nexport const is = (n, T) => n && n.constructor === T\n\n/**\n * @template {abstract new (...args: any) => any} TYPE\n * @param {TYPE} T\n */\nexport const isTemplate = (T) =>\n  /**\n   * @param {any} n\n   * @return {n is InstanceType<TYPE>}\n   **/\n  n => n && n.constructor === T\n","/**\n * Utility functions to work with buffers (Uint8Array).\n *\n * @module buffer\n */\n\nimport * as string from './string.js'\nimport * as env from './environment.js'\nimport * as array from './array.js'\nimport * as math from './math.js'\nimport * as encoding from './encoding.js'\nimport * as decoding from './decoding.js'\n\n/**\n * @param {number} len\n */\nexport const createUint8ArrayFromLen = len => new Uint8Array(len)\n\n/**\n * Create Uint8Array with initial content from buffer\n *\n * @param {ArrayBuffer} buffer\n * @param {number} byteOffset\n * @param {number} length\n */\nexport const createUint8ArrayViewFromArrayBuffer = (buffer, byteOffset, length) => new Uint8Array(buffer, byteOffset, length)\n\n/**\n * Create Uint8Array with initial content from buffer\n *\n * @param {ArrayBuffer} buffer\n */\nexport const createUint8ArrayFromArrayBuffer = buffer => new Uint8Array(buffer)\n\n/* c8 ignore start */\n/**\n * @param {Uint8Array} bytes\n * @return {string}\n */\nconst toBase64Browser = bytes => {\n  let s = ''\n  for (let i = 0; i < bytes.byteLength; i++) {\n    s += string.fromCharCode(bytes[i])\n  }\n  // eslint-disable-next-line no-undef\n  return btoa(s)\n}\n/* c8 ignore stop */\n\n/**\n * @param {Uint8Array} bytes\n * @return {string}\n */\nconst toBase64Node = bytes => Buffer.from(bytes.buffer, bytes.byteOffset, bytes.byteLength).toString('base64')\n\n/* c8 ignore start */\n/**\n * @param {string} s\n * @return {Uint8Array}\n */\nconst fromBase64Browser = s => {\n  // eslint-disable-next-line no-undef\n  const a = atob(s)\n  const bytes = createUint8ArrayFromLen(a.length)\n  for (let i = 0; i < a.length; i++) {\n    bytes[i] = a.charCodeAt(i)\n  }\n  return bytes\n}\n/* c8 ignore stop */\n\n/**\n * @param {string} s\n */\nconst fromBase64Node = s => {\n  const buf = Buffer.from(s, 'base64')\n  return createUint8ArrayViewFromArrayBuffer(buf.buffer, buf.byteOffset, buf.byteLength)\n}\n\n/* c8 ignore next */\nexport const toBase64 = env.isBrowser ? toBase64Browser : toBase64Node\n\n/* c8 ignore next */\nexport const fromBase64 = env.isBrowser ? fromBase64Browser : fromBase64Node\n\n/**\n * Implements base64url - see https://datatracker.ietf.org/doc/html/rfc4648#section-5\n * @param {Uint8Array} buf\n */\nexport const toBase64UrlEncoded = buf => toBase64(buf).replaceAll('+', '-').replaceAll('/', '_').replaceAll('=', '')\n\n/**\n * @param {string} base64\n */\nexport const fromBase64UrlEncoded = base64 => fromBase64(base64.replaceAll('-', '+').replaceAll('_', '/'))\n\n/**\n * Base64 is always a more efficient choice. This exists for utility purposes only.\n *\n * @param {Uint8Array} buf\n */\nexport const toHexString = buf => array.map(buf, b => b.toString(16).padStart(2, '0')).join('')\n\n/**\n * Note: This function expects that the hex doesn't start with 0x..\n *\n * @param {string} hex\n */\nexport const fromHexString = hex => {\n  const hlen = hex.length\n  const buf = new Uint8Array(math.ceil(hlen / 2))\n  for (let i = 0; i < hlen; i += 2) {\n    buf[buf.length - i / 2 - 1] = Number.parseInt(hex.slice(hlen - i - 2, hlen - i), 16)\n  }\n  return buf\n}\n\n/**\n * Copy the content of an Uint8Array view to a new ArrayBuffer.\n *\n * @param {Uint8Array} uint8Array\n * @return {Uint8Array}\n */\nexport const copyUint8Array = uint8Array => {\n  const newBuf = createUint8ArrayFromLen(uint8Array.byteLength)\n  newBuf.set(uint8Array)\n  return newBuf\n}\n\n/**\n * Encode anything as a UInt8Array. It's a pun on typescripts's `any` type.\n * See encoding.writeAny for more information.\n *\n * @param {any} data\n * @return {Uint8Array}\n */\nexport const encodeAny = data =>\n  encoding.encode(encoder => encoding.writeAny(encoder, data))\n\n/**\n * Decode an any-encoded value.\n *\n * @param {Uint8Array} buf\n * @return {any}\n */\nexport const decodeAny = buf => decoding.readAny(decoding.createDecoder(buf))\n\n/**\n * Shift Byte Array {N} bits to the left. Does not expand byte array.\n *\n * @param {Uint8Array} bs\n * @param {number} N should be in the range of [0-7]\n */\nexport const shiftNBitsLeft = (bs, N) => {\n  if (N === 0) return bs\n  bs = new Uint8Array(bs)\n  bs[0] <<= N\n  for (let i = 1; i < bs.length; i++) {\n    bs[i - 1] |= bs[i] >>> (8 - N)\n    bs[i] <<= N\n  }\n  return bs\n}\n","/* eslint-env browser */\n\n/**\n * Helpers for cross-tab communication using broadcastchannel with LocalStorage fallback.\n *\n * ```js\n * // In browser window A:\n * broadcastchannel.subscribe('my events', data => console.log(data))\n * broadcastchannel.publish('my events', 'Hello world!') // => A: 'Hello world!' fires synchronously in same tab\n *\n * // In browser window B:\n * broadcastchannel.publish('my events', 'hello from tab B') // => A: 'hello from tab B'\n * ```\n *\n * @module broadcastchannel\n */\n\n// @todo before next major: use Uint8Array instead as buffer object\n\nimport * as map from './map.js'\nimport * as set from './set.js'\nimport * as buffer from './buffer.js'\nimport * as storage from './storage.js'\n\n/**\n * @typedef {Object} Channel\n * @property {Set<function(any, any):any>} Channel.subs\n * @property {any} Channel.bc\n */\n\n/**\n * @type {Map<string, Channel>}\n */\nconst channels = new Map()\n\n/* c8 ignore start */\nclass LocalStoragePolyfill {\n  /**\n   * @param {string} room\n   */\n  constructor (room) {\n    this.room = room\n    /**\n     * @type {null|function({data:ArrayBuffer}):void}\n     */\n    this.onmessage = null\n    /**\n     * @param {any} e\n     */\n    this._onChange = e => e.key === room && this.onmessage !== null && this.onmessage({ data: buffer.fromBase64(e.newValue || '') })\n    storage.onChange(this._onChange)\n  }\n\n  /**\n   * @param {ArrayBuffer} buf\n   */\n  postMessage (buf) {\n    storage.varStorage.setItem(this.room, buffer.toBase64(buffer.createUint8ArrayFromArrayBuffer(buf)))\n  }\n\n  close () {\n    storage.offChange(this._onChange)\n  }\n}\n/* c8 ignore stop */\n\n// Use BroadcastChannel or Polyfill\n/* c8 ignore next */\nconst BC = typeof BroadcastChannel === 'undefined' ? LocalStoragePolyfill : BroadcastChannel\n\n/**\n * @param {string} room\n * @return {Channel}\n */\nconst getChannel = room =>\n  map.setIfUndefined(channels, room, () => {\n    const subs = set.create()\n    const bc = new BC(room)\n    /**\n     * @param {{data:ArrayBuffer}} e\n     */\n    /* c8 ignore next */\n    bc.onmessage = e => subs.forEach(sub => sub(e.data, 'broadcastchannel'))\n    return {\n      bc, subs\n    }\n  })\n\n/**\n * Subscribe to global `publish` events.\n *\n * @function\n * @param {string} room\n * @param {function(any, any):any} f\n */\nexport const subscribe = (room, f) => {\n  getChannel(room).subs.add(f)\n  return f\n}\n\n/**\n * Unsubscribe from `publish` global events.\n *\n * @function\n * @param {string} room\n * @param {function(any, any):any} f\n */\nexport const unsubscribe = (room, f) => {\n  const channel = getChannel(room)\n  const unsubscribed = channel.subs.delete(f)\n  if (unsubscribed && channel.subs.size === 0) {\n    channel.bc.close()\n    channels.delete(room)\n  }\n  return unsubscribed\n}\n\n/**\n * Publish data to all subscribers (including subscribers on this tab)\n *\n * @function\n * @param {string} room\n * @param {any} data\n * @param {any} [origin]\n */\nexport const publish = (room, data, origin = null) => {\n  const c = getChannel(room)\n  c.bc.postMessage(data)\n  c.subs.forEach(sub => sub(data, origin))\n}\n","/**\n * Utility module to work with time.\n *\n * @module time\n */\n\nimport * as metric from './metric.js'\nimport * as math from './math.js'\n\n/**\n * Return current time.\n *\n * @return {Date}\n */\nexport const getDate = () => new Date()\n\n/**\n * Return current unix time.\n *\n * @return {number}\n */\nexport const getUnixTime = Date.now\n\n/**\n * Transform time (in ms) to a human readable format. E.g. 1100 => 1.1s. 60s => 1min. .001 => 10s.\n *\n * @param {number} d duration in milliseconds\n * @return {string} humanized approximation of time\n */\nexport const humanizeDuration = d => {\n  if (d < 60000) {\n    const p = metric.prefix(d, -1)\n    return math.round(p.n * 100) / 100 + p.prefix + 's'\n  }\n  d = math.floor(d / 1000)\n  const seconds = d % 60\n  const minutes = math.floor(d / 60) % 60\n  const hours = math.floor(d / 3600) % 24\n  const days = math.floor(d / 86400)\n  if (days > 0) {\n    return days + 'd' + ((hours > 0 || minutes > 30) ? ' ' + (minutes > 30 ? hours + 1 : hours) + 'h' : '')\n  }\n  if (hours > 0) {\n    /* c8 ignore next */\n    return hours + 'h' + ((minutes > 0 || seconds > 30) ? ' ' + (seconds > 30 ? minutes + 1 : minutes) + 'min' : '')\n  }\n  return minutes + 'min' + (seconds > 0 ? ' ' + seconds + 's' : '')\n}\n","/**\n * Common Math expressions.\n *\n * @module math\n */\n\nexport const floor = Math.floor\nexport const ceil = Math.ceil\nexport const abs = Math.abs\nexport const imul = Math.imul\nexport const round = Math.round\nexport const log10 = Math.log10\nexport const log2 = Math.log2\nexport const log = Math.log\nexport const sqrt = Math.sqrt\n\n/**\n * @function\n * @param {number} a\n * @param {number} b\n * @return {number} The sum of a and b\n */\nexport const add = (a, b) => a + b\n\n/**\n * @function\n * @param {number} a\n * @param {number} b\n * @return {number} The smaller element of a and b\n */\nexport const min = (a, b) => a < b ? a : b\n\n/**\n * @function\n * @param {number} a\n * @param {number} b\n * @return {number} The bigger element of a and b\n */\nexport const max = (a, b) => a > b ? a : b\n\nexport const isNaN = Number.isNaN\n\nexport const pow = Math.pow\n/**\n * Base 10 exponential function. Returns the value of 10 raised to the power of pow.\n *\n * @param {number} exp\n * @return {number}\n */\nexport const exp10 = exp => Math.pow(10, exp)\n\nexport const sign = Math.sign\n\n/**\n * @param {number} n\n * @return {boolean} Wether n is negative. This function also differentiates between -0 and +0\n */\nexport const isNegativeZero = n => n !== 0 ? n < 0 : 1 / n < 0\n","/* eslint-env browser */\n\n/**\n * Binary data constants.\n *\n * @module binary\n */\n\n/**\n * n-th bit activated.\n *\n * @type {number}\n */\nexport const BIT1 = 1\nexport const BIT2 = 2\nexport const BIT3 = 4\nexport const BIT4 = 8\nexport const BIT5 = 16\nexport const BIT6 = 32\nexport const BIT7 = 64\nexport const BIT8 = 128\nexport const BIT9 = 256\nexport const BIT10 = 512\nexport const BIT11 = 1024\nexport const BIT12 = 2048\nexport const BIT13 = 4096\nexport const BIT14 = 8192\nexport const BIT15 = 16384\nexport const BIT16 = 32768\nexport const BIT17 = 65536\nexport const BIT18 = 1 << 17\nexport const BIT19 = 1 << 18\nexport const BIT20 = 1 << 19\nexport const BIT21 = 1 << 20\nexport const BIT22 = 1 << 21\nexport const BIT23 = 1 << 22\nexport const BIT24 = 1 << 23\nexport const BIT25 = 1 << 24\nexport const BIT26 = 1 << 25\nexport const BIT27 = 1 << 26\nexport const BIT28 = 1 << 27\nexport const BIT29 = 1 << 28\nexport const BIT30 = 1 << 29\nexport const BIT31 = 1 << 30\nexport const BIT32 = 1 << 31\n\n/**\n * First n bits activated.\n *\n * @type {number}\n */\nexport const BITS0 = 0\nexport const BITS1 = 1\nexport const BITS2 = 3\nexport const BITS3 = 7\nexport const BITS4 = 15\nexport const BITS5 = 31\nexport const BITS6 = 63\nexport const BITS7 = 127\nexport const BITS8 = 255\nexport const BITS9 = 511\nexport const BITS10 = 1023\nexport const BITS11 = 2047\nexport const BITS12 = 4095\nexport const BITS13 = 8191\nexport const BITS14 = 16383\nexport const BITS15 = 32767\nexport const BITS16 = 65535\nexport const BITS17 = BIT18 - 1\nexport const BITS18 = BIT19 - 1\nexport const BITS19 = BIT20 - 1\nexport const BITS20 = BIT21 - 1\nexport const BITS21 = BIT22 - 1\nexport const BITS22 = BIT23 - 1\nexport const BITS23 = BIT24 - 1\nexport const BITS24 = BIT25 - 1\nexport const BITS25 = BIT26 - 1\nexport const BITS26 = BIT27 - 1\nexport const BITS27 = BIT28 - 1\nexport const BITS28 = BIT29 - 1\nexport const BITS29 = BIT30 - 1\nexport const BITS30 = BIT31 - 1\n/**\n * @type {number}\n */\nexport const BITS31 = 0x7FFFFFFF\n/**\n * @type {number}\n */\nexport const BITS32 = 0xFFFFFFFF\n","/**\n * Efficient schema-less binary encoding with support for variable length encoding.\n *\n * Use [lib0/encoding] with [lib0/decoding]. Every encoding function has a corresponding decoding function.\n *\n * Encodes numbers in little-endian order (least to most significant byte order)\n * and is compatible with Golang's binary encoding (https://golang.org/pkg/encoding/binary/)\n * which is also used in Protocol Buffers.\n *\n * ```js\n * // encoding step\n * const encoder = encoding.createEncoder()\n * encoding.writeVarUint(encoder, 256)\n * encoding.writeVarString(encoder, 'Hello world!')\n * const buf = encoding.toUint8Array(encoder)\n * ```\n *\n * ```js\n * // decoding step\n * const decoder = decoding.createDecoder(buf)\n * decoding.readVarUint(decoder) // => 256\n * decoding.readVarString(decoder) // => 'Hello world!'\n * decoding.hasContent(decoder) // => false - all data is read\n * ```\n *\n * @module encoding\n */\n\nimport * as math from './math.js'\nimport * as number from './number.js'\nimport * as binary from './binary.js'\nimport * as string from './string.js'\nimport * as array from './array.js'\n\n/**\n * A BinaryEncoder handles the encoding to an Uint8Array.\n */\nexport class Encoder {\n  constructor () {\n    this.cpos = 0\n    this.cbuf = new Uint8Array(100)\n    /**\n     * @type {Array<Uint8Array>}\n     */\n    this.bufs = []\n  }\n}\n\n/**\n * @function\n * @return {Encoder}\n */\nexport const createEncoder = () => new Encoder()\n\n/**\n * @param {function(Encoder):void} f\n */\nexport const encode = (f) => {\n  const encoder = createEncoder()\n  f(encoder)\n  return toUint8Array(encoder)\n}\n\n/**\n * The current length of the encoded data.\n *\n * @function\n * @param {Encoder} encoder\n * @return {number}\n */\nexport const length = encoder => {\n  let len = encoder.cpos\n  for (let i = 0; i < encoder.bufs.length; i++) {\n    len += encoder.bufs[i].length\n  }\n  return len\n}\n\n/**\n * Check whether encoder is empty.\n *\n * @function\n * @param {Encoder} encoder\n * @return {boolean}\n */\nexport const hasContent = encoder => encoder.cpos > 0 || encoder.bufs.length > 0\n\n/**\n * Transform to Uint8Array.\n *\n * @function\n * @param {Encoder} encoder\n * @return {Uint8Array} The created ArrayBuffer.\n */\nexport const toUint8Array = encoder => {\n  const uint8arr = new Uint8Array(length(encoder))\n  let curPos = 0\n  for (let i = 0; i < encoder.bufs.length; i++) {\n    const d = encoder.bufs[i]\n    uint8arr.set(d, curPos)\n    curPos += d.length\n  }\n  uint8arr.set(new Uint8Array(encoder.cbuf.buffer, 0, encoder.cpos), curPos)\n  return uint8arr\n}\n\n/**\n * Verify that it is possible to write `len` bytes wtihout checking. If\n * necessary, a new Buffer with the required length is attached.\n *\n * @param {Encoder} encoder\n * @param {number} len\n */\nexport const verifyLen = (encoder, len) => {\n  const bufferLen = encoder.cbuf.length\n  if (bufferLen - encoder.cpos < len) {\n    encoder.bufs.push(new Uint8Array(encoder.cbuf.buffer, 0, encoder.cpos))\n    encoder.cbuf = new Uint8Array(math.max(bufferLen, len) * 2)\n    encoder.cpos = 0\n  }\n}\n\n/**\n * Write one byte to the encoder.\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} num The byte that is to be encoded.\n */\nexport const write = (encoder, num) => {\n  const bufferLen = encoder.cbuf.length\n  if (encoder.cpos === bufferLen) {\n    encoder.bufs.push(encoder.cbuf)\n    encoder.cbuf = new Uint8Array(bufferLen * 2)\n    encoder.cpos = 0\n  }\n  encoder.cbuf[encoder.cpos++] = num\n}\n\n/**\n * Write one byte at a specific position.\n * Position must already be written (i.e. encoder.length > pos)\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} pos Position to which to write data\n * @param {number} num Unsigned 8-bit integer\n */\nexport const set = (encoder, pos, num) => {\n  let buffer = null\n  // iterate all buffers and adjust position\n  for (let i = 0; i < encoder.bufs.length && buffer === null; i++) {\n    const b = encoder.bufs[i]\n    if (pos < b.length) {\n      buffer = b // found buffer\n    } else {\n      pos -= b.length\n    }\n  }\n  if (buffer === null) {\n    // use current buffer\n    buffer = encoder.cbuf\n  }\n  buffer[pos] = num\n}\n\n/**\n * Write one byte as an unsigned integer.\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} num The number that is to be encoded.\n */\nexport const writeUint8 = write\n\n/**\n * Write one byte as an unsigned Integer at a specific location.\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} pos The location where the data will be written.\n * @param {number} num The number that is to be encoded.\n */\nexport const setUint8 = set\n\n/**\n * Write two bytes as an unsigned integer.\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} num The number that is to be encoded.\n */\nexport const writeUint16 = (encoder, num) => {\n  write(encoder, num & binary.BITS8)\n  write(encoder, (num >>> 8) & binary.BITS8)\n}\n/**\n * Write two bytes as an unsigned integer at a specific location.\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} pos The location where the data will be written.\n * @param {number} num The number that is to be encoded.\n */\nexport const setUint16 = (encoder, pos, num) => {\n  set(encoder, pos, num & binary.BITS8)\n  set(encoder, pos + 1, (num >>> 8) & binary.BITS8)\n}\n\n/**\n * Write two bytes as an unsigned integer\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} num The number that is to be encoded.\n */\nexport const writeUint32 = (encoder, num) => {\n  for (let i = 0; i < 4; i++) {\n    write(encoder, num & binary.BITS8)\n    num >>>= 8\n  }\n}\n\n/**\n * Write two bytes as an unsigned integer in big endian order.\n * (most significant byte first)\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} num The number that is to be encoded.\n */\nexport const writeUint32BigEndian = (encoder, num) => {\n  for (let i = 3; i >= 0; i--) {\n    write(encoder, (num >>> (8 * i)) & binary.BITS8)\n  }\n}\n\n/**\n * Write two bytes as an unsigned integer at a specific location.\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} pos The location where the data will be written.\n * @param {number} num The number that is to be encoded.\n */\nexport const setUint32 = (encoder, pos, num) => {\n  for (let i = 0; i < 4; i++) {\n    set(encoder, pos + i, num & binary.BITS8)\n    num >>>= 8\n  }\n}\n\n/**\n * Write a variable length unsigned integer. Max encodable integer is 2^53.\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} num The number that is to be encoded.\n */\nexport const writeVarUint = (encoder, num) => {\n  while (num > binary.BITS7) {\n    write(encoder, binary.BIT8 | (binary.BITS7 & num))\n    num = math.floor(num / 128) // shift >>> 7\n  }\n  write(encoder, binary.BITS7 & num)\n}\n\n/**\n * Write a variable length integer.\n *\n * We use the 7th bit instead for signaling that this is a negative number.\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} num The number that is to be encoded.\n */\nexport const writeVarInt = (encoder, num) => {\n  const isNegative = math.isNegativeZero(num)\n  if (isNegative) {\n    num = -num\n  }\n  //             |- whether to continue reading         |- whether is negative     |- number\n  write(encoder, (num > binary.BITS6 ? binary.BIT8 : 0) | (isNegative ? binary.BIT7 : 0) | (binary.BITS6 & num))\n  num = math.floor(num / 64) // shift >>> 6\n  // We don't need to consider the case of num === 0 so we can use a different\n  // pattern here than above.\n  while (num > 0) {\n    write(encoder, (num > binary.BITS7 ? binary.BIT8 : 0) | (binary.BITS7 & num))\n    num = math.floor(num / 128) // shift >>> 7\n  }\n}\n\n/**\n * A cache to store strings temporarily\n */\nconst _strBuffer = new Uint8Array(30000)\nconst _maxStrBSize = _strBuffer.length / 3\n\n/**\n * Write a variable length string.\n *\n * @function\n * @param {Encoder} encoder\n * @param {String} str The string that is to be encoded.\n */\nexport const _writeVarStringNative = (encoder, str) => {\n  if (str.length < _maxStrBSize) {\n    // We can encode the string into the existing buffer\n    /* c8 ignore next */\n    const written = string.utf8TextEncoder.encodeInto(str, _strBuffer).written || 0\n    writeVarUint(encoder, written)\n    for (let i = 0; i < written; i++) {\n      write(encoder, _strBuffer[i])\n    }\n  } else {\n    writeVarUint8Array(encoder, string.encodeUtf8(str))\n  }\n}\n\n/**\n * Write a variable length string.\n *\n * @function\n * @param {Encoder} encoder\n * @param {String} str The string that is to be encoded.\n */\nexport const _writeVarStringPolyfill = (encoder, str) => {\n  const encodedString = unescape(encodeURIComponent(str))\n  const len = encodedString.length\n  writeVarUint(encoder, len)\n  for (let i = 0; i < len; i++) {\n    write(encoder, /** @type {number} */ (encodedString.codePointAt(i)))\n  }\n}\n\n/**\n * Write a variable length string.\n *\n * @function\n * @param {Encoder} encoder\n * @param {String} str The string that is to be encoded.\n */\n/* c8 ignore next */\nexport const writeVarString = (string.utf8TextEncoder && /** @type {any} */ (string.utf8TextEncoder).encodeInto) ? _writeVarStringNative : _writeVarStringPolyfill\n\n/**\n * Write a string terminated by a special byte sequence. This is not very performant and is\n * generally discouraged. However, the resulting byte arrays are lexiographically ordered which\n * makes this a nice feature for databases.\n *\n * The string will be encoded using utf8 and then terminated and escaped using writeTerminatingUint8Array.\n *\n * @function\n * @param {Encoder} encoder\n * @param {String} str The string that is to be encoded.\n */\nexport const writeTerminatedString = (encoder, str) =>\n  writeTerminatedUint8Array(encoder, string.encodeUtf8(str))\n\n/**\n * Write a terminating Uint8Array. Note that this is not performant and is generally\n * discouraged. There are few situations when this is needed.\n *\n * We use 0x0 as a terminating character. 0x1 serves as an escape character for 0x0 and 0x1.\n *\n * Example: [0,1,2] is encoded to [1,0,1,1,2,0]. 0x0, and 0x1 needed to be escaped using 0x1. Then\n * the result is terminated using the 0x0 character.\n *\n * This is basically how many systems implement null terminated strings. However, we use an escape\n * character 0x1 to avoid issues and potenial attacks on our database (if this is used as a key\n * encoder for NoSql databases).\n *\n * @function\n * @param {Encoder} encoder\n * @param {Uint8Array} buf The string that is to be encoded.\n */\nexport const writeTerminatedUint8Array = (encoder, buf) => {\n  for (let i = 0; i < buf.length; i++) {\n    const b = buf[i]\n    if (b === 0 || b === 1) {\n      write(encoder, 1)\n    }\n    write(encoder, buf[i])\n  }\n  write(encoder, 0)\n}\n\n/**\n * Write the content of another Encoder.\n *\n * @TODO: can be improved!\n *        - Note: Should consider that when appending a lot of small Encoders, we should rather clone than referencing the old structure.\n *                Encoders start with a rather big initial buffer.\n *\n * @function\n * @param {Encoder} encoder The enUint8Arr\n * @param {Encoder} append The BinaryEncoder to be written.\n */\nexport const writeBinaryEncoder = (encoder, append) => writeUint8Array(encoder, toUint8Array(append))\n\n/**\n * Append fixed-length Uint8Array to the encoder.\n *\n * @function\n * @param {Encoder} encoder\n * @param {Uint8Array} uint8Array\n */\nexport const writeUint8Array = (encoder, uint8Array) => {\n  const bufferLen = encoder.cbuf.length\n  const cpos = encoder.cpos\n  const leftCopyLen = math.min(bufferLen - cpos, uint8Array.length)\n  const rightCopyLen = uint8Array.length - leftCopyLen\n  encoder.cbuf.set(uint8Array.subarray(0, leftCopyLen), cpos)\n  encoder.cpos += leftCopyLen\n  if (rightCopyLen > 0) {\n    // Still something to write, write right half..\n    // Append new buffer\n    encoder.bufs.push(encoder.cbuf)\n    // must have at least size of remaining buffer\n    encoder.cbuf = new Uint8Array(math.max(bufferLen * 2, rightCopyLen))\n    // copy array\n    encoder.cbuf.set(uint8Array.subarray(leftCopyLen))\n    encoder.cpos = rightCopyLen\n  }\n}\n\n/**\n * Append an Uint8Array to Encoder.\n *\n * @function\n * @param {Encoder} encoder\n * @param {Uint8Array} uint8Array\n */\nexport const writeVarUint8Array = (encoder, uint8Array) => {\n  writeVarUint(encoder, uint8Array.byteLength)\n  writeUint8Array(encoder, uint8Array)\n}\n\n/**\n * Create an DataView of the next `len` bytes. Use it to write data after\n * calling this function.\n *\n * ```js\n * // write float32 using DataView\n * const dv = writeOnDataView(encoder, 4)\n * dv.setFloat32(0, 1.1)\n * // read float32 using DataView\n * const dv = readFromDataView(encoder, 4)\n * dv.getFloat32(0) // => 1.100000023841858 (leaving it to the reader to find out why this is the correct result)\n * ```\n *\n * @param {Encoder} encoder\n * @param {number} len\n * @return {DataView}\n */\nexport const writeOnDataView = (encoder, len) => {\n  verifyLen(encoder, len)\n  const dview = new DataView(encoder.cbuf.buffer, encoder.cpos, len)\n  encoder.cpos += len\n  return dview\n}\n\n/**\n * @param {Encoder} encoder\n * @param {number} num\n */\nexport const writeFloat32 = (encoder, num) => writeOnDataView(encoder, 4).setFloat32(0, num, false)\n\n/**\n * @param {Encoder} encoder\n * @param {number} num\n */\nexport const writeFloat64 = (encoder, num) => writeOnDataView(encoder, 8).setFloat64(0, num, false)\n\n/**\n * @param {Encoder} encoder\n * @param {bigint} num\n */\nexport const writeBigInt64 = (encoder, num) => /** @type {any} */ (writeOnDataView(encoder, 8)).setBigInt64(0, num, false)\n\n/**\n * @param {Encoder} encoder\n * @param {bigint} num\n */\nexport const writeBigUint64 = (encoder, num) => /** @type {any} */ (writeOnDataView(encoder, 8)).setBigUint64(0, num, false)\n\nconst floatTestBed = new DataView(new ArrayBuffer(4))\n/**\n * Check if a number can be encoded as a 32 bit float.\n *\n * @param {number} num\n * @return {boolean}\n */\nconst isFloat32 = num => {\n  floatTestBed.setFloat32(0, num)\n  return floatTestBed.getFloat32(0) === num\n}\n\n/**\n * Encode data with efficient binary format.\n *\n * Differences to JSON:\n *  Transforms data to a binary format (not to a string)\n *  Encodes undefined, NaN, and ArrayBuffer (these can't be represented in JSON)\n *  Numbers are efficiently encoded either as a variable length integer, as a\n *   32 bit float, as a 64 bit float, or as a 64 bit bigint.\n *\n * Encoding table:\n *\n * | Data Type           | Prefix   | Encoding Method    | Comment |\n * | ------------------- | -------- | ------------------ | ------- |\n * | undefined           | 127      |                    | Functions, symbol, and everything that cannot be identified is encoded as undefined |\n * | null                | 126      |                    | |\n * | integer             | 125      | writeVarInt        | Only encodes 32 bit signed integers |\n * | float32             | 124      | writeFloat32       | |\n * | float64             | 123      | writeFloat64       | |\n * | bigint              | 122      | writeBigInt64      | |\n * | boolean (false)     | 121      |                    | True and false are different data types so we save the following byte |\n * | boolean (true)      | 120      |                    | - 0b01111000 so the last bit determines whether true or false |\n * | string              | 119      | writeVarString     | |\n * | object<string,any>  | 118      | custom             | Writes {length} then {length} key-value pairs |\n * | array<any>          | 117      | custom             | Writes {length} then {length} json values |\n * | Uint8Array          | 116      | writeVarUint8Array | We use Uint8Array for any kind of binary data |\n *\n * Reasons for the decreasing prefix:\n * We need the first bit for extendability (later we may want to encode the\n * prefix with writeVarUint). The remaining 7 bits are divided as follows:\n * [0-30]   the beginning of the data range is used for custom purposes\n *          (defined by the function that uses this library)\n * [31-127] the end of the data range is used for data encoding by\n *          lib0/encoding.js\n *\n * @param {Encoder} encoder\n * @param {undefined|null|number|bigint|boolean|string|Object<string,any>|Array<any>|Uint8Array} data\n */\nexport const writeAny = (encoder, data) => {\n  switch (typeof data) {\n    case 'string':\n      // TYPE 119: STRING\n      write(encoder, 119)\n      writeVarString(encoder, data)\n      break\n    case 'number':\n      if (number.isInteger(data) && math.abs(data) <= binary.BITS31) {\n        // TYPE 125: INTEGER\n        write(encoder, 125)\n        writeVarInt(encoder, data)\n      } else if (isFloat32(data)) {\n        // TYPE 124: FLOAT32\n        write(encoder, 124)\n        writeFloat32(encoder, data)\n      } else {\n        // TYPE 123: FLOAT64\n        write(encoder, 123)\n        writeFloat64(encoder, data)\n      }\n      break\n    case 'bigint':\n      // TYPE 122: BigInt\n      write(encoder, 122)\n      writeBigInt64(encoder, data)\n      break\n    case 'object':\n      if (data === null) {\n        // TYPE 126: null\n        write(encoder, 126)\n      } else if (array.isArray(data)) {\n        // TYPE 117: Array\n        write(encoder, 117)\n        writeVarUint(encoder, data.length)\n        for (let i = 0; i < data.length; i++) {\n          writeAny(encoder, data[i])\n        }\n      } else if (data instanceof Uint8Array) {\n        // TYPE 116: ArrayBuffer\n        write(encoder, 116)\n        writeVarUint8Array(encoder, data)\n      } else {\n        // TYPE 118: Object\n        write(encoder, 118)\n        const keys = Object.keys(data)\n        writeVarUint(encoder, keys.length)\n        for (let i = 0; i < keys.length; i++) {\n          const key = keys[i]\n          writeVarString(encoder, key)\n          writeAny(encoder, data[key])\n        }\n      }\n      break\n    case 'boolean':\n      // TYPE 120/121: boolean (true/false)\n      write(encoder, data ? 120 : 121)\n      break\n    default:\n      // TYPE 127: undefined\n      write(encoder, 127)\n  }\n}\n\n/**\n * Now come a few stateful encoder that have their own classes.\n */\n\n/**\n * Basic Run Length Encoder - a basic compression implementation.\n *\n * Encodes [1,1,1,7] to [1,3,7,1] (3 times 1, 1 time 7). This encoder might do more harm than good if there are a lot of values that are not repeated.\n *\n * It was originally used for image compression. Cool .. article http://csbruce.com/cbm/transactor/pdfs/trans_v7_i06.pdf\n *\n * @note T must not be null!\n *\n * @template T\n */\nexport class RleEncoder extends Encoder {\n  /**\n   * @param {function(Encoder, T):void} writer\n   */\n  constructor (writer) {\n    super()\n    /**\n     * The writer\n     */\n    this.w = writer\n    /**\n     * Current state\n     * @type {T|null}\n     */\n    this.s = null\n    this.count = 0\n  }\n\n  /**\n   * @param {T} v\n   */\n  write (v) {\n    if (this.s === v) {\n      this.count++\n    } else {\n      if (this.count > 0) {\n        // flush counter, unless this is the first value (count = 0)\n        writeVarUint(this, this.count - 1) // since count is always > 0, we can decrement by one. non-standard encoding ftw\n      }\n      this.count = 1\n      // write first value\n      this.w(this, v)\n      this.s = v\n    }\n  }\n}\n\n/**\n * Basic diff decoder using variable length encoding.\n *\n * Encodes the values [3, 1100, 1101, 1050, 0] to [3, 1097, 1, -51, -1050] using writeVarInt.\n */\nexport class IntDiffEncoder extends Encoder {\n  /**\n   * @param {number} start\n   */\n  constructor (start) {\n    super()\n    /**\n     * Current state\n     * @type {number}\n     */\n    this.s = start\n  }\n\n  /**\n   * @param {number} v\n   */\n  write (v) {\n    writeVarInt(this, v - this.s)\n    this.s = v\n  }\n}\n\n/**\n * A combination of IntDiffEncoder and RleEncoder.\n *\n * Basically first writes the IntDiffEncoder and then counts duplicate diffs using RleEncoding.\n *\n * Encodes the values [1,1,1,2,3,4,5,6] as [1,1,0,2,1,5] (RLE([1,0,0,1,1,1,1,1])  RleIntDiff[1,1,0,2,1,5])\n */\nexport class RleIntDiffEncoder extends Encoder {\n  /**\n   * @param {number} start\n   */\n  constructor (start) {\n    super()\n    /**\n     * Current state\n     * @type {number}\n     */\n    this.s = start\n    this.count = 0\n  }\n\n  /**\n   * @param {number} v\n   */\n  write (v) {\n    if (this.s === v && this.count > 0) {\n      this.count++\n    } else {\n      if (this.count > 0) {\n        // flush counter, unless this is the first value (count = 0)\n        writeVarUint(this, this.count - 1) // since count is always > 0, we can decrement by one. non-standard encoding ftw\n      }\n      this.count = 1\n      // write first value\n      writeVarInt(this, v - this.s)\n      this.s = v\n    }\n  }\n}\n\n/**\n * @param {UintOptRleEncoder} encoder\n */\nconst flushUintOptRleEncoder = encoder => {\n  if (encoder.count > 0) {\n    // flush counter, unless this is the first value (count = 0)\n    // case 1: just a single value. set sign to positive\n    // case 2: write several values. set sign to negative to indicate that there is a length coming\n    writeVarInt(encoder.encoder, encoder.count === 1 ? encoder.s : -encoder.s)\n    if (encoder.count > 1) {\n      writeVarUint(encoder.encoder, encoder.count - 2) // since count is always > 1, we can decrement by one. non-standard encoding ftw\n    }\n  }\n}\n\n/**\n * Optimized Rle encoder that does not suffer from the mentioned problem of the basic Rle encoder.\n *\n * Internally uses VarInt encoder to write unsigned integers. If the input occurs multiple times, we write\n * write it as a negative number. The UintOptRleDecoder then understands that it needs to read a count.\n *\n * Encodes [1,2,3,3,3] as [1,2,-3,3] (once 1, once 2, three times 3)\n */\nexport class UintOptRleEncoder {\n  constructor () {\n    this.encoder = new Encoder()\n    /**\n     * @type {number}\n     */\n    this.s = 0\n    this.count = 0\n  }\n\n  /**\n   * @param {number} v\n   */\n  write (v) {\n    if (this.s === v) {\n      this.count++\n    } else {\n      flushUintOptRleEncoder(this)\n      this.count = 1\n      this.s = v\n    }\n  }\n\n  /**\n   * Flush the encoded state and transform this to a Uint8Array.\n   *\n   * Note that this should only be called once.\n   */\n  toUint8Array () {\n    flushUintOptRleEncoder(this)\n    return toUint8Array(this.encoder)\n  }\n}\n\n/**\n * Increasing Uint Optimized RLE Encoder\n *\n * The RLE encoder counts the number of same occurences of the same value.\n * The IncUintOptRle encoder counts if the value increases.\n * I.e. 7, 8, 9, 10 will be encoded as [-7, 4]. 1, 3, 5 will be encoded\n * as [1, 3, 5].\n */\nexport class IncUintOptRleEncoder {\n  constructor () {\n    this.encoder = new Encoder()\n    /**\n     * @type {number}\n     */\n    this.s = 0\n    this.count = 0\n  }\n\n  /**\n   * @param {number} v\n   */\n  write (v) {\n    if (this.s + this.count === v) {\n      this.count++\n    } else {\n      flushUintOptRleEncoder(this)\n      this.count = 1\n      this.s = v\n    }\n  }\n\n  /**\n   * Flush the encoded state and transform this to a Uint8Array.\n   *\n   * Note that this should only be called once.\n   */\n  toUint8Array () {\n    flushUintOptRleEncoder(this)\n    return toUint8Array(this.encoder)\n  }\n}\n\n/**\n * @param {IntDiffOptRleEncoder} encoder\n */\nconst flushIntDiffOptRleEncoder = encoder => {\n  if (encoder.count > 0) {\n    //          31 bit making up the diff | wether to write the counter\n    // const encodedDiff = encoder.diff << 1 | (encoder.count === 1 ? 0 : 1)\n    const encodedDiff = encoder.diff * 2 + (encoder.count === 1 ? 0 : 1)\n    // flush counter, unless this is the first value (count = 0)\n    // case 1: just a single value. set first bit to positive\n    // case 2: write several values. set first bit to negative to indicate that there is a length coming\n    writeVarInt(encoder.encoder, encodedDiff)\n    if (encoder.count > 1) {\n      writeVarUint(encoder.encoder, encoder.count - 2) // since count is always > 1, we can decrement by one. non-standard encoding ftw\n    }\n  }\n}\n\n/**\n * A combination of the IntDiffEncoder and the UintOptRleEncoder.\n *\n * The count approach is similar to the UintDiffOptRleEncoder, but instead of using the negative bitflag, it encodes\n * in the LSB whether a count is to be read. Therefore this Encoder only supports 31 bit integers!\n *\n * Encodes [1, 2, 3, 2] as [3, 1, 6, -1] (more specifically [(1 << 1) | 1, (3 << 0) | 0, -1])\n *\n * Internally uses variable length encoding. Contrary to normal UintVar encoding, the first byte contains:\n * * 1 bit that denotes whether the next value is a count (LSB)\n * * 1 bit that denotes whether this value is negative (MSB - 1)\n * * 1 bit that denotes whether to continue reading the variable length integer (MSB)\n *\n * Therefore, only five bits remain to encode diff ranges.\n *\n * Use this Encoder only when appropriate. In most cases, this is probably a bad idea.\n */\nexport class IntDiffOptRleEncoder {\n  constructor () {\n    this.encoder = new Encoder()\n    /**\n     * @type {number}\n     */\n    this.s = 0\n    this.count = 0\n    this.diff = 0\n  }\n\n  /**\n   * @param {number} v\n   */\n  write (v) {\n    if (this.diff === v - this.s) {\n      this.s = v\n      this.count++\n    } else {\n      flushIntDiffOptRleEncoder(this)\n      this.count = 1\n      this.diff = v - this.s\n      this.s = v\n    }\n  }\n\n  /**\n   * Flush the encoded state and transform this to a Uint8Array.\n   *\n   * Note that this should only be called once.\n   */\n  toUint8Array () {\n    flushIntDiffOptRleEncoder(this)\n    return toUint8Array(this.encoder)\n  }\n}\n\n/**\n * Optimized String Encoder.\n *\n * Encoding many small strings in a simple Encoder is not very efficient. The function call to decode a string takes some time and creates references that must be eventually deleted.\n * In practice, when decoding several million small strings, the GC will kick in more and more often to collect orphaned string objects (or maybe there is another reason?).\n *\n * This string encoder solves the above problem. All strings are concatenated and written as a single string using a single encoding call.\n *\n * The lengths are encoded using a UintOptRleEncoder.\n */\nexport class StringEncoder {\n  constructor () {\n    /**\n     * @type {Array<string>}\n     */\n    this.sarr = []\n    this.s = ''\n    this.lensE = new UintOptRleEncoder()\n  }\n\n  /**\n   * @param {string} string\n   */\n  write (string) {\n    this.s += string\n    if (this.s.length > 19) {\n      this.sarr.push(this.s)\n      this.s = ''\n    }\n    this.lensE.write(string.length)\n  }\n\n  toUint8Array () {\n    const encoder = new Encoder()\n    this.sarr.push(this.s)\n    this.s = ''\n    writeVarString(encoder, this.sarr.join(''))\n    writeUint8Array(encoder, this.lensE.toUint8Array())\n    return toUint8Array(encoder)\n  }\n}\n","/**\n * Utility helpers for working with numbers.\n *\n * @module number\n */\n\nimport * as math from './math.js'\nimport * as binary from './binary.js'\n\nexport const MAX_SAFE_INTEGER = Number.MAX_SAFE_INTEGER\nexport const MIN_SAFE_INTEGER = Number.MIN_SAFE_INTEGER\n\nexport const LOWEST_INT32 = 1 << 31\nexport const HIGHEST_INT32 = binary.BITS31\nexport const HIGHEST_UINT32 = binary.BITS32\n\n/* c8 ignore next */\nexport const isInteger = Number.isInteger || (num => typeof num === 'number' && isFinite(num) && math.floor(num) === num)\nexport const isNaN = Number.isNaN\nexport const parseInt = Number.parseInt\n\n/**\n * Count the number of \"1\" bits in an unsigned 32bit number.\n *\n * Super fun bitcount algorithm by Brian Kernighan.\n *\n * @param {number} n\n */\nexport const countBits = n => {\n  n &= binary.BITS32\n  let count = 0\n  while (n) {\n    n &= (n - 1)\n    count++\n  }\n  return count\n}\n","/**\n * Error helpers.\n *\n * @module error\n */\n\n/**\n * @param {string} s\n * @return {Error}\n */\n/* c8 ignore next */\nexport const create = s => new Error(s)\n\n/**\n * @throws {Error}\n * @return {never}\n */\n/* c8 ignore next 3 */\nexport const methodUnimplemented = () => {\n  throw create('Method unimplemented')\n}\n\n/**\n * @throws {Error}\n * @return {never}\n */\n/* c8 ignore next 3 */\nexport const unexpectedCase = () => {\n  throw create('Unexpected case')\n}\n","/**\n * Efficient schema-less binary decoding with support for variable length encoding.\n *\n * Use [lib0/decoding] with [lib0/encoding]. Every encoding function has a corresponding decoding function.\n *\n * Encodes numbers in little-endian order (least to most significant byte order)\n * and is compatible with Golang's binary encoding (https://golang.org/pkg/encoding/binary/)\n * which is also used in Protocol Buffers.\n *\n * ```js\n * // encoding step\n * const encoder = encoding.createEncoder()\n * encoding.writeVarUint(encoder, 256)\n * encoding.writeVarString(encoder, 'Hello world!')\n * const buf = encoding.toUint8Array(encoder)\n * ```\n *\n * ```js\n * // decoding step\n * const decoder = decoding.createDecoder(buf)\n * decoding.readVarUint(decoder) // => 256\n * decoding.readVarString(decoder) // => 'Hello world!'\n * decoding.hasContent(decoder) // => false - all data is read\n * ```\n *\n * @module decoding\n */\n\nimport * as binary from './binary.js'\nimport * as math from './math.js'\nimport * as number from './number.js'\nimport * as string from './string.js'\nimport * as error from './error.js'\nimport * as encoding from './encoding.js'\n\nconst errorUnexpectedEndOfArray = error.create('Unexpected end of array')\nconst errorIntegerOutOfRange = error.create('Integer out of Range')\n\n/**\n * A Decoder handles the decoding of an Uint8Array.\n */\nexport class Decoder {\n  /**\n   * @param {Uint8Array} uint8Array Binary data to decode\n   */\n  constructor (uint8Array) {\n    /**\n     * Decoding target.\n     *\n     * @type {Uint8Array}\n     */\n    this.arr = uint8Array\n    /**\n     * Current decoding position.\n     *\n     * @type {number}\n     */\n    this.pos = 0\n  }\n}\n\n/**\n * @function\n * @param {Uint8Array} uint8Array\n * @return {Decoder}\n */\nexport const createDecoder = uint8Array => new Decoder(uint8Array)\n\n/**\n * @function\n * @param {Decoder} decoder\n * @return {boolean}\n */\nexport const hasContent = decoder => decoder.pos !== decoder.arr.length\n\n/**\n * Clone a decoder instance.\n * Optionally set a new position parameter.\n *\n * @function\n * @param {Decoder} decoder The decoder instance\n * @param {number} [newPos] Defaults to current position\n * @return {Decoder} A clone of `decoder`\n */\nexport const clone = (decoder, newPos = decoder.pos) => {\n  const _decoder = createDecoder(decoder.arr)\n  _decoder.pos = newPos\n  return _decoder\n}\n\n/**\n * Create an Uint8Array view of the next `len` bytes and advance the position by `len`.\n *\n * Important: The Uint8Array still points to the underlying ArrayBuffer. Make sure to discard the result as soon as possible to prevent any memory leaks.\n *            Use `buffer.copyUint8Array` to copy the result into a new Uint8Array.\n *\n * @function\n * @param {Decoder} decoder The decoder instance\n * @param {number} len The length of bytes to read\n * @return {Uint8Array}\n */\nexport const readUint8Array = (decoder, len) => {\n  const view = new Uint8Array(decoder.arr.buffer, decoder.pos + decoder.arr.byteOffset, len)\n  decoder.pos += len\n  return view\n}\n\n/**\n * Read variable length Uint8Array.\n *\n * Important: The Uint8Array still points to the underlying ArrayBuffer. Make sure to discard the result as soon as possible to prevent any memory leaks.\n *            Use `buffer.copyUint8Array` to copy the result into a new Uint8Array.\n *\n * @function\n * @param {Decoder} decoder\n * @return {Uint8Array}\n */\nexport const readVarUint8Array = decoder => readUint8Array(decoder, readVarUint(decoder))\n\n/**\n * Read the rest of the content as an ArrayBuffer\n * @function\n * @param {Decoder} decoder\n * @return {Uint8Array}\n */\nexport const readTailAsUint8Array = decoder => readUint8Array(decoder, decoder.arr.length - decoder.pos)\n\n/**\n * Skip one byte, jump to the next position.\n * @function\n * @param {Decoder} decoder The decoder instance\n * @return {number} The next position\n */\nexport const skip8 = decoder => decoder.pos++\n\n/**\n * Read one byte as unsigned integer.\n * @function\n * @param {Decoder} decoder The decoder instance\n * @return {number} Unsigned 8-bit integer\n */\nexport const readUint8 = decoder => decoder.arr[decoder.pos++]\n\n/**\n * Read 2 bytes as unsigned integer.\n *\n * @function\n * @param {Decoder} decoder\n * @return {number} An unsigned integer.\n */\nexport const readUint16 = decoder => {\n  const uint =\n    decoder.arr[decoder.pos] +\n    (decoder.arr[decoder.pos + 1] << 8)\n  decoder.pos += 2\n  return uint\n}\n\n/**\n * Read 4 bytes as unsigned integer.\n *\n * @function\n * @param {Decoder} decoder\n * @return {number} An unsigned integer.\n */\nexport const readUint32 = decoder => {\n  const uint =\n    (decoder.arr[decoder.pos] +\n    (decoder.arr[decoder.pos + 1] << 8) +\n    (decoder.arr[decoder.pos + 2] << 16) +\n    (decoder.arr[decoder.pos + 3] << 24)) >>> 0\n  decoder.pos += 4\n  return uint\n}\n\n/**\n * Read 4 bytes as unsigned integer in big endian order.\n * (most significant byte first)\n *\n * @function\n * @param {Decoder} decoder\n * @return {number} An unsigned integer.\n */\nexport const readUint32BigEndian = decoder => {\n  const uint =\n    (decoder.arr[decoder.pos + 3] +\n    (decoder.arr[decoder.pos + 2] << 8) +\n    (decoder.arr[decoder.pos + 1] << 16) +\n    (decoder.arr[decoder.pos] << 24)) >>> 0\n  decoder.pos += 4\n  return uint\n}\n\n/**\n * Look ahead without incrementing the position\n * to the next byte and read it as unsigned integer.\n *\n * @function\n * @param {Decoder} decoder\n * @return {number} An unsigned integer.\n */\nexport const peekUint8 = decoder => decoder.arr[decoder.pos]\n\n/**\n * Look ahead without incrementing the position\n * to the next byte and read it as unsigned integer.\n *\n * @function\n * @param {Decoder} decoder\n * @return {number} An unsigned integer.\n */\nexport const peekUint16 = decoder =>\n  decoder.arr[decoder.pos] +\n  (decoder.arr[decoder.pos + 1] << 8)\n\n/**\n * Look ahead without incrementing the position\n * to the next byte and read it as unsigned integer.\n *\n * @function\n * @param {Decoder} decoder\n * @return {number} An unsigned integer.\n */\nexport const peekUint32 = decoder => (\n  decoder.arr[decoder.pos] +\n  (decoder.arr[decoder.pos + 1] << 8) +\n  (decoder.arr[decoder.pos + 2] << 16) +\n  (decoder.arr[decoder.pos + 3] << 24)\n) >>> 0\n\n/**\n * Read unsigned integer (32bit) with variable length.\n * 1/8th of the storage is used as encoding overhead.\n *  * numbers < 2^7 is stored in one bytlength\n *  * numbers < 2^14 is stored in two bylength\n *\n * @function\n * @param {Decoder} decoder\n * @return {number} An unsigned integer.length\n */\nexport const readVarUint = decoder => {\n  let num = 0\n  let mult = 1\n  const len = decoder.arr.length\n  while (decoder.pos < len) {\n    const r = decoder.arr[decoder.pos++]\n    // num = num | ((r & binary.BITS7) << len)\n    num = num + (r & binary.BITS7) * mult // shift $r << (7*#iterations) and add it to num\n    mult *= 128 // next iteration, shift 7 \"more\" to the left\n    if (r < binary.BIT8) {\n      return num\n    }\n    /* c8 ignore start */\n    if (num > number.MAX_SAFE_INTEGER) {\n      throw errorIntegerOutOfRange\n    }\n    /* c8 ignore stop */\n  }\n  throw errorUnexpectedEndOfArray\n}\n\n/**\n * Read signed integer (32bit) with variable length.\n * 1/8th of the storage is used as encoding overhead.\n *  * numbers < 2^7 is stored in one bytlength\n *  * numbers < 2^14 is stored in two bylength\n * @todo This should probably create the inverse ~num if number is negative - but this would be a breaking change.\n *\n * @function\n * @param {Decoder} decoder\n * @return {number} An unsigned integer.length\n */\nexport const readVarInt = decoder => {\n  let r = decoder.arr[decoder.pos++]\n  let num = r & binary.BITS6\n  let mult = 64\n  const sign = (r & binary.BIT7) > 0 ? -1 : 1\n  if ((r & binary.BIT8) === 0) {\n    // don't continue reading\n    return sign * num\n  }\n  const len = decoder.arr.length\n  while (decoder.pos < len) {\n    r = decoder.arr[decoder.pos++]\n    // num = num | ((r & binary.BITS7) << len)\n    num = num + (r & binary.BITS7) * mult\n    mult *= 128\n    if (r < binary.BIT8) {\n      return sign * num\n    }\n    /* c8 ignore start */\n    if (num > number.MAX_SAFE_INTEGER) {\n      throw errorIntegerOutOfRange\n    }\n    /* c8 ignore stop */\n  }\n  throw errorUnexpectedEndOfArray\n}\n\n/**\n * Look ahead and read varUint without incrementing position\n *\n * @function\n * @param {Decoder} decoder\n * @return {number}\n */\nexport const peekVarUint = decoder => {\n  const pos = decoder.pos\n  const s = readVarUint(decoder)\n  decoder.pos = pos\n  return s\n}\n\n/**\n * Look ahead and read varUint without incrementing position\n *\n * @function\n * @param {Decoder} decoder\n * @return {number}\n */\nexport const peekVarInt = decoder => {\n  const pos = decoder.pos\n  const s = readVarInt(decoder)\n  decoder.pos = pos\n  return s\n}\n\n/**\n * We don't test this function anymore as we use native decoding/encoding by default now.\n * Better not modify this anymore..\n *\n * Transforming utf8 to a string is pretty expensive. The code performs 10x better\n * when String.fromCodePoint is fed with all characters as arguments.\n * But most environments have a maximum number of arguments per functions.\n * For effiency reasons we apply a maximum of 10000 characters at once.\n *\n * @function\n * @param {Decoder} decoder\n * @return {String} The read String.\n */\n/* c8 ignore start */\nexport const _readVarStringPolyfill = decoder => {\n  let remainingLen = readVarUint(decoder)\n  if (remainingLen === 0) {\n    return ''\n  } else {\n    let encodedString = String.fromCodePoint(readUint8(decoder)) // remember to decrease remainingLen\n    if (--remainingLen < 100) { // do not create a Uint8Array for small strings\n      while (remainingLen--) {\n        encodedString += String.fromCodePoint(readUint8(decoder))\n      }\n    } else {\n      while (remainingLen > 0) {\n        const nextLen = remainingLen < 10000 ? remainingLen : 10000\n        // this is dangerous, we create a fresh array view from the existing buffer\n        const bytes = decoder.arr.subarray(decoder.pos, decoder.pos + nextLen)\n        decoder.pos += nextLen\n        // Starting with ES5.1 we can supply a generic array-like object as arguments\n        encodedString += String.fromCodePoint.apply(null, /** @type {any} */ (bytes))\n        remainingLen -= nextLen\n      }\n    }\n    return decodeURIComponent(escape(encodedString))\n  }\n}\n/* c8 ignore stop */\n\n/**\n * @function\n * @param {Decoder} decoder\n * @return {String} The read String\n */\nexport const _readVarStringNative = decoder =>\n  /** @type any */ (string.utf8TextDecoder).decode(readVarUint8Array(decoder))\n\n/**\n * Read string of variable length\n * * varUint is used to store the length of the string\n *\n * @function\n * @param {Decoder} decoder\n * @return {String} The read String\n *\n */\n/* c8 ignore next */\nexport const readVarString = string.utf8TextDecoder ? _readVarStringNative : _readVarStringPolyfill\n\n/**\n * @param {Decoder} decoder\n * @return {Uint8Array}\n */\nexport const readTerminatedUint8Array = decoder => {\n  const encoder = encoding.createEncoder()\n  let b\n  while (true) {\n    b = readUint8(decoder)\n    if (b === 0) {\n      return encoding.toUint8Array(encoder)\n    }\n    if (b === 1) {\n      b = readUint8(decoder)\n    }\n    encoding.write(encoder, b)\n  }\n}\n\n/**\n * @param {Decoder} decoder\n * @return {string}\n */\nexport const readTerminatedString = decoder => string.decodeUtf8(readTerminatedUint8Array(decoder))\n\n/**\n * Look ahead and read varString without incrementing position\n *\n * @function\n * @param {Decoder} decoder\n * @return {string}\n */\nexport const peekVarString = decoder => {\n  const pos = decoder.pos\n  const s = readVarString(decoder)\n  decoder.pos = pos\n  return s\n}\n\n/**\n * @param {Decoder} decoder\n * @param {number} len\n * @return {DataView}\n */\nexport const readFromDataView = (decoder, len) => {\n  const dv = new DataView(decoder.arr.buffer, decoder.arr.byteOffset + decoder.pos, len)\n  decoder.pos += len\n  return dv\n}\n\n/**\n * @param {Decoder} decoder\n */\nexport const readFloat32 = decoder => readFromDataView(decoder, 4).getFloat32(0, false)\n\n/**\n * @param {Decoder} decoder\n */\nexport const readFloat64 = decoder => readFromDataView(decoder, 8).getFloat64(0, false)\n\n/**\n * @param {Decoder} decoder\n */\nexport const readBigInt64 = decoder => /** @type {any} */ (readFromDataView(decoder, 8)).getBigInt64(0, false)\n\n/**\n * @param {Decoder} decoder\n */\nexport const readBigUint64 = decoder => /** @type {any} */ (readFromDataView(decoder, 8)).getBigUint64(0, false)\n\n/**\n * @type {Array<function(Decoder):any>}\n */\nconst readAnyLookupTable = [\n  decoder => undefined, // CASE 127: undefined\n  decoder => null, // CASE 126: null\n  readVarInt, // CASE 125: integer\n  readFloat32, // CASE 124: float32\n  readFloat64, // CASE 123: float64\n  readBigInt64, // CASE 122: bigint\n  decoder => false, // CASE 121: boolean (false)\n  decoder => true, // CASE 120: boolean (true)\n  readVarString, // CASE 119: string\n  decoder => { // CASE 118: object<string,any>\n    const len = readVarUint(decoder)\n    /**\n     * @type {Object<string,any>}\n     */\n    const obj = {}\n    for (let i = 0; i < len; i++) {\n      const key = readVarString(decoder)\n      obj[key] = readAny(decoder)\n    }\n    return obj\n  },\n  decoder => { // CASE 117: array<any>\n    const len = readVarUint(decoder)\n    const arr = []\n    for (let i = 0; i < len; i++) {\n      arr.push(readAny(decoder))\n    }\n    return arr\n  },\n  readVarUint8Array // CASE 116: Uint8Array\n]\n\n/**\n * @param {Decoder} decoder\n */\nexport const readAny = decoder => readAnyLookupTable[127 - readUint8(decoder)](decoder)\n\n/**\n * T must not be null.\n *\n * @template T\n */\nexport class RleDecoder extends Decoder {\n  /**\n   * @param {Uint8Array} uint8Array\n   * @param {function(Decoder):T} reader\n   */\n  constructor (uint8Array, reader) {\n    super(uint8Array)\n    /**\n     * The reader\n     */\n    this.reader = reader\n    /**\n     * Current state\n     * @type {T|null}\n     */\n    this.s = null\n    this.count = 0\n  }\n\n  read () {\n    if (this.count === 0) {\n      this.s = this.reader(this)\n      if (hasContent(this)) {\n        this.count = readVarUint(this) + 1 // see encoder implementation for the reason why this is incremented\n      } else {\n        this.count = -1 // read the current value forever\n      }\n    }\n    this.count--\n    return /** @type {T} */ (this.s)\n  }\n}\n\nexport class IntDiffDecoder extends Decoder {\n  /**\n   * @param {Uint8Array} uint8Array\n   * @param {number} start\n   */\n  constructor (uint8Array, start) {\n    super(uint8Array)\n    /**\n     * Current state\n     * @type {number}\n     */\n    this.s = start\n  }\n\n  /**\n   * @return {number}\n   */\n  read () {\n    this.s += readVarInt(this)\n    return this.s\n  }\n}\n\nexport class RleIntDiffDecoder extends Decoder {\n  /**\n   * @param {Uint8Array} uint8Array\n   * @param {number} start\n   */\n  constructor (uint8Array, start) {\n    super(uint8Array)\n    /**\n     * Current state\n     * @type {number}\n     */\n    this.s = start\n    this.count = 0\n  }\n\n  /**\n   * @return {number}\n   */\n  read () {\n    if (this.count === 0) {\n      this.s += readVarInt(this)\n      if (hasContent(this)) {\n        this.count = readVarUint(this) + 1 // see encoder implementation for the reason why this is incremented\n      } else {\n        this.count = -1 // read the current value forever\n      }\n    }\n    this.count--\n    return /** @type {number} */ (this.s)\n  }\n}\n\nexport class UintOptRleDecoder extends Decoder {\n  /**\n   * @param {Uint8Array} uint8Array\n   */\n  constructor (uint8Array) {\n    super(uint8Array)\n    /**\n     * @type {number}\n     */\n    this.s = 0\n    this.count = 0\n  }\n\n  read () {\n    if (this.count === 0) {\n      this.s = readVarInt(this)\n      // if the sign is negative, we read the count too, otherwise count is 1\n      const isNegative = math.isNegativeZero(this.s)\n      this.count = 1\n      if (isNegative) {\n        this.s = -this.s\n        this.count = readVarUint(this) + 2\n      }\n    }\n    this.count--\n    return /** @type {number} */ (this.s)\n  }\n}\n\nexport class IncUintOptRleDecoder extends Decoder {\n  /**\n   * @param {Uint8Array} uint8Array\n   */\n  constructor (uint8Array) {\n    super(uint8Array)\n    /**\n     * @type {number}\n     */\n    this.s = 0\n    this.count = 0\n  }\n\n  read () {\n    if (this.count === 0) {\n      this.s = readVarInt(this)\n      // if the sign is negative, we read the count too, otherwise count is 1\n      const isNegative = math.isNegativeZero(this.s)\n      this.count = 1\n      if (isNegative) {\n        this.s = -this.s\n        this.count = readVarUint(this) + 2\n      }\n    }\n    this.count--\n    return /** @type {number} */ (this.s++)\n  }\n}\n\nexport class IntDiffOptRleDecoder extends Decoder {\n  /**\n   * @param {Uint8Array} uint8Array\n   */\n  constructor (uint8Array) {\n    super(uint8Array)\n    /**\n     * @type {number}\n     */\n    this.s = 0\n    this.count = 0\n    this.diff = 0\n  }\n\n  /**\n   * @return {number}\n   */\n  read () {\n    if (this.count === 0) {\n      const diff = readVarInt(this)\n      // if the first bit is set, we read more data\n      const hasCount = diff & 1\n      this.diff = math.floor(diff / 2) // shift >> 1\n      this.count = 1\n      if (hasCount) {\n        this.count = readVarUint(this) + 2\n      }\n    }\n    this.s += this.diff\n    this.count--\n    return this.s\n  }\n}\n\nexport class StringDecoder {\n  /**\n   * @param {Uint8Array} uint8Array\n   */\n  constructor (uint8Array) {\n    this.decoder = new UintOptRleDecoder(uint8Array)\n    this.str = readVarString(this.decoder)\n    /**\n     * @type {number}\n     */\n    this.spos = 0\n  }\n\n  /**\n   * @return {string}\n   */\n  read () {\n    const end = this.spos + this.decoder.read()\n    const res = this.str.slice(this.spos, end)\n    this.spos = end\n    return res\n  }\n}\n","/**\n * Common Math expressions.\n *\n * @module math\n */\n\nexport const floor = Math.floor\nexport const ceil = Math.ceil\nexport const abs = Math.abs\nexport const imul = Math.imul\nexport const round = Math.round\nexport const log10 = Math.log10\nexport const log2 = Math.log2\nexport const log = Math.log\nexport const sqrt = Math.sqrt\n\n/**\n * @function\n * @param {number} a\n * @param {number} b\n * @return {number} The sum of a and b\n */\nexport const add = (a, b) => a + b\n\n/**\n * @function\n * @param {number} a\n * @param {number} b\n * @return {number} The smaller element of a and b\n */\nexport const min = (a, b) => a < b ? a : b\n\n/**\n * @function\n * @param {number} a\n * @param {number} b\n * @return {number} The bigger element of a and b\n */\nexport const max = (a, b) => a > b ? a : b\n\nexport const isNaN = Number.isNaN\n\nexport const pow = Math.pow\n/**\n * Base 10 exponential function. Returns the value of 10 raised to the power of pow.\n *\n * @param {number} exp\n * @return {number}\n */\nexport const exp10 = exp => Math.pow(10, exp)\n\nexport const sign = Math.sign\n\n/**\n * @param {number} n\n * @return {boolean} Wether n is negative. This function also differentiates between -0 and +0\n */\nexport const isNegativeZero = n => n !== 0 ? n < 0 : 1 / n < 0\n","/* eslint-env browser */\n\n/**\n * Binary data constants.\n *\n * @module binary\n */\n\n/**\n * n-th bit activated.\n *\n * @type {number}\n */\nexport const BIT1 = 1\nexport const BIT2 = 2\nexport const BIT3 = 4\nexport const BIT4 = 8\nexport const BIT5 = 16\nexport const BIT6 = 32\nexport const BIT7 = 64\nexport const BIT8 = 128\nexport const BIT9 = 256\nexport const BIT10 = 512\nexport const BIT11 = 1024\nexport const BIT12 = 2048\nexport const BIT13 = 4096\nexport const BIT14 = 8192\nexport const BIT15 = 16384\nexport const BIT16 = 32768\nexport const BIT17 = 65536\nexport const BIT18 = 1 << 17\nexport const BIT19 = 1 << 18\nexport const BIT20 = 1 << 19\nexport const BIT21 = 1 << 20\nexport const BIT22 = 1 << 21\nexport const BIT23 = 1 << 22\nexport const BIT24 = 1 << 23\nexport const BIT25 = 1 << 24\nexport const BIT26 = 1 << 25\nexport const BIT27 = 1 << 26\nexport const BIT28 = 1 << 27\nexport const BIT29 = 1 << 28\nexport const BIT30 = 1 << 29\nexport const BIT31 = 1 << 30\nexport const BIT32 = 1 << 31\n\n/**\n * First n bits activated.\n *\n * @type {number}\n */\nexport const BITS0 = 0\nexport const BITS1 = 1\nexport const BITS2 = 3\nexport const BITS3 = 7\nexport const BITS4 = 15\nexport const BITS5 = 31\nexport const BITS6 = 63\nexport const BITS7 = 127\nexport const BITS8 = 255\nexport const BITS9 = 511\nexport const BITS10 = 1023\nexport const BITS11 = 2047\nexport const BITS12 = 4095\nexport const BITS13 = 8191\nexport const BITS14 = 16383\nexport const BITS15 = 32767\nexport const BITS16 = 65535\nexport const BITS17 = BIT18 - 1\nexport const BITS18 = BIT19 - 1\nexport const BITS19 = BIT20 - 1\nexport const BITS20 = BIT21 - 1\nexport const BITS21 = BIT22 - 1\nexport const BITS22 = BIT23 - 1\nexport const BITS23 = BIT24 - 1\nexport const BITS24 = BIT25 - 1\nexport const BITS25 = BIT26 - 1\nexport const BITS26 = BIT27 - 1\nexport const BITS27 = BIT28 - 1\nexport const BITS28 = BIT29 - 1\nexport const BITS29 = BIT30 - 1\nexport const BITS30 = BIT31 - 1\n/**\n * @type {number}\n */\nexport const BITS31 = 0x7FFFFFFF\n/**\n * @type {number}\n */\nexport const BITS32 = 0xFFFFFFFF\n","import * as array from './array.js'\n\n/**\n * Utility module to work with strings.\n *\n * @module string\n */\n\nexport const fromCharCode = String.fromCharCode\nexport const fromCodePoint = String.fromCodePoint\n\n/**\n * The largest utf16 character.\n * Corresponds to Uint8Array([255, 255]) or charcodeof(2x2^8)\n */\nexport const MAX_UTF16_CHARACTER = fromCharCode(65535)\n\n/**\n * @param {string} s\n * @return {string}\n */\nconst toLowerCase = s => s.toLowerCase()\n\nconst trimLeftRegex = /^\\s*/g\n\n/**\n * @param {string} s\n * @return {string}\n */\nexport const trimLeft = s => s.replace(trimLeftRegex, '')\n\nconst fromCamelCaseRegex = /([A-Z])/g\n\n/**\n * @param {string} s\n * @param {string} separator\n * @return {string}\n */\nexport const fromCamelCase = (s, separator) => trimLeft(s.replace(fromCamelCaseRegex, match => `${separator}${toLowerCase(match)}`))\n\n/**\n * Compute the utf8ByteLength\n * @param {string} str\n * @return {number}\n */\nexport const utf8ByteLength = str => unescape(encodeURIComponent(str)).length\n\n/**\n * @param {string} str\n * @return {Uint8Array}\n */\nexport const _encodeUtf8Polyfill = str => {\n  const encodedString = unescape(encodeURIComponent(str))\n  const len = encodedString.length\n  const buf = new Uint8Array(len)\n  for (let i = 0; i < len; i++) {\n    buf[i] = /** @type {number} */ (encodedString.codePointAt(i))\n  }\n  return buf\n}\n\n/* c8 ignore next */\nexport const utf8TextEncoder = /** @type {TextEncoder} */ (typeof TextEncoder !== 'undefined' ? new TextEncoder() : null)\n\n/**\n * @param {string} str\n * @return {Uint8Array}\n */\nexport const _encodeUtf8Native = str => utf8TextEncoder.encode(str)\n\n/**\n * @param {string} str\n * @return {Uint8Array}\n */\n/* c8 ignore next */\nexport const encodeUtf8 = utf8TextEncoder ? _encodeUtf8Native : _encodeUtf8Polyfill\n\n/**\n * @param {Uint8Array} buf\n * @return {string}\n */\nexport const _decodeUtf8Polyfill = buf => {\n  let remainingLen = buf.length\n  let encodedString = ''\n  let bufPos = 0\n  while (remainingLen > 0) {\n    const nextLen = remainingLen < 10000 ? remainingLen : 10000\n    const bytes = buf.subarray(bufPos, bufPos + nextLen)\n    bufPos += nextLen\n    // Starting with ES5.1 we can supply a generic array-like object as arguments\n    encodedString += String.fromCodePoint.apply(null, /** @type {any} */ (bytes))\n    remainingLen -= nextLen\n  }\n  return decodeURIComponent(escape(encodedString))\n}\n\n/* c8 ignore next */\nexport let utf8TextDecoder = typeof TextDecoder === 'undefined' ? null : new TextDecoder('utf-8', { fatal: true, ignoreBOM: true })\n\n/* c8 ignore start */\nif (utf8TextDecoder && utf8TextDecoder.decode(new Uint8Array()).length === 1) {\n  // Safari doesn't handle BOM correctly.\n  // This fixes a bug in Safari 13.0.5 where it produces a BOM the first time it is called.\n  // utf8TextDecoder.decode(new Uint8Array()).length === 1 on the first call and\n  // utf8TextDecoder.decode(new Uint8Array()).length === 1 on the second call\n  // Another issue is that from then on no BOM chars are recognized anymore\n  /* c8 ignore next */\n  utf8TextDecoder = null\n}\n/* c8 ignore stop */\n\n/**\n * @param {Uint8Array} buf\n * @return {string}\n */\nexport const _decodeUtf8Native = buf => /** @type {TextDecoder} */ (utf8TextDecoder).decode(buf)\n\n/**\n * @param {Uint8Array} buf\n * @return {string}\n */\n/* c8 ignore next */\nexport const decodeUtf8 = utf8TextDecoder ? _decodeUtf8Native : _decodeUtf8Polyfill\n\n/**\n * @param {string} str The initial string\n * @param {number} index Starting position\n * @param {number} remove Number of characters to remove\n * @param {string} insert New content to insert\n */\nexport const splice = (str, index, remove, insert = '') => str.slice(0, index) + insert + str.slice(index + remove)\n\n/**\n * @param {string} source\n * @param {number} n\n */\nexport const repeat = (source, n) => array.unfold(n, () => source).join('')\n\n/**\n * Escape HTML characters &,<,>,',\" to their respective HTML entities &amp;,&lt;,&gt;,&#39;,&quot;\n *\n * @param {string} str\n */\nexport const escapeHTML = str =>\n  str.replace(/[&<>'\"]/g, r => /** @type {string} */ ({\n    '&': '&amp;',\n    '<': '&lt;',\n    '>': '&gt;',\n    \"'\": '&#39;',\n    '\"': '&quot;'\n  }[r]))\n\n/**\n * Reverse of `escapeHTML`\n *\n * @param {string} str\n */\nexport const unescapeHTML = str =>\n  str.replace(/&amp;|&lt;|&gt;|&#39;|&quot;/g, r => /** @type {string} */ ({\n    '&amp;': '&',\n    '&lt;': '<',\n    '&gt;': '>',\n    '&#39;': \"'\",\n    '&quot;': '\"'\n  }[r]))\n","/**\n * Efficient schema-less binary encoding with support for variable length encoding.\n *\n * Use [lib0/encoding] with [lib0/decoding]. Every encoding function has a corresponding decoding function.\n *\n * Encodes numbers in little-endian order (least to most significant byte order)\n * and is compatible with Golang's binary encoding (https://golang.org/pkg/encoding/binary/)\n * which is also used in Protocol Buffers.\n *\n * ```js\n * // encoding step\n * const encoder = encoding.createEncoder()\n * encoding.writeVarUint(encoder, 256)\n * encoding.writeVarString(encoder, 'Hello world!')\n * const buf = encoding.toUint8Array(encoder)\n * ```\n *\n * ```js\n * // decoding step\n * const decoder = decoding.createDecoder(buf)\n * decoding.readVarUint(decoder) // => 256\n * decoding.readVarString(decoder) // => 'Hello world!'\n * decoding.hasContent(decoder) // => false - all data is read\n * ```\n *\n * @module encoding\n */\n\nimport * as math from './math.js'\nimport * as number from './number.js'\nimport * as binary from './binary.js'\nimport * as string from './string.js'\nimport * as array from './array.js'\n\n/**\n * A BinaryEncoder handles the encoding to an Uint8Array.\n */\nexport class Encoder {\n  constructor () {\n    this.cpos = 0\n    this.cbuf = new Uint8Array(100)\n    /**\n     * @type {Array<Uint8Array>}\n     */\n    this.bufs = []\n  }\n}\n\n/**\n * @function\n * @return {Encoder}\n */\nexport const createEncoder = () => new Encoder()\n\n/**\n * @param {function(Encoder):void} f\n */\nexport const encode = (f) => {\n  const encoder = createEncoder()\n  f(encoder)\n  return toUint8Array(encoder)\n}\n\n/**\n * The current length of the encoded data.\n *\n * @function\n * @param {Encoder} encoder\n * @return {number}\n */\nexport const length = encoder => {\n  let len = encoder.cpos\n  for (let i = 0; i < encoder.bufs.length; i++) {\n    len += encoder.bufs[i].length\n  }\n  return len\n}\n\n/**\n * Check whether encoder is empty.\n *\n * @function\n * @param {Encoder} encoder\n * @return {boolean}\n */\nexport const hasContent = encoder => encoder.cpos > 0 || encoder.bufs.length > 0\n\n/**\n * Transform to Uint8Array.\n *\n * @function\n * @param {Encoder} encoder\n * @return {Uint8Array} The created ArrayBuffer.\n */\nexport const toUint8Array = encoder => {\n  const uint8arr = new Uint8Array(length(encoder))\n  let curPos = 0\n  for (let i = 0; i < encoder.bufs.length; i++) {\n    const d = encoder.bufs[i]\n    uint8arr.set(d, curPos)\n    curPos += d.length\n  }\n  uint8arr.set(new Uint8Array(encoder.cbuf.buffer, 0, encoder.cpos), curPos)\n  return uint8arr\n}\n\n/**\n * Verify that it is possible to write `len` bytes wtihout checking. If\n * necessary, a new Buffer with the required length is attached.\n *\n * @param {Encoder} encoder\n * @param {number} len\n */\nexport const verifyLen = (encoder, len) => {\n  const bufferLen = encoder.cbuf.length\n  if (bufferLen - encoder.cpos < len) {\n    encoder.bufs.push(new Uint8Array(encoder.cbuf.buffer, 0, encoder.cpos))\n    encoder.cbuf = new Uint8Array(math.max(bufferLen, len) * 2)\n    encoder.cpos = 0\n  }\n}\n\n/**\n * Write one byte to the encoder.\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} num The byte that is to be encoded.\n */\nexport const write = (encoder, num) => {\n  const bufferLen = encoder.cbuf.length\n  if (encoder.cpos === bufferLen) {\n    encoder.bufs.push(encoder.cbuf)\n    encoder.cbuf = new Uint8Array(bufferLen * 2)\n    encoder.cpos = 0\n  }\n  encoder.cbuf[encoder.cpos++] = num\n}\n\n/**\n * Write one byte at a specific position.\n * Position must already be written (i.e. encoder.length > pos)\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} pos Position to which to write data\n * @param {number} num Unsigned 8-bit integer\n */\nexport const set = (encoder, pos, num) => {\n  let buffer = null\n  // iterate all buffers and adjust position\n  for (let i = 0; i < encoder.bufs.length && buffer === null; i++) {\n    const b = encoder.bufs[i]\n    if (pos < b.length) {\n      buffer = b // found buffer\n    } else {\n      pos -= b.length\n    }\n  }\n  if (buffer === null) {\n    // use current buffer\n    buffer = encoder.cbuf\n  }\n  buffer[pos] = num\n}\n\n/**\n * Write one byte as an unsigned integer.\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} num The number that is to be encoded.\n */\nexport const writeUint8 = write\n\n/**\n * Write one byte as an unsigned Integer at a specific location.\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} pos The location where the data will be written.\n * @param {number} num The number that is to be encoded.\n */\nexport const setUint8 = set\n\n/**\n * Write two bytes as an unsigned integer.\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} num The number that is to be encoded.\n */\nexport const writeUint16 = (encoder, num) => {\n  write(encoder, num & binary.BITS8)\n  write(encoder, (num >>> 8) & binary.BITS8)\n}\n/**\n * Write two bytes as an unsigned integer at a specific location.\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} pos The location where the data will be written.\n * @param {number} num The number that is to be encoded.\n */\nexport const setUint16 = (encoder, pos, num) => {\n  set(encoder, pos, num & binary.BITS8)\n  set(encoder, pos + 1, (num >>> 8) & binary.BITS8)\n}\n\n/**\n * Write two bytes as an unsigned integer\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} num The number that is to be encoded.\n */\nexport const writeUint32 = (encoder, num) => {\n  for (let i = 0; i < 4; i++) {\n    write(encoder, num & binary.BITS8)\n    num >>>= 8\n  }\n}\n\n/**\n * Write two bytes as an unsigned integer in big endian order.\n * (most significant byte first)\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} num The number that is to be encoded.\n */\nexport const writeUint32BigEndian = (encoder, num) => {\n  for (let i = 3; i >= 0; i--) {\n    write(encoder, (num >>> (8 * i)) & binary.BITS8)\n  }\n}\n\n/**\n * Write two bytes as an unsigned integer at a specific location.\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} pos The location where the data will be written.\n * @param {number} num The number that is to be encoded.\n */\nexport const setUint32 = (encoder, pos, num) => {\n  for (let i = 0; i < 4; i++) {\n    set(encoder, pos + i, num & binary.BITS8)\n    num >>>= 8\n  }\n}\n\n/**\n * Write a variable length unsigned integer. Max encodable integer is 2^53.\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} num The number that is to be encoded.\n */\nexport const writeVarUint = (encoder, num) => {\n  while (num > binary.BITS7) {\n    write(encoder, binary.BIT8 | (binary.BITS7 & num))\n    num = math.floor(num / 128) // shift >>> 7\n  }\n  write(encoder, binary.BITS7 & num)\n}\n\n/**\n * Write a variable length integer.\n *\n * We use the 7th bit instead for signaling that this is a negative number.\n *\n * @function\n * @param {Encoder} encoder\n * @param {number} num The number that is to be encoded.\n */\nexport const writeVarInt = (encoder, num) => {\n  const isNegative = math.isNegativeZero(num)\n  if (isNegative) {\n    num = -num\n  }\n  //             |- whether to continue reading         |- whether is negative     |- number\n  write(encoder, (num > binary.BITS6 ? binary.BIT8 : 0) | (isNegative ? binary.BIT7 : 0) | (binary.BITS6 & num))\n  num = math.floor(num / 64) // shift >>> 6\n  // We don't need to consider the case of num === 0 so we can use a different\n  // pattern here than above.\n  while (num > 0) {\n    write(encoder, (num > binary.BITS7 ? binary.BIT8 : 0) | (binary.BITS7 & num))\n    num = math.floor(num / 128) // shift >>> 7\n  }\n}\n\n/**\n * A cache to store strings temporarily\n */\nconst _strBuffer = new Uint8Array(30000)\nconst _maxStrBSize = _strBuffer.length / 3\n\n/**\n * Write a variable length string.\n *\n * @function\n * @param {Encoder} encoder\n * @param {String} str The string that is to be encoded.\n */\nexport const _writeVarStringNative = (encoder, str) => {\n  if (str.length < _maxStrBSize) {\n    // We can encode the string into the existing buffer\n    /* c8 ignore next */\n    const written = string.utf8TextEncoder.encodeInto(str, _strBuffer).written || 0\n    writeVarUint(encoder, written)\n    for (let i = 0; i < written; i++) {\n      write(encoder, _strBuffer[i])\n    }\n  } else {\n    writeVarUint8Array(encoder, string.encodeUtf8(str))\n  }\n}\n\n/**\n * Write a variable length string.\n *\n * @function\n * @param {Encoder} encoder\n * @param {String} str The string that is to be encoded.\n */\nexport const _writeVarStringPolyfill = (encoder, str) => {\n  const encodedString = unescape(encodeURIComponent(str))\n  const len = encodedString.length\n  writeVarUint(encoder, len)\n  for (let i = 0; i < len; i++) {\n    write(encoder, /** @type {number} */ (encodedString.codePointAt(i)))\n  }\n}\n\n/**\n * Write a variable length string.\n *\n * @function\n * @param {Encoder} encoder\n * @param {String} str The string that is to be encoded.\n */\n/* c8 ignore next */\nexport const writeVarString = (string.utf8TextEncoder && /** @type {any} */ (string.utf8TextEncoder).encodeInto) ? _writeVarStringNative : _writeVarStringPolyfill\n\n/**\n * Write a string terminated by a special byte sequence. This is not very performant and is\n * generally discouraged. However, the resulting byte arrays are lexiographically ordered which\n * makes this a nice feature for databases.\n *\n * The string will be encoded using utf8 and then terminated and escaped using writeTerminatingUint8Array.\n *\n * @function\n * @param {Encoder} encoder\n * @param {String} str The string that is to be encoded.\n */\nexport const writeTerminatedString = (encoder, str) =>\n  writeTerminatedUint8Array(encoder, string.encodeUtf8(str))\n\n/**\n * Write a terminating Uint8Array. Note that this is not performant and is generally\n * discouraged. There are few situations when this is needed.\n *\n * We use 0x0 as a terminating character. 0x1 serves as an escape character for 0x0 and 0x1.\n *\n * Example: [0,1,2] is encoded to [1,0,1,1,2,0]. 0x0, and 0x1 needed to be escaped using 0x1. Then\n * the result is terminated using the 0x0 character.\n *\n * This is basically how many systems implement null terminated strings. However, we use an escape\n * character 0x1 to avoid issues and potenial attacks on our database (if this is used as a key\n * encoder for NoSql databases).\n *\n * @function\n * @param {Encoder} encoder\n * @param {Uint8Array} buf The string that is to be encoded.\n */\nexport const writeTerminatedUint8Array = (encoder, buf) => {\n  for (let i = 0; i < buf.length; i++) {\n    const b = buf[i]\n    if (b === 0 || b === 1) {\n      write(encoder, 1)\n    }\n    write(encoder, buf[i])\n  }\n  write(encoder, 0)\n}\n\n/**\n * Write the content of another Encoder.\n *\n * @TODO: can be improved!\n *        - Note: Should consider that when appending a lot of small Encoders, we should rather clone than referencing the old structure.\n *                Encoders start with a rather big initial buffer.\n *\n * @function\n * @param {Encoder} encoder The enUint8Arr\n * @param {Encoder} append The BinaryEncoder to be written.\n */\nexport const writeBinaryEncoder = (encoder, append) => writeUint8Array(encoder, toUint8Array(append))\n\n/**\n * Append fixed-length Uint8Array to the encoder.\n *\n * @function\n * @param {Encoder} encoder\n * @param {Uint8Array} uint8Array\n */\nexport const writeUint8Array = (encoder, uint8Array) => {\n  const bufferLen = encoder.cbuf.length\n  const cpos = encoder.cpos\n  const leftCopyLen = math.min(bufferLen - cpos, uint8Array.length)\n  const rightCopyLen = uint8Array.length - leftCopyLen\n  encoder.cbuf.set(uint8Array.subarray(0, leftCopyLen), cpos)\n  encoder.cpos += leftCopyLen\n  if (rightCopyLen > 0) {\n    // Still something to write, write right half..\n    // Append new buffer\n    encoder.bufs.push(encoder.cbuf)\n    // must have at least size of remaining buffer\n    encoder.cbuf = new Uint8Array(math.max(bufferLen * 2, rightCopyLen))\n    // copy array\n    encoder.cbuf.set(uint8Array.subarray(leftCopyLen))\n    encoder.cpos = rightCopyLen\n  }\n}\n\n/**\n * Append an Uint8Array to Encoder.\n *\n * @function\n * @param {Encoder} encoder\n * @param {Uint8Array} uint8Array\n */\nexport const writeVarUint8Array = (encoder, uint8Array) => {\n  writeVarUint(encoder, uint8Array.byteLength)\n  writeUint8Array(encoder, uint8Array)\n}\n\n/**\n * Create an DataView of the next `len` bytes. Use it to write data after\n * calling this function.\n *\n * ```js\n * // write float32 using DataView\n * const dv = writeOnDataView(encoder, 4)\n * dv.setFloat32(0, 1.1)\n * // read float32 using DataView\n * const dv = readFromDataView(encoder, 4)\n * dv.getFloat32(0) // => 1.100000023841858 (leaving it to the reader to find out why this is the correct result)\n * ```\n *\n * @param {Encoder} encoder\n * @param {number} len\n * @return {DataView}\n */\nexport const writeOnDataView = (encoder, len) => {\n  verifyLen(encoder, len)\n  const dview = new DataView(encoder.cbuf.buffer, encoder.cpos, len)\n  encoder.cpos += len\n  return dview\n}\n\n/**\n * @param {Encoder} encoder\n * @param {number} num\n */\nexport const writeFloat32 = (encoder, num) => writeOnDataView(encoder, 4).setFloat32(0, num, false)\n\n/**\n * @param {Encoder} encoder\n * @param {number} num\n */\nexport const writeFloat64 = (encoder, num) => writeOnDataView(encoder, 8).setFloat64(0, num, false)\n\n/**\n * @param {Encoder} encoder\n * @param {bigint} num\n */\nexport const writeBigInt64 = (encoder, num) => /** @type {any} */ (writeOnDataView(encoder, 8)).setBigInt64(0, num, false)\n\n/**\n * @param {Encoder} encoder\n * @param {bigint} num\n */\nexport const writeBigUint64 = (encoder, num) => /** @type {any} */ (writeOnDataView(encoder, 8)).setBigUint64(0, num, false)\n\nconst floatTestBed = new DataView(new ArrayBuffer(4))\n/**\n * Check if a number can be encoded as a 32 bit float.\n *\n * @param {number} num\n * @return {boolean}\n */\nconst isFloat32 = num => {\n  floatTestBed.setFloat32(0, num)\n  return floatTestBed.getFloat32(0) === num\n}\n\n/**\n * Encode data with efficient binary format.\n *\n * Differences to JSON:\n *  Transforms data to a binary format (not to a string)\n *  Encodes undefined, NaN, and ArrayBuffer (these can't be represented in JSON)\n *  Numbers are efficiently encoded either as a variable length integer, as a\n *   32 bit float, as a 64 bit float, or as a 64 bit bigint.\n *\n * Encoding table:\n *\n * | Data Type           | Prefix   | Encoding Method    | Comment |\n * | ------------------- | -------- | ------------------ | ------- |\n * | undefined           | 127      |                    | Functions, symbol, and everything that cannot be identified is encoded as undefined |\n * | null                | 126      |                    | |\n * | integer             | 125      | writeVarInt        | Only encodes 32 bit signed integers |\n * | float32             | 124      | writeFloat32       | |\n * | float64             | 123      | writeFloat64       | |\n * | bigint              | 122      | writeBigInt64      | |\n * | boolean (false)     | 121      |                    | True and false are different data types so we save the following byte |\n * | boolean (true)      | 120      |                    | - 0b01111000 so the last bit determines whether true or false |\n * | string              | 119      | writeVarString     | |\n * | object<string,any>  | 118      | custom             | Writes {length} then {length} key-value pairs |\n * | array<any>          | 117      | custom             | Writes {length} then {length} json values |\n * | Uint8Array          | 116      | writeVarUint8Array | We use Uint8Array for any kind of binary data |\n *\n * Reasons for the decreasing prefix:\n * We need the first bit for extendability (later we may want to encode the\n * prefix with writeVarUint). The remaining 7 bits are divided as follows:\n * [0-30]   the beginning of the data range is used for custom purposes\n *          (defined by the function that uses this library)\n * [31-127] the end of the data range is used for data encoding by\n *          lib0/encoding.js\n *\n * @param {Encoder} encoder\n * @param {undefined|null|number|bigint|boolean|string|Object<string,any>|Array<any>|Uint8Array} data\n */\nexport const writeAny = (encoder, data) => {\n  switch (typeof data) {\n    case 'string':\n      // TYPE 119: STRING\n      write(encoder, 119)\n      writeVarString(encoder, data)\n      break\n    case 'number':\n      if (number.isInteger(data) && math.abs(data) <= binary.BITS31) {\n        // TYPE 125: INTEGER\n        write(encoder, 125)\n        writeVarInt(encoder, data)\n      } else if (isFloat32(data)) {\n        // TYPE 124: FLOAT32\n        write(encoder, 124)\n        writeFloat32(encoder, data)\n      } else {\n        // TYPE 123: FLOAT64\n        write(encoder, 123)\n        writeFloat64(encoder, data)\n      }\n      break\n    case 'bigint':\n      // TYPE 122: BigInt\n      write(encoder, 122)\n      writeBigInt64(encoder, data)\n      break\n    case 'object':\n      if (data === null) {\n        // TYPE 126: null\n        write(encoder, 126)\n      } else if (array.isArray(data)) {\n        // TYPE 117: Array\n        write(encoder, 117)\n        writeVarUint(encoder, data.length)\n        for (let i = 0; i < data.length; i++) {\n          writeAny(encoder, data[i])\n        }\n      } else if (data instanceof Uint8Array) {\n        // TYPE 116: ArrayBuffer\n        write(encoder, 116)\n        writeVarUint8Array(encoder, data)\n      } else {\n        // TYPE 118: Object\n        write(encoder, 118)\n        const keys = Object.keys(data)\n        writeVarUint(encoder, keys.length)\n        for (let i = 0; i < keys.length; i++) {\n          const key = keys[i]\n          writeVarString(encoder, key)\n          writeAny(encoder, data[key])\n        }\n      }\n      break\n    case 'boolean':\n      // TYPE 120/121: boolean (true/false)\n      write(encoder, data ? 120 : 121)\n      break\n    default:\n      // TYPE 127: undefined\n      write(encoder, 127)\n  }\n}\n\n/**\n * Now come a few stateful encoder that have their own classes.\n */\n\n/**\n * Basic Run Length Encoder - a basic compression implementation.\n *\n * Encodes [1,1,1,7] to [1,3,7,1] (3 times 1, 1 time 7). This encoder might do more harm than good if there are a lot of values that are not repeated.\n *\n * It was originally used for image compression. Cool .. article http://csbruce.com/cbm/transactor/pdfs/trans_v7_i06.pdf\n *\n * @note T must not be null!\n *\n * @template T\n */\nexport class RleEncoder extends Encoder {\n  /**\n   * @param {function(Encoder, T):void} writer\n   */\n  constructor (writer) {\n    super()\n    /**\n     * The writer\n     */\n    this.w = writer\n    /**\n     * Current state\n     * @type {T|null}\n     */\n    this.s = null\n    this.count = 0\n  }\n\n  /**\n   * @param {T} v\n   */\n  write (v) {\n    if (this.s === v) {\n      this.count++\n    } else {\n      if (this.count > 0) {\n        // flush counter, unless this is the first value (count = 0)\n        writeVarUint(this, this.count - 1) // since count is always > 0, we can decrement by one. non-standard encoding ftw\n      }\n      this.count = 1\n      // write first value\n      this.w(this, v)\n      this.s = v\n    }\n  }\n}\n\n/**\n * Basic diff decoder using variable length encoding.\n *\n * Encodes the values [3, 1100, 1101, 1050, 0] to [3, 1097, 1, -51, -1050] using writeVarInt.\n */\nexport class IntDiffEncoder extends Encoder {\n  /**\n   * @param {number} start\n   */\n  constructor (start) {\n    super()\n    /**\n     * Current state\n     * @type {number}\n     */\n    this.s = start\n  }\n\n  /**\n   * @param {number} v\n   */\n  write (v) {\n    writeVarInt(this, v - this.s)\n    this.s = v\n  }\n}\n\n/**\n * A combination of IntDiffEncoder and RleEncoder.\n *\n * Basically first writes the IntDiffEncoder and then counts duplicate diffs using RleEncoding.\n *\n * Encodes the values [1,1,1,2,3,4,5,6] as [1,1,0,2,1,5] (RLE([1,0,0,1,1,1,1,1])  RleIntDiff[1,1,0,2,1,5])\n */\nexport class RleIntDiffEncoder extends Encoder {\n  /**\n   * @param {number} start\n   */\n  constructor (start) {\n    super()\n    /**\n     * Current state\n     * @type {number}\n     */\n    this.s = start\n    this.count = 0\n  }\n\n  /**\n   * @param {number} v\n   */\n  write (v) {\n    if (this.s === v && this.count > 0) {\n      this.count++\n    } else {\n      if (this.count > 0) {\n        // flush counter, unless this is the first value (count = 0)\n        writeVarUint(this, this.count - 1) // since count is always > 0, we can decrement by one. non-standard encoding ftw\n      }\n      this.count = 1\n      // write first value\n      writeVarInt(this, v - this.s)\n      this.s = v\n    }\n  }\n}\n\n/**\n * @param {UintOptRleEncoder} encoder\n */\nconst flushUintOptRleEncoder = encoder => {\n  if (encoder.count > 0) {\n    // flush counter, unless this is the first value (count = 0)\n    // case 1: just a single value. set sign to positive\n    // case 2: write several values. set sign to negative to indicate that there is a length coming\n    writeVarInt(encoder.encoder, encoder.count === 1 ? encoder.s : -encoder.s)\n    if (encoder.count > 1) {\n      writeVarUint(encoder.encoder, encoder.count - 2) // since count is always > 1, we can decrement by one. non-standard encoding ftw\n    }\n  }\n}\n\n/**\n * Optimized Rle encoder that does not suffer from the mentioned problem of the basic Rle encoder.\n *\n * Internally uses VarInt encoder to write unsigned integers. If the input occurs multiple times, we write\n * write it as a negative number. The UintOptRleDecoder then understands that it needs to read a count.\n *\n * Encodes [1,2,3,3,3] as [1,2,-3,3] (once 1, once 2, three times 3)\n */\nexport class UintOptRleEncoder {\n  constructor () {\n    this.encoder = new Encoder()\n    /**\n     * @type {number}\n     */\n    this.s = 0\n    this.count = 0\n  }\n\n  /**\n   * @param {number} v\n   */\n  write (v) {\n    if (this.s === v) {\n      this.count++\n    } else {\n      flushUintOptRleEncoder(this)\n      this.count = 1\n      this.s = v\n    }\n  }\n\n  /**\n   * Flush the encoded state and transform this to a Uint8Array.\n   *\n   * Note that this should only be called once.\n   */\n  toUint8Array () {\n    flushUintOptRleEncoder(this)\n    return toUint8Array(this.encoder)\n  }\n}\n\n/**\n * Increasing Uint Optimized RLE Encoder\n *\n * The RLE encoder counts the number of same occurences of the same value.\n * The IncUintOptRle encoder counts if the value increases.\n * I.e. 7, 8, 9, 10 will be encoded as [-7, 4]. 1, 3, 5 will be encoded\n * as [1, 3, 5].\n */\nexport class IncUintOptRleEncoder {\n  constructor () {\n    this.encoder = new Encoder()\n    /**\n     * @type {number}\n     */\n    this.s = 0\n    this.count = 0\n  }\n\n  /**\n   * @param {number} v\n   */\n  write (v) {\n    if (this.s + this.count === v) {\n      this.count++\n    } else {\n      flushUintOptRleEncoder(this)\n      this.count = 1\n      this.s = v\n    }\n  }\n\n  /**\n   * Flush the encoded state and transform this to a Uint8Array.\n   *\n   * Note that this should only be called once.\n   */\n  toUint8Array () {\n    flushUintOptRleEncoder(this)\n    return toUint8Array(this.encoder)\n  }\n}\n\n/**\n * @param {IntDiffOptRleEncoder} encoder\n */\nconst flushIntDiffOptRleEncoder = encoder => {\n  if (encoder.count > 0) {\n    //          31 bit making up the diff | wether to write the counter\n    // const encodedDiff = encoder.diff << 1 | (encoder.count === 1 ? 0 : 1)\n    const encodedDiff = encoder.diff * 2 + (encoder.count === 1 ? 0 : 1)\n    // flush counter, unless this is the first value (count = 0)\n    // case 1: just a single value. set first bit to positive\n    // case 2: write several values. set first bit to negative to indicate that there is a length coming\n    writeVarInt(encoder.encoder, encodedDiff)\n    if (encoder.count > 1) {\n      writeVarUint(encoder.encoder, encoder.count - 2) // since count is always > 1, we can decrement by one. non-standard encoding ftw\n    }\n  }\n}\n\n/**\n * A combination of the IntDiffEncoder and the UintOptRleEncoder.\n *\n * The count approach is similar to the UintDiffOptRleEncoder, but instead of using the negative bitflag, it encodes\n * in the LSB whether a count is to be read. Therefore this Encoder only supports 31 bit integers!\n *\n * Encodes [1, 2, 3, 2] as [3, 1, 6, -1] (more specifically [(1 << 1) | 1, (3 << 0) | 0, -1])\n *\n * Internally uses variable length encoding. Contrary to normal UintVar encoding, the first byte contains:\n * * 1 bit that denotes whether the next value is a count (LSB)\n * * 1 bit that denotes whether this value is negative (MSB - 1)\n * * 1 bit that denotes whether to continue reading the variable length integer (MSB)\n *\n * Therefore, only five bits remain to encode diff ranges.\n *\n * Use this Encoder only when appropriate. In most cases, this is probably a bad idea.\n */\nexport class IntDiffOptRleEncoder {\n  constructor () {\n    this.encoder = new Encoder()\n    /**\n     * @type {number}\n     */\n    this.s = 0\n    this.count = 0\n    this.diff = 0\n  }\n\n  /**\n   * @param {number} v\n   */\n  write (v) {\n    if (this.diff === v - this.s) {\n      this.s = v\n      this.count++\n    } else {\n      flushIntDiffOptRleEncoder(this)\n      this.count = 1\n      this.diff = v - this.s\n      this.s = v\n    }\n  }\n\n  /**\n   * Flush the encoded state and transform this to a Uint8Array.\n   *\n   * Note that this should only be called once.\n   */\n  toUint8Array () {\n    flushIntDiffOptRleEncoder(this)\n    return toUint8Array(this.encoder)\n  }\n}\n\n/**\n * Optimized String Encoder.\n *\n * Encoding many small strings in a simple Encoder is not very efficient. The function call to decode a string takes some time and creates references that must be eventually deleted.\n * In practice, when decoding several million small strings, the GC will kick in more and more often to collect orphaned string objects (or maybe there is another reason?).\n *\n * This string encoder solves the above problem. All strings are concatenated and written as a single string using a single encoding call.\n *\n * The lengths are encoded using a UintOptRleEncoder.\n */\nexport class StringEncoder {\n  constructor () {\n    /**\n     * @type {Array<string>}\n     */\n    this.sarr = []\n    this.s = ''\n    this.lensE = new UintOptRleEncoder()\n  }\n\n  /**\n   * @param {string} string\n   */\n  write (string) {\n    this.s += string\n    if (this.s.length > 19) {\n      this.sarr.push(this.s)\n      this.s = ''\n    }\n    this.lensE.write(string.length)\n  }\n\n  toUint8Array () {\n    const encoder = new Encoder()\n    this.sarr.push(this.s)\n    this.s = ''\n    writeVarString(encoder, this.sarr.join(''))\n    writeUint8Array(encoder, this.lensE.toUint8Array())\n    return toUint8Array(encoder)\n  }\n}\n","/**\n * Utility helpers for working with numbers.\n *\n * @module number\n */\n\nimport * as math from './math.js'\nimport * as binary from './binary.js'\n\nexport const MAX_SAFE_INTEGER = Number.MAX_SAFE_INTEGER\nexport const MIN_SAFE_INTEGER = Number.MIN_SAFE_INTEGER\n\nexport const LOWEST_INT32 = 1 << 31\nexport const HIGHEST_INT32 = binary.BITS31\nexport const HIGHEST_UINT32 = binary.BITS32\n\n/* c8 ignore next */\nexport const isInteger = Number.isInteger || (num => typeof num === 'number' && isFinite(num) && math.floor(num) === num)\nexport const isNaN = Number.isNaN\nexport const parseInt = Number.parseInt\n\n/**\n * Count the number of \"1\" bits in an unsigned 32bit number.\n *\n * Super fun bitcount algorithm by Brian Kernighan.\n *\n * @param {number} n\n */\nexport const countBits = n => {\n  n &= binary.BITS32\n  let count = 0\n  while (n) {\n    n &= (n - 1)\n    count++\n  }\n  return count\n}\n","/**\n * Error helpers.\n *\n * @module error\n */\n\n/**\n * @param {string} s\n * @return {Error}\n */\n/* c8 ignore next */\nexport const create = s => new Error(s)\n\n/**\n * @throws {Error}\n * @return {never}\n */\n/* c8 ignore next 3 */\nexport const methodUnimplemented = () => {\n  throw create('Method unimplemented')\n}\n\n/**\n * @throws {Error}\n * @return {never}\n */\n/* c8 ignore next 3 */\nexport const unexpectedCase = () => {\n  throw create('Unexpected case')\n}\n","/**\n * Efficient schema-less binary decoding with support for variable length encoding.\n *\n * Use [lib0/decoding] with [lib0/encoding]. Every encoding function has a corresponding decoding function.\n *\n * Encodes numbers in little-endian order (least to most significant byte order)\n * and is compatible with Golang's binary encoding (https://golang.org/pkg/encoding/binary/)\n * which is also used in Protocol Buffers.\n *\n * ```js\n * // encoding step\n * const encoder = encoding.createEncoder()\n * encoding.writeVarUint(encoder, 256)\n * encoding.writeVarString(encoder, 'Hello world!')\n * const buf = encoding.toUint8Array(encoder)\n * ```\n *\n * ```js\n * // decoding step\n * const decoder = decoding.createDecoder(buf)\n * decoding.readVarUint(decoder) // => 256\n * decoding.readVarString(decoder) // => 'Hello world!'\n * decoding.hasContent(decoder) // => false - all data is read\n * ```\n *\n * @module decoding\n */\n\nimport * as binary from './binary.js'\nimport * as math from './math.js'\nimport * as number from './number.js'\nimport * as string from './string.js'\nimport * as error from './error.js'\nimport * as encoding from './encoding.js'\n\nconst errorUnexpectedEndOfArray = error.create('Unexpected end of array')\nconst errorIntegerOutOfRange = error.create('Integer out of Range')\n\n/**\n * A Decoder handles the decoding of an Uint8Array.\n */\nexport class Decoder {\n  /**\n   * @param {Uint8Array} uint8Array Binary data to decode\n   */\n  constructor (uint8Array) {\n    /**\n     * Decoding target.\n     *\n     * @type {Uint8Array}\n     */\n    this.arr = uint8Array\n    /**\n     * Current decoding position.\n     *\n     * @type {number}\n     */\n    this.pos = 0\n  }\n}\n\n/**\n * @function\n * @param {Uint8Array} uint8Array\n * @return {Decoder}\n */\nexport const createDecoder = uint8Array => new Decoder(uint8Array)\n\n/**\n * @function\n * @param {Decoder} decoder\n * @return {boolean}\n */\nexport const hasContent = decoder => decoder.pos !== decoder.arr.length\n\n/**\n * Clone a decoder instance.\n * Optionally set a new position parameter.\n *\n * @function\n * @param {Decoder} decoder The decoder instance\n * @param {number} [newPos] Defaults to current position\n * @return {Decoder} A clone of `decoder`\n */\nexport const clone = (decoder, newPos = decoder.pos) => {\n  const _decoder = createDecoder(decoder.arr)\n  _decoder.pos = newPos\n  return _decoder\n}\n\n/**\n * Create an Uint8Array view of the next `len` bytes and advance the position by `len`.\n *\n * Important: The Uint8Array still points to the underlying ArrayBuffer. Make sure to discard the result as soon as possible to prevent any memory leaks.\n *            Use `buffer.copyUint8Array` to copy the result into a new Uint8Array.\n *\n * @function\n * @param {Decoder} decoder The decoder instance\n * @param {number} len The length of bytes to read\n * @return {Uint8Array}\n */\nexport const readUint8Array = (decoder, len) => {\n  const view = new Uint8Array(decoder.arr.buffer, decoder.pos + decoder.arr.byteOffset, len)\n  decoder.pos += len\n  return view\n}\n\n/**\n * Read variable length Uint8Array.\n *\n * Important: The Uint8Array still points to the underlying ArrayBuffer. Make sure to discard the result as soon as possible to prevent any memory leaks.\n *            Use `buffer.copyUint8Array` to copy the result into a new Uint8Array.\n *\n * @function\n * @param {Decoder} decoder\n * @return {Uint8Array}\n */\nexport const readVarUint8Array = decoder => readUint8Array(decoder, readVarUint(decoder))\n\n/**\n * Read the rest of the content as an ArrayBuffer\n * @function\n * @param {Decoder} decoder\n * @return {Uint8Array}\n */\nexport const readTailAsUint8Array = decoder => readUint8Array(decoder, decoder.arr.length - decoder.pos)\n\n/**\n * Skip one byte, jump to the next position.\n * @function\n * @param {Decoder} decoder The decoder instance\n * @return {number} The next position\n */\nexport const skip8 = decoder => decoder.pos++\n\n/**\n * Read one byte as unsigned integer.\n * @function\n * @param {Decoder} decoder The decoder instance\n * @return {number} Unsigned 8-bit integer\n */\nexport const readUint8 = decoder => decoder.arr[decoder.pos++]\n\n/**\n * Read 2 bytes as unsigned integer.\n *\n * @function\n * @param {Decoder} decoder\n * @return {number} An unsigned integer.\n */\nexport const readUint16 = decoder => {\n  const uint =\n    decoder.arr[decoder.pos] +\n    (decoder.arr[decoder.pos + 1] << 8)\n  decoder.pos += 2\n  return uint\n}\n\n/**\n * Read 4 bytes as unsigned integer.\n *\n * @function\n * @param {Decoder} decoder\n * @return {number} An unsigned integer.\n */\nexport const readUint32 = decoder => {\n  const uint =\n    (decoder.arr[decoder.pos] +\n    (decoder.arr[decoder.pos + 1] << 8) +\n    (decoder.arr[decoder.pos + 2] << 16) +\n    (decoder.arr[decoder.pos + 3] << 24)) >>> 0\n  decoder.pos += 4\n  return uint\n}\n\n/**\n * Read 4 bytes as unsigned integer in big endian order.\n * (most significant byte first)\n *\n * @function\n * @param {Decoder} decoder\n * @return {number} An unsigned integer.\n */\nexport const readUint32BigEndian = decoder => {\n  const uint =\n    (decoder.arr[decoder.pos + 3] +\n    (decoder.arr[decoder.pos + 2] << 8) +\n    (decoder.arr[decoder.pos + 1] << 16) +\n    (decoder.arr[decoder.pos] << 24)) >>> 0\n  decoder.pos += 4\n  return uint\n}\n\n/**\n * Look ahead without incrementing the position\n * to the next byte and read it as unsigned integer.\n *\n * @function\n * @param {Decoder} decoder\n * @return {number} An unsigned integer.\n */\nexport const peekUint8 = decoder => decoder.arr[decoder.pos]\n\n/**\n * Look ahead without incrementing the position\n * to the next byte and read it as unsigned integer.\n *\n * @function\n * @param {Decoder} decoder\n * @return {number} An unsigned integer.\n */\nexport const peekUint16 = decoder =>\n  decoder.arr[decoder.pos] +\n  (decoder.arr[decoder.pos + 1] << 8)\n\n/**\n * Look ahead without incrementing the position\n * to the next byte and read it as unsigned integer.\n *\n * @function\n * @param {Decoder} decoder\n * @return {number} An unsigned integer.\n */\nexport const peekUint32 = decoder => (\n  decoder.arr[decoder.pos] +\n  (decoder.arr[decoder.pos + 1] << 8) +\n  (decoder.arr[decoder.pos + 2] << 16) +\n  (decoder.arr[decoder.pos + 3] << 24)\n) >>> 0\n\n/**\n * Read unsigned integer (32bit) with variable length.\n * 1/8th of the storage is used as encoding overhead.\n *  * numbers < 2^7 is stored in one bytlength\n *  * numbers < 2^14 is stored in two bylength\n *\n * @function\n * @param {Decoder} decoder\n * @return {number} An unsigned integer.length\n */\nexport const readVarUint = decoder => {\n  let num = 0\n  let mult = 1\n  const len = decoder.arr.length\n  while (decoder.pos < len) {\n    const r = decoder.arr[decoder.pos++]\n    // num = num | ((r & binary.BITS7) << len)\n    num = num + (r & binary.BITS7) * mult // shift $r << (7*#iterations) and add it to num\n    mult *= 128 // next iteration, shift 7 \"more\" to the left\n    if (r < binary.BIT8) {\n      return num\n    }\n    /* c8 ignore start */\n    if (num > number.MAX_SAFE_INTEGER) {\n      throw errorIntegerOutOfRange\n    }\n    /* c8 ignore stop */\n  }\n  throw errorUnexpectedEndOfArray\n}\n\n/**\n * Read signed integer (32bit) with variable length.\n * 1/8th of the storage is used as encoding overhead.\n *  * numbers < 2^7 is stored in one bytlength\n *  * numbers < 2^14 is stored in two bylength\n * @todo This should probably create the inverse ~num if number is negative - but this would be a breaking change.\n *\n * @function\n * @param {Decoder} decoder\n * @return {number} An unsigned integer.length\n */\nexport const readVarInt = decoder => {\n  let r = decoder.arr[decoder.pos++]\n  let num = r & binary.BITS6\n  let mult = 64\n  const sign = (r & binary.BIT7) > 0 ? -1 : 1\n  if ((r & binary.BIT8) === 0) {\n    // don't continue reading\n    return sign * num\n  }\n  const len = decoder.arr.length\n  while (decoder.pos < len) {\n    r = decoder.arr[decoder.pos++]\n    // num = num | ((r & binary.BITS7) << len)\n    num = num + (r & binary.BITS7) * mult\n    mult *= 128\n    if (r < binary.BIT8) {\n      return sign * num\n    }\n    /* c8 ignore start */\n    if (num > number.MAX_SAFE_INTEGER) {\n      throw errorIntegerOutOfRange\n    }\n    /* c8 ignore stop */\n  }\n  throw errorUnexpectedEndOfArray\n}\n\n/**\n * Look ahead and read varUint without incrementing position\n *\n * @function\n * @param {Decoder} decoder\n * @return {number}\n */\nexport const peekVarUint = decoder => {\n  const pos = decoder.pos\n  const s = readVarUint(decoder)\n  decoder.pos = pos\n  return s\n}\n\n/**\n * Look ahead and read varUint without incrementing position\n *\n * @function\n * @param {Decoder} decoder\n * @return {number}\n */\nexport const peekVarInt = decoder => {\n  const pos = decoder.pos\n  const s = readVarInt(decoder)\n  decoder.pos = pos\n  return s\n}\n\n/**\n * We don't test this function anymore as we use native decoding/encoding by default now.\n * Better not modify this anymore..\n *\n * Transforming utf8 to a string is pretty expensive. The code performs 10x better\n * when String.fromCodePoint is fed with all characters as arguments.\n * But most environments have a maximum number of arguments per functions.\n * For effiency reasons we apply a maximum of 10000 characters at once.\n *\n * @function\n * @param {Decoder} decoder\n * @return {String} The read String.\n */\n/* c8 ignore start */\nexport const _readVarStringPolyfill = decoder => {\n  let remainingLen = readVarUint(decoder)\n  if (remainingLen === 0) {\n    return ''\n  } else {\n    let encodedString = String.fromCodePoint(readUint8(decoder)) // remember to decrease remainingLen\n    if (--remainingLen < 100) { // do not create a Uint8Array for small strings\n      while (remainingLen--) {\n        encodedString += String.fromCodePoint(readUint8(decoder))\n      }\n    } else {\n      while (remainingLen > 0) {\n        const nextLen = remainingLen < 10000 ? remainingLen : 10000\n        // this is dangerous, we create a fresh array view from the existing buffer\n        const bytes = decoder.arr.subarray(decoder.pos, decoder.pos + nextLen)\n        decoder.pos += nextLen\n        // Starting with ES5.1 we can supply a generic array-like object as arguments\n        encodedString += String.fromCodePoint.apply(null, /** @type {any} */ (bytes))\n        remainingLen -= nextLen\n      }\n    }\n    return decodeURIComponent(escape(encodedString))\n  }\n}\n/* c8 ignore stop */\n\n/**\n * @function\n * @param {Decoder} decoder\n * @return {String} The read String\n */\nexport const _readVarStringNative = decoder =>\n  /** @type any */ (string.utf8TextDecoder).decode(readVarUint8Array(decoder))\n\n/**\n * Read string of variable length\n * * varUint is used to store the length of the string\n *\n * @function\n * @param {Decoder} decoder\n * @return {String} The read String\n *\n */\n/* c8 ignore next */\nexport const readVarString = string.utf8TextDecoder ? _readVarStringNative : _readVarStringPolyfill\n\n/**\n * @param {Decoder} decoder\n * @return {Uint8Array}\n */\nexport const readTerminatedUint8Array = decoder => {\n  const encoder = encoding.createEncoder()\n  let b\n  while (true) {\n    b = readUint8(decoder)\n    if (b === 0) {\n      return encoding.toUint8Array(encoder)\n    }\n    if (b === 1) {\n      b = readUint8(decoder)\n    }\n    encoding.write(encoder, b)\n  }\n}\n\n/**\n * @param {Decoder} decoder\n * @return {string}\n */\nexport const readTerminatedString = decoder => string.decodeUtf8(readTerminatedUint8Array(decoder))\n\n/**\n * Look ahead and read varString without incrementing position\n *\n * @function\n * @param {Decoder} decoder\n * @return {string}\n */\nexport const peekVarString = decoder => {\n  const pos = decoder.pos\n  const s = readVarString(decoder)\n  decoder.pos = pos\n  return s\n}\n\n/**\n * @param {Decoder} decoder\n * @param {number} len\n * @return {DataView}\n */\nexport const readFromDataView = (decoder, len) => {\n  const dv = new DataView(decoder.arr.buffer, decoder.arr.byteOffset + decoder.pos, len)\n  decoder.pos += len\n  return dv\n}\n\n/**\n * @param {Decoder} decoder\n */\nexport const readFloat32 = decoder => readFromDataView(decoder, 4).getFloat32(0, false)\n\n/**\n * @param {Decoder} decoder\n */\nexport const readFloat64 = decoder => readFromDataView(decoder, 8).getFloat64(0, false)\n\n/**\n * @param {Decoder} decoder\n */\nexport const readBigInt64 = decoder => /** @type {any} */ (readFromDataView(decoder, 8)).getBigInt64(0, false)\n\n/**\n * @param {Decoder} decoder\n */\nexport const readBigUint64 = decoder => /** @type {any} */ (readFromDataView(decoder, 8)).getBigUint64(0, false)\n\n/**\n * @type {Array<function(Decoder):any>}\n */\nconst readAnyLookupTable = [\n  decoder => undefined, // CASE 127: undefined\n  decoder => null, // CASE 126: null\n  readVarInt, // CASE 125: integer\n  readFloat32, // CASE 124: float32\n  readFloat64, // CASE 123: float64\n  readBigInt64, // CASE 122: bigint\n  decoder => false, // CASE 121: boolean (false)\n  decoder => true, // CASE 120: boolean (true)\n  readVarString, // CASE 119: string\n  decoder => { // CASE 118: object<string,any>\n    const len = readVarUint(decoder)\n    /**\n     * @type {Object<string,any>}\n     */\n    const obj = {}\n    for (let i = 0; i < len; i++) {\n      const key = readVarString(decoder)\n      obj[key] = readAny(decoder)\n    }\n    return obj\n  },\n  decoder => { // CASE 117: array<any>\n    const len = readVarUint(decoder)\n    const arr = []\n    for (let i = 0; i < len; i++) {\n      arr.push(readAny(decoder))\n    }\n    return arr\n  },\n  readVarUint8Array // CASE 116: Uint8Array\n]\n\n/**\n * @param {Decoder} decoder\n */\nexport const readAny = decoder => readAnyLookupTable[127 - readUint8(decoder)](decoder)\n\n/**\n * T must not be null.\n *\n * @template T\n */\nexport class RleDecoder extends Decoder {\n  /**\n   * @param {Uint8Array} uint8Array\n   * @param {function(Decoder):T} reader\n   */\n  constructor (uint8Array, reader) {\n    super(uint8Array)\n    /**\n     * The reader\n     */\n    this.reader = reader\n    /**\n     * Current state\n     * @type {T|null}\n     */\n    this.s = null\n    this.count = 0\n  }\n\n  read () {\n    if (this.count === 0) {\n      this.s = this.reader(this)\n      if (hasContent(this)) {\n        this.count = readVarUint(this) + 1 // see encoder implementation for the reason why this is incremented\n      } else {\n        this.count = -1 // read the current value forever\n      }\n    }\n    this.count--\n    return /** @type {T} */ (this.s)\n  }\n}\n\nexport class IntDiffDecoder extends Decoder {\n  /**\n   * @param {Uint8Array} uint8Array\n   * @param {number} start\n   */\n  constructor (uint8Array, start) {\n    super(uint8Array)\n    /**\n     * Current state\n     * @type {number}\n     */\n    this.s = start\n  }\n\n  /**\n   * @return {number}\n   */\n  read () {\n    this.s += readVarInt(this)\n    return this.s\n  }\n}\n\nexport class RleIntDiffDecoder extends Decoder {\n  /**\n   * @param {Uint8Array} uint8Array\n   * @param {number} start\n   */\n  constructor (uint8Array, start) {\n    super(uint8Array)\n    /**\n     * Current state\n     * @type {number}\n     */\n    this.s = start\n    this.count = 0\n  }\n\n  /**\n   * @return {number}\n   */\n  read () {\n    if (this.count === 0) {\n      this.s += readVarInt(this)\n      if (hasContent(this)) {\n        this.count = readVarUint(this) + 1 // see encoder implementation for the reason why this is incremented\n      } else {\n        this.count = -1 // read the current value forever\n      }\n    }\n    this.count--\n    return /** @type {number} */ (this.s)\n  }\n}\n\nexport class UintOptRleDecoder extends Decoder {\n  /**\n   * @param {Uint8Array} uint8Array\n   */\n  constructor (uint8Array) {\n    super(uint8Array)\n    /**\n     * @type {number}\n     */\n    this.s = 0\n    this.count = 0\n  }\n\n  read () {\n    if (this.count === 0) {\n      this.s = readVarInt(this)\n      // if the sign is negative, we read the count too, otherwise count is 1\n      const isNegative = math.isNegativeZero(this.s)\n      this.count = 1\n      if (isNegative) {\n        this.s = -this.s\n        this.count = readVarUint(this) + 2\n      }\n    }\n    this.count--\n    return /** @type {number} */ (this.s)\n  }\n}\n\nexport class IncUintOptRleDecoder extends Decoder {\n  /**\n   * @param {Uint8Array} uint8Array\n   */\n  constructor (uint8Array) {\n    super(uint8Array)\n    /**\n     * @type {number}\n     */\n    this.s = 0\n    this.count = 0\n  }\n\n  read () {\n    if (this.count === 0) {\n      this.s = readVarInt(this)\n      // if the sign is negative, we read the count too, otherwise count is 1\n      const isNegative = math.isNegativeZero(this.s)\n      this.count = 1\n      if (isNegative) {\n        this.s = -this.s\n        this.count = readVarUint(this) + 2\n      }\n    }\n    this.count--\n    return /** @type {number} */ (this.s++)\n  }\n}\n\nexport class IntDiffOptRleDecoder extends Decoder {\n  /**\n   * @param {Uint8Array} uint8Array\n   */\n  constructor (uint8Array) {\n    super(uint8Array)\n    /**\n     * @type {number}\n     */\n    this.s = 0\n    this.count = 0\n    this.diff = 0\n  }\n\n  /**\n   * @return {number}\n   */\n  read () {\n    if (this.count === 0) {\n      const diff = readVarInt(this)\n      // if the first bit is set, we read more data\n      const hasCount = diff & 1\n      this.diff = math.floor(diff / 2) // shift >> 1\n      this.count = 1\n      if (hasCount) {\n        this.count = readVarUint(this) + 2\n      }\n    }\n    this.s += this.diff\n    this.count--\n    return this.s\n  }\n}\n\nexport class StringDecoder {\n  /**\n   * @param {Uint8Array} uint8Array\n   */\n  constructor (uint8Array) {\n    this.decoder = new UintOptRleDecoder(uint8Array)\n    this.str = readVarString(this.decoder)\n    /**\n     * @type {number}\n     */\n    this.spos = 0\n  }\n\n  /**\n   * @return {string}\n   */\n  read () {\n    const end = this.spos + this.decoder.read()\n    const res = this.str.slice(this.spos, end)\n    this.spos = end\n    return res\n  }\n}\n","/**\n * @module sync-protocol\n */\n\nimport * as encoding from 'lib0/encoding'\nimport * as decoding from 'lib0/decoding'\nimport * as Y from 'yjs'\n\n/**\n * @typedef {Map<number, number>} StateMap\n */\n\n/**\n * Core Yjs defines two message types:\n *  YjsSyncStep1: Includes the State Set of the sending client. When received, the client should reply with YjsSyncStep2.\n *  YjsSyncStep2: Includes all missing structs and the complete delete set. When received, the client is assured that it\n *   received all information from the remote client.\n *\n * In a peer-to-peer network, you may want to introduce a SyncDone message type. Both parties should initiate the connection\n * with SyncStep1. When a client received SyncStep2, it should reply with SyncDone. When the local client received both\n * SyncStep2 and SyncDone, it is assured that it is synced to the remote client.\n *\n * In a client-server model, you want to handle this differently: The client should initiate the connection with SyncStep1.\n * When the server receives SyncStep1, it should reply with SyncStep2 immediately followed by SyncStep1. The client replies\n * with SyncStep2 when it receives SyncStep1. Optionally the server may send a SyncDone after it received SyncStep2, so the\n * client knows that the sync is finished.  There are two reasons for this more elaborated sync model: 1. This protocol can\n * easily be implemented on top of http and websockets. 2. The server should only reply to requests, and not initiate them.\n * Therefore it is necessary that the client initiates the sync.\n *\n * Construction of a message:\n * [messageType : varUint, message definition..]\n *\n * Note: A message does not include information about the room name. This must to be handled by the upper layer protocol!\n *\n * stringify[messageType] stringifies a message definition (messageType is already read from the bufffer)\n */\n\nexport const messageYjsSyncStep1 = 0\nexport const messageYjsSyncStep2 = 1\nexport const messageYjsUpdate = 2\n\n/**\n * Create a sync step 1 message based on the state of the current shared document.\n *\n * @param {encoding.Encoder} encoder\n * @param {Y.Doc} doc\n */\nexport const writeSyncStep1 = (encoder, doc) => {\n  encoding.writeVarUint(encoder, messageYjsSyncStep1)\n  const sv = Y.encodeStateVector(doc)\n  encoding.writeVarUint8Array(encoder, sv)\n}\n\n/**\n * @param {encoding.Encoder} encoder\n * @param {Y.Doc} doc\n * @param {Uint8Array} [encodedStateVector]\n */\nexport const writeSyncStep2 = (encoder, doc, encodedStateVector) => {\n  encoding.writeVarUint(encoder, messageYjsSyncStep2)\n  encoding.writeVarUint8Array(encoder, Y.encodeStateAsUpdate(doc, encodedStateVector))\n}\n\n/**\n * Read SyncStep1 message and reply with SyncStep2.\n *\n * @param {decoding.Decoder} decoder The reply to the received message\n * @param {encoding.Encoder} encoder The received message\n * @param {Y.Doc} doc\n */\nexport const readSyncStep1 = (decoder, encoder, doc) =>\n  writeSyncStep2(encoder, doc, decoding.readVarUint8Array(decoder))\n\n/**\n * Read and apply Structs and then DeleteStore to a y instance.\n *\n * @param {decoding.Decoder} decoder\n * @param {Y.Doc} doc\n * @param {any} transactionOrigin\n */\nexport const readSyncStep2 = (decoder, doc, transactionOrigin) => {\n  try {\n    Y.applyUpdate(doc, decoding.readVarUint8Array(decoder), transactionOrigin)\n  } catch (error) {\n    // This catches errors that are thrown by event handlers\n    console.error('Caught error while handling a Yjs update', error)\n  }\n}\n\n/**\n * @param {encoding.Encoder} encoder\n * @param {Uint8Array} update\n */\nexport const writeUpdate = (encoder, update) => {\n  encoding.writeVarUint(encoder, messageYjsUpdate)\n  encoding.writeVarUint8Array(encoder, update)\n}\n\n/**\n * Read and apply Structs and then DeleteStore to a y instance.\n *\n * @param {decoding.Decoder} decoder\n * @param {Y.Doc} doc\n * @param {any} transactionOrigin\n */\nexport const readUpdate = readSyncStep2\n\n/**\n * @param {decoding.Decoder} decoder A message received from another client\n * @param {encoding.Encoder} encoder The reply message. Does not need to be sent if empty.\n * @param {Y.Doc} doc\n * @param {any} transactionOrigin\n */\nexport const readSyncMessage = (decoder, encoder, doc, transactionOrigin) => {\n  const messageType = decoding.readVarUint(decoder)\n  switch (messageType) {\n    case messageYjsSyncStep1:\n      readSyncStep1(decoder, encoder, doc)\n      break\n    case messageYjsSyncStep2:\n      readSyncStep2(decoder, doc, transactionOrigin)\n      break\n    case messageYjsUpdate:\n      readUpdate(decoder, doc, transactionOrigin)\n      break\n    default:\n      throw new Error('Unknown message type')\n  }\n  return messageType\n}\n","/**\n * Utility module to work with time.\n *\n * @module time\n */\n\nimport * as metric from './metric.js'\nimport * as math from './math.js'\n\n/**\n * Return current time.\n *\n * @return {Date}\n */\nexport const getDate = () => new Date()\n\n/**\n * Return current unix time.\n *\n * @return {number}\n */\nexport const getUnixTime = Date.now\n\n/**\n * Transform time (in ms) to a human readable format. E.g. 1100 => 1.1s. 60s => 1min. .001 => 10s.\n *\n * @param {number} d duration in milliseconds\n * @return {string} humanized approximation of time\n */\nexport const humanizeDuration = d => {\n  if (d < 60000) {\n    const p = metric.prefix(d, -1)\n    return math.round(p.n * 100) / 100 + p.prefix + 's'\n  }\n  d = math.floor(d / 1000)\n  const seconds = d % 60\n  const minutes = math.floor(d / 60) % 60\n  const hours = math.floor(d / 3600) % 24\n  const days = math.floor(d / 86400)\n  if (days > 0) {\n    return days + 'd' + ((hours > 0 || minutes > 30) ? ' ' + (minutes > 30 ? hours + 1 : hours) + 'h' : '')\n  }\n  if (hours > 0) {\n    /* c8 ignore next */\n    return hours + 'h' + ((minutes > 0 || seconds > 30) ? ' ' + (seconds > 30 ? minutes + 1 : minutes) + 'min' : '')\n  }\n  return minutes + 'min' + (seconds > 0 ? ' ' + seconds + 's' : '')\n}\n","/**\n * Utility module to work with key-value stores.\n *\n * @module map\n */\n\n/**\n * Creates a new Map instance.\n *\n * @function\n * @return {Map<any, any>}\n *\n * @function\n */\nexport const create = () => new Map()\n\n/**\n * Copy a Map object into a fresh Map object.\n *\n * @function\n * @template K,V\n * @param {Map<K,V>} m\n * @return {Map<K,V>}\n */\nexport const copy = m => {\n  const r = create()\n  m.forEach((v, k) => { r.set(k, v) })\n  return r\n}\n\n/**\n * Get map property. Create T if property is undefined and set T on map.\n *\n * ```js\n * const listeners = map.setIfUndefined(events, 'eventName', set.create)\n * listeners.add(listener)\n * ```\n *\n * @function\n * @template {Map<any, any>} MAP\n * @template {MAP extends Map<any,infer V> ? function():V : unknown} CF\n * @param {MAP} map\n * @param {MAP extends Map<infer K,any> ? K : unknown} key\n * @param {CF} createT\n * @return {ReturnType<CF>}\n */\nexport const setIfUndefined = (map, key, createT) => {\n  let set = map.get(key)\n  if (set === undefined) {\n    map.set(key, set = createT())\n  }\n  return set\n}\n\n/**\n * Creates an Array and populates it with the content of all key-value pairs using the `f(value, key)` function.\n *\n * @function\n * @template K\n * @template V\n * @template R\n * @param {Map<K,V>} m\n * @param {function(V,K):R} f\n * @return {Array<R>}\n */\nexport const map = (m, f) => {\n  const res = []\n  for (const [key, value] of m) {\n    res.push(f(value, key))\n  }\n  return res\n}\n\n/**\n * Tests whether any key-value pairs pass the test implemented by `f(value, key)`.\n *\n * @todo should rename to some - similarly to Array.some\n *\n * @function\n * @template K\n * @template V\n * @param {Map<K,V>} m\n * @param {function(V,K):boolean} f\n * @return {boolean}\n */\nexport const any = (m, f) => {\n  for (const [key, value] of m) {\n    if (f(value, key)) {\n      return true\n    }\n  }\n  return false\n}\n\n/**\n * Tests whether all key-value pairs pass the test implemented by `f(value, key)`.\n *\n * @function\n * @template K\n * @template V\n * @param {Map<K,V>} m\n * @param {function(V,K):boolean} f\n * @return {boolean}\n */\nexport const all = (m, f) => {\n  for (const [key, value] of m) {\n    if (!f(value, key)) {\n      return false\n    }\n  }\n  return true\n}\n","/**\n * Utility module to work with sets.\n *\n * @module set\n */\n\nexport const create = () => new Set()\n\n/**\n * @template T\n * @param {Set<T>} set\n * @return {Array<T>}\n */\nexport const toArray = set => Array.from(set)\n\n/**\n * @template T\n * @param {Set<T>} set\n * @return {T|undefined}\n */\nexport const first = set => set.values().next().value\n\n/**\n * @template T\n * @param {Iterable<T>} entries\n * @return {Set<T>}\n */\nexport const from = entries => new Set(entries)\n","/**\n * Utility module to work with Arrays.\n *\n * @module array\n */\n\nimport * as set from './set.js'\n\n/**\n * Return the last element of an array. The element must exist\n *\n * @template L\n * @param {ArrayLike<L>} arr\n * @return {L}\n */\nexport const last = arr => arr[arr.length - 1]\n\n/**\n * @template C\n * @return {Array<C>}\n */\nexport const create = () => /** @type {Array<C>} */ ([])\n\n/**\n * @template D\n * @param {Array<D>} a\n * @return {Array<D>}\n */\nexport const copy = a => /** @type {Array<D>} */ (a.slice())\n\n/**\n * Append elements from src to dest\n *\n * @template M\n * @param {Array<M>} dest\n * @param {Array<M>} src\n */\nexport const appendTo = (dest, src) => {\n  for (let i = 0; i < src.length; i++) {\n    dest.push(src[i])\n  }\n}\n\n/**\n * Transforms something array-like to an actual Array.\n *\n * @function\n * @template T\n * @param {ArrayLike<T>|Iterable<T>} arraylike\n * @return {T}\n */\nexport const from = Array.from\n\n/**\n * True iff condition holds on every element in the Array.\n *\n * @function\n * @template {ArrayLike<any>} ARR\n *\n * @param {ARR} arr\n * @param {ARR extends ArrayLike<infer S> ? ((value:S, index:number, arr:ARR) => boolean) : any} f\n * @return {boolean}\n */\nexport const every = (arr, f) => {\n  for (let i = 0; i < arr.length; i++) {\n    if (!f(arr[i], i, arr)) {\n      return false\n    }\n  }\n  return true\n}\n\n/**\n * True iff condition holds on some element in the Array.\n *\n * @function\n * @template {ArrayLike<any>} ARR\n *\n * @param {ARR} arr\n * @param {ARR extends ArrayLike<infer S> ? ((value:S, index:number, arr:ARR) => boolean) : never} f\n * @return {boolean}\n */\nexport const some = (arr, f) => {\n  for (let i = 0; i < arr.length; i++) {\n    if (f(arr[i], i, arr)) {\n      return true\n    }\n  }\n  return false\n}\n\n/**\n * @template ELEM\n *\n * @param {ArrayLike<ELEM>} a\n * @param {ArrayLike<ELEM>} b\n * @return {boolean}\n */\nexport const equalFlat = (a, b) => a.length === b.length && every(a, (item, index) => item === b[index])\n\n/**\n * @template ELEM\n * @param {Array<Array<ELEM>>} arr\n * @return {Array<ELEM>}\n */\nexport const flatten = arr => fold(arr, /** @type {Array<ELEM>} */ ([]), (acc, val) => acc.concat(val))\n\n/**\n * @template T\n * @param {number} len\n * @param {function(number, Array<T>):T} f\n * @return {Array<T>}\n */\nexport const unfold = (len, f) => {\n  const array = new Array(len)\n  for (let i = 0; i < len; i++) {\n    array[i] = f(i, array)\n  }\n  return array\n}\n\n/**\n * @template T\n * @template RESULT\n * @param {Array<T>} arr\n * @param {RESULT} seed\n * @param {function(RESULT, T, number):RESULT} folder\n */\nexport const fold = (arr, seed, folder) => arr.reduce(folder, seed)\n\nexport const isArray = Array.isArray\n\n/**\n * @template T\n * @param {Array<T>} arr\n * @return {Array<T>}\n */\nexport const unique = arr => from(set.from(arr))\n\n/**\n * @template T\n * @template M\n * @param {ArrayLike<T>} arr\n * @param {function(T):M} mapper\n * @return {Array<T>}\n */\nexport const uniqueBy = (arr, mapper) => {\n  /**\n   * @type {Set<M>}\n   */\n  const happened = set.create()\n  /**\n   * @type {Array<T>}\n   */\n  const result = []\n  for (let i = 0; i < arr.length; i++) {\n    const el = arr[i]\n    const mapped = mapper(el)\n    if (!happened.has(mapped)) {\n      happened.add(mapped)\n      result.push(el)\n    }\n  }\n  return result\n}\n\n/**\n * @template {ArrayLike<any>} ARR\n * @template {function(ARR extends ArrayLike<infer T> ? T : never, number, ARR):any} MAPPER\n * @param {ARR} arr\n * @param {MAPPER} mapper\n * @return {Array<MAPPER extends function(...any): infer M ? M : never>}\n */\nexport const map = (arr, mapper) => {\n  /**\n   * @type {Array<any>}\n   */\n  const res = Array(arr.length)\n  for (let i = 0; i < arr.length; i++) {\n    res[i] = mapper(/** @type {any} */ (arr[i]), i, /** @type {any} */ (arr))\n  }\n  return /** @type {any} */ (res)\n}\n\n/**\n * This function bubble-sorts a single item to the correct position. The sort happens in-place and\n * might be useful to ensure that a single item is at the correct position in an otherwise sorted\n * array.\n *\n * @example\n *  const arr = [3, 2, 5]\n *  arr.sort((a, b) => a - b)\n *  arr // => [2, 3, 5]\n *  arr.splice(1, 0, 7)\n *  array.bubbleSortItem(arr, 1, (a, b) => a - b)\n *  arr // => [2, 3, 5, 7]\n *\n * @template T\n * @param {Array<T>} arr\n * @param {number} i\n * @param {(a:T,b:T) => number} compareFn\n */\nexport const bubblesortItem = (arr, i, compareFn) => {\n  const n = arr[i]\n  let j = i\n  // try to sort to the right\n  while (j + 1 < arr.length && compareFn(n, arr[j + 1]) > 0) {\n    arr[j] = arr[j + 1]\n    arr[++j] = n\n  }\n  if (i === j && j > 0) { // no change yet\n    // sort to the left\n    while (j > 0 && compareFn(arr[j - 1], n) > 0) {\n      arr[j] = arr[j - 1]\n      arr[--j] = n\n    }\n  }\n  return j\n}\n","/**\n * Observable class prototype.\n *\n * @module observable\n */\n\nimport * as map from './map.js'\nimport * as set from './set.js'\nimport * as array from './array.js'\n\n/**\n * Handles named events.\n * @experimental\n *\n * This is basically a (better typed) duplicate of Observable, which will replace Observable in the\n * next release.\n *\n * @template {{[key in keyof EVENTS]: function(...any):void}} EVENTS\n */\nexport class ObservableV2 {\n  constructor () {\n    /**\n     * Some desc.\n     * @type {Map<string, Set<any>>}\n     */\n    this._observers = map.create()\n  }\n\n  /**\n   * @template {keyof EVENTS & string} NAME\n   * @param {NAME} name\n   * @param {EVENTS[NAME]} f\n   */\n  on (name, f) {\n    map.setIfUndefined(this._observers, /** @type {string} */ (name), set.create).add(f)\n    return f\n  }\n\n  /**\n   * @template {keyof EVENTS & string} NAME\n   * @param {NAME} name\n   * @param {EVENTS[NAME]} f\n   */\n  once (name, f) {\n    /**\n     * @param  {...any} args\n     */\n    const _f = (...args) => {\n      this.off(name, /** @type {any} */ (_f))\n      f(...args)\n    }\n    this.on(name, /** @type {any} */ (_f))\n  }\n\n  /**\n   * @template {keyof EVENTS & string} NAME\n   * @param {NAME} name\n   * @param {EVENTS[NAME]} f\n   */\n  off (name, f) {\n    const observers = this._observers.get(name)\n    if (observers !== undefined) {\n      observers.delete(f)\n      if (observers.size === 0) {\n        this._observers.delete(name)\n      }\n    }\n  }\n\n  /**\n   * Emit a named event. All registered event listeners that listen to the\n   * specified name will receive the event.\n   *\n   * @todo This should catch exceptions\n   *\n   * @template {keyof EVENTS & string} NAME\n   * @param {NAME} name The event name.\n   * @param {Parameters<EVENTS[NAME]>} args The arguments that are applied to the event listener.\n   */\n  emit (name, args) {\n    // copy all listeners to an array first to make sure that no event is emitted to listeners that are subscribed while the event handler is called.\n    return array.from((this._observers.get(name) || map.create()).values()).forEach(f => f(...args))\n  }\n\n  destroy () {\n    this._observers = map.create()\n  }\n}\n\n/* c8 ignore start */\n/**\n * Handles named events.\n *\n * @deprecated\n * @template N\n */\nexport class Observable {\n  constructor () {\n    /**\n     * Some desc.\n     * @type {Map<N, any>}\n     */\n    this._observers = map.create()\n  }\n\n  /**\n   * @param {N} name\n   * @param {function} f\n   */\n  on (name, f) {\n    map.setIfUndefined(this._observers, name, set.create).add(f)\n  }\n\n  /**\n   * @param {N} name\n   * @param {function} f\n   */\n  once (name, f) {\n    /**\n     * @param  {...any} args\n     */\n    const _f = (...args) => {\n      this.off(name, _f)\n      f(...args)\n    }\n    this.on(name, _f)\n  }\n\n  /**\n   * @param {N} name\n   * @param {function} f\n   */\n  off (name, f) {\n    const observers = this._observers.get(name)\n    if (observers !== undefined) {\n      observers.delete(f)\n      if (observers.size === 0) {\n        this._observers.delete(name)\n      }\n    }\n  }\n\n  /**\n   * Emit a named event. All registered event listeners that listen to the\n   * specified name will receive the event.\n   *\n   * @todo This should catch exceptions\n   *\n   * @param {N} name The event name.\n   * @param {Array<any>} args The arguments that are applied to the event listener.\n   */\n  emit (name, args) {\n    // copy all listeners to an array first to make sure that no event is emitted to listeners that are subscribed while the event handler is called.\n    return array.from((this._observers.get(name) || map.create()).values()).forEach(f => f(...args))\n  }\n\n  destroy () {\n    this._observers = map.create()\n  }\n}\n/* c8 ignore end */\n","/**\n * Utility functions for working with EcmaScript objects.\n *\n * @module object\n */\n\n/**\n * @return {Object<string,any>} obj\n */\nexport const create = () => Object.create(null)\n\n/**\n * Object.assign\n */\nexport const assign = Object.assign\n\n/**\n * @param {Object<string,any>} obj\n */\nexport const keys = Object.keys\n\n/**\n * @template V\n * @param {{[key:string]: V}} obj\n * @return {Array<V>}\n */\nexport const values = Object.values\n\n/**\n * @template V\n * @param {{[k:string]:V}} obj\n * @param {function(V,string):any} f\n */\nexport const forEach = (obj, f) => {\n  for (const key in obj) {\n    f(obj[key], key)\n  }\n}\n\n/**\n * @todo implement mapToArray & map\n *\n * @template R\n * @param {Object<string,any>} obj\n * @param {function(any,string):R} f\n * @return {Array<R>}\n */\nexport const map = (obj, f) => {\n  const results = []\n  for (const key in obj) {\n    results.push(f(obj[key], key))\n  }\n  return results\n}\n\n/**\n * @deprecated use object.size instead\n * @param {Object<string,any>} obj\n * @return {number}\n */\nexport const length = obj => keys(obj).length\n\n/**\n * @param {Object<string,any>} obj\n * @return {number}\n */\nexport const size = obj => keys(obj).length\n\n/**\n * @template {{ [key:string|number|symbol]: any }} T\n * @param {T} obj\n * @param {(v:T[keyof T],k:keyof T)=>boolean} f\n * @return {boolean}\n */\nexport const some = (obj, f) => {\n  for (const key in obj) {\n    if (f(obj[key], key)) {\n      return true\n    }\n  }\n  return false\n}\n\n/**\n * @param {Object|null|undefined} obj\n */\nexport const isEmpty = obj => {\n  // eslint-disable-next-line no-unreachable-loop\n  for (const _k in obj) {\n    return false\n  }\n  return true\n}\n\n/**\n * @template {{ [key:string|number|symbol]: any }} T\n * @param {T} obj\n * @param {(v:T[keyof T],k:keyof T)=>boolean} f\n * @return {boolean}\n */\nexport const every = (obj, f) => {\n  for (const key in obj) {\n    if (!f(obj[key], key)) {\n      return false\n    }\n  }\n  return true\n}\n\n/**\n * Calls `Object.prototype.hasOwnProperty`.\n *\n * @param {any} obj\n * @param {string|number|symbol} key\n * @return {boolean}\n */\nexport const hasProperty = (obj, key) => Object.prototype.hasOwnProperty.call(obj, key)\n\n/**\n * @param {Object<string,any>} a\n * @param {Object<string,any>} b\n * @return {boolean}\n */\nexport const equalFlat = (a, b) => a === b || (size(a) === size(b) && every(a, (val, key) => (val !== undefined || hasProperty(b, key)) && b[key] === val))\n\n/**\n * Make an object immutable. This hurts performance and is usually not needed if you perform good\n * coding practices.\n */\nexport const freeze = Object.freeze\n\n/**\n * Make an object and all its children immutable.\n * This *really* hurts performance and is usually not needed if you perform good coding practices.\n *\n * @template {any} T\n * @param {T} o\n * @return {Readonly<T>}\n */\nexport const deepFreeze = (o) => {\n  for (const key in o) {\n    const c = o[key]\n    if (typeof c === 'object' || typeof c === 'function') {\n      deepFreeze(o[key])\n    }\n  }\n  return freeze(o)\n}\n\n/**\n * Get object property. Create T if property is undefined and set T on object.\n *\n * @function\n * @template {object} KV\n * @template {keyof KV} [K=keyof KV]\n * @param {KV} o\n * @param {K} key\n * @param {() => KV[K]} createT\n * @return {KV[K]}\n */\nexport const setIfUndefined = (o, key, createT) => hasProperty(o, key) ? o[key] : (o[key] = createT())\n","export const EqualityTraitSymbol = Symbol('Equality')\n\n/**\n * @typedef {{ [EqualityTraitSymbol]:(other:EqualityTrait)=>boolean }} EqualityTrait\n */\n","/**\n * Common functions and function call helpers.\n *\n * @module function\n */\n\nimport * as array from './array.js'\nimport * as object from './object.js'\nimport * as traits from './traits.js'\n\n/**\n * Calls all functions in `fs` with args. Only throws after all functions were called.\n *\n * @param {Array<function>} fs\n * @param {Array<any>} args\n */\nexport const callAll = (fs, args, i = 0) => {\n  try {\n    for (; i < fs.length; i++) {\n      fs[i](...args)\n    }\n  } finally {\n    if (i < fs.length) {\n      callAll(fs, args, i + 1)\n    }\n  }\n}\n\nexport const nop = () => {}\n\n/**\n * @template T\n * @param {function():T} f\n * @return {T}\n */\nexport const apply = f => f()\n\n/**\n * @template A\n *\n * @param {A} a\n * @return {A}\n */\nexport const id = a => a\n\n/**\n * @template T\n *\n * @param {T} a\n * @param {T} b\n * @return {boolean}\n */\nexport const equalityStrict = (a, b) => a === b\n\n/**\n * @template T\n *\n * @param {Array<T>|object} a\n * @param {Array<T>|object} b\n * @return {boolean}\n */\nexport const equalityFlat = (a, b) => a === b || (a != null && b != null && a.constructor === b.constructor && ((array.isArray(a) && array.equalFlat(a, /** @type {Array<T>} */ (b))) || (typeof a === 'object' && object.equalFlat(a, b))))\n\n/* c8 ignore start */\n\n/**\n * @param {any} a\n * @param {any} b\n * @return {boolean}\n */\nexport const equalityDeep = (a, b) => {\n  if (a === b) {\n    return true\n  }\n  if (a == null || b == null || a.constructor !== b.constructor) {\n    return false\n  }\n  if (a[traits.EqualityTraitSymbol] != null) {\n    return a[traits.EqualityTraitSymbol](b)\n  }\n  switch (a.constructor) {\n    case ArrayBuffer:\n      a = new Uint8Array(a)\n      b = new Uint8Array(b)\n    // eslint-disable-next-line no-fallthrough\n    case Uint8Array: {\n      if (a.byteLength !== b.byteLength) {\n        return false\n      }\n      for (let i = 0; i < a.length; i++) {\n        if (a[i] !== b[i]) {\n          return false\n        }\n      }\n      break\n    }\n    case Set: {\n      if (a.size !== b.size) {\n        return false\n      }\n      for (const value of a) {\n        if (!b.has(value)) {\n          return false\n        }\n      }\n      break\n    }\n    case Map: {\n      if (a.size !== b.size) {\n        return false\n      }\n      for (const key of a.keys()) {\n        if (!b.has(key) || !equalityDeep(a.get(key), b.get(key))) {\n          return false\n        }\n      }\n      break\n    }\n    case Object:\n      if (object.length(a) !== object.length(b)) {\n        return false\n      }\n      for (const key in a) {\n        if (!object.hasProperty(a, key) || !equalityDeep(a[key], b[key])) {\n          return false\n        }\n      }\n      break\n    case Array:\n      if (a.length !== b.length) {\n        return false\n      }\n      for (let i = 0; i < a.length; i++) {\n        if (!equalityDeep(a[i], b[i])) {\n          return false\n        }\n      }\n      break\n    default:\n      return false\n  }\n  return true\n}\n\n/**\n * @template V\n * @template {V} OPTS\n *\n * @param {V} value\n * @param {Array<OPTS>} options\n */\n// @ts-ignore\nexport const isOneOf = (value, options) => options.includes(value)\n/* c8 ignore stop */\n\nexport const isArray = array.isArray\n\n/**\n * @param {any} s\n * @return {s is String}\n */\nexport const isString = (s) => s && s.constructor === String\n\n/**\n * @param {any} n\n * @return {n is Number}\n */\nexport const isNumber = n => n != null && n.constructor === Number\n\n/**\n * @template {abstract new (...args: any) => any} TYPE\n * @param {any} n\n * @param {TYPE} T\n * @return {n is InstanceType<TYPE>}\n */\nexport const is = (n, T) => n && n.constructor === T\n\n/**\n * @template {abstract new (...args: any) => any} TYPE\n * @param {TYPE} T\n */\nexport const isTemplate = (T) =>\n  /**\n   * @param {any} n\n   * @return {n is InstanceType<TYPE>}\n   **/\n  n => n && n.constructor === T\n","/**\n * @module awareness-protocol\n */\n\nimport * as encoding from 'lib0/encoding'\nimport * as decoding from 'lib0/decoding'\nimport * as time from 'lib0/time'\nimport * as math from 'lib0/math'\nimport { Observable } from 'lib0/observable'\nimport * as f from 'lib0/function'\nimport * as Y from 'yjs' // eslint-disable-line\n\nexport const outdatedTimeout = 30000\n\n/**\n * @typedef {Object} MetaClientState\n * @property {number} MetaClientState.clock\n * @property {number} MetaClientState.lastUpdated unix timestamp\n */\n\n/**\n * The Awareness class implements a simple shared state protocol that can be used for non-persistent data like awareness information\n * (cursor, username, status, ..). Each client can update its own local state and listen to state changes of\n * remote clients. Every client may set a state of a remote peer to `null` to mark the client as offline.\n *\n * Each client is identified by a unique client id (something we borrow from `doc.clientID`). A client can override\n * its own state by propagating a message with an increasing timestamp (`clock`). If such a message is received, it is\n * applied if the known state of that client is older than the new state (`clock < newClock`). If a client thinks that\n * a remote client is offline, it may propagate a message with\n * `{ clock: currentClientClock, state: null, client: remoteClient }`. If such a\n * message is received, and the known clock of that client equals the received clock, it will override the state with `null`.\n *\n * Before a client disconnects, it should propagate a `null` state with an updated clock.\n *\n * Awareness states must be updated every 30 seconds. Otherwise the Awareness instance will delete the client state.\n *\n * @extends {Observable<string>}\n */\nexport class Awareness extends Observable {\n  /**\n   * @param {Y.Doc} doc\n   */\n  constructor (doc) {\n    super()\n    this.doc = doc\n    /**\n     * @type {number}\n     */\n    this.clientID = doc.clientID\n    /**\n     * Maps from client id to client state\n     * @type {Map<number, Object<string, any>>}\n     */\n    this.states = new Map()\n    /**\n     * @type {Map<number, MetaClientState>}\n     */\n    this.meta = new Map()\n    this._checkInterval = /** @type {any} */ (setInterval(() => {\n      const now = time.getUnixTime()\n      if (this.getLocalState() !== null && (outdatedTimeout / 2 <= now - /** @type {{lastUpdated:number}} */ (this.meta.get(this.clientID)).lastUpdated)) {\n        // renew local clock\n        this.setLocalState(this.getLocalState())\n      }\n      /**\n       * @type {Array<number>}\n       */\n      const remove = []\n      this.meta.forEach((meta, clientid) => {\n        if (clientid !== this.clientID && outdatedTimeout <= now - meta.lastUpdated && this.states.has(clientid)) {\n          remove.push(clientid)\n        }\n      })\n      if (remove.length > 0) {\n        removeAwarenessStates(this, remove, 'timeout')\n      }\n    }, math.floor(outdatedTimeout / 10)))\n    doc.on('destroy', () => {\n      this.destroy()\n    })\n    this.setLocalState({})\n  }\n\n  destroy () {\n    this.emit('destroy', [this])\n    this.setLocalState(null)\n    super.destroy()\n    clearInterval(this._checkInterval)\n  }\n\n  /**\n   * @return {Object<string,any>|null}\n   */\n  getLocalState () {\n    return this.states.get(this.clientID) || null\n  }\n\n  /**\n   * @param {Object<string,any>|null} state\n   */\n  setLocalState (state) {\n    const clientID = this.clientID\n    const currLocalMeta = this.meta.get(clientID)\n    const clock = currLocalMeta === undefined ? 0 : currLocalMeta.clock + 1\n    const prevState = this.states.get(clientID)\n    if (state === null) {\n      this.states.delete(clientID)\n    } else {\n      this.states.set(clientID, state)\n    }\n    this.meta.set(clientID, {\n      clock,\n      lastUpdated: time.getUnixTime()\n    })\n    const added = []\n    const updated = []\n    const filteredUpdated = []\n    const removed = []\n    if (state === null) {\n      removed.push(clientID)\n    } else if (prevState == null) {\n      if (state != null) {\n        added.push(clientID)\n      }\n    } else {\n      updated.push(clientID)\n      if (!f.equalityDeep(prevState, state)) {\n        filteredUpdated.push(clientID)\n      }\n    }\n    if (added.length > 0 || filteredUpdated.length > 0 || removed.length > 0) {\n      this.emit('change', [{ added, updated: filteredUpdated, removed }, 'local'])\n    }\n    this.emit('update', [{ added, updated, removed }, 'local'])\n  }\n\n  /**\n   * @param {string} field\n   * @param {any} value\n   */\n  setLocalStateField (field, value) {\n    const state = this.getLocalState()\n    if (state !== null) {\n      this.setLocalState({\n        ...state,\n        [field]: value\n      })\n    }\n  }\n\n  /**\n   * @return {Map<number,Object<string,any>>}\n   */\n  getStates () {\n    return this.states\n  }\n}\n\n/**\n * Mark (remote) clients as inactive and remove them from the list of active peers.\n * This change will be propagated to remote clients.\n *\n * @param {Awareness} awareness\n * @param {Array<number>} clients\n * @param {any} origin\n */\nexport const removeAwarenessStates = (awareness, clients, origin) => {\n  const removed = []\n  for (let i = 0; i < clients.length; i++) {\n    const clientID = clients[i]\n    if (awareness.states.has(clientID)) {\n      awareness.states.delete(clientID)\n      if (clientID === awareness.clientID) {\n        const curMeta = /** @type {MetaClientState} */ (awareness.meta.get(clientID))\n        awareness.meta.set(clientID, {\n          clock: curMeta.clock + 1,\n          lastUpdated: time.getUnixTime()\n        })\n      }\n      removed.push(clientID)\n    }\n  }\n  if (removed.length > 0) {\n    awareness.emit('change', [{ added: [], updated: [], removed }, origin])\n    awareness.emit('update', [{ added: [], updated: [], removed }, origin])\n  }\n}\n\n/**\n * @param {Awareness} awareness\n * @param {Array<number>} clients\n * @return {Uint8Array}\n */\nexport const encodeAwarenessUpdate = (awareness, clients, states = awareness.states) => {\n  const len = clients.length\n  const encoder = encoding.createEncoder()\n  encoding.writeVarUint(encoder, len)\n  for (let i = 0; i < len; i++) {\n    const clientID = clients[i]\n    const state = states.get(clientID) || null\n    const clock = /** @type {MetaClientState} */ (awareness.meta.get(clientID)).clock\n    encoding.writeVarUint(encoder, clientID)\n    encoding.writeVarUint(encoder, clock)\n    encoding.writeVarString(encoder, JSON.stringify(state))\n  }\n  return encoding.toUint8Array(encoder)\n}\n\n/**\n * Modify the content of an awareness update before re-encoding it to an awareness update.\n *\n * This might be useful when you have a central server that wants to ensure that clients\n * cant hijack somebody elses identity.\n *\n * @param {Uint8Array} update\n * @param {function(any):any} modify\n * @return {Uint8Array}\n */\nexport const modifyAwarenessUpdate = (update, modify) => {\n  const decoder = decoding.createDecoder(update)\n  const encoder = encoding.createEncoder()\n  const len = decoding.readVarUint(decoder)\n  encoding.writeVarUint(encoder, len)\n  for (let i = 0; i < len; i++) {\n    const clientID = decoding.readVarUint(decoder)\n    const clock = decoding.readVarUint(decoder)\n    const state = JSON.parse(decoding.readVarString(decoder))\n    const modifiedState = modify(state)\n    encoding.writeVarUint(encoder, clientID)\n    encoding.writeVarUint(encoder, clock)\n    encoding.writeVarString(encoder, JSON.stringify(modifiedState))\n  }\n  return encoding.toUint8Array(encoder)\n}\n\n/**\n * @param {Awareness} awareness\n * @param {Uint8Array} update\n * @param {any} origin This will be added to the emitted change event\n */\nexport const applyAwarenessUpdate = (awareness, update, origin) => {\n  const decoder = decoding.createDecoder(update)\n  const timestamp = time.getUnixTime()\n  const added = []\n  const updated = []\n  const filteredUpdated = []\n  const removed = []\n  const len = decoding.readVarUint(decoder)\n  for (let i = 0; i < len; i++) {\n    const clientID = decoding.readVarUint(decoder)\n    let clock = decoding.readVarUint(decoder)\n    const state = JSON.parse(decoding.readVarString(decoder))\n    const clientMeta = awareness.meta.get(clientID)\n    const prevState = awareness.states.get(clientID)\n    const currClock = clientMeta === undefined ? 0 : clientMeta.clock\n    if (currClock < clock || (currClock === clock && state === null && awareness.states.has(clientID))) {\n      if (state === null) {\n        // never let a remote client remove this local state\n        if (clientID === awareness.clientID && awareness.getLocalState() != null) {\n          // remote client removed the local state. Do not remote state. Broadcast a message indicating\n          // that this client still exists by increasing the clock\n          clock++\n        } else {\n          awareness.states.delete(clientID)\n        }\n      } else {\n        awareness.states.set(clientID, state)\n      }\n      awareness.meta.set(clientID, {\n        clock,\n        lastUpdated: timestamp\n      })\n      if (clientMeta === undefined && state !== null) {\n        added.push(clientID)\n      } else if (clientMeta !== undefined && state === null) {\n        removed.push(clientID)\n      } else if (state !== null) {\n        if (!f.equalityDeep(state, prevState)) {\n          filteredUpdated.push(clientID)\n        }\n        updated.push(clientID)\n      }\n    }\n  }\n  if (added.length > 0 || filteredUpdated.length > 0 || removed.length > 0) {\n    awareness.emit('change', [{\n      added, updated: filteredUpdated, removed\n    }, origin])\n  }\n  if (added.length > 0 || updated.length > 0 || removed.length > 0) {\n    awareness.emit('update', [{\n      added, updated, removed\n    }, origin])\n  }\n}\n","/**\n * Observable class prototype.\n *\n * @module observable\n */\n\nimport * as map from './map.js'\nimport * as set from './set.js'\nimport * as array from './array.js'\n\n/**\n * Handles named events.\n * @experimental\n *\n * This is basically a (better typed) duplicate of Observable, which will replace Observable in the\n * next release.\n *\n * @template {{[key in keyof EVENTS]: function(...any):void}} EVENTS\n */\nexport class ObservableV2 {\n  constructor () {\n    /**\n     * Some desc.\n     * @type {Map<string, Set<any>>}\n     */\n    this._observers = map.create()\n  }\n\n  /**\n   * @template {keyof EVENTS & string} NAME\n   * @param {NAME} name\n   * @param {EVENTS[NAME]} f\n   */\n  on (name, f) {\n    map.setIfUndefined(this._observers, /** @type {string} */ (name), set.create).add(f)\n    return f\n  }\n\n  /**\n   * @template {keyof EVENTS & string} NAME\n   * @param {NAME} name\n   * @param {EVENTS[NAME]} f\n   */\n  once (name, f) {\n    /**\n     * @param  {...any} args\n     */\n    const _f = (...args) => {\n      this.off(name, /** @type {any} */ (_f))\n      f(...args)\n    }\n    this.on(name, /** @type {any} */ (_f))\n  }\n\n  /**\n   * @template {keyof EVENTS & string} NAME\n   * @param {NAME} name\n   * @param {EVENTS[NAME]} f\n   */\n  off (name, f) {\n    const observers = this._observers.get(name)\n    if (observers !== undefined) {\n      observers.delete(f)\n      if (observers.size === 0) {\n        this._observers.delete(name)\n      }\n    }\n  }\n\n  /**\n   * Emit a named event. All registered event listeners that listen to the\n   * specified name will receive the event.\n   *\n   * @todo This should catch exceptions\n   *\n   * @template {keyof EVENTS & string} NAME\n   * @param {NAME} name The event name.\n   * @param {Parameters<EVENTS[NAME]>} args The arguments that are applied to the event listener.\n   */\n  emit (name, args) {\n    // copy all listeners to an array first to make sure that no event is emitted to listeners that are subscribed while the event handler is called.\n    return array.from((this._observers.get(name) || map.create()).values()).forEach(f => f(...args))\n  }\n\n  destroy () {\n    this._observers = map.create()\n  }\n}\n\n/* c8 ignore start */\n/**\n * Handles named events.\n *\n * @deprecated\n * @template N\n */\nexport class Observable {\n  constructor () {\n    /**\n     * Some desc.\n     * @type {Map<N, any>}\n     */\n    this._observers = map.create()\n  }\n\n  /**\n   * @param {N} name\n   * @param {function} f\n   */\n  on (name, f) {\n    map.setIfUndefined(this._observers, name, set.create).add(f)\n  }\n\n  /**\n   * @param {N} name\n   * @param {function} f\n   */\n  once (name, f) {\n    /**\n     * @param  {...any} args\n     */\n    const _f = (...args) => {\n      this.off(name, _f)\n      f(...args)\n    }\n    this.on(name, _f)\n  }\n\n  /**\n   * @param {N} name\n   * @param {function} f\n   */\n  off (name, f) {\n    const observers = this._observers.get(name)\n    if (observers !== undefined) {\n      observers.delete(f)\n      if (observers.size === 0) {\n        this._observers.delete(name)\n      }\n    }\n  }\n\n  /**\n   * Emit a named event. All registered event listeners that listen to the\n   * specified name will receive the event.\n   *\n   * @todo This should catch exceptions\n   *\n   * @param {N} name The event name.\n   * @param {Array<any>} args The arguments that are applied to the event listener.\n   */\n  emit (name, args) {\n    // copy all listeners to an array first to make sure that no event is emitted to listeners that are subscribed while the event handler is called.\n    return array.from((this._observers.get(name) || map.create()).values()).forEach(f => f(...args))\n  }\n\n  destroy () {\n    this._observers = map.create()\n  }\n}\n/* c8 ignore end */\n","/**\n * Utility functions for working with EcmaScript objects.\n *\n * @module object\n */\n\n/**\n * @return {Object<string,any>} obj\n */\nexport const create = () => Object.create(null)\n\n/**\n * Object.assign\n */\nexport const assign = Object.assign\n\n/**\n * @param {Object<string,any>} obj\n */\nexport const keys = Object.keys\n\n/**\n * @template V\n * @param {{[key:string]: V}} obj\n * @return {Array<V>}\n */\nexport const values = Object.values\n\n/**\n * @template V\n * @param {{[k:string]:V}} obj\n * @param {function(V,string):any} f\n */\nexport const forEach = (obj, f) => {\n  for (const key in obj) {\n    f(obj[key], key)\n  }\n}\n\n/**\n * @todo implement mapToArray & map\n *\n * @template R\n * @param {Object<string,any>} obj\n * @param {function(any,string):R} f\n * @return {Array<R>}\n */\nexport const map = (obj, f) => {\n  const results = []\n  for (const key in obj) {\n    results.push(f(obj[key], key))\n  }\n  return results\n}\n\n/**\n * @deprecated use object.size instead\n * @param {Object<string,any>} obj\n * @return {number}\n */\nexport const length = obj => keys(obj).length\n\n/**\n * @param {Object<string,any>} obj\n * @return {number}\n */\nexport const size = obj => keys(obj).length\n\n/**\n * @template {{ [key:string|number|symbol]: any }} T\n * @param {T} obj\n * @param {(v:T[keyof T],k:keyof T)=>boolean} f\n * @return {boolean}\n */\nexport const some = (obj, f) => {\n  for (const key in obj) {\n    if (f(obj[key], key)) {\n      return true\n    }\n  }\n  return false\n}\n\n/**\n * @param {Object|null|undefined} obj\n */\nexport const isEmpty = obj => {\n  // eslint-disable-next-line no-unreachable-loop\n  for (const _k in obj) {\n    return false\n  }\n  return true\n}\n\n/**\n * @template {{ [key:string|number|symbol]: any }} T\n * @param {T} obj\n * @param {(v:T[keyof T],k:keyof T)=>boolean} f\n * @return {boolean}\n */\nexport const every = (obj, f) => {\n  for (const key in obj) {\n    if (!f(obj[key], key)) {\n      return false\n    }\n  }\n  return true\n}\n\n/**\n * Calls `Object.prototype.hasOwnProperty`.\n *\n * @param {any} obj\n * @param {string|number|symbol} key\n * @return {boolean}\n */\nexport const hasProperty = (obj, key) => Object.prototype.hasOwnProperty.call(obj, key)\n\n/**\n * @param {Object<string,any>} a\n * @param {Object<string,any>} b\n * @return {boolean}\n */\nexport const equalFlat = (a, b) => a === b || (size(a) === size(b) && every(a, (val, key) => (val !== undefined || hasProperty(b, key)) && b[key] === val))\n\n/**\n * Make an object immutable. This hurts performance and is usually not needed if you perform good\n * coding practices.\n */\nexport const freeze = Object.freeze\n\n/**\n * Make an object and all its children immutable.\n * This *really* hurts performance and is usually not needed if you perform good coding practices.\n *\n * @template {any} T\n * @param {T} o\n * @return {Readonly<T>}\n */\nexport const deepFreeze = (o) => {\n  for (const key in o) {\n    const c = o[key]\n    if (typeof c === 'object' || typeof c === 'function') {\n      deepFreeze(o[key])\n    }\n  }\n  return freeze(o)\n}\n\n/**\n * Get object property. Create T if property is undefined and set T on object.\n *\n * @function\n * @template {object} KV\n * @template {keyof KV} [K=keyof KV]\n * @param {KV} o\n * @param {K} key\n * @param {() => KV[K]} createT\n * @return {KV[K]}\n */\nexport const setIfUndefined = (o, key, createT) => hasProperty(o, key) ? o[key] : (o[key] = createT())\n","/**\n * @module provider/websocket\n */\n\n/* eslint-env browser */\n\nimport * as Y from 'yjs' // eslint-disable-line\nimport * as bc from 'lib0/broadcastchannel'\nimport * as time from 'lib0/time'\nimport * as encoding from 'lib0/encoding'\nimport * as decoding from 'lib0/decoding'\nimport * as syncProtocol from 'y-protocols/sync'\nimport * as authProtocol from 'y-protocols/auth'\nimport * as awarenessProtocol from 'y-protocols/awareness'\nimport { ObservableV2 } from 'lib0/observable'\nimport * as math from 'lib0/math'\nimport * as url from 'lib0/url'\nimport * as env from 'lib0/environment'\n\nexport const messageSync = 0\nexport const messageQueryAwareness = 3\nexport const messageAwareness = 1\nexport const messageAuth = 2\n\n/**\n *                       encoder,          decoder,          provider,          emitSynced, messageType\n * @type {Array<function(encoding.Encoder, decoding.Decoder, WebsocketProvider, boolean,    number):void>}\n */\nconst messageHandlers = []\n\nmessageHandlers[messageSync] = (\n  encoder,\n  decoder,\n  provider,\n  emitSynced,\n  _messageType\n) => {\n  encoding.writeVarUint(encoder, messageSync)\n  const syncMessageType = syncProtocol.readSyncMessage(\n    decoder,\n    encoder,\n    provider.doc,\n    provider\n  )\n  if (\n    emitSynced && syncMessageType === syncProtocol.messageYjsSyncStep2 &&\n    !provider.synced\n  ) {\n    provider.synced = true\n  }\n}\n\nmessageHandlers[messageQueryAwareness] = (\n  encoder,\n  _decoder,\n  provider,\n  _emitSynced,\n  _messageType\n) => {\n  encoding.writeVarUint(encoder, messageAwareness)\n  encoding.writeVarUint8Array(\n    encoder,\n    awarenessProtocol.encodeAwarenessUpdate(\n      provider.awareness,\n      Array.from(provider.awareness.getStates().keys())\n    )\n  )\n}\n\nmessageHandlers[messageAwareness] = (\n  _encoder,\n  decoder,\n  provider,\n  _emitSynced,\n  _messageType\n) => {\n  awarenessProtocol.applyAwarenessUpdate(\n    provider.awareness,\n    decoding.readVarUint8Array(decoder),\n    provider\n  )\n}\n\nmessageHandlers[messageAuth] = (\n  _encoder,\n  decoder,\n  provider,\n  _emitSynced,\n  _messageType\n) => {\n  authProtocol.readAuthMessage(\n    decoder,\n    provider.doc,\n    (_ydoc, reason) => permissionDeniedHandler(provider, reason)\n  )\n}\n\n// @todo - this should depend on awareness.outdatedTime\nconst messageReconnectTimeout = 30000\n\n/**\n * @param {WebsocketProvider} provider\n * @param {string} reason\n */\nconst permissionDeniedHandler = (provider, reason) =>\n  console.warn(`Permission denied to access ${provider.url}.\\n${reason}`)\n\n/**\n * @param {WebsocketProvider} provider\n * @param {Uint8Array} buf\n * @param {boolean} emitSynced\n * @return {encoding.Encoder}\n */\nconst readMessage = (provider, buf, emitSynced) => {\n  const decoder = decoding.createDecoder(buf)\n  const encoder = encoding.createEncoder()\n  const messageType = decoding.readVarUint(decoder)\n  const messageHandler = provider.messageHandlers[messageType]\n  if (/** @type {any} */ (messageHandler)) {\n    messageHandler(encoder, decoder, provider, emitSynced, messageType)\n  } else {\n    console.error('Unable to compute message')\n  }\n  return encoder\n}\n\n/**\n * Outsource this function so that a new websocket connection is created immediately.\n * I suspect that the `ws.onclose` event is not always fired if there are network issues.\n *\n * @param {WebsocketProvider} provider\n * @param {WebSocket} ws\n * @param {CloseEvent | null} event\n */\nconst closeWebsocketConnection = (provider, ws, event) => {\n  if (ws === provider.ws) {\n    provider.emit('connection-close', [event, provider])\n    provider.ws = null\n    ws.close()\n    provider.wsconnecting = false\n    if (provider.wsconnected) {\n      provider.wsconnected = false\n      provider.synced = false\n      // update awareness (all users except local left)\n      awarenessProtocol.removeAwarenessStates(\n        provider.awareness,\n        Array.from(provider.awareness.getStates().keys()).filter((client) =>\n          client !== provider.doc.clientID\n        ),\n        provider\n      )\n      provider.emit('status', [{\n        status: 'disconnected'\n      }])\n    } else {\n      provider.wsUnsuccessfulReconnects++\n    }\n    // Start with no reconnect timeout and increase timeout by\n    // using exponential backoff starting with 100ms\n    setTimeout(\n      setupWS,\n      math.min(\n        math.pow(2, provider.wsUnsuccessfulReconnects) * 100,\n        provider.maxBackoffTime\n      ),\n      provider\n    )\n  }\n}\n\n/**\n * @param {WebsocketProvider} provider\n */\nconst setupWS = (provider) => {\n  if (provider.shouldConnect && provider.ws === null) {\n    const websocket = new provider._WS(provider.url, provider.protocols)\n    websocket.binaryType = 'arraybuffer'\n    provider.ws = websocket\n    provider.wsconnecting = true\n    provider.wsconnected = false\n    provider.synced = false\n\n    websocket.onmessage = (event) => {\n      provider.wsLastMessageReceived = time.getUnixTime()\n      const encoder = readMessage(provider, new Uint8Array(event.data), true)\n      if (encoding.length(encoder) > 1) {\n        websocket.send(encoding.toUint8Array(encoder))\n      }\n    }\n    websocket.onerror = (event) => {\n      provider.emit('connection-error', [event, provider])\n    }\n    websocket.onclose = (event) => {\n      closeWebsocketConnection(provider, websocket, event)\n    }\n    websocket.onopen = () => {\n      provider.wsLastMessageReceived = time.getUnixTime()\n      provider.wsconnecting = false\n      provider.wsconnected = true\n      provider.wsUnsuccessfulReconnects = 0\n      provider.emit('status', [{\n        status: 'connected'\n      }])\n      // always send sync step 1 when connected\n      const encoder = encoding.createEncoder()\n      encoding.writeVarUint(encoder, messageSync)\n      syncProtocol.writeSyncStep1(encoder, provider.doc)\n      websocket.send(encoding.toUint8Array(encoder))\n      // broadcast local awareness state\n      if (provider.awareness.getLocalState() !== null) {\n        const encoderAwarenessState = encoding.createEncoder()\n        encoding.writeVarUint(encoderAwarenessState, messageAwareness)\n        encoding.writeVarUint8Array(\n          encoderAwarenessState,\n          awarenessProtocol.encodeAwarenessUpdate(provider.awareness, [\n            provider.doc.clientID\n          ])\n        )\n        websocket.send(encoding.toUint8Array(encoderAwarenessState))\n      }\n    }\n    provider.emit('status', [{\n      status: 'connecting'\n    }])\n  }\n}\n\n/**\n * @param {WebsocketProvider} provider\n * @param {ArrayBuffer} buf\n */\nconst broadcastMessage = (provider, buf) => {\n  const ws = provider.ws\n  if (provider.wsconnected && ws && ws.readyState === ws.OPEN) {\n    ws.send(buf)\n  }\n  if (provider.bcconnected) {\n    bc.publish(provider.bcChannel, buf, provider)\n  }\n}\n\n/**\n * Websocket Provider for Yjs. Creates a websocket connection to sync the shared document.\n * The document name is attached to the provided url. I.e. the following example\n * creates a websocket connection to http://localhost:1234/my-document-name\n *\n * @example\n *   import * as Y from 'yjs'\n *   import { WebsocketProvider } from 'y-websocket'\n *   const doc = new Y.Doc()\n *   const provider = new WebsocketProvider('http://localhost:1234', 'my-document-name', doc)\n *\n * @extends {ObservableV2<{ 'connection-close': (event: CloseEvent | null,  provider: WebsocketProvider) => any, 'status': (event: { status: 'connected' | 'disconnected' | 'connecting' }) => any, 'connection-error': (event: Event, provider: WebsocketProvider) => any, 'sync': (state: boolean) => any }>}\n */\nexport class WebsocketProvider extends ObservableV2 {\n  /**\n   * @param {string} serverUrl\n   * @param {string} roomname\n   * @param {Y.Doc} doc\n   * @param {object} opts\n   * @param {boolean} [opts.connect]\n   * @param {awarenessProtocol.Awareness} [opts.awareness]\n   * @param {Object<string,string>} [opts.params] specify url parameters\n   * @param {Array<string>} [opts.protocols] specify websocket protocols\n   * @param {typeof WebSocket} [opts.WebSocketPolyfill] Optionall provide a WebSocket polyfill\n   * @param {number} [opts.resyncInterval] Request server state every `resyncInterval` milliseconds\n   * @param {number} [opts.maxBackoffTime] Maximum amount of time to wait before trying to reconnect (we try to reconnect using exponential backoff)\n   * @param {boolean} [opts.disableBc] Disable cross-tab BroadcastChannel communication\n   */\n  constructor (serverUrl, roomname, doc, {\n    connect = true,\n    awareness = new awarenessProtocol.Awareness(doc),\n    params = {},\n    protocols = [],\n    WebSocketPolyfill = WebSocket,\n    resyncInterval = -1,\n    maxBackoffTime = 2500,\n    disableBc = false\n  } = {}) {\n    super()\n    // ensure that serverUrl does not end with /\n    while (serverUrl[serverUrl.length - 1] === '/') {\n      serverUrl = serverUrl.slice(0, serverUrl.length - 1)\n    }\n    this.serverUrl = serverUrl\n    this.bcChannel = serverUrl + '/' + roomname\n    this.maxBackoffTime = maxBackoffTime\n    /**\n     * The specified url parameters. This can be safely updated. The changed parameters will be used\n     * when a new connection is established.\n     * @type {Object<string,string>}\n     */\n    this.params = params\n    this.protocols = protocols\n    this.roomname = roomname\n    this.doc = doc\n    this._WS = WebSocketPolyfill\n    this.awareness = awareness\n    this.wsconnected = false\n    this.wsconnecting = false\n    this.bcconnected = false\n    this.disableBc = disableBc\n    this.wsUnsuccessfulReconnects = 0\n    this.messageHandlers = messageHandlers.slice()\n    /**\n     * @type {boolean}\n     */\n    this._synced = false\n    /**\n     * @type {WebSocket?}\n     */\n    this.ws = null\n    this.wsLastMessageReceived = 0\n    /**\n     * Whether to connect to other peers or not\n     * @type {boolean}\n     */\n    this.shouldConnect = connect\n\n    /**\n     * @type {number}\n     */\n    this._resyncInterval = 0\n    if (resyncInterval > 0) {\n      this._resyncInterval = /** @type {any} */ (setInterval(() => {\n        if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n          // resend sync step 1\n          const encoder = encoding.createEncoder()\n          encoding.writeVarUint(encoder, messageSync)\n          syncProtocol.writeSyncStep1(encoder, doc)\n          this.ws.send(encoding.toUint8Array(encoder))\n        }\n      }, resyncInterval))\n    }\n\n    /**\n     * @param {ArrayBuffer} data\n     * @param {any} origin\n     */\n    this._bcSubscriber = (data, origin) => {\n      if (origin !== this) {\n        const encoder = readMessage(this, new Uint8Array(data), false)\n        if (encoding.length(encoder) > 1) {\n          bc.publish(this.bcChannel, encoding.toUint8Array(encoder), this)\n        }\n      }\n    }\n    /**\n     * Listens to Yjs updates and sends them to remote peers (ws and broadcastchannel)\n     * @param {Uint8Array} update\n     * @param {any} origin\n     */\n    this._updateHandler = (update, origin) => {\n      if (origin !== this) {\n        const encoder = encoding.createEncoder()\n        encoding.writeVarUint(encoder, messageSync)\n        syncProtocol.writeUpdate(encoder, update)\n        broadcastMessage(this, encoding.toUint8Array(encoder))\n      }\n    }\n    this.doc.on('update', this._updateHandler)\n    /**\n     * @param {any} changed\n     * @param {any} _origin\n     */\n    this._awarenessUpdateHandler = ({ added, updated, removed }, _origin) => {\n      const changedClients = added.concat(updated).concat(removed)\n      const encoder = encoding.createEncoder()\n      encoding.writeVarUint(encoder, messageAwareness)\n      encoding.writeVarUint8Array(\n        encoder,\n        awarenessProtocol.encodeAwarenessUpdate(awareness, changedClients)\n      )\n      broadcastMessage(this, encoding.toUint8Array(encoder))\n    }\n    this._exitHandler = () => {\n      awarenessProtocol.removeAwarenessStates(\n        this.awareness,\n        [doc.clientID],\n        'app closed'\n      )\n    }\n    if (env.isNode && typeof process !== 'undefined') {\n      process.on('exit', this._exitHandler)\n    }\n    awareness.on('update', this._awarenessUpdateHandler)\n    this._checkInterval = /** @type {any} */ (setInterval(() => {\n      if (\n        this.wsconnected &&\n        messageReconnectTimeout <\n          time.getUnixTime() - this.wsLastMessageReceived\n      ) {\n        // no message received in a long time - not even your own awareness\n        // updates (which are updated every 15 seconds)\n        closeWebsocketConnection(this, /** @type {WebSocket} */ (this.ws), null)\n      }\n    }, messageReconnectTimeout / 10))\n    if (connect) {\n      this.connect()\n    }\n  }\n\n  get url () {\n    const encodedParams = url.encodeQueryParams(this.params)\n    return this.serverUrl + '/' + this.roomname +\n      (encodedParams.length === 0 ? '' : '?' + encodedParams)\n  }\n\n  /**\n   * @type {boolean}\n   */\n  get synced () {\n    return this._synced\n  }\n\n  set synced (state) {\n    if (this._synced !== state) {\n      this._synced = state\n      // @ts-ignore\n      this.emit('synced', [state])\n      this.emit('sync', [state])\n    }\n  }\n\n  destroy () {\n    if (this._resyncInterval !== 0) {\n      clearInterval(this._resyncInterval)\n    }\n    clearInterval(this._checkInterval)\n    this.disconnect()\n    if (env.isNode && typeof process !== 'undefined') {\n      process.off('exit', this._exitHandler)\n    }\n    this.awareness.off('update', this._awarenessUpdateHandler)\n    this.doc.off('update', this._updateHandler)\n    super.destroy()\n  }\n\n  connectBc () {\n    if (this.disableBc) {\n      return\n    }\n    if (!this.bcconnected) {\n      bc.subscribe(this.bcChannel, this._bcSubscriber)\n      this.bcconnected = true\n    }\n    // send sync step1 to bc\n    // write sync step 1\n    const encoderSync = encoding.createEncoder()\n    encoding.writeVarUint(encoderSync, messageSync)\n    syncProtocol.writeSyncStep1(encoderSync, this.doc)\n    bc.publish(this.bcChannel, encoding.toUint8Array(encoderSync), this)\n    // broadcast local state\n    const encoderState = encoding.createEncoder()\n    encoding.writeVarUint(encoderState, messageSync)\n    syncProtocol.writeSyncStep2(encoderState, this.doc)\n    bc.publish(this.bcChannel, encoding.toUint8Array(encoderState), this)\n    // write queryAwareness\n    const encoderAwarenessQuery = encoding.createEncoder()\n    encoding.writeVarUint(encoderAwarenessQuery, messageQueryAwareness)\n    bc.publish(\n      this.bcChannel,\n      encoding.toUint8Array(encoderAwarenessQuery),\n      this\n    )\n    // broadcast local awareness state\n    const encoderAwarenessState = encoding.createEncoder()\n    encoding.writeVarUint(encoderAwarenessState, messageAwareness)\n    encoding.writeVarUint8Array(\n      encoderAwarenessState,\n      awarenessProtocol.encodeAwarenessUpdate(this.awareness, [\n        this.doc.clientID\n      ])\n    )\n    bc.publish(\n      this.bcChannel,\n      encoding.toUint8Array(encoderAwarenessState),\n      this\n    )\n  }\n\n  disconnectBc () {\n    // broadcast message with local awareness state set to null (indicating disconnect)\n    const encoder = encoding.createEncoder()\n    encoding.writeVarUint(encoder, messageAwareness)\n    encoding.writeVarUint8Array(\n      encoder,\n      awarenessProtocol.encodeAwarenessUpdate(this.awareness, [\n        this.doc.clientID\n      ], new Map())\n    )\n    broadcastMessage(this, encoding.toUint8Array(encoder))\n    if (this.bcconnected) {\n      bc.unsubscribe(this.bcChannel, this._bcSubscriber)\n      this.bcconnected = false\n    }\n  }\n\n  disconnect () {\n    this.shouldConnect = false\n    this.disconnectBc()\n    if (this.ws !== null) {\n      closeWebsocketConnection(this, this.ws, null)\n    }\n  }\n\n  connect () {\n    this.shouldConnect = true\n    if (!this.wsconnected && this.ws === null) {\n      setupWS(this)\n      this.connectBc()\n    }\n  }\n}\n","\nimport * as Y from 'yjs' // eslint-disable-line\nimport * as encoding from 'lib0/encoding'\nimport * as decoding from 'lib0/decoding'\n\nexport const messagePermissionDenied = 0\n\n/**\n * @param {encoding.Encoder} encoder\n * @param {string} reason\n */\nexport const writePermissionDenied = (encoder, reason) => {\n  encoding.writeVarUint(encoder, messagePermissionDenied)\n  encoding.writeVarString(encoder, reason)\n}\n\n/**\n * @callback PermissionDeniedHandler\n * @param {any} y\n * @param {string} reason\n */\n\n/**\n *\n * @param {decoding.Decoder} decoder\n * @param {Y.Doc} y\n * @param {PermissionDeniedHandler} permissionDeniedHandler\n */\nexport const readAuthMessage = (decoder, y, permissionDeniedHandler) => {\n  switch (decoding.readVarUint(decoder)) {\n    case messagePermissionDenied: permissionDeniedHandler(y, decoding.readVarString(decoder))\n  }\n}\n","/**\n * Utility module to work with urls.\n *\n * @module url\n */\n\nimport * as object from './object.js'\n\n/**\n * Parse query parameters from an url.\n *\n * @param {string} url\n * @return {Object<string,string>}\n */\nexport const decodeQueryParams = url => {\n  /**\n   * @type {Object<string,string>}\n   */\n  const query = {}\n  const urlQuerySplit = url.split('?')\n  const pairs = urlQuerySplit[urlQuerySplit.length - 1].split('&')\n  for (let i = 0; i < pairs.length; i++) {\n    const item = pairs[i]\n    if (item.length > 0) {\n      const pair = item.split('=')\n      query[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '')\n    }\n  }\n  return query\n}\n\n/**\n * @param {Object<string,string>} params\n * @return {string}\n */\nexport const encodeQueryParams = params =>\n  object.map(params, (val, key) => `${encodeURIComponent(key)}=${encodeURIComponent(val)}`).join('&')\n","import { __ } from '@wordpress/i18n';\n\nexport function getErrorMessage( error: unknown, defaultMessage?: string ): string {\n\tif ( error instanceof Error ) {\n\t\treturn error.message;\n\t}\n\n\t// First look for a .data.error string (as returned by the REST API).\n\tif (\n\t\terror &&\n\t\ttypeof error === 'object' &&\n\t\t'data' in error &&\n\t\terror.data &&\n\t\ttypeof error.data === 'object' &&\n\t\t'error' in error.data\n\t) {\n\t\treturn getErrorMessage( error.data.error, defaultMessage );\n\t}\n\n\t// Next look for an error-like object with a message string.\n\tif (\n\t\terror &&\n\t\ttypeof error === 'object' &&\n\t\t'message' in error &&\n\t\ttypeof error.message === 'string'\n\t) {\n\t\treturn error.message;\n\t}\n\n\treturn defaultMessage ?? __( 'Unknown error', 'vip-real-time-collaboration' );\n}\n","import { isDevelopment } from '@/utilities/config';\nimport { Logger } from '@/utilities/logger';\n\nconst logger = new Logger( 'crypto' );\n\n/**\n * Generate a UUID.\n *\n * Uses window.crypto.randomUUID if available, otherwise falls back to a\n * custom implementation.\n *\n * @returns A UUID.\n */\nexport function generateUUID(): string {\n\tif ( window.isSecureContext ) {\n\t\treturn window.crypto.randomUUID();\n\t}\n\n\t// Fallback for when crypto.randomUUID is not available.\n\tif ( isDevelopment() ) {\n\t\tlogger.warn( 'Using fallback UUID function in non-secure context.' );\n\n\t\treturn 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace( /[xy]/g, function ( char ) {\n\t\t\t// eslint-disable-next-line no-bitwise\n\t\t\tconst randomValue = ( Math.random() * 16 ) | 0;\n\t\t\t// eslint-disable-next-line no-bitwise\n\t\t\tconst value = char === 'x' ? randomValue : ( randomValue & 0x3 ) | 0x8;\n\t\t\treturn value.toString( 16 );\n\t\t} );\n\t}\n\n\tthrow new Error( 'Unable to generate UUID outside of secure context in non-development mode!' );\n}\n","/**\n * External dependencies\n */\nimport apiFetch from '@wordpress/api-fetch';\nimport { __ } from '@wordpress/i18n';\nimport { WebsocketProvider, type WebsocketProviderOptions } from 'y-websocket';\n\nimport { AwarenessManager } from '@/awareness-manager';\nimport {\n\tisDevelopment,\n\tBLOG_ID,\n\tWEBSOCKET_PROVIDER_MAX_BACKOFF_IN_MS,\n\tWEBSOCKET_URL,\n} from '@/utilities/config';\nimport { generateUUID } from '@/utilities/crypto';\nimport { getErrorMessage } from '@/utilities/error';\nimport { memoizeFn } from '@/utilities/function';\nimport { Logger } from '@/utilities/logger';\n\nimport type { ObjectID, ObjectType, ProviderCreator } from '@wordpress/sync';\nimport type { Awareness } from 'y-protocols/awareness.js';\nimport type * as Y from 'yjs';\n\nexport interface WebSocketConnectionConfig {\n\toptions?: WebsocketProviderOptions;\n\tserverUrl: string;\n}\n\nconst defaultResult = {\n\tdestroy: () => {},\n};\n\n/**\n * Creates a connection ID generator with in-memory storage\n */\nconst getConnectionId = memoizeFn( (): string => generateUUID() );\n\nconst logger = new Logger( 'websocket-client' );\n\n/**\n * Fetch a fresh authentication token from the REST API.\n */\nasync function fetchAuthToken( syncObjectType: string, syncObjectId: string ): Promise< string > {\n\tconst data = await apiFetch< { token: string } >( {\n\t\tpath: '/vip-rtc/v1/websocket/auth',\n\t\tmethod: 'POST',\n\t\tdata: {\n\t\t\tsyncObjectType,\n\t\t\tsyncObjectId,\n\t\t\tconnectionId: getConnectionId(),\n\t\t},\n\t} );\n\n\tif ( ! data.token ) {\n\t\tthrow new Error( __( 'No auth token returned', 'vip-real-time-collaboration' ) );\n\t}\n\n\treturn data.token;\n}\n\n/**\n * Log a link to inspect the Yjs provider using Yjs inspector.\n */\nfunction logInspectUrl( provider: WebsocketProvider ): void {\n\tconst connectionConfig = {\n\t\tcreateNewDoc: false,\n\t\troom: `${ provider.roomname }?auth=${ provider.params?.auth }`,\n\t\tprovider: 'y-websocket',\n\t\turl: WEBSOCKET_URL,\n\t};\n\n\t// The inspect URL always targets a local Yjs inspector.\n\tconst inspectUrl = `http://localhost:5173/#/connection=${ encodeURIComponent(\n\t\tJSON.stringify( connectionConfig )\n\t) }`;\n\n\tlogger.info( `Yjs inspector for ${ provider.roomname }: ${ inspectUrl }` );\n}\n\nfunction onStatusChange(\n\tevent: { status: 'connected' | 'connecting' | 'connection-error' | 'disconnected' },\n\tprovider: WebsocketProvider\n): void {\n\tswitch ( event.status ) {\n\t\tcase 'connecting': {\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'connection-error': {\n\t\t\tAwarenessManager.setConnectionStatus( provider.awareness.clientID, false );\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'connected': {\n\t\t\tAwarenessManager.setConnectionStatus( provider.awareness.clientID, true );\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'disconnected': {\n\t\t\tAwarenessManager.setConnectionStatus( provider.awareness.clientID, false );\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\n/**\n * Configure the websocket provider to use auth token for websocket connection.\n * Implement exponential backoff for reconnect attempts since we are opting out\n * of the built-in reconnect logic by disabling `provider.shouldConnect`.\n */\nfunction createConnect(\n\tprovider: WebsocketProvider,\n\tsyncObjectType: string,\n\tsyncObjectId: string\n): () => Promise< void > {\n\tlet reconnectAttempts = 0;\n\n\treturn async function (): Promise< void > {\n\t\tif ( reconnectAttempts > 0 ) {\n\t\t\tconst backoffDelayInMs = Math.min(\n\t\t\t\t1000 * 2 ** reconnectAttempts,\n\t\t\t\tWEBSOCKET_PROVIDER_MAX_BACKOFF_IN_MS\n\t\t\t);\n\n\t\t\tlogger.warn(\n\t\t\t\t`Attempting to reconnect to WebSocket in ${ Math.floor( backoffDelayInMs / 1000 ) }s...`\n\t\t\t);\n\n\t\t\tawait new Promise( resolve => setTimeout( resolve, backoffDelayInMs ) );\n\t\t}\n\n\t\treconnectAttempts += 1;\n\n\t\ttry {\n\t\t\tconst authToken = await fetchAuthToken( syncObjectType, syncObjectId );\n\n\t\t\tprovider.params = {\n\t\t\t\tauth: authToken,\n\t\t\t};\n\t\t\tprovider.connect();\n\n\t\t\t// Disable provider#shouldConnect to prevent websocket from attempting to\n\t\t\t// reconnect before the new auth token is fetched (they are short-lived).\n\t\t\t// When provider.connect() runs it updates provider#shouldConnect to true.\n\t\t\tprovider.shouldConnect = false;\n\n\t\t\tlogInspectUrl( provider );\n\t\t} catch ( error: unknown ) {\n\t\t\tlogger.error(\n\t\t\t\t`${ __(\n\t\t\t\t\t'Failed to fetch auth token and connect to WebSocket',\n\t\t\t\t\t'vip-real-time-collaboration'\n\t\t\t\t) }: ${ getErrorMessage( error ) }`\n\t\t\t);\n\t\t}\n\t};\n}\n\n/**\n * Function that creates a new WebSocket Connection.\n *\n * @param {string} serverUrl The WebSocket server URL.\n * @return {ProviderCreator} A function that connects a Y.Doc to a WebSocket server.\n */\nexport function createWebSocketConnection( serverUrl: string ): ProviderCreator {\n\tconst config: WebSocketConnectionConfig = {\n\t\tserverUrl,\n\t\toptions: {\n\t\t\t/**\n\t\t\t * Disable automatic connection to prevent websocket from attempting to connect\n\t\t\t * before the auth token is fetched.\n\t\t\t */\n\t\t\tconnect: false,\n\t\t},\n\t};\n\n\treturn async function (\n\t\tobjectType: ObjectType,\n\t\tobjectId: ObjectID,\n\t\tdoc: Y.Doc,\n\t\tawareness?: Awareness\n\t) {\n\t\ttry {\n\t\t\t// For now, we only support traditional post types.\n\t\t\tif ( ! objectType.startsWith( 'postType/' ) || ! parseInt( objectId, 10 ) ) {\n\t\t\t\tlogger.debug( 'WebSocket connection skipped for unsupported object', {\n\t\t\t\t\tobjectType,\n\t\t\t\t\tobjectId,\n\t\t\t\t} );\n\t\t\t\treturn defaultResult;\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * Some entities like posts aren't unique across all sites in a multisite setup.\n\t\t\t * To avoid conflicts, we add the blog ID to the room name.\n\t\t\t *\n\t\t\t * This might not be desired for entities like sites which are unique across the\n\t\t\t * multisite. We don't sync entities like those yet. When we do, we'll need to revisit\n\t\t\t * adding the blog ID to the room name as that won't be needed.\n\t\t\t */\n\t\t\tconst roomName = `site-${ BLOG_ID ?? 1 }/${ objectType }-${ objectId }`;\n\t\t\tconst options = { ...config.options, awareness };\n\t\t\tconst provider = new WebsocketProvider( config.serverUrl, roomName, doc, options );\n\t\t\tconst connect = createConnect( provider, objectType, objectId );\n\n\t\t\tprovider.on( 'connection-close', connect );\n\t\t\tprovider.on( 'connection-error', () => {\n\t\t\t\t// The provider does not change status on connection error, so we\n\t\t\t\t// manually trigger a synthetic status change.\n\t\t\t\tonStatusChange( { status: 'connection-error' }, provider );\n\t\t\t} );\n\t\t\tprovider.on( 'status', event => onStatusChange( event, provider ) );\n\n\t\t\t// Provide some debugging functions in development mode.\n\t\t\tif ( isDevelopment() ) {\n\t\t\t\twindow.VIP_RTC.debug.disconnectWebSocket = () => {\n\t\t\t\t\tprovider.off( 'connection-close', connect );\n\t\t\t\t\tprovider.disconnect();\n\t\t\t\t};\n\n\t\t\t\twindow.VIP_RTC.debug.reconnectWebSocket = () => {\n\t\t\t\t\tprovider.on( 'connection-close', connect );\n\t\t\t\t\tvoid connect();\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tif ( awareness ) {\n\t\t\t\tlogger.debug( 'Initializing awareness for WebSocket connection', { objectType, objectId } );\n\t\t\t\tawait AwarenessManager.initialize( awareness );\n\t\t\t}\n\n\t\t\tawait connect();\n\n\t\t\treturn {\n\t\t\t\tdestroy: () => provider.destroy(),\n\t\t\t};\n\t\t} catch ( err ) {\n\t\t\tlogger.critical( 'Failed to create WebSocket connection', { error: err } );\n\t\t}\n\n\t\treturn defaultResult;\n\t};\n}\n","export function memoizeFn< T extends ( ...args: unknown[] ) => unknown >( fn: T ): T {\n\tconst cache = new Map< string, ReturnType< T > >();\n\n\treturn ( ( ...args: Parameters< T > ) => {\n\t\tconst key = JSON.stringify( args );\n\t\tif ( cache.has( key ) ) {\n\t\t\treturn cache.get( key );\n\t\t}\n\n\t\tconst result = fn( ...args ) as ReturnType< T >;\n\t\tcache.set( key, result );\n\t\treturn result;\n\t} ) as T;\n}\n","import { addFilter } from '@wordpress/hooks';\nimport { registerPlugin } from '@wordpress/plugins';\n\nimport { ReadOnlyCodeEditor } from '@/components/read-only-code-editor';\nimport { RTCSettingsPanel } from '@/components/rtc-settings-panel';\nimport { WEBSOCKET_URL } from '@/utilities/config';\nimport { Logger } from '@/utilities/logger';\nimport { createWebSocketConnection } from '@/websocket-client';\n\naddFilter( 'sync.providers', 'vip-rtc', () => {\n\t// We already error check for the WebSocket URL in the main plugin file,\n\t// so this is here for safety.\n\tif ( ! WEBSOCKET_URL ) {\n\t\tnew Logger().critical(\n\t\t\t'VIP Real-Time Collaboration WebSocket URL has not been configured. The plugin will not be functional without it.'\n\t\t);\n\t\treturn [];\n\t}\n\n\treturn [ createWebSocketConnection( WEBSOCKET_URL ) ];\n} );\n\nregisterPlugin( 'vip-rtc-settings-panel', {\n\trender: RTCSettingsPanel,\n} );\n\nregisterPlugin( 'vip-rtc-read-only-code-editor', {\n\trender: ReadOnlyCodeEditor,\n} );\n","/**\n * WordPress dependencies\n */\nimport { useSelect } from '@wordpress/data';\nimport { store as editPostStore, type EditPostStoreSelectors } from '@wordpress/edit-post';\nimport { useEffect } from '@wordpress/element';\nimport { applyFilters } from '@wordpress/hooks';\n\nfunction isTextAreaElement( element: Element | null ): element is HTMLTextAreaElement {\n\treturn element?.matches( 'textarea' ) ?? false;\n}\n\nexport function ReadOnlyCodeEditor() {\n\t// Get the current editor mode (visual or text).\n\t// Visual mode is the default block editor mode.\n\t// Text mode is the code editor mode.\n\tconst editorMode = useSelect< EditPostStoreSelectors, 'visual' | 'text' | undefined >( select => {\n\t\tconst { getEditorMode } = select( editPostStore );\n\t\treturn getEditorMode();\n\t} );\n\n\t// When in text mode, set the code editor (textarea) to read-only.\n\tuseEffect( () => {\n\t\tif ( editorMode === 'text' ) {\n\t\t\tconst editorPostTextEditorElement = document.querySelector( '.editor-post-text-editor' );\n\n\t\t\tif ( isTextAreaElement( editorPostTextEditorElement ) ) {\n\t\t\t\t// Add a filter here to customize this value, based on any external logic.\n\t\t\t\tconst readOnly = applyFilters( 'vip_rtc_read_only_code_editor', true );\n\n\t\t\t\t// Ensure we have a boolean value only, defaulting to true for safety.\n\t\t\t\teditorPostTextEditorElement.readOnly = typeof readOnly === 'boolean' ? readOnly : true;\n\t\t\t}\n\t\t}\n\t}, [ editorMode ] );\n\n\treturn null;\n}\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","window","Avatar","userInfo","showUserColorBorder","style","border","color","undefined","opacity","isConnected","_jsx","className","children","alt","name","src","avatarUrl","title","WEBSOCKET_URL","getVipConfigFromWindow","BLOG_ID","VIP_RTC","LogLevel","DEFAULT_LOG_THRESHOLD","WARNING","Logger","constructor","localNamespace","threshold","this","namespace","log","level","args","levelStr","console","debug","DEBUG","info","INFO","warn","error","ERROR","critical","CRITICAL","logger","loadFromLocalStorage","defaultValue","saved","localStorage","getItem","parsed","JSON","parse","Array","isArray","assign","saveToLocalStorage","data","setItem","stringify","LOCAL_STORAGE_KEY","Setting","DEFAULT_STATE","AWARENESS_AVATARS","AWARENESS_CURSORS","DEBUG_TOOLS","SELF_AWARENESS","USER_ENTER_NOTIFICATION","USER_EXIT_NOTIFICATION","selectors","getSetting","state","setting","store","createReduxStore","reducer","action","type","newState","payload","enabled","actions","setSetting","NotificationType","sendNotification","status","createNotice","dispatch","noticesStore","content","PostRestored","predicate","isMe","getPostRestoredNotificationContent","PostUpdated","noun","verb","includes","getPostUpdatedNotificationContent","UserEntered","UserExited","getUserPresenceNotificationContent","getContentForNotificationType","select","settingsStore","shouldSendNotification","id","clientId","isDismissible","register","applyUpdate","wp","sync","Y","encodeStateVector","applyUpdateV2","encodeStateAsUpdate","createRelativePositionFromTypeIndex","encodeStateAsUpdateV2","createAbsolutePositionFromRelativePosition","Doc","SelectionType","getSelectionState","selectionStart","selectionEnd","yBlocks","isSelectionEmpty","keys","length","noSelection","None","isSelectionInOneBlock","isCursorOnly","offset","WholeBlock","blockId","cursorPosition","getCursorPosition","Cursor","cursorStartPosition","cursorEndPosition","SelectionInOneBlock","SelectionInMultipleBlocks","blockStartId","blockEndId","selection","blocks","block","findBlockByClientId","currentYText","attributeKey","relativePosition","absoluteOffset","innerBlock","areCursorPositionsEqual","cursorPosition1","cursorPosition2","isRelativePositionEqual","isAbsoluteOffsetEqual","areUserInfosEqual","userInfo1","userInfo2","entries","every","value","areEditorStatesEqual","state1","state2","Boolean","selection1","selection2","areSelectionsEqual","userMap","Map","getActiveClientIds","from","getActiveUsers","isDisconnected","values","findIndex","user","has","existingState","updatedState","set","delete","editorState","userState1","userState2","userState","patchUserInfo","removeUser","updateEditorState","upsertUser","useSortedAwarenessUsers","activeUsers","useSelect","awarenessStore","useMemo","sort","user1","user2","Avatars","isSelfAwarenessEnabled","rtcSettingsStore","visibleUsers","slice","remainingUsers","remainingUsersText","map","join","_jsxs","_Fragment","typeCharacter","targetElement","character","iframeDocument","getSelection","rangeCount","range","getRangeAt","deleteContents","textNode","createTextNode","insertNode","setStartAfter","setEndAfter","removeAllRanges","addRange","createRange","selectNodeContents","collapse","DebugTools","isTyping","setIsTyping","useState","lastSelectedBlock","setLastSelectedBlock","typingSpeed","setTypingSpeed","typingIntervalRef","useRef","getSelectedBlockClientId","blockEditorStore","selectedBlockClientId","selectBlock","insertBlock","useDispatch","useEffect","ensureBlockExists","__awaiter","newBlock","createBlock","Promise","resolve","setTimeout","currentSelection","then","targetBlockId","charIndex","currentLineIndex","currentLine","loremIpsumLines","Math","floor","random","current","setInterval","blockElement","querySelector","getAttribute","findEditableElement","activeElement","focus","nextChar","startTypingInterval","catch","clearInterval","onClick","toggleTyping","handleSpeedReset","min","max","onChange","event","parseInt","target","SVG","viewBox","xmlns","Path","fillRule","clipRule","PostLockedModal","buttonRef","onSuccess","postContent","getEditedPostContent","editorStore","useCopyToClipboard","useCopyPostContentToClipboard","disconnectedPastThreshold","setDisconnectedPastThreshold","timeoutRef","clearTimeout","_a","useIsDisconnected","Modal","__experimentalHideHeader","icon","isFullScreen","onRequestClose","shouldCloseOnClickOutside","shouldCloseOnEsc","VStack","alignment","justify","spacing","Icon","fill","size","__","HStack","Button","ref","variant","href","isDestructive","getBlockElementById","blockEditorDocument","getBrowserName","userAgent","navigator","browserName","getCurrentUserInfo","avatar_urls","avatarUrls","slug","coreStore","getCurrentUser","METRO_COLORS","getNewUserColor","existingColors","availableColors","filter","generateRandomInt","hexColor","preferredColor","round","USER_HIGHLIGHT_ALPHA","toString","padStart","toUpperCase","DrawType","AwarenessManager","awareness","setCurrentUserState","refreshAwareness","subscribeToCRDTChanges","subscribeToSelectionChanges","subscribeToUserChanges","initialize","__instance","clientID","setConnectionStatus","convertRelativePositionToAbsolutePosition","position","_b","doc","states","getStates","otherUserColors","browserType","setLocalStateField","field","clientIdsFromStore","Set","clientIdsFromAwareness","forEach","validateUserState","add","now","Date","recordMap","getMap","stateMap","observe","transaction","keysChanged","local","remoteClientId","getSelectionStart","getSelectionEnd","getSelectedBlocksInitialCaretPosition","localCursorTimeout","subscribe","newSelectionStart","newSelectionEnd","initialPosition","editEntityRecord","getCurrentPostId","getCurrentPostType","postId","postType","edits","undoIgnore","updateSelectionInEntityRecord","updateSelectionState","awarenessCursorTimeout","pendingEditorState","userRemovalTimeouts","on","added","removed","updated","updatedUserStates","drawUserSelections","overlay","editorDocument","userSelections","drawType","querySelectorAll","container","remove","userName","OtherUsers","coords","selectionAsCursor","userContainer","document","createElement","left","x","top","y","cursor","backgroundColor","height","label","textContent","appendChild","absolutePosition","getOffsetPositionInBlock","index","charOffset","node","findInnerBlockOffset","cursorRange","setStart","cursorRect","getBoundingClientRect","overlayRect","blockRect","cursorX","cursorY","width","cursorHeight","getComputedStyle","lineHeight","treeWalker","createTreeWalker","NodeFilter","SHOW_TEXT","SHOW_ELEMENT","currentOffset","lastTextNode","nodeCount","nextNode","nodeLength","nodeValue","nodeType","Node","ELEMENT_NODE","TEXT_NODE","nodeName","nodeAfterBr","_d","_c","_e","RTCOverlay","containerRef","overlayRef","setDocument","ownerDocument","renderCursorsRef","All","sortedUsers","useRenderCursors","resizeObserverRef","useResizeObserver","mergedRef","useMergeRefs","highlightedBlockIds","userStates","isAwarenessCursorsEnabled","unhighlightBlocks","blockIds","boxShadow","borderRadius","blocksToHighlight","isWholeBlockSelected","shouldDrawUser","selectedBlockIds","blockColorPair","useBlockHighlighting","unlock","__dangerousOptInToUnstableAPIsOnlyForCoreModules","EditorPresence","editorPrivateApis","create","setIfUndefined","createT","fromCharCode","String","trimLeftRegex","fromCodePoint","fromCamelCaseRegex","fromCamelCase","s","separator","replace","trimLeft","match","toLowerCase","utf8TextEncoder","TextEncoder","utf8TextDecoder","TextDecoder","fatal","ignoreBOM","decode","Uint8Array","_localStorage","newValue","usePolyfill","e","varStorage","isNode","process","release","test","isBrowser","params","platform","hasParam","pargs","argv","currParamName","i","parg","push","location","search","split","kv","computeParams","getVariable","v","env","replaceAll","hasConf","FORCE_COLOR","stdout","isTTY","toBase64","bytes","byteLength","btoa","Buffer","buffer","byteOffset","fromBase64","atob","len","charCodeAt","buf","channels","BC","BroadcastChannel","room","eventHandler","onmessage","_onChange","addEventListener","postMessage","close","removeEventListener","getChannel","subs","bc","sub","publish","origin","c","getUnixTime","ceil","abs","imul","log10","log2","sqrt","b","pow","Number","isNaN","BIT8","sign","BITS7","Encoder","cpos","cbuf","bufs","createEncoder","encoder","toUint8Array","uint8arr","curPos","write","num","bufferLen","writeVarUint","writeUint8Array","encodeInto","uint8Array","leftCopyLen","rightCopyLen","subarray","writeVarUint8Array","DataView","ArrayBuffer","MAX_SAFE_INTEGER","MIN_SAFE_INTEGER","isInteger","Error","errorUnexpectedEndOfArray","errorIntegerOutOfRange","Decoder","arr","pos","readVarUint8Array","decoder","view","readUint8Array","readVarUint","mult","r","str","encode","encodedString","unescape","encodeURIComponent","codePointAt","written","remainingLen","nextLen","apply","decodeURIComponent","escape","writeSyncStep1","sv","writeSyncStep2","encodedStateVector","readSyncStep2","transactionOrigin","readUpdate","Observable","_observers","f","once","_f","off","observers","emit","destroy","hasProperty","EqualityTraitSymbol","freeze","Symbol","Awareness","super","meta","_checkInterval","getLocalState","outdatedTimeout","lastUpdated","setLocalState","clientid","removeAwarenessStates","currLocalMeta","clock","prevState","filteredUpdated","clients","curMeta","encodeAwarenessUpdate","messageHandlers","provider","emitSynced","_messageType","syncMessageType","messageType","readSyncStep1","synced","_decoder","_emitSynced","_encoder","update","timestamp","clientMeta","currClock","permissionDeniedHandler","_ydoc","reason","url","readMessage","messageHandler","closeWebsocketConnection","ws","wsconnecting","wsconnected","client","wsUnsuccessfulReconnects","setupWS","maxBackoffTime","shouldConnect","websocket","_WS","protocols","binaryType","wsLastMessageReceived","send","onerror","onclose","onopen","encoderAwarenessState","broadcastMessage","readyState","OPEN","bcconnected","bcChannel","WebsocketProvider","serverUrl","roomname","connect","WebSocketPolyfill","WebSocket","resyncInterval","disableBc","_synced","_resyncInterval","_bcSubscriber","_updateHandler","_awarenessUpdateHandler","_origin","changedClients","concat","_exitHandler","messageReconnectTimeout","encodedParams","results","val","disconnect","connectBc","encoderSync","encoderState","encoderAwarenessQuery","disconnectBc","channel","getErrorMessage","defaultMessage","message","defaultResult","getConnectionId","cache","result","isSecureContext","crypto","randomUUID","generateUUID","fn","memoizeFn","onStatusChange","createConnect","syncObjectType","syncObjectId","reconnectAttempts","backoffDelayInMs","authToken","apiFetch","path","method","connectionId","token","fetchAuthToken","auth","connectionConfig","createNewDoc","inspectUrl","logInspectUrl","createWebSocketConnection","config","options","objectType","objectId","startsWith","roomName","err","addFilter","registerPlugin","render","isAvatarsEnabled","isCursorsEnabled","isDebugToolsEnabled","isUserEnterNotificationEnabled","isUserExitNotificationEnabled","BlockCanvasCover","Fill","PluginDocumentSettingPanel","ToggleControl","checked","Heading","marginTop","marginBottom","Flex","direction","gap","FlexItem","Text","editorMode","getEditorMode","editPostStore","editorPostTextEditorElement","element","matches","readOnly","applyFilters"],"sourceRoot":""}