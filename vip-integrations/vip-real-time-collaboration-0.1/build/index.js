(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var s in n)e.o(n,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:n[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.hooks,n=window.wp.plugins,s=window.ReactJSXRuntime,o=window.wp.components,r=window.wp.data,c=window.wp.editor,i=window.wp.i18n;function a({userState:e,showUserColorBorder:t}){const n=e.avatar_urls[24]||e.avatar_urls[48]||e.avatar_urls[96],o={border:!0===t?`2px solid ${e.color}`:void 0,opacity:e.isConnected?1:.5};return(0,s.jsx)("div",{className:"vip-real-time-collaboration-avatar",children:(0,s.jsx)("img",{src:n,alt:e.name,title:e.name,style:o})})}const l=(e,t)=>{try{const n=localStorage.getItem(e);if(n){const e=JSON.parse(n);return"object"!=typeof e||null===e||Array.isArray(e)?e:Object.assign(Object.assign({},t),e)}}catch(t){console.warn(`Failed to load data from localStorage (key: ${e}):`,t)}return t},u=(e,t)=>{try{localStorage.setItem(e,JSON.stringify(t))}catch(t){console.warn(`Failed to save data to localStorage (key: ${e}):`,t)}},d="vip-rtc-settings",h={isAwarenessAvatarsEnabled:!0,isAwarenessHighlightsEnabled:!0,isAwarenessCursorsEnabled:!0},f={isAwarenessAvatarsEnabled(e){const{isAwarenessAvatarsEnabled:t}=e;return t},isAwarenessHighlightsEnabled(e){const{isAwarenessHighlightsEnabled:t}=e;return t},isAwarenessCursorsEnabled(e){const{isAwarenessCursorsEnabled:t}=e;return t}},p=(0,r.createReduxStore)("vip-real-time-collaboration/settings",{reducer:(e=l(d,h),t)=>{switch(t.type){case"SET_AWARENESS_AVATARS_ENABLED":{const n=Object.assign(Object.assign({},e),{isAwarenessAvatarsEnabled:t.payload});return u(d,n),n}case"SET_AWARENESS_HIGHLIGHTS_ENABLED":{const n=Object.assign(Object.assign({},e),{isAwarenessHighlightsEnabled:t.payload});return u(d,n),n}case"SET_AWARENESS_CURSORS_ENABLED":{const n=Object.assign(Object.assign({},e),{isAwarenessCursorsEnabled:t.payload});return u(d,n),n}default:return e}},actions:{setAwarenessAvatarsEnabled:e=>({type:"SET_AWARENESS_AVATARS_ENABLED",payload:e}),setAwarenessHighlightsEnabled:e=>({type:"SET_AWARENESS_HIGHLIGHTS_ENABLED",payload:e}),setAwarenessCursorsEnabled:e=>({type:"SET_AWARENESS_CURSORS_ENABLED",payload:e})},selectors:f});(0,r.register)(p);const g=window.wp.element,b=window.wp.coreData,w=window.wp.blockEditor,v=window.wp.blocks,y=window.wp.compose,m={};function S(e){let t=null;return()=>{null!==t&&cancelAnimationFrame(t),t=requestAnimationFrame(()=>{e()})}}var E;!function(e){e.None="none",e.Cursor="cursor",e.SelectionInOneBlock="selection-in-1-block",e.SelectionInMultipleBlocks="selection-in-multiple-blocks"}(E||(E={}));const I=(e,t,n,s)=>{return o=void 0,c=void 0,a=function*(){const{editEntityRecord:o}=(0,r.dispatch)(b.store);if(e.clientId){const r={selection:{selectionStart:e,selectionEnd:t,initialPosition:n}};o(s.kind,s.name,s.recordId,r,{undoIgnore:!0})}const{setCurrentUserSelection:c}=(0,r.dispatch)(M);c(C(e,t))},new((i=void 0)||(i=Promise))(function(e,t){function n(e){try{r(a.next(e))}catch(e){t(e)}}function s(e){try{r(a.throw(e))}catch(e){t(e)}}function r(t){var o;t.done?e(t.value):(o=t.value,o instanceof i?o:new i(function(e){e(o)})).then(n,s)}r((a=a.apply(o,c||[])).next())});var o,c,i,a},C=(e,t)=>{if(0===Object.keys(e).length)return{type:E.None};const n=e.clientId===t.clientId;return n&&e.offset===t.offset?{type:E.Cursor,blockId:e.clientId,cursorPosition:e.offset}:n?{type:E.SelectionInOneBlock,blockId:e.clientId,cursorStartPosition:e.offset,cursorEndPosition:t.offset}:{type:E.SelectionInMultipleBlocks,blockStartId:e.clientId,blockEndId:t.clientId,cursorStartPosition:e.offset,cursorEndPosition:t.offset}},A=(e,t,n,s)=>{e.querySelectorAll(".vip-real-time-collaboration-user").forEach(e=>{e.remove()}),s&&n.forEach(({userName:n,selection:s,color:o})=>{let r=null;if(s.type===E.None);else if(s.type===E.Cursor)r=x(s,t,e);else if(s.type===E.SelectionInOneBlock){const n={type:E.Cursor,blockId:s.blockId,cursorPosition:s.cursorStartPosition};r=x(n,t,e)}else if(s.type===E.SelectionInMultipleBlocks){const n={type:E.Cursor,blockId:s.blockStartId,cursorPosition:s.cursorStartPosition};r=x(n,t,e)}if(r){const t=document.createElement("div");t.className="vip-real-time-collaboration-user",t.style.left=`${r.x}px`,t.style.top=`${r.y}px`;const s=document.createElement("div");s.className="vip-real-time-collaboration-user-cursor",s.style.backgroundColor=o,s.style.height=`${r.height}px`;const c=document.createElement("div");c.className="vip-real-time-collaboration-user-label",c.textContent=n,c.style.backgroundColor=o,t.appendChild(s),t.appendChild(c),e.appendChild(t)}})},x=(e,t,n)=>{const s=t.querySelector(`[data-block="${e.blockId}"]`);if(!s)return null;const o=_(s,e.cursorPosition,t,n);return null!=o?o:null},_=(e,t,n,s)=>{const{node:o,offset:r}=U(e,t,n),c=n.createRange();try{c.setStart(o,r)}catch(e){return console.error("Failed to create a range for cursor:",{error:e,node:o,offset:r}),null}c.collapse(!0);const i=c.getBoundingClientRect(),a=s.getBoundingClientRect(),l=e.getBoundingClientRect();let u=0,d=0;0===i.x&&0===i.y&&0===i.width&&0===i.height?(u=l.left-a.left,d=l.top-a.top):(u=i.left-a.left,d=i.top-a.top);let h=i.height;return 0===h&&(h=parseInt(window.getComputedStyle(e).lineHeight,10)||l.height),{x:u,y:d,height:h}},U=(e,t,n)=>{var s,o;const r=n.createTreeWalker(e,NodeFilter.SHOW_TEXT);let c=0,i=null,a=null,l=1;for(;a=r.nextNode();){if(l++,l>1e3)return{node:e,offset:0};if(!(null===(s=a.nodeValue)||void 0===s?void 0:s.length))continue;const n=a.nodeValue.length;if(c+n>=t)return{node:a,offset:t-c};c+=n,i=a,a=r.nextNode()}return i&&(null===(o=i.nodeValue)||void 0===o?void 0:o.length)?{node:i,offset:i.nodeValue.length}:{node:e,offset:0}},k={currentUserSelection:{type:E.None},userMap:new Map},j={getActiveClientIds:e=>Array.from(e.userMap.keys()),getActiveUsers:e=>Array.from(e.userMap.values()),getCurrentUserSelection:e=>e.currentUserSelection,isDisconnected:e=>-1!==j.getActiveUsers(e).findIndex(e=>e.isMe&&!1===e.isConnected)},M=(0,r.createReduxStore)("vip-real-time-collaboration/awareness",{reducer:(e=k,t)=>{switch(t.type){case"PATCH_USER":if(e.userMap.has(t.payload.clientId)){const n=e.userMap.get(t.payload.clientId);e.userMap.set(t.payload.clientId,Object.assign(Object.assign({},n),t.payload.userState))}return Object.assign(Object.assign({},e),{userMap:new Map(e.userMap)});case"REMOVE_USER":return e.userMap.delete(t.payload.clientId),Object.assign(Object.assign({},e),{userMap:new Map(e.userMap)});case"SET_CURRENT_USER_SELECTION":return Object.assign(Object.assign({},e),{currentUserSelection:t.payload.selection});case"UPSERT_USER":return e.userMap.set(t.payload.clientId,t.payload.userState),Object.assign(Object.assign({},e),{userMap:new Map(e.userMap)});default:return e}},actions:{patchUser:(e,t)=>({type:"PATCH_USER",payload:{clientId:e,userState:t}}),removeUser:e=>({type:"REMOVE_USER",payload:{clientId:e}}),setCurrentUserSelection:e=>({type:"SET_CURRENT_USER_SELECTION",payload:{selection:e}}),upsertUser:(e,t)=>({type:"UPSERT_USER",payload:{clientId:e,userState:t}})},selectors:j});function T(){const e=(0,r.useSelect)(e=>e(M).getActiveUsers()),t=(0,r.useSelect)(e=>e(b.store).getCurrentUser());return(0,g.useMemo)(()=>{var n;const s=[...e],o=s.findIndex(e=>e.id===(null==t?void 0:t.id));if(o>=0){const e=null===(n=s.splice(o,1))||void 0===n?void 0:n[0];e&&s.unshift(e)}return s},[t,e])}function O(){const e=T();if(e.length<=1)return null;const t=e.slice(0,3),n=e.slice(3),o=n.map(e=>e.name).join(", ");return(0,s.jsxs)("div",{className:"vip-real-time-collaboration-avatars",children:[t.map(e=>(0,s.jsx)(a,{userState:e,showUserColorBorder:!0},e.clientId)),n.length>0&&(0,s.jsxs)("div",{className:"vip-real-time-collaboration-avatar-remaining",title:o,children:["+",n.length]})]})}(0,r.register)(M);const R=window.wp.primitives,D=(0,s.jsx)(R.SVG,{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,s.jsx)(R.Path,{fillRule:"evenodd",clipRule:"evenodd",d:"M12.218 5.377a.25.25 0 0 0-.436 0l-7.29 12.96a.25.25 0 0 0 .218.373h14.58a.25.25 0 0 0 .218-.372l-7.29-12.96Zm-1.743-.735c.669-1.19 2.381-1.19 3.05 0l7.29 12.96a1.75 1.75 0 0 1-1.525 2.608H4.71a1.75 1.75 0 0 1-1.525-2.608l7.29-12.96ZM12.75 17.46h-1.5v-1.5h1.5v1.5Zm-1.5-3h1.5v-5h-1.5v5Z"})});function N(){return window.VIP_RTC.wsUrl}function P(){return function(){const[e,t]=(0,g.useState)(!1),n=(0,g.useRef)(null),s=(0,r.useSelect)(e=>e(M).isDisconnected());return(0,g.useEffect)(()=>{var e;return s?n.current=setTimeout(()=>{t(!0)},5e3):(t(!1),clearTimeout(null!==(e=n.current)&&void 0!==e?e:void 0)),()=>{var e;return clearTimeout(null!==(e=n.current)&&void 0!==e?e:void 0)}},[s]),e}()?(0,s.jsx)(o.Modal,{__experimentalHideHeader:!0,icon:D,isDismissible:!1,isFullScreen:!0,onRequestClose:()=>{},shouldCloseOnClickOutside:!1,shouldCloseOnEsc:!1,children:(0,s.jsx)("div",{className:"vip-rtc-post-locked-modal__container",children:(0,s.jsxs)(o.__experimentalVStack,{alignment:"center",justify:"center",spacing:2,children:[(0,s.jsx)(o.Icon,{fill:"#ccc",icon:D,size:64}),(0,s.jsx)("h1",{children:(0,i.__)("Disconnected","vip-real-time-collaboration")}),(0,s.jsxs)("p",{className:"vip-rtc-post-locked-modal__p",children:[(0,i.__)("You are currently disconnected from the collaborative editing server.","vip-real-time-collaboration")," ",(0,i.__)("Editing is temporarily disabled to prevent conflicts with other users.","vip-real-time-collaboration")]}),(0,s.jsxs)(o.__experimentalHStack,{spacing:2,justify:"center",children:[(0,s.jsx)(o.Button,{href:"edit.php",isDestructive:!0,variant:"secondary",children:(0,i.__)("Edit another post","vip-real-time-collaboration")}),(0,s.jsx)(o.Button,{isDestructive:!0,onClick:()=>location.reload(),variant:"secondary",children:(0,i.__)("Refresh","vip-real-time-collaboration")})]})]})})}):null}const B=(e,t)=>e.querySelector(`[data-block="${t}"]`);function L({iframeDocument:e}){const t=(0,g.useRef)(null),n=(0,r.useSelect)(e=>e(p).isAwarenessAvatarsEnabled());return function(e){const t=(0,g.useRef)(new Set),n=(0,r.useSelect)(e=>e(M).getActiveUsers()),s=(0,r.useSelect)(e=>e(p).isAwarenessHighlightsEnabled());(0,g.useEffect)(()=>{if(null===e)return;const o=n=>{n.forEach(n=>{const s=B(e,n);s&&(s.style.boxShadow="",s.style.borderRadius=""),t.current.delete(n)})},r=n.map(e=>{var t,n;return(null===(n=null===(t=e.editorState)||void 0===t?void 0:t.selection)||void 0===n?void 0:n.type)===E.Cursor?{blockId:e.editorState.selection.blockId,color:e.color}:null}).filter(e=>null!==e);if(!s)return void o(Array.from(t.current));const c=r.map(e=>e.blockId);o(Array.from(t.current).filter(e=>!c.includes(e))),1!==n.length&&r.forEach(n=>{const{color:s,blockId:o}=n,r=B(e,o);r&&r&&(r.style.boxShadow=`${s} 0 0 0 2px`,r.style.borderRadius="4px",t.current.add(o))})},[n,s,e])}(e),function(e,t){const{selectionChange:n}=(0,r.useDispatch)(w.store),{selectionStart:s,selectionEnd:o,isBlockValid:i,getBlock:a,initialCaretPosition:l}=(0,r.useSelect)(e=>({selectionStart:e(w.store).getSelectionStart(),selectionEnd:e(w.store).getSelectionEnd(),isBlockValid:e(w.store).isBlockValid,getBlock:e(w.store).getBlock,initialCaretPosition:e(w.store).getSelectedBlocksInitialCaretPosition()})),u=function(){const{postId:e,postType:t}=(0,r.useSelect)(e=>{const{getCurrentPostId:t,getCurrentPostType:n}=e(c.store);return{postId:t(),postType:n()}});return e&&t?{kind:"postType",name:t,recordId:e}:null}();!function(e,t,n){var s;if("string"!=typeof e.name)throw new Error("Invalid storeDescriptor for useInterceptActionDispatch");const o=e.name;(null===(s=null==m?void 0:m[o])||void 0===s?void 0:s[t])||((null==m?void 0:m[o])||(m[o]={}),m[o][t]={actionIntercept:!1,callback:n}),(0,g.useEffect)(()=>{var e;(null===(e=null==m?void 0:m[o])||void 0===e?void 0:e[t])&&(m[o][t].callback=n)},[o,t,n]),(0,r.use)(e=>({dispatch:n=>{var s;const r="string"==typeof n?n:n.name,c=Object.assign({},e.dispatch(r));if(r!==o)return c;const i=null===(s=null==m?void 0:m[o])||void 0===s?void 0:s[t];if(i&&!i.actionIntercept&&c[t]){const e=c[t];i.actionIntercept=(...n)=>{var s,r;null===(r=null===(s=null==m?void 0:m[o])||void 0===s?void 0:s[t])||void 0===r||r.callback(e,n)}}return i&&i.actionIntercept&&(c[t]=i.actionIntercept),c}}))}(w.store,"mergeBlocks",(e,t)=>{e(...t),setTimeout(()=>{const e=t;for(const t of e){const e=a(t);i(t)&&(0,v.isUnmodifiedDefaultBlock)(e)&&n(t)}},0)});const d=(0,r.useSelect)(e=>e(p).isAwarenessCursorsEnabled()),h=(0,g.useMemo)(()=>(0,y.debounce)(I,20),[]);(0,g.useEffect)(()=>{u&&h(s,o,l,u)},[s,o,h,l,u]);const f=T(),b=(0,g.useRef)();(0,g.useEffect)(()=>{b.current=()=>{if(!e.current||!t)return;const n=f.map(e=>{var t;return{userName:e.name,selection:null!==(t=e.editorState.selection)&&void 0!==t?t:{type:E.None},color:e.color}});A(e.current,t,n,d)},b.current()},[f,e.current,t,d]),(0,g.useEffect)(()=>{const e=S(()=>{b.current&&b.current()});return window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[])}(t,e),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"vip-real-time-collaboration-overlay-full",ref:t}),(0,s.jsx)("div",{className:"vip-real-time-collaboration-overlay-fixed",children:n&&(0,s.jsx)(O,{})}),(0,s.jsx)(P,{})]})}const $=window.wp.apiFetch;var H=e.n($);const F=String.fromCharCode,V=(String.fromCodePoint,/^\s*/g),W=/([A-Z])/g,z=(e,t)=>(e=>e.replace(V,""))(e.replace(W,e=>`${t}${(e=>e.toLowerCase())(e)}`));"undefined"!=typeof TextEncoder&&new TextEncoder;let q="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});q&&1===q.decode(new Uint8Array).length&&(q=null);const G=()=>new Map;let Y=new class{constructor(){this.map=new Map}setItem(e,t){this.map.set(e,t)}getItem(e){return this.map.get(e)}},J=!0;try{"undefined"!=typeof localStorage&&(Y=localStorage,J=!1)}catch(e){}const Z=Y,X="undefined"!=typeof process&&process.release&&/node|io\.js/.test(process.release.name),K="undefined"!=typeof window&&!X;let Q;"undefined"!=typeof navigator&&/Mac/.test(navigator.platform);const ee=[];(e=>(()=>{if(void 0===Q)if(X){Q=G();const e=process.argv;let t=null;for(let n=0;n<e.length;n++){const s=e[n];"-"===s[0]?(null!==t&&Q.set(t,""),t=s):null!==t?(Q.set(t,s),t=null):ee.push(s)}null!==t&&Q.set(t,"")}else"object"==typeof location?(Q=G(),(location.search||"?").slice(1).split("&").forEach(e=>{if(0!==e.length){const[t,n]=e.split("=");Q.set(`--${z(t,"-")}`,n),Q.set(`-${z(t,"-")}`,n)}})):Q=G();return Q})().has(e))("--"+"production")||(e=>{return void 0===(t=X?process.env[e.toUpperCase()]:Z.getItem(e))?null:t;var t})("production");const te=K?e=>{let t="";for(let n=0;n<e.byteLength;n++)t+=F(e[n]);return btoa(t)}:e=>Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("base64"),ne=K?e=>{const t=atob(e),n=(s=t.length,new Uint8Array(s));var s;for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}:e=>{const t=Buffer.from(e,"base64");return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)},se=window.wp.sync.Y.applyUpdate,oe=window.wp.sync.Y.applyUpdateV2,re=window.wp.sync.Y.encodeStateVector,ce=window.wp.sync.Y.encodeStateAsUpdate,ie=window.wp.sync.Y.encodeStateAsUpdateV2,ae=window.wp.sync.Y.Doc;var le=function(e,t,n,s){return new(n||(n=Promise))(function(o,r){function c(e){try{a(s.next(e))}catch(e){r(e)}}function i(e){try{a(s.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}a((s=s.apply(e,t||[])).next())})};const ue=window.VIP_RTC.crdtDocVersion,de="/vip-rtc/v1/crdt";function he(e){return te(ie(e))}function fe(e){const t=new ae,n=ne(e);return oe(t,n),t.clientID=Math.floor(1e9*Math.random()),t}function pe(e,t,n){return le(this,arguments,void 0,function*(e,t,n,s=!1){var o;try{const r=yield H()({data:{crdtDoc:he(n),crdtVersion:ue,isInitialUpdate:s,syncObjectType:e,syncObjectId:t},method:"PUT",path:de});if(!r.success)throw new Error((0,i.__)("Unknown failure","vip-real-time-collaboration"));if(r.crdtDoc)return null!==(o=fe(r.crdtDoc))&&void 0!==o?o:n}catch(n){console.debug(`Error updating CRDT document for ${e}:${t}`,n instanceof Error?n.message:String(n))}return n})}const ge=Math.floor,be=(Math.ceil,Math.abs,Math.imul,Math.round,Math.log10,Math.log2,Math.log,Math.sqrt,Number.isNaN,Math.pow,Math.sign,128),we=127,ve=String.fromCharCode,ye=(String.fromCodePoint,ve(65535),"undefined"!=typeof TextEncoder?new TextEncoder:null),me=ye?e=>ye.encode(e):e=>{const t=unescape(encodeURIComponent(e)),n=t.length,s=new Uint8Array(n);for(let e=0;e<n;e++)s[e]=t.codePointAt(e);return s};let Se="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});Se&&1===Se.decode(new Uint8Array).length&&(Se=null);class Ee{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const Ie=(e,t)=>{const n=e.cbuf.length;e.cpos===n&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(2*n),e.cpos=0),e.cbuf[e.cpos++]=t},Ce=(e,t)=>{for(;t>we;)Ie(e,be|we&t),t=ge(t/128);Ie(e,we&t)},Ae=new Uint8Array(3e4),xe=Ae.length/3,_e=ye&&ye.encodeInto?(e,t)=>{if(t.length<xe){const n=ye.encodeInto(t,Ae).written||0;Ce(e,n);for(let t=0;t<n;t++)Ie(e,Ae[t])}else Ue(e,me(t))}:(e,t)=>{const n=unescape(encodeURIComponent(t)),s=n.length;Ce(e,s);for(let t=0;t<s;t++)Ie(e,n.codePointAt(t))},Ue=(e,t)=>{Ce(e,t.byteLength),((e,t)=>{const n=e.cbuf.length,s=e.cpos,o=(r=n-s)<(c=t.length)?r:c;var r,c;const i=t.length-o;e.cbuf.set(t.subarray(0,o),s),e.cpos+=o,i>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(((e,t)=>e>t?e:t)(2*n,i)),e.cbuf.set(t.subarray(o)),e.cpos=i)})(e,t)};new DataView(new ArrayBuffer(4));const ke=Number.MAX_SAFE_INTEGER,je=(Number.MIN_SAFE_INTEGER,Number.isInteger,Number.isNaN,Number.parseInt,e=>new Error(e)),Me=je("Unexpected end of array"),Te=je("Integer out of Range");class Oe{constructor(e){this.arr=e,this.pos=0}}const Re=e=>((e,t)=>{const n=new Uint8Array(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,n})(e,Ne(e)),De=e=>e.arr[e.pos++],Ne=e=>{let t=0,n=1;const s=e.arr.length;for(;e.pos<s;){const s=e.arr[e.pos++];if(t+=(s&we)*n,n*=128,s<be)return t;if(t>ke)throw Te}throw Me},Pe=Se?e=>Se.decode(Re(e)):e=>{let t=Ne(e);if(0===t)return"";{let n=String.fromCodePoint(De(e));if(--t<100)for(;t--;)n+=String.fromCodePoint(De(e));else for(;t>0;){const s=t<1e4?t:1e4,o=e.arr.subarray(e.pos,e.pos+s);e.pos+=s,n+=String.fromCodePoint.apply(null,o),t-=s}return decodeURIComponent(escape(n))}},Be=Date.now,Le=()=>new Map,$e=()=>new Set,He=Array.from;Array.isArray;class Fe{constructor(){this._observers=Le()}on(e,t){((e,t,n)=>{let s=e.get(t);return void 0===s&&e.set(t,s=n()),s})(this._observers,e,$e).add(t)}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};this.on(e,n)}off(e,t){const n=this._observers.get(e);void 0!==n&&(n.delete(t),0===n.size&&this._observers.delete(e))}emit(e,t){return He((this._observers.get(e)||Le()).values()).forEach(e=>e(...t))}destroy(){this._observers=Le()}}Object.assign;const Ve=Object.keys,We=(Object.values,e=>Ve(e).length),ze=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),qe=(Object.freeze,Symbol("Equality")),Ge=(e,t)=>{if(e===t)return!0;if(null==e||null==t||e.constructor!==t.constructor)return!1;if(null!=e[qe])return e[qe](t);switch(e.constructor){case ArrayBuffer:e=new Uint8Array(e),t=new Uint8Array(t);case Uint8Array:if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;break;case Set:if(e.size!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;break;case Map:if(e.size!==t.size)return!1;for(const n of e.keys())if(!t.has(n)||!Ge(e.get(n),t.get(n)))return!1;break;case Object:if(We(e)!==We(t))return!1;for(const n in e)if(!ze(e,n)||!Ge(e[n],t[n]))return!1;break;case Array:if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!Ge(e[n],t[n]))return!1;break;default:return!1}return!0};class Ye extends Fe{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const e=Be();null!==this.getLocalState()&&15e3<=e-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const t=[];this.meta.forEach((n,s)=>{s!==this.clientID&&3e4<=e-n.lastUpdated&&this.states.has(s)&&t.push(s)}),t.length>0&&Je(this,t,"timeout")},ge(3e3)),e.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){const t=this.clientID,n=this.meta.get(t),s=void 0===n?0:n.clock+1,o=this.states.get(t);null===e?this.states.delete(t):this.states.set(t,e),this.meta.set(t,{clock:s,lastUpdated:Be()});const r=[],c=[],i=[],a=[];null===e?a.push(t):null==o?null!=e&&r.push(t):(c.push(t),Ge(o,e)||i.push(t)),(r.length>0||i.length>0||a.length>0)&&this.emit("change",[{added:r,updated:i,removed:a},"local"]),this.emit("update",[{added:r,updated:c,removed:a},"local"])}setLocalStateField(e,t){const n=this.getLocalState();null!==n&&this.setLocalState({...n,[e]:t})}getStates(){return this.states}}const Je=(e,t,n)=>{const s=[];for(let n=0;n<t.length;n++){const o=t[n];if(e.states.has(o)){if(e.states.delete(o),o===e.clientID){const t=e.meta.get(o);e.meta.set(o,{clock:t.clock+1,lastUpdated:Be()})}s.push(o)}}s.length>0&&(e.emit("change",[{added:[],updated:[],removed:s},n]),e.emit("update",[{added:[],updated:[],removed:s},n]))},Ze=(e,t,n=e.states)=>{const s=t.length,o=new Ee;Ce(o,s);for(let r=0;r<s;r++){const s=t[r],c=n.get(s)||null,i=e.meta.get(s).clock;Ce(o,s),Ce(o,i),_e(o,JSON.stringify(c))}return(e=>{const t=new Uint8Array((e=>{let t=e.cpos;for(let n=0;n<e.bufs.length;n++)t+=e.bufs[n].length;return t})(e));let n=0;for(let s=0;s<e.bufs.length;s++){const o=e.bufs[s];t.set(o,n),n+=o.length}return t.set(new Uint8Array(e.cbuf.buffer,0,e.cpos),n),t})(o)};function Xe(){const e=window.navigator.userAgent;let t="Unknown";return e.includes("Firefox")?t="Firefox":e.includes("Edg")?t="Microsoft Edge":e.includes("Chrome")&&!e.includes("Edg")?t="Chrome":e.includes("Safari")&&!e.includes("Chrome")?t="Safari":e.includes("MSIE")||e.includes("Trident")?t="Internet Explorer":(e.includes("Opera")||e.includes("OPR"))&&(t="Opera"),t}function Ke(){return e=this,t=void 0,s=function*(){var e;const{avatar_urls:t,id:n,name:s}=null!==(e=(0,r.select)(b.store).getCurrentUser())&&void 0!==e?e:{};return n?{avatar_urls:t,id:n,name:s}:(yield new Promise(e=>setTimeout(e,100)),yield Ke())},new((n=void 0)||(n=Promise))(function(o,r){function c(e){try{a(s.next(e))}catch(e){r(e)}}function i(e){try{a(s.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}a((s=s.apply(e,t||[])).next())});var e,t,n,s}const Qe=["#A4C400","#60A917","#008A00","#00ABA9","#1BA1E2","#0050EF","#6A00FF","#AA00FF","#F472D0","#D80073","#A20025","#E51400","#FA6800","#F0A30A","#E3C800","#647687"],et="vip-rtc-preferred-color",tt=(e,t)=>Math.floor(Math.random()*(t-e+1))+e;var nt=function(e,t,n,s){return new(n||(n=Promise))(function(o,r){function c(e){try{a(s.next(e))}catch(e){r(e)}}function i(e){try{a(s.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}a((s=s.apply(e,t||[])).next())})};class st{constructor(){this.awarenessInstances=new Map,this.currentWordPressUserInfoPromise=Ke(),window.addEventListener("beforeunload",()=>{this.awarenessInstances.forEach(e=>{Je(e,[e.clientID],"removeAwarenessStates")})})}static get instance(){return st.__instance||(st.__instance=new st),st.__instance}static bootstrap(e,t){return nt(this,void 0,void 0,function*(){const n=st.instance;n.awarenessInstances.set(e,t),yield n.subscribeToUserChanges(t),n.subscribeToSelectionChanges(t)})}getCurrentUserState(e){return nt(this,void 0,void 0,function*(){var t;const n=null!==(t=e.getStates())&&void 0!==t?t:new Map,s=(e=>{e=e.map(e=>e.slice(0,-2));const t=Qe.filter(t=>!e.includes(t));if(0===t.length)return`hsla(${tt(0,360)}, ${tt(50,100)}%, ${tt(45,95)}%, 0.7)`;let n=null;const s=l(et,null);return s&&t.includes(s)?n=s:(n=t[`${tt(0,t.length-1)}`],u(et,n)),`${n}${Math.round(178.5).toString(16).padStart(2,"0").toUpperCase()}`})(Array.from(n.values()).filter(e=>!e.isMe).map(e=>e.color).filter(Boolean)),o=yield this.currentWordPressUserInfoPromise;return Object.assign(Object.assign({},o),{browserType:Xe(),clientId:e.clientID,color:s,editorState:{selection:{type:E.None}},isConnected:!0,isMe:!0})})}getStates(e){return e.getStates()}static resetAfterDisconnect(){const e=st.instance,{removeUser:t,upsertUser:n}=(0,r.dispatch)(M),{getActiveClientIds:s}=(0,r.select)(M),o=new Set(s()),c=new Set;e.awarenessInstances.forEach(t=>{e.getStates(t).forEach((e,t)=>{n(t,e),c.add(t)})}),o.forEach(e=>{c.has(e)||t(e)})}setLocalStateField(e,t,n){e.setLocalStateField(t,n)}subscribeToSelectionChanges(e){const{getCurrentUserSelection:t}=(0,r.select)(M);let n=t();(0,r.subscribe)(()=>{const s=t();s!==n&&(n=s,this.setLocalStateField(e,"editorState",{selection:n}))})}subscribeToUserChanges(e){return nt(this,void 0,void 0,function*(){const t=yield this.getCurrentUserState(e);e.setLocalState(t);const n=new Map,{patchUser:s,removeUser:o,upsertUser:c}=(0,r.dispatch)(M);this.getStates(e).forEach((e,t)=>{c(t,e)}),e.on("change",({added:r,removed:i,updated:a})=>{const l=this.getStates(e);[...r,...a].forEach(e=>{const s=l.get(e);n.has(e)&&clearTimeout(n.get(e)),s&&c(e,Object.assign(Object.assign({},s),{isConnected:!0,isMe:s.clientId===t.clientId}))}),i.forEach(e=>{n.has(e)||(s(e,{isConnected:!1}),n.set(e,setTimeout(()=>{o(e)},5e3)))})})})}}const ot=()=>new Map,rt=(e,t,n)=>{let s=e.get(t);return void 0===s&&e.set(t,s=n()),s},ct=()=>new Set,it=String.fromCharCode,at=(String.fromCodePoint,it(65535),/^\s*/g),lt=/([A-Z])/g,ut=(e,t)=>(e=>e.replace(at,""))(e.replace(lt,e=>`${t}${(e=>e.toLowerCase())(e)}`)),dt="undefined"!=typeof TextEncoder?new TextEncoder:null;let ht="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});ht&&1===ht.decode(new Uint8Array).length&&(ht=null);let ft=new class{constructor(){this.map=new Map}setItem(e,t){this.map.set(e,t)}getItem(e){return this.map.get(e)}},pt=!0;try{"undefined"!=typeof localStorage&&localStorage&&(ft=localStorage,pt=!1)}catch(e){}const gt=ft,bt=Array.from,wt=(Array.isArray,"undefined"!=typeof process&&process.release&&/node|io\.js/.test(process.release.name)&&"[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)),vt="undefined"!=typeof window&&"undefined"!=typeof document&&!wt;let yt;"undefined"!=typeof navigator&&/Mac/.test(navigator.platform);const mt=[],St=e=>(()=>{if(void 0===yt)if(wt){yt=ot();const e=process.argv;let t=null;for(let n=0;n<e.length;n++){const s=e[n];"-"===s[0]?(null!==t&&yt.set(t,""),t=s):null!==t?(yt.set(t,s),t=null):mt.push(s)}null!==t&&yt.set(t,"")}else"object"==typeof location?(yt=ot(),(location.search||"?").slice(1).split("&").forEach(e=>{if(0!==e.length){const[t,n]=e.split("=");yt.set(`--${ut(t,"-")}`,n),yt.set(`-${ut(t,"-")}`,n)}})):yt=ot();return yt})().has(e),Et=e=>{return void 0===(t=wt?process.env[e.toUpperCase().replaceAll("-","_")]:gt.getItem(e))?null:t;var t},It=e=>St("--"+e)||null!==Et(e);var Ct;It("production"),wt&&(Ct=process.env.FORCE_COLOR,["true","1","2"].includes(Ct))||!St("--no-colors")&&!It("no-color")&&(!wt||process.stdout.isTTY)&&(!wt||St("--color")||null!==Et("COLORTERM")||(Et("TERM")||"").includes("color"));const At=vt?e=>{let t="";for(let n=0;n<e.byteLength;n++)t+=it(e[n]);return btoa(t)}:e=>Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("base64"),xt=vt?e=>{const t=atob(e),n=(s=t.length,new Uint8Array(s));var s;for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}:e=>{const t=Buffer.from(e,"base64");return n=t.buffer,s=t.byteOffset,o=t.byteLength,new Uint8Array(n,s,o);var n,s,o},_t=new Map,Ut="undefined"==typeof BroadcastChannel?class{constructor(e){var t;this.room=e,this.onmessage=null,this._onChange=t=>t.key===e&&null!==this.onmessage&&this.onmessage({data:xt(t.newValue||"")}),t=this._onChange,pt||addEventListener("storage",t)}postMessage(e){gt.setItem(this.room,At(new Uint8Array(e)))}close(){var e;e=this._onChange,pt||removeEventListener("storage",e)}}:BroadcastChannel,kt=e=>rt(_t,e,()=>{const t=ct(),n=new Ut(e);return n.onmessage=e=>t.forEach(t=>t(e.data,"broadcastchannel")),{bc:n,subs:t}}),jt=(e,t,n=null)=>{const s=kt(e);s.bc.postMessage(t),s.subs.forEach(e=>e(t,n))},Mt=Date.now,Tt=Math.floor,Ot=(Math.ceil,Math.abs,Math.imul,Math.round,Math.log10,Math.log2,Math.log,Math.sqrt,(e,t)=>e<t?e:t),Rt=(Number.isNaN,Math.pow),Dt=(Math.sign,128),Nt=127;class Pt{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const Bt=()=>new Pt,Lt=e=>{let t=e.cpos;for(let n=0;n<e.bufs.length;n++)t+=e.bufs[n].length;return t},$t=e=>{const t=new Uint8Array(Lt(e));let n=0;for(let s=0;s<e.bufs.length;s++){const o=e.bufs[s];t.set(o,n),n+=o.length}return t.set(new Uint8Array(e.cbuf.buffer,0,e.cpos),n),t},Ht=(e,t)=>{const n=e.cbuf.length;e.cpos===n&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(2*n),e.cpos=0),e.cbuf[e.cpos++]=t},Ft=(e,t)=>{for(;t>Nt;)Ht(e,Dt|Nt&t),t=Tt(t/128);Ht(e,Nt&t)},Vt=(new Uint8Array(3e4).length,dt&&dt.encodeInto,(e,t)=>{const n=e.cbuf.length,s=e.cpos,o=Ot(n-s,t.length),r=t.length-o;var c,i;e.cbuf.set(t.subarray(0,o),s),e.cpos+=o,r>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array((c=2*n)>(i=r)?c:i),e.cbuf.set(t.subarray(o)),e.cpos=r)}),Wt=(e,t)=>{Ft(e,t.byteLength),Vt(e,t)};new DataView(new ArrayBuffer(4));const zt=Number.MAX_SAFE_INTEGER,qt=(Number.MIN_SAFE_INTEGER,Number.isInteger,Number.isNaN,Number.parseInt,e=>new Error(e)),Gt=qt("Unexpected end of array"),Yt=qt("Integer out of Range");class Jt{constructor(e){this.arr=e,this.pos=0}}const Zt=e=>((e,t)=>{const n=new Uint8Array(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,n})(e,Xt(e)),Xt=e=>{let t=0,n=1;const s=e.arr.length;for(;e.pos<s;){const s=e.arr[e.pos++];if(t+=(s&Nt)*n,n*=128,s<Dt)return t;if(t>zt)throw Yt}throw Gt},Kt=(e,t)=>{Ce(e,0);const n=re(t);Ue(e,n)},Qt=(e,t,n)=>{Ce(e,1),Ue(e,ce(t,n))},en=(e,t,n)=>{try{se(t,Re(e),n)}catch(e){console.error("Caught error while handling a Yjs update",e)}},tn=en;class nn{constructor(){this._observers=ot()}on(e,t){return rt(this._observers,e,ct).add(t),t}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};this.on(e,n)}off(e,t){const n=this._observers.get(e);void 0!==n&&(n.delete(t),0===n.size&&this._observers.delete(e))}emit(e,t){return bt((this._observers.get(e)||ot()).values()).forEach(e=>e(...t))}destroy(){this._observers=ot()}}Object.assign,Object.keys,Object.values,Object.freeze;const sn=[];sn[0]=(e,t,n,s,o)=>{Ft(e,0);const r=((e,t,n,s)=>{const o=Ne(e);switch(o){case 0:((e,t,n)=>{Qt(t,n,Re(e))})(e,t,n);break;case 1:en(e,n,s);break;case 2:tn(e,n,s);break;default:throw new Error("Unknown message type")}return o})(t,e,n.doc,n);s&&1===r&&!n.synced&&(n.synced=!0)},sn[3]=(e,t,n,s,o)=>{Ft(e,1),Wt(e,Ze(n.awareness,Array.from(n.awareness.getStates().keys())))},sn[1]=(e,t,n,s,o)=>{((e,t,n)=>{const s=new Oe(t),o=Be(),r=[],c=[],i=[],a=[],l=Ne(s);for(let t=0;t<l;t++){const t=Ne(s);let n=Ne(s);const l=JSON.parse(Pe(s)),u=e.meta.get(t),d=e.states.get(t),h=void 0===u?0:u.clock;(h<n||h===n&&null===l&&e.states.has(t))&&(null===l?t===e.clientID&&null!=e.getLocalState()?n++:e.states.delete(t):e.states.set(t,l),e.meta.set(t,{clock:n,lastUpdated:o}),void 0===u&&null!==l?r.push(t):void 0!==u&&null===l?a.push(t):null!==l&&(Ge(l,d)||i.push(t),c.push(t)))}(r.length>0||i.length>0||a.length>0)&&e.emit("change",[{added:r,updated:i,removed:a},n]),(r.length>0||c.length>0||a.length>0)&&e.emit("update",[{added:r,updated:c,removed:a},n])})(n.awareness,Zt(t),n)},sn[2]=(e,t,n,s,o)=>{((e,t,n)=>{0===Ne(e)&&n(0,Pe(e))})(t,n.doc,(e,t)=>on(n,t))};const on=(e,t)=>console.warn(`Permission denied to access ${e.url}.\n${t}`),rn=(e,t,n)=>{const s=new Jt(t),o=Bt(),r=Xt(s),c=e.messageHandlers[r];return c?c(o,s,e,n,r):console.error("Unable to compute message"),o},cn=(e,t,n)=>{t===e.ws&&(e.emit("connection-close",[n,e]),e.ws=null,t.close(),e.wsconnecting=!1,e.wsconnected?(e.wsconnected=!1,e.synced=!1,Je(e.awareness,Array.from(e.awareness.getStates().keys()).filter(t=>t!==e.doc.clientID),e),e.emit("status",[{status:"disconnected"}])):e.wsUnsuccessfulReconnects++,setTimeout(an,Ot(100*Rt(2,e.wsUnsuccessfulReconnects),e.maxBackoffTime),e))},an=e=>{if(e.shouldConnect&&null===e.ws){const t=new e._WS(e.url,e.protocols);t.binaryType="arraybuffer",e.ws=t,e.wsconnecting=!0,e.wsconnected=!1,e.synced=!1,t.onmessage=n=>{e.wsLastMessageReceived=Mt();const s=rn(e,new Uint8Array(n.data),!0);Lt(s)>1&&t.send($t(s))},t.onerror=t=>{e.emit("connection-error",[t,e])},t.onclose=n=>{cn(e,t,n)},t.onopen=()=>{e.wsLastMessageReceived=Mt(),e.wsconnecting=!1,e.wsconnected=!0,e.wsUnsuccessfulReconnects=0,e.emit("status",[{status:"connected"}]);const n=Bt();if(Ft(n,0),Kt(n,e.doc),t.send($t(n)),null!==e.awareness.getLocalState()){const n=Bt();Ft(n,1),Wt(n,Ze(e.awareness,[e.doc.clientID])),t.send($t(n))}},e.emit("status",[{status:"connecting"}])}},ln=(e,t)=>{const n=e.ws;e.wsconnected&&n&&n.readyState===n.OPEN&&n.send(t),e.bcconnected&&jt(e.bcChannel,t,e)};class un extends nn{constructor(e,t,n,{connect:s=!0,awareness:o=new Ye(n),params:r={},protocols:c=[],WebSocketPolyfill:i=WebSocket,resyncInterval:a=-1,maxBackoffTime:l=2500,disableBc:u=!1}={}){for(super();"/"===e[e.length-1];)e=e.slice(0,e.length-1);this.serverUrl=e,this.bcChannel=e+"/"+t,this.maxBackoffTime=l,this.params=r,this.protocols=c,this.roomname=t,this.doc=n,this._WS=i,this.awareness=o,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disableBc=u,this.wsUnsuccessfulReconnects=0,this.messageHandlers=sn.slice(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=s,this._resyncInterval=0,a>0&&(this._resyncInterval=setInterval(()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){const e=Bt();Ft(e,0),Kt(e,n),this.ws.send($t(e))}},a)),this._bcSubscriber=(e,t)=>{if(t!==this){const t=rn(this,new Uint8Array(e),!1);Lt(t)>1&&jt(this.bcChannel,$t(t),this)}},this._updateHandler=(e,t)=>{if(t!==this){const t=Bt();Ft(t,0),((e,t)=>{Ce(e,2),Ue(e,t)})(t,e),ln(this,$t(t))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:e,updated:t,removed:n},s)=>{const r=e.concat(t).concat(n),c=Bt();Ft(c,1),Wt(c,Ze(o,r)),ln(this,$t(c))},this._exitHandler=()=>{Je(this.awareness,[n.clientID],"app closed")},wt&&"undefined"!=typeof process&&process.on("exit",this._exitHandler),o.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval(()=>{this.wsconnected&&3e4<Mt()-this.wsLastMessageReceived&&cn(this,this.ws,null)},3e3),s&&this.connect()}get url(){const e=(()=>((e,t)=>{const n=[];for(const s in e)n.push(t(e[s],s));return n})(this.params,(e,t)=>`${encodeURIComponent(t)}=${encodeURIComponent(e)}`).join("&"))();return this.serverUrl+"/"+this.roomname+(0===e.length?"":"?"+e)}get synced(){return this._synced}set synced(e){this._synced!==e&&(this._synced=e,this.emit("synced",[e]),this.emit("sync",[e]))}destroy(){0!==this._resyncInterval&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),wt&&"undefined"!=typeof process&&process.off("exit",this._exitHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){if(this.disableBc)return;var e,t;this.bcconnected||(e=this.bcChannel,t=this._bcSubscriber,kt(e).subs.add(t),this.bcconnected=!0);const n=Bt();Ft(n,0),Kt(n,this.doc),jt(this.bcChannel,$t(n),this);const s=Bt();Ft(s,0),Qt(s,this.doc),jt(this.bcChannel,$t(s),this);const o=Bt();Ft(o,3),jt(this.bcChannel,$t(o),this);const r=Bt();Ft(r,1),Wt(r,Ze(this.awareness,[this.doc.clientID])),jt(this.bcChannel,$t(r),this)}disconnectBc(){const e=Bt();Ft(e,1),Wt(e,Ze(this.awareness,[this.doc.clientID],new Map)),ln(this,$t(e)),this.bcconnected&&(((e,t)=>{const n=kt(e);n.subs.delete(t)&&0===n.subs.size&&(n.bc.close(),_t.delete(e))})(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),null!==this.ws&&cn(this,this.ws,null)}connect(){this.shouldConnect=!0,this.wsconnected||null!==this.ws||(an(this),this.connectBc())}}var dn=function(e,t,n,s){return new(n||(n=Promise))(function(o,r){function c(e){try{a(s.next(e))}catch(e){r(e)}}function i(e){try{a(s.throw(e))}catch(e){r(e)}}function a(e){e.done?o(e.value):function(e){return e instanceof n?e:new n(function(t){t(e)})}(e.value).then(c,i)}a((s=s.apply(e,t||[])).next())})};const hn=function(){const e=new Map;return(...t)=>{const n=JSON.stringify(t);if(e.has(n))return e.get(n);const s=(()=>window.isSecureContext?window.crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))(...t);return e.set(n,s),s}}();var fn=function(e,t,n,s){return new(n||(n=Promise))(function(o,r){function c(e){try{a(s.next(e))}catch(e){r(e)}}function i(e){try{a(s.throw(e))}catch(e){r(e)}}function a(e){e.done?o(e.value):function(e){return e instanceof n?e:new n(function(t){t(e)})}(e.value).then(c,i)}a((s=s.apply(e,t||[])).next())})};class pn extends window.wp.sync.SyncProvider{constructor(e){super(null,function(e){return function(){return dn(this,arguments,void 0,function*(t="unknown",n,s){try{const o=`${n}-${t}`,r=new un(e.serverUrl,o,s,e.options),c=function(e,t,n){return function(){return dn(this,void 0,void 0,function*(){try{const s=yield function(e,t){return dn(this,void 0,void 0,function*(){const n=yield H()({path:"/vip-rtc/v1/websocket/auth",method:"POST",data:{syncObjectType:e,syncObjectId:t,connectionId:hn()}});if(!n.token)throw new Error((0,i.__)("No auth token returned","vip-real-time-collaboration"));return n.token})}(t,n);e.params={auth:s},e.connect(),e.shouldConnect=!1,function(e,t,n){const s=`${e}-${t}`,o={createNewDoc:!1,room:`${s}?auth=${n}`,provider:"y-websocket",url:N()},r=`http://localhost:5173/#/connection=${encodeURIComponent(JSON.stringify(o))}`;console.debug(`Inspect Yjs provider for ${s}: ${r}`)}(t,n,s)}catch(e){const t=function(e){return e instanceof Error||e&&"object"==typeof e&&"message"in e&&"string"==typeof e.message?e.message:(0,i.__)("Unknown error","vip-real-time-collaboration")}(e);console.error(`[RTC:WebSocket] ${(0,i.__)("Failed to fetch auth token and connect to WebSocket","vip-real-time-collaboration")}: ${t}`)}})}}(r,n,t);return r.on("connection-close",c),r.on("connection-error",()=>{var t;null===(t=e.onStatusChange)||void 0===t||t.call(e,{status:"connection-error"},r)}),r.on("status",t=>{var n;return null===(n=e.onStatusChange)||void 0===n?void 0:n.call(e,t,r)}),yield c(),{awareness:r.awareness,destroy:()=>r.destroy()}}catch(e){}return{destroy:()=>{}}})}}(Object.assign(Object.assign({},e),{onStatusChange:(...e)=>this.onProviderStatusChange(...e)}))),this.entitiesWithCrdtPersistence=new Map,this.subscribeToPostSave()}bootstrap(e,t,n){const s=Object.create(null,{bootstrap:{get:()=>super.bootstrap}});return fn(this,void 0,void 0,function*(){var o;yield s.bootstrap.call(this,e,t,n);const r=e.objectType,c=e.getObjectId(t),i=this.getEntityId(r,c),a=null!==(o=this.connections.get(i))&&void 0!==o?o:[];for(const t of a)t.awareness&&e.supportsAwareness&&(yield st.bootstrap(i,t.awareness));r.startsWith("postType/")&&this.entitiesWithCrdtPersistence.set(i,[r,c])})}getInitialCRDTDoc(e,t){const n=Object.create(null,{getInitialCRDTDoc:{get:()=>super.getInitialCRDTDoc}});return fn(this,void 0,void 0,function*(){const s=e.getObjectId(t),o=yield function(e,t){return le(this,void 0,void 0,function*(){const n=new URLSearchParams({crdtVersion:ue.toString(),syncObjectType:e,syncObjectId:t}),s=`${de}?${n.toString()}`;try{const e=yield H()({method:"GET",path:s});if(!e.crdtDoc){if(!0!==e.success)throw new Error((0,i.__)("Unexpected response format","vip-real-time-collaboration"));return null}return fe(e.crdtDoc)}catch(n){console.debug(`Error fetching CRDT document for ${e}:${t}`,n instanceof Error?n.message:String(n))}return null})}(e.objectType,s);if(o)return o;const r=yield n.getInitialCRDTDoc.call(this,e,t);return yield pe(e.objectType,s,r,!0)})}subscribeToPostSave(){let e=!1;(0,r.subscribe)(()=>{const{isAutosavingPost:t,isSavingPost:n}=(0,r.select)(c.store),s=n()&&!t();s&&!e?(this.entitiesWithCrdtPersistence.forEach(([e,t])=>{this.persistCrdtDoc(e,t)}),e=!0):s||(e=!1)})}persistCrdtDoc(e,t){return fn(this,void 0,void 0,function*(){var n;const s=null===(n=this.getEntityState(e,t))||void 0===n?void 0:n.ydoc;if(!s)throw new Error(`CRDT document not found for ${e} with ID ${t}`);yield pe(e,t,s,!1)})}onProviderStatusChange(e,t){switch(e.status){case"connecting":break;case"connection-error":{const{patchUser:e}=(0,r.dispatch)(M);e(t.awareness.clientID,{isConnected:!1});break}case"connected":st.resetAfterDisconnect();break;case"disconnected":if(t.awareness.clientID){const{patchUser:e}=(0,r.dispatch)(M);e(t.awareness.clientID,{isConnected:!1})}}}}(0,t.addFilter)("core.getSyncProvider","vip-rtc",e=>{if(e)return e;const t={serverUrl:N(),options:{connect:!1}};return t.serverUrl?new pn(t):(console.error("VIP Real-Time Collaboration WebSocket URL has not been configured. The plugin will not be functional without it."),null)}),(0,n.registerPlugin)("vip-real-time-collaboration",{render:function(){const{isAvatarsEnabled:e,isHighlightsEnabled:t,isCursorsEnabled:n}=(0,r.useSelect)(e=>({isAvatarsEnabled:e(p).isAwarenessAvatarsEnabled(),isHighlightsEnabled:e(p).isAwarenessHighlightsEnabled(),isCursorsEnabled:e(p).isAwarenessCursorsEnabled()})),{setAwarenessAvatarsEnabled:l,setAwarenessHighlightsEnabled:u,setAwarenessCursorsEnabled:d}=(0,r.useDispatch)(p);!function(){const e=function(e){const[t,n]=(0,g.useState)(null);return(0,g.useEffect)(()=>{let t=null,s=null;const o=()=>{const t=document.querySelector(e);return n(t||null),t},r=()=>{t&&clearInterval(t),t=setInterval(()=>{const e=o();e&&(c(),i(e))},200)},c=()=>{t&&(clearInterval(t),t=null)},i=e=>{const t=S(()=>{o()||(a(),r())});e.parentElement&&(s=new MutationObserver(t),s.observe(e.parentElement,{childList:!0,subtree:!1}))},a=()=>{s&&(s.disconnect(),s=null)},l=o();return l?i(l):r(),()=>{c(),a()}},[e]),t}('iframe[name="editor-canvas"]'),t=(0,g.useRef)(null),n=null==e?void 0:e.contentDocument;(0,g.useEffect)(()=>{var e;if(n){null===(e=n.querySelector(".vip-real-time-collaboration-overlay"))||void 0===e||e.remove();const s=n.createElement("div");s.className="vip-real-time-collaboration-overlay",n.body.appendChild(s);const o=(0,g.createRoot)(s);t.current=o,o.render((0,g.createElement)(L,{iframeDocument:n}))}return()=>{t.current&&(t.current.unmount(),t.current=null)}},[n])}();const h=T();return(0,s.jsxs)(c.PluginDocumentSettingPanel,{name:"vip-real-time-collaboration",title:"Real-Time Collaboration",className:"vip-real-time-collaboration-settings",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)(o.ToggleControl,{label:"Enable Avatars",checked:e,onChange:e=>{(e=>{l(e)})(e)}}),(0,s.jsx)(o.ToggleControl,{label:"Enable Highlights",checked:t,onChange:e=>{(e=>{u(e)})(e)}}),(0,s.jsx)(o.ToggleControl,{label:"Enable Cursors",checked:n,onChange:e=>{(e=>{d(e)})(e)}})]}),(0,s.jsx)(o.__experimentalText,{style:{marginTop:"16px",display:"block"},children:(0,i.__)("Collaborators","vip-real-time-collaboration")}),(0,s.jsx)(o.Flex,{direction:"column",className:"vip-real-time-collaboration-sidebar-users",gap:0,children:h.map(e=>(0,s.jsx)(o.FlexItem,{children:(0,s.jsxs)(o.Flex,{direction:"row",justify:"flex-start",className:"vip-real-time-collaboration-sidebar-user-row",children:[(0,s.jsx)(a,{userState:e,showUserColorBorder:!0}),(0,s.jsx)(o.__experimentalText,{children:e.name})]})},e.clientId))})]})}})})();