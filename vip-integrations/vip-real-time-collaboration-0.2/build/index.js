(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})}};e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const t=window.wp.hooks,n=window.wp.plugins,o=window.ReactJSXRuntime,s=window.wp.blockEditor,r=window.wp.components,i=window.wp.data,c=window.wp.editor,l=window.wp.element,a=window.wp.blocks;function u(e,t,n){const o=n.getSelection();if(o&&o.rangeCount>0){const e=o.getRangeAt(0);e.deleteContents();const s=n.createTextNode(t);e.insertNode(s),e.setStartAfter(s),e.setEndAfter(s),o.removeAllRanges(),o.addRange(e)}else{const s=n.createRange();s.selectNodeContents(e),s.collapse(!1);const r=n.createTextNode(t);s.insertNode(r),s.setStartAfter(r),s.setEndAfter(r),null==o||o.removeAllRanges(),null==o||o.addRange(s)}}function d({iframeDocument:e}){const[t,n]=(0,l.useState)(!1),[r,c]=(0,l.useState)(null),[d,f]=(0,l.useState)(100),p=(0,l.useRef)(null),g=(0,i.useSelect)(e=>e(s.store).getSelectedBlockClientId),b=g(),{selectBlock:m,insertBlock:w}=(0,i.useDispatch)(s.store);(0,l.useEffect)(()=>{b&&!t&&c(b)},[b,t]);const v=()=>{return e=this,t=void 0,o=function*(){if(r)return r;if(b)return c(b),b;const e=(0,a.createBlock)("core/paragraph");return w(e),new Promise(e=>{setTimeout(()=>{const t=g();t?(c(t),e(t)):e(null)},10)})},new((n=void 0)||(n=Promise))(function(s,r){function i(e){try{l(o.next(e))}catch(e){r(e)}}function c(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(i,c)}l((o=o.apply(e,t||[])).next())});var e,t,n,o};return(0,l.useEffect)(()=>(t?v().then(t=>{t?(t=>{let o=0,s=0,r=h[Math.floor(Math.random()*h.length)]||"";m(t),p.current=setInterval(()=>{const i=function(e,t){const n=e.querySelector(`[data-block="${t}"]`);return n&&"true"===n.getAttribute("contenteditable")?n:null}(e,t);if(!i)return void n(!1);e.activeElement!==i&&i.focus();let c=r[o];c||(r=h[Math.floor(Math.random()*h.length)]||"",o=0,c=r[o],s>0&&u(i," ",e),s++),c&&(u(i,c,e),o++)},d)})(t):n(!1)}).catch(()=>{n(!1)}):p.current&&(clearInterval(p.current),p.current=null),()=>{p.current&&clearInterval(p.current)}),[t,d,e,m,w]),(0,o.jsxs)("div",{className:"vip-real-time-collaboration-debug-interface",children:[(0,o.jsx)("div",{className:"vip-real-time-collaboration-debug-header",children:"Debug Tools"}),(0,o.jsx)("button",{type:"button",onClick:()=>{n(!t)},className:"vip-real-time-collaboration-debug-reset",children:t?"Stop typing":"Start typing"}),t&&(0,o.jsxs)("div",{className:"vip-real-time-collaboration-debug-speed",children:[(0,o.jsxs)("div",{className:"vip-real-time-collaboration-debug-speed-header",children:[(0,o.jsx)("span",{children:"Speed:"}),(0,o.jsx)("button",{type:"button",onClick:()=>{f(100)},className:"vip-real-time-collaboration-debug-reset",children:"Reset"})]}),(0,o.jsx)("input",{type:"range",min:"20",max:"1000",value:d,onChange:e=>{f(parseInt(e.target.value,10))},className:"vip-real-time-collaboration-debug-slider"}),(0,o.jsxs)("div",{className:"vip-real-time-collaboration-debug-speed-value",children:[d,"ms per character"]})]})]})}const h=["Lorem ipsum dolor sit amet, consectetur adipiscing elit. ","Suspendisse sem leo, gravida id nulla at, blandit laoreet risus. ","Pellentesque velit justo, ullamcorper a ante nec, efficitur vulputate tortor. ","Etiam sem dui, mollis vitae felis nec, sagittis facilisis libero. ","Fusce justo tellus, consequat id enim eu, lacinia euismod lorem. ","Donec faucibus varius aliquam. ","Maecenas sit amet nisl ac sem pulvinar consequat vel a metus. ","Suspendisse potenti. ","Morbi blandit, enim vitae blandit malesuada, enim lorem accumsan nibh, nec maximus tellus quam vitae dui. ","Curabitur lacinia, lectus et eleifend pretium, leo ante tincidunt quam, nec cursus tellus sem id odio. ","Morbi eget nisl ligula. ","Proin eget neque eget felis interdum dignissim. ","Ut justo augue, accumsan eu efficitur et, placerat non ex. ","Nullam id gravida risus. ","Etiam vitae tortor vel nisl imperdiet mollis sed quis tortor. ","Donec velit quam, elementum eu nibh in, convallis vehicula erat. ","Sed viverra accumsan justo, eu egestas quam vehicula non. ","Cras egestas consequat erat, ut laoreet massa ornare ut. ","Vivamus vitae consequat arcu. ","In at mollis libero, quis convallis elit. ","Mauris bibendum mauris odio, et condimentum nisi convallis eu. ","Mauris pharetra metus id laoreet tempor. ","Sed gravida massa quis risus laoreet iaculis. ","Donec non eros gravida nisl sodales porta. ","Nullam a pellentesque tortor. ","Curabitur rhoncus consectetur mauris ut ornare. ","Vestibulum quis posuere enim. ","Fusce id orci pharetra enim vestibulum imperdiet et ut nunc. ","Mauris tempus arcu et est aliquet, sit amet tincidunt felis ultricies. ","Curabitur in lorem lorem. "],f=window.wp.compose,p=window.wp.coreData,g=m("wsUrl"),b=m("blogId");function m(e){return"undefined"==typeof window||void 0===window.VIP_RTC?null:window.VIP_RTC[e]}var w;!function(e){e[e.CRITICAL=5]="CRITICAL",e[e.ERROR=4]="ERROR",e[e.WARNING=3]="WARNING",e[e.INFO=2]="INFO",e[e.DEBUG=1]="DEBUG"}(w||(w={}));const v=w.WARNING;class y{constructor(e="",t=v){this.threshold=t,this.namespace="vip-rtc"+(e?`:${e}`:"")}log(e,...t){if(e<this.threshold)return;const n=w[e];console.log(`[${this.namespace}][${n}]`,...t)}debug(...e){this.log(w.DEBUG,...e)}info(...e){this.log(w.INFO,...e)}warn(...e){this.log(w.WARNING,...e)}error(...e){this.log(w.ERROR,...e)}critical(...e){this.log(w.CRITICAL,...e)}}const S=new y("local-storage"),I="vip-rtc-settings";var E;!function(e){e.AWARENESS_CURSORS="Awareness_Cursors",e.DEBUG_TOOLS="Debug_Tools",e.POST_UPDATE_NOTIFICATION="Post_Update_Notification",e.USER_ENTER_NOTIFICATION="User_Enter_Notification",e.USER_EXIT_NOTIFICATION="User_Exit_Notification"}(E||(E={}));const N={[E.AWARENESS_CURSORS]:!0,[E.DEBUG_TOOLS]:!1,[E.POST_UPDATE_NOTIFICATION]:!0,[E.USER_ENTER_NOTIFICATION]:!0,[E.USER_EXIT_NOTIFICATION]:!1},C=[E.DEBUG_TOOLS],_={getSetting:(e,t)=>!C.includes(t)&&e[t]},A=(0,i.createReduxStore)("vip-real-time-collaboration/settings",{reducer:(t=((t,n)=>{var o,s;try{const r=null===(s=null===(o=e.g.window)||void 0===o?void 0:o.localStorage)||void 0===s?void 0:s.getItem(t);if(r){const e=JSON.parse(r);return"object"!=typeof e||null===e||Array.isArray(e)?e:Object.assign(Object.assign({},n),e)}}catch(e){S.warn(`Failed to load data from localStorage (key: ${t}):`,e)}return n})(I,N),n)=>{if("SET_SETTING"===n.type){const e=Object.assign(Object.assign({},t),{[n.payload.setting]:n.payload.enabled});return((e,t)=>{try{localStorage.setItem(e,JSON.stringify(t))}catch(t){S.warn(`Failed to save data to localStorage (key: ${e}):`,t)}})(I,e),e}return t},actions:{setSetting:(e,t)=>({type:"SET_SETTING",payload:{setting:e,enabled:t}})},selectors:_});(0,i.register)(A);const T=(e,t)=>e.querySelector(`[data-block="${t}"]`),R=window.React,k=wp.sync.Y;var O,U;new y("selection"),function(e){e.None="none",e.Cursor="cursor",e.SelectionInOneBlock="selection-in-one-block",e.SelectionInMultipleBlocks="selection-in-multiple-blocks",e.WholeBlock="whole-block"}(O||(O={})),function(e){e[e.None=0]="None",e[e.OtherUsers=1]="OtherUsers"}(U||(U={}));const M=new y("use-render-cursors"),x=(e,t,n,o)=>{if(null===e)return null;const s=n.querySelector(`[data-block="${t}"]`);if(!s)return null;const r=j(s,e,n,o);return null!=r?r:null},j=(e,t,n,o)=>{const{node:s,offset:r}=D(e,t,n),i=n.createRange();try{i.setStart(s,r)}catch(e){return M.error("Failed to create a range for cursor:",{error:e,node:s,offset:r}),null}i.collapse(!0);const c=i.getBoundingClientRect(),l=o.getBoundingClientRect(),a=e.getBoundingClientRect();let u=0,d=0;0===c.x&&0===c.y&&0===c.width&&0===c.height?(u=a.left-l.left,d=a.top-l.top):(u=c.left-l.left,d=c.top-l.top);let h=c.height;return 0===h&&(h=parseInt(window.getComputedStyle(e).lineHeight,10)||a.height),{x:u,y:d,height:h}},D=(e,t,n)=>{var o,s,r,i,c;const l=n.createTreeWalker(e,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT);let a=0,u=null,d=null,h=1;for(;d=l.nextNode();){if(h++,h>1e3)return u?{node:u,offset:0}:{node:e,offset:0};const n=null!==(s=null===(o=d.nodeValue)||void 0===o?void 0:o.length)&&void 0!==s?s:0;if(d.nodeType!==Node.ELEMENT_NODE){if(0!==n){if(a+n>=t)return{node:d,offset:t-a};a+=n,d.nodeType===Node.TEXT_NODE&&(u=d)}}else if("BR"===d.nodeName){if(a+1>=t){const t=l.nextNode();return(null==t?void 0:t.nodeType)===Node.TEXT_NODE?{node:t,offset:0}:u?{node:u,offset:null!==(i=null===(r=u.nodeValue)||void 0===r?void 0:r.length)&&void 0!==i?i:0}:{node:e,offset:0}}a+=1;continue}}return u&&(null===(c=u.nodeValue)||void 0===c?void 0:c.length)?{node:u,offset:u.nodeValue.length}:{node:e,offset:0}};function B({blockEditorDocument:e,cursorRegistry:t,postId:n,postType:s}){const r=(0,l.useRef)(null),c=function(e,t,n,o,s){const r=(0,i.useSelect)(e=>{const{getSetting:t}=e(A);return t(E.AWARENESS_CURSORS)?U.OtherUsers:U.None},[]),c=(0,p.useActiveCollaborators)(null!=o?o:null,null!=s?s:null),l=(0,p.useGetAbsolutePositionIndex)(null!=o?o:null,null!=s?s:null),a=(0,R.useMemo)(()=>()=>{if(!e.current||!t)return;const o=c.filter(e=>e.collaboratorInfo).map(e=>{var t,n;return{userName:e.collaboratorInfo.name,clientId:e.clientId,selection:null!==(n=null===(t=e.editorState)||void 0===t?void 0:t.selection)&&void 0!==n?n:{type:O.None},color:e.collaboratorInfo.color,isMe:e.isMe}});((e,t,n,o,s,r)=>{e&&t&&(s.removeAll(),o!==U.None&&n.forEach(({userName:n,clientId:i,selection:c,color:l,isMe:a})=>{if(a&&o===U.OtherUsers)return;let u=null;if(c.type===O.None);else if(c.type===O.WholeBlock);else if(c.type===O.Cursor)u=x(r(c),c.blockId,t,e);else if(c.type===O.SelectionInOneBlock){const n={type:O.Cursor,blockId:c.blockId,cursorPosition:c.cursorStartPosition};u=x(r(n),n.blockId,t,e)}else if(c.type===O.SelectionInMultipleBlocks){const n={type:O.Cursor,blockId:c.blockStartId,cursorPosition:c.cursorStartPosition};u=x(r(n),n.blockId,t,e)}if(u){const t=document.createElement("div");t.className="vip-real-time-collaboration-user",t.style.left=`${u.x}px`,t.style.top=`${u.y}px`;const o=document.createElement("div");o.className="vip-real-time-collaboration-user-cursor",o.style.backgroundColor=l,o.style.height=`${u.height}px`;const r=document.createElement("div");r.className="vip-real-time-collaboration-user-label",r.textContent=n,r.style.backgroundColor=l,t.appendChild(o),t.appendChild(r),e.appendChild(t),s.registerCursor(i,t)}}))})(e.current,t,o,r,n,l)},[t,n,r,l,e,c]);return(0,R.useEffect)(a,[r,a,c]),()=>{const e=setTimeout(a,500);return()=>clearTimeout(e)}}(r,null!=e?e:null,t,null!=n?n:null,null!=s?s:null),a=(0,f.useResizeObserver)(c);(0,l.useEffect)(c,[c]);const u=(0,f.useMergeRefs)([r,a]);return function(e,t,n){const o=(0,l.useRef)(new Set),s=(0,p.useActiveCollaborators)(null!=t?t:null,null!=n?n:null),{isAwarenessCursorsEnabled:r}=(0,i.useSelect)(e=>{const{getSetting:t}=e(A);return{isAwarenessCursorsEnabled:t(E.AWARENESS_CURSORS)}},[]);(0,l.useEffect)(()=>{if(null===e)return;const t=t=>{t.forEach(t=>{const n=T(e,t);n&&(n.style.boxShadow="",n.style.borderRadius=""),o.current.delete(t)})},n=s.map(e=>{var t,n,o;const s=(null===(n=null===(t=e.editorState)||void 0===t?void 0:t.selection)||void 0===n?void 0:n.type)===p.SelectionType.WholeBlock,r=!e.isMe;return s&&r?{blockId:(null===(o=e.editorState)||void 0===o?void 0:o.selection).blockId,color:e.collaboratorInfo.color}:null}).filter(e=>null!==e);if(!r)return void t(Array.from(o.current));const i=n.map(e=>e.blockId);t(Array.from(o.current).filter(e=>!i.includes(e))),n.forEach(t=>{const{color:n,blockId:s}=t,r=T(e,s);r&&r&&(r.style.boxShadow=`${n} 0 0 0 2px`,r.style.borderRadius="4px",o.current.add(s))})},[s,r,e])}(document,null!=n?n:null,null!=s?s:null),(0,o.jsx)("div",{className:"vip-real-time-collaboration-overlay-full",ref:u})}const L=window.wp.editPost;class P{constructor(){this.cursorMap=new Map}registerCursor(e,t){this.cursorMap.set(e,t)}scrollToCursor(e,t){var n,o,s;const r=this.cursorMap.get(e);return!!r&&(r.scrollIntoView({behavior:null!==(n=null==t?void 0:t.behavior)&&void 0!==n?n:"smooth",block:null!==(o=null==t?void 0:t.block)&&void 0!==o?o:"center",inline:null!==(s=null==t?void 0:t.inline)&&void 0!==s?s:"nearest"}),(null==t?void 0:t.highlightDuration)&&this.highlightCursor(r,t.highlightDuration),!0)}removeAll(){this.cursorMap.forEach(e=>e.remove()),this.cursorMap.clear()}highlightCursor(e,t){e.classList.add("vip-real-time-collaboration-cursor-highlighted"),setTimeout(()=>{e.classList.remove("vip-real-time-collaboration-cursor-highlighted")},t)}}const F=window.wp.apiFetch;var $=e.n(F);const W=window.wp.i18n,q=()=>new Map,G=(e,t,n)=>{let o=e.get(t);return void 0===o&&e.set(t,o=n()),o},H=()=>new Set,V=String.fromCharCode,z=(String.fromCodePoint,V(65535),/^\s*/g),X=/([A-Z])/g,J=(e,t)=>(e=>e.replace(z,""))(e.replace(X,e=>`${t}${(e=>e.toLowerCase())(e)}`)),Y="undefined"!=typeof TextEncoder?new TextEncoder:null;let Z="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});Z&&1===Z.decode(new Uint8Array).length&&(Z=null);let K=new class{constructor(){this.map=new Map}setItem(e,t){this.map.set(e,t)}getItem(e){return this.map.get(e)}},Q=!0;try{"undefined"!=typeof localStorage&&localStorage&&(K=localStorage,Q=!1)}catch(e){}const ee=K,te=Array.from,ne=(Array.isArray,"undefined"!=typeof process&&process.release&&/node|io\.js/.test(process.release.name)&&"[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)),oe="undefined"!=typeof window&&"undefined"!=typeof document&&!ne;let se;"undefined"!=typeof navigator&&/Mac/.test(navigator.platform);const re=[],ie=e=>(()=>{if(void 0===se)if(ne){se=q();const e=process.argv;let t=null;for(let n=0;n<e.length;n++){const o=e[n];"-"===o[0]?(null!==t&&se.set(t,""),t=o):null!==t?(se.set(t,o),t=null):re.push(o)}null!==t&&se.set(t,"")}else"object"==typeof location?(se=q(),(location.search||"?").slice(1).split("&").forEach(e=>{if(0!==e.length){const[t,n]=e.split("=");se.set(`--${J(t,"-")}`,n),se.set(`-${J(t,"-")}`,n)}})):se=q();return se})().has(e),ce=e=>{return void 0===(t=ne?process.env[e.toUpperCase().replaceAll("-","_")]:ee.getItem(e))?null:t;var t},le=e=>ie("--"+e)||null!==ce(e);var ae;le("production"),ne&&(ae=process.env.FORCE_COLOR,["true","1","2"].includes(ae))||!ie("--no-colors")&&!le("no-color")&&(!ne||process.stdout.isTTY)&&(!ne||ie("--color")||null!==ce("COLORTERM")||(ce("TERM")||"").includes("color"));const ue=oe?e=>{let t="";for(let n=0;n<e.byteLength;n++)t+=V(e[n]);return btoa(t)}:e=>Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("base64"),de=oe?e=>{const t=atob(e),n=(o=t.length,new Uint8Array(o));var o;for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}:e=>{const t=Buffer.from(e,"base64");return n=t.buffer,o=t.byteOffset,s=t.byteLength,new Uint8Array(n,o,s);var n,o,s},he=new Map,fe="undefined"==typeof BroadcastChannel?class{constructor(e){var t;this.room=e,this.onmessage=null,this._onChange=t=>t.key===e&&null!==this.onmessage&&this.onmessage({data:de(t.newValue||"")}),t=this._onChange,Q||addEventListener("storage",t)}postMessage(e){ee.setItem(this.room,ue(new Uint8Array(e)))}close(){var e;e=this._onChange,Q||removeEventListener("storage",e)}}:BroadcastChannel,pe=e=>G(he,e,()=>{const t=H(),n=new fe(e);return n.onmessage=e=>t.forEach(t=>t(e.data,"broadcastchannel")),{bc:n,subs:t}}),ge=(e,t,n=null)=>{const o=pe(e);o.bc.postMessage(t),o.subs.forEach(e=>e(t,n))},be=Date.now,me=Math.floor,we=(Math.ceil,Math.abs,Math.imul,Math.round,Math.log10,Math.log2,Math.log,Math.sqrt,(e,t)=>e<t?e:t),ve=(Number.isNaN,Math.pow),ye=(Math.sign,128),Se=127;class Ie{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const Ee=()=>new Ie,Ne=e=>{let t=e.cpos;for(let n=0;n<e.bufs.length;n++)t+=e.bufs[n].length;return t},Ce=e=>{const t=new Uint8Array(Ne(e));let n=0;for(let o=0;o<e.bufs.length;o++){const s=e.bufs[o];t.set(s,n),n+=s.length}return t.set(new Uint8Array(e.cbuf.buffer,0,e.cpos),n),t},_e=(e,t)=>{const n=e.cbuf.length;e.cpos===n&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(2*n),e.cpos=0),e.cbuf[e.cpos++]=t},Ae=(e,t)=>{for(;t>Se;)_e(e,ye|Se&t),t=me(t/128);_e(e,Se&t)},Te=(new Uint8Array(3e4).length,Y&&Y.encodeInto,(e,t)=>{const n=e.cbuf.length,o=e.cpos,s=we(n-o,t.length),r=t.length-s;var i,c;e.cbuf.set(t.subarray(0,s),o),e.cpos+=s,r>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array((i=2*n)>(c=r)?i:c),e.cbuf.set(t.subarray(s)),e.cpos=r)}),Re=(e,t)=>{Ae(e,t.byteLength),Te(e,t)};new DataView(new ArrayBuffer(4));const ke=Number.MAX_SAFE_INTEGER,Oe=(Number.MIN_SAFE_INTEGER,Number.isInteger,Number.isNaN,Number.parseInt,e=>new Error(e)),Ue=Oe("Unexpected end of array"),Me=Oe("Integer out of Range");class xe{constructor(e){this.arr=e,this.pos=0}}const je=e=>((e,t)=>{const n=new Uint8Array(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,n})(e,De(e)),De=e=>{let t=0,n=1;const o=e.arr.length;for(;e.pos<o;){const o=e.arr[e.pos++];if(t+=(o&Se)*n,n*=128,o<ye)return t;if(t>ke)throw Me}throw Ue},Be=Math.floor,Le=(Math.ceil,Math.abs,Math.imul,Math.round,Math.log10,Math.log2,Math.log,Math.sqrt,Number.isNaN,Math.pow,Math.sign,128),Pe=127,Fe=String.fromCharCode,$e=(String.fromCodePoint,Fe(65535),"undefined"!=typeof TextEncoder?new TextEncoder:null),We=$e?e=>$e.encode(e):e=>{const t=unescape(encodeURIComponent(e)),n=t.length,o=new Uint8Array(n);for(let e=0;e<n;e++)o[e]=t.codePointAt(e);return o};let qe="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});qe&&1===qe.decode(new Uint8Array).length&&(qe=null);class Ge{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const He=(e,t)=>{const n=e.cbuf.length;e.cpos===n&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(2*n),e.cpos=0),e.cbuf[e.cpos++]=t},Ve=(e,t)=>{for(;t>Pe;)He(e,Le|Pe&t),t=Be(t/128);He(e,Pe&t)},ze=new Uint8Array(3e4),Xe=ze.length/3,Je=$e&&$e.encodeInto?(e,t)=>{if(t.length<Xe){const n=$e.encodeInto(t,ze).written||0;Ve(e,n);for(let t=0;t<n;t++)He(e,ze[t])}else Ye(e,We(t))}:(e,t)=>{const n=unescape(encodeURIComponent(t)),o=n.length;Ve(e,o);for(let t=0;t<o;t++)He(e,n.codePointAt(t))},Ye=(e,t)=>{Ve(e,t.byteLength),((e,t)=>{const n=e.cbuf.length,o=e.cpos,s=(r=n-o)<(i=t.length)?r:i;var r,i;const c=t.length-s;e.cbuf.set(t.subarray(0,s),o),e.cpos+=s,c>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(((e,t)=>e>t?e:t)(2*n,c)),e.cbuf.set(t.subarray(s)),e.cpos=c)})(e,t)};new DataView(new ArrayBuffer(4));const Ze=Number.MAX_SAFE_INTEGER,Ke=(Number.MIN_SAFE_INTEGER,Number.isInteger,Number.isNaN,Number.parseInt,e=>new Error(e)),Qe=Ke("Unexpected end of array"),et=Ke("Integer out of Range");class tt{constructor(e){this.arr=e,this.pos=0}}const nt=e=>((e,t)=>{const n=new Uint8Array(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,n})(e,st(e)),ot=e=>e.arr[e.pos++],st=e=>{let t=0,n=1;const o=e.arr.length;for(;e.pos<o;){const o=e.arr[e.pos++];if(t+=(o&Pe)*n,n*=128,o<Le)return t;if(t>Ze)throw et}throw Qe},rt=qe?e=>qe.decode(nt(e)):e=>{let t=st(e);if(0===t)return"";{let n=String.fromCodePoint(ot(e));if(--t<100)for(;t--;)n+=String.fromCodePoint(ot(e));else for(;t>0;){const o=t<1e4?t:1e4,s=e.arr.subarray(e.pos,e.pos+o);e.pos+=o,n+=String.fromCodePoint.apply(null,s),t-=o}return decodeURIComponent(escape(n))}},it=(e,t)=>{Ve(e,0);const n=k.encodeStateVector(t);Ye(e,n)},ct=(e,t,n)=>{Ve(e,1),Ye(e,k.encodeStateAsUpdate(t,n))},lt=(e,t,n)=>{try{k.applyUpdate(t,nt(e),n)}catch(e){console.error("Caught error while handling a Yjs update",e)}},at=lt,ut=Date.now,dt=()=>new Map,ht=()=>new Set,ft=Array.from;Array.isArray;class pt{constructor(){this._observers=dt()}on(e,t){((e,t,n)=>{let o=e.get(t);return void 0===o&&e.set(t,o=n()),o})(this._observers,e,ht).add(t)}once(e,t){const n=(...o)=>{this.off(e,n),t(...o)};this.on(e,n)}off(e,t){const n=this._observers.get(e);void 0!==n&&(n.delete(t),0===n.size&&this._observers.delete(e))}emit(e,t){return ft((this._observers.get(e)||dt()).values()).forEach(e=>e(...t))}destroy(){this._observers=dt()}}Object.assign;const gt=Object.keys,bt=(Object.values,e=>gt(e).length),mt=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),wt=(Object.freeze,Symbol("Equality")),vt=(e,t)=>{if(e===t)return!0;if(null==e||null==t||e.constructor!==t.constructor)return!1;if(null!=e[wt])return e[wt](t);switch(e.constructor){case ArrayBuffer:e=new Uint8Array(e),t=new Uint8Array(t);case Uint8Array:if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;break;case Set:if(e.size!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;break;case Map:if(e.size!==t.size)return!1;for(const n of e.keys())if(!t.has(n)||!vt(e.get(n),t.get(n)))return!1;break;case Object:if(bt(e)!==bt(t))return!1;for(const n in e)if(!mt(e,n)||!vt(e[n],t[n]))return!1;break;case Array:if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!vt(e[n],t[n]))return!1;break;default:return!1}return!0};class yt extends pt{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const e=ut();null!==this.getLocalState()&&15e3<=e-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const t=[];this.meta.forEach((n,o)=>{o!==this.clientID&&3e4<=e-n.lastUpdated&&this.states.has(o)&&t.push(o)}),t.length>0&&St(this,t,"timeout")},Be(3e3)),e.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){const t=this.clientID,n=this.meta.get(t),o=void 0===n?0:n.clock+1,s=this.states.get(t);null===e?this.states.delete(t):this.states.set(t,e),this.meta.set(t,{clock:o,lastUpdated:ut()});const r=[],i=[],c=[],l=[];null===e?l.push(t):null==s?null!=e&&r.push(t):(i.push(t),vt(s,e)||c.push(t)),(r.length>0||c.length>0||l.length>0)&&this.emit("change",[{added:r,updated:c,removed:l},"local"]),this.emit("update",[{added:r,updated:i,removed:l},"local"])}setLocalStateField(e,t){const n=this.getLocalState();null!==n&&this.setLocalState({...n,[e]:t})}getStates(){return this.states}}const St=(e,t,n)=>{const o=[];for(let n=0;n<t.length;n++){const s=t[n];if(e.states.has(s)){if(e.states.delete(s),s===e.clientID){const t=e.meta.get(s);e.meta.set(s,{clock:t.clock+1,lastUpdated:ut()})}o.push(s)}}o.length>0&&(e.emit("change",[{added:[],updated:[],removed:o},n]),e.emit("update",[{added:[],updated:[],removed:o},n]))},It=(e,t,n=e.states)=>{const o=t.length,s=new Ge;Ve(s,o);for(let r=0;r<o;r++){const o=t[r],i=n.get(o)||null,c=e.meta.get(o).clock;Ve(s,o),Ve(s,c),Je(s,JSON.stringify(i))}return(e=>{const t=new Uint8Array((e=>{let t=e.cpos;for(let n=0;n<e.bufs.length;n++)t+=e.bufs[n].length;return t})(e));let n=0;for(let o=0;o<e.bufs.length;o++){const s=e.bufs[o];t.set(s,n),n+=s.length}return t.set(new Uint8Array(e.cbuf.buffer,0,e.cpos),n),t})(s)};class Et{constructor(){this._observers=q()}on(e,t){return G(this._observers,e,H).add(t),t}once(e,t){const n=(...o)=>{this.off(e,n),t(...o)};this.on(e,n)}off(e,t){const n=this._observers.get(e);void 0!==n&&(n.delete(t),0===n.size&&this._observers.delete(e))}emit(e,t){return te((this._observers.get(e)||q()).values()).forEach(e=>e(...t))}destroy(){this._observers=q()}}Object.assign,Object.keys,Object.values,Object.freeze;const Nt=[];Nt[0]=(e,t,n,o,s)=>{Ae(e,0);const r=((e,t,n,o)=>{const s=st(e);switch(s){case 0:((e,t,n)=>{ct(t,n,nt(e))})(e,t,n);break;case 1:lt(e,n,o);break;case 2:at(e,n,o);break;default:throw new Error("Unknown message type")}return s})(t,e,n.doc,n);o&&1===r&&!n.synced&&(n.synced=!0)},Nt[3]=(e,t,n,o,s)=>{Ae(e,1),Re(e,It(n.awareness,Array.from(n.awareness.getStates().keys())))},Nt[1]=(e,t,n,o,s)=>{((e,t,n)=>{const o=new tt(t),s=ut(),r=[],i=[],c=[],l=[],a=st(o);for(let t=0;t<a;t++){const t=st(o);let n=st(o);const a=JSON.parse(rt(o)),u=e.meta.get(t),d=e.states.get(t),h=void 0===u?0:u.clock;(h<n||h===n&&null===a&&e.states.has(t))&&(null===a?t===e.clientID&&null!=e.getLocalState()?n++:e.states.delete(t):e.states.set(t,a),e.meta.set(t,{clock:n,lastUpdated:s}),void 0===u&&null!==a?r.push(t):void 0!==u&&null===a?l.push(t):null!==a&&(vt(a,d)||c.push(t),i.push(t)))}(r.length>0||c.length>0||l.length>0)&&e.emit("change",[{added:r,updated:c,removed:l},n]),(r.length>0||i.length>0||l.length>0)&&e.emit("update",[{added:r,updated:i,removed:l},n])})(n.awareness,je(t),n)},Nt[2]=(e,t,n,o,s)=>{((e,t,n)=>{0===st(e)&&n(0,rt(e))})(t,n.doc,(e,t)=>Ct(n,t))};const Ct=(e,t)=>console.warn(`Permission denied to access ${e.url}.\n${t}`),_t=(e,t,n)=>{const o=new xe(t),s=Ee(),r=De(o),i=e.messageHandlers[r];return i?i(s,o,e,n,r):console.error("Unable to compute message"),s},At=(e,t,n)=>{t===e.ws&&(e.emit("connection-close",[n,e]),e.ws=null,t.close(),e.wsconnecting=!1,e.wsconnected?(e.wsconnected=!1,e.synced=!1,St(e.awareness,Array.from(e.awareness.getStates().keys()).filter(t=>t!==e.doc.clientID),e),e.emit("status",[{status:"disconnected"}])):e.wsUnsuccessfulReconnects++,setTimeout(Tt,we(100*ve(2,e.wsUnsuccessfulReconnects),e.maxBackoffTime),e))},Tt=e=>{if(e.shouldConnect&&null===e.ws){const t=new e._WS(e.url,e.protocols);t.binaryType="arraybuffer",e.ws=t,e.wsconnecting=!0,e.wsconnected=!1,e.synced=!1,t.onmessage=n=>{e.wsLastMessageReceived=be();const o=_t(e,new Uint8Array(n.data),!0);Ne(o)>1&&t.send(Ce(o))},t.onerror=t=>{e.emit("connection-error",[t,e])},t.onclose=n=>{At(e,t,n)},t.onopen=()=>{e.wsLastMessageReceived=be(),e.wsconnecting=!1,e.wsconnected=!0,e.wsUnsuccessfulReconnects=0,e.emit("status",[{status:"connected"}]);const n=Ee();if(Ae(n,0),it(n,e.doc),t.send(Ce(n)),null!==e.awareness.getLocalState()){const n=Ee();Ae(n,1),Re(n,It(e.awareness,[e.doc.clientID])),t.send(Ce(n))}},e.emit("status",[{status:"connecting"}])}},Rt=(e,t)=>{const n=e.ws;e.wsconnected&&n&&n.readyState===n.OPEN&&n.send(t),e.bcconnected&&ge(e.bcChannel,t,e)};class kt extends Et{constructor(e,t,n,{connect:o=!0,awareness:s=new yt(n),params:r={},protocols:i=[],WebSocketPolyfill:c=WebSocket,resyncInterval:l=-1,maxBackoffTime:a=2500,disableBc:u=!1}={}){for(super();"/"===e[e.length-1];)e=e.slice(0,e.length-1);this.serverUrl=e,this.bcChannel=e+"/"+t,this.maxBackoffTime=a,this.params=r,this.protocols=i,this.roomname=t,this.doc=n,this._WS=c,this.awareness=s,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disableBc=u,this.wsUnsuccessfulReconnects=0,this.messageHandlers=Nt.slice(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=o,this._resyncInterval=0,l>0&&(this._resyncInterval=setInterval(()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){const e=Ee();Ae(e,0),it(e,n),this.ws.send(Ce(e))}},l)),this._bcSubscriber=(e,t)=>{if(t!==this){const t=_t(this,new Uint8Array(e),!1);Ne(t)>1&&ge(this.bcChannel,Ce(t),this)}},this._updateHandler=(e,t)=>{if(t!==this){const t=Ee();Ae(t,0),((e,t)=>{Ve(e,2),Ye(e,t)})(t,e),Rt(this,Ce(t))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:e,updated:t,removed:n},o)=>{const r=e.concat(t).concat(n),i=Ee();Ae(i,1),Re(i,It(s,r)),Rt(this,Ce(i))},this._exitHandler=()=>{St(this.awareness,[n.clientID],"app closed")},ne&&"undefined"!=typeof process&&process.on("exit",this._exitHandler),s.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval(()=>{this.wsconnected&&3e4<be()-this.wsLastMessageReceived&&At(this,this.ws,null)},3e3),o&&this.connect()}get url(){const e=(()=>((e,t)=>{const n=[];for(const o in e)n.push(t(e[o],o));return n})(this.params,(e,t)=>`${encodeURIComponent(t)}=${encodeURIComponent(e)}`).join("&"))();return this.serverUrl+"/"+this.roomname+(0===e.length?"":"?"+e)}get synced(){return this._synced}set synced(e){this._synced!==e&&(this._synced=e,this.emit("synced",[e]),this.emit("sync",[e]))}destroy(){0!==this._resyncInterval&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),ne&&"undefined"!=typeof process&&process.off("exit",this._exitHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){if(this.disableBc)return;var e,t;this.bcconnected||(e=this.bcChannel,t=this._bcSubscriber,pe(e).subs.add(t),this.bcconnected=!0);const n=Ee();Ae(n,0),it(n,this.doc),ge(this.bcChannel,Ce(n),this);const o=Ee();Ae(o,0),ct(o,this.doc),ge(this.bcChannel,Ce(o),this);const s=Ee();Ae(s,3),ge(this.bcChannel,Ce(s),this);const r=Ee();Ae(r,1),Re(r,It(this.awareness,[this.doc.clientID])),ge(this.bcChannel,Ce(r),this)}disconnectBc(){const e=Ee();Ae(e,1),Re(e,It(this.awareness,[this.doc.clientID],new Map)),Rt(this,Ce(e)),this.bcconnected&&(((e,t)=>{const n=pe(e);n.subs.delete(t)&&0===n.subs.size&&(n.bc.close(),he.delete(e))})(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),null!==this.ws&&At(this,this.ws,null)}connect(){this.shouldConnect=!0,this.wsconnected||null!==this.ws||(Tt(this),this.connectBc())}}function Ot(e,t){return e instanceof Error?e.message:e&&"object"==typeof e&&"data"in e&&e.data&&"object"==typeof e.data&&"error"in e.data?Ot(e.data.error,t):e&&"object"==typeof e&&"message"in e&&"string"==typeof e.message?e.message:null!=t?t:(0,W.__)("Unknown error","vip-real-time-collaboration")}new y("crypto");class Ut{constructor(){this.listeners=new Set}emit(e){this.listeners.forEach(t=>t(e))}on(e){this.listeners.add(e)}off(e){this.listeners.delete(e)}destroy(){this.listeners.clear()}}var Mt=function(e,t,n,o){return new(n||(n=Promise))(function(s,r){function i(e){try{l(o.next(e))}catch(e){r(e)}}function c(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){e.done?s(e.value):function(e){return e instanceof n?e:new n(function(t){t(e)})}(e.value).then(i,c)}l((o=o.apply(e,t||[])).next())})};const xt={destroy:()=>{},on:()=>{}},jt=function(){const e=new Map;return(...t)=>{const n=JSON.stringify(t);if(e.has(n))return e.get(n);const o=(()=>function(){if(window.isSecureContext)return window.crypto.randomUUID();throw new Error("Unable to generate UUID outside of secure context in non-development mode!")}())(...t);return e.set(n,o),o}}(),Dt=new y("websocket-client");function Bt(e){if(e)switch(e){case 4001:return{code:"connection-expired"};case 4002:return{code:"too-many-connections"};default:return}}function Lt(e,t,n){let o=0;return function(){return Mt(this,void 0,void 0,function*(){if(o>0){const e=Math.min(1e3*Math.pow(2,o),15e3);Dt.warn(`Attempting to reconnect to WebSocket in ${Math.floor(e/1e3)}s...`),yield new Promise(t=>setTimeout(t,e))}o+=1;try{const o=yield function(e,t){return Mt(this,void 0,void 0,function*(){const n=yield $()({path:"/vip-rtc/v1/websocket/auth",method:"POST",data:{syncObjectType:e,syncObjectId:t,wpClientId:jt()}});if(!n.token)throw new Error((0,W.__)("No auth token returned","vip-real-time-collaboration"));return n.token})}(t,n);e.params={auth:o},e.connect(),e.shouldConnect=!1,function(e){var t;const n={createNewDoc:!1,room:`${e.roomname}?auth=${null===(t=e.params)||void 0===t?void 0:t.auth}`,provider:"y-websocket",url:g},o=`http://localhost:5173/#/connection=${encodeURIComponent(JSON.stringify(n))}`;Dt.info(`Yjs inspector for ${e.roomname}: ${o}`)}(e)}catch(e){Dt.error(`${(0,W.__)("Failed to fetch auth token and connect to WebSocket","vip-real-time-collaboration")}: ${Ot(e)}`)}})}}function Pt(e){const t={serverUrl:e,options:{connect:!1}};return function(e){return Mt(this,arguments,void 0,function*({awareness:e,objectType:n,objectId:o,ydoc:s}){try{if(!(null===o||n.startsWith("postType/")&&parseInt(o,10)))return Dt.debug("WebSocket connection skipped for unsupported object",{objectType:n,objectId:o}),xt;const r=`site-${null!=b?b:1}/${n}-${null!=o?o:"collection"}`,i=Object.assign(Object.assign({},t.options),{awareness:e}),c=new kt(t.serverUrl,r,s,i),l=Lt(c,n,null!=o?o:"collection"),a=new Ut,u=e=>{a.emit({status:"disconnected",error:Bt(null==e?void 0:e.code)}),l()};return c.on("connection-close",u),c.on("status",e=>{"disconnected"!==e.status&&a.emit({status:e.status})}),yield l(),{destroy:()=>{a.destroy(),c.destroy()},on:(e,t)=>{"sync-connection-status"===e&&a.on(t)}}}catch(e){Dt.critical("Failed to create WebSocket connection",{error:e})}return xt})}}(0,t.addFilter)("sync.providers","vip-rtc",()=>g?[Pt(g)]:((new y).critical("VIP Real-Time Collaboration WebSocket URL has not been configured. The plugin will not be functional without it."),[])),(0,n.registerPlugin)("vip-rtc-settings-panel",{render:function(){const{isCursorsEnabled:e,isDebugToolsEnabled:t}=(0,i.useSelect)(e=>{const{getSetting:t}=e(A);return{isCursorsEnabled:t(E.AWARENESS_CURSORS),isDebugToolsEnabled:t(E.DEBUG_TOOLS)}},[]),{setSetting:n}=(0,i.useDispatch)(A),a=(0,l.useRef)(new P),u=(0,i.useSelect)(e=>e(c.store).getCurrentPostId()),h=(0,i.useSelect)(e=>e(c.store).getCurrentPostType());return function(){const e=(0,i.useSelect)(e=>e(L.store).getEditorMode());(0,l.useEffect)(()=>{if("text"===e){const e=document.querySelector(".editor-post-text-editor"),t=document.querySelector(".components-textarea-control__input");e instanceof HTMLTextAreaElement&&t instanceof HTMLTextAreaElement&&(e.readOnly=!0,t.readOnly=!0)}},[e])}(),(0,o.jsxs)(o.Fragment,{children:[s.BlockCanvasCover&&s.BlockCanvasCover.Fill&&(0,o.jsx)(s.BlockCanvasCover.Fill,{children:({containerRef:e})=>{var n,s,r;return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(B,{blockEditorDocument:null===(n=e.current)||void 0===n?void 0:n.ownerDocument,cursorRegistry:a.current,postId:u,postType:h}),t&&(null===(s=e.current)||void 0===s?void 0:s.ownerDocument)&&(0,o.jsx)(d,{iframeDocument:null===(r=e.current)||void 0===r?void 0:r.ownerDocument})]})}}),(0,o.jsxs)(c.PluginDocumentSettingPanel,{name:"vip-real-time-collaboration",title:"Real-time collaboration",className:"vip-real-time-collaboration-settings",children:[(0,o.jsxs)("div",{children:[(0,o.jsx)(r.ToggleControl,{label:"Enable cursors",checked:e,onChange:e=>n(E.AWARENESS_CURSORS,e)}),!1]}),(0,o.jsx)("div",{className:"vip-telemetry-target"})]})]})}})})();
//# sourceMappingURL=index.js.map