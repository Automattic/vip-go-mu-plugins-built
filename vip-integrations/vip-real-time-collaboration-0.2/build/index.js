(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var s in n)e.o(n,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:n[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.hooks,n=o("wsUrl"),s=o("blogId");function o(e){return"undefined"==typeof window||void 0===window.VIP_RTC?null:window.VIP_RTC[e]}var r;!function(e){e[e.CRITICAL=5]="CRITICAL",e[e.ERROR=4]="ERROR",e[e.WARNING=3]="WARNING",e[e.INFO=2]="INFO",e[e.DEBUG=1]="DEBUG"}(r||(r={}));const c=r.WARNING;class a{constructor(e="",t=c){this.threshold=t,this.namespace="vip-rtc"+(e?`:${e}`:"")}log(e,...t){if(e<this.threshold)return;const n=r[e];console.log(`[${this.namespace}][${n}]`,...t)}debug(...e){this.log(r.DEBUG,...e)}info(...e){this.log(r.INFO,...e)}warn(...e){this.log(r.WARNING,...e)}error(...e){this.log(r.ERROR,...e)}critical(...e){this.log(r.CRITICAL,...e)}}const i=window.wp.apiFetch;var l=e.n(i);const h=window.wp.i18n,u=wp.sync.Y,d=()=>new Map,f=(e,t,n)=>{let s=e.get(t);return void 0===s&&e.set(t,s=n()),s},p=()=>new Set,b=String.fromCharCode,g=(String.fromCodePoint,b(65535),/^\s*/g),w=/([A-Z])/g,y=(e,t)=>(e=>e.replace(g,""))(e.replace(w,e=>`${t}${(e=>e.toLowerCase())(e)}`)),m="undefined"!=typeof TextEncoder?new TextEncoder:null;let v="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});v&&1===v.decode(new Uint8Array).length&&(v=null);let I=new class{constructor(){this.map=new Map}setItem(e,t){this.map.set(e,t)}getItem(e){return this.map.get(e)}},U=!0;try{"undefined"!=typeof localStorage&&localStorage&&(I=localStorage,U=!1)}catch(e){}const _=I,S=Array.from,A=(Array.isArray,"undefined"!=typeof process&&process.release&&/node|io\.js/.test(process.release.name)&&"[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)),C="undefined"!=typeof window&&"undefined"!=typeof document&&!A;let M;"undefined"!=typeof navigator&&/Mac/.test(navigator.platform);const k=[],E=e=>(()=>{if(void 0===M)if(A){M=d();const e=process.argv;let t=null;for(let n=0;n<e.length;n++){const s=e[n];"-"===s[0]?(null!==t&&M.set(t,""),t=s):null!==t?(M.set(t,s),t=null):k.push(s)}null!==t&&M.set(t,"")}else"object"==typeof location?(M=d(),(location.search||"?").slice(1).split("&").forEach(e=>{if(0!==e.length){const[t,n]=e.split("=");M.set(`--${y(t,"-")}`,n),M.set(`-${y(t,"-")}`,n)}})):M=d();return M})().has(e),N=e=>{return void 0===(t=A?process.env[e.toUpperCase().replaceAll("-","_")]:_.getItem(e))?null:t;var t},R=e=>E("--"+e)||null!==N(e);var O;R("production"),A&&(O=process.env.FORCE_COLOR,["true","1","2"].includes(O))||!E("--no-colors")&&!R("no-color")&&(!A||process.stdout.isTTY)&&(!A||E("--color")||null!==N("COLORTERM")||(N("TERM")||"").includes("color"));const T=C?e=>{let t="";for(let n=0;n<e.byteLength;n++)t+=b(e[n]);return btoa(t)}:e=>Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("base64"),L=C?e=>{const t=atob(e),n=(s=t.length,new Uint8Array(s));var s;for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}:e=>{const t=Buffer.from(e,"base64");return n=t.buffer,s=t.byteOffset,o=t.byteLength,new Uint8Array(n,s,o);var n,s,o},j=new Map,x="undefined"==typeof BroadcastChannel?class{constructor(e){var t;this.room=e,this.onmessage=null,this._onChange=t=>t.key===e&&null!==this.onmessage&&this.onmessage({data:L(t.newValue||"")}),t=this._onChange,U||addEventListener("storage",t)}postMessage(e){_.setItem(this.room,T(new Uint8Array(e)))}close(){var e;e=this._onChange,U||removeEventListener("storage",e)}}:BroadcastChannel,D=e=>f(j,e,()=>{const t=p(),n=new x(e);return n.onmessage=e=>t.forEach(t=>t(e.data,"broadcastchannel")),{bc:n,subs:t}}),B=(e,t,n=null)=>{const s=D(e);s.bc.postMessage(t),s.subs.forEach(e=>e(t,n))},$=Date.now,P=Math.floor,W=(Math.ceil,Math.abs,Math.imul,Math.round,Math.log10,Math.log2,Math.log,Math.sqrt,(e,t)=>e<t?e:t),F=(Number.isNaN,Math.pow),G=(Math.sign,128),H=127;class z{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const V=()=>new z,J=e=>{let t=e.cpos;for(let n=0;n<e.bufs.length;n++)t+=e.bufs[n].length;return t},Y=e=>{const t=new Uint8Array(J(e));let n=0;for(let s=0;s<e.bufs.length;s++){const o=e.bufs[s];t.set(o,n),n+=o.length}return t.set(new Uint8Array(e.cbuf.buffer,0,e.cpos),n),t},q=(e,t)=>{const n=e.cbuf.length;e.cpos===n&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(2*n),e.cpos=0),e.cbuf[e.cpos++]=t},X=(e,t)=>{for(;t>H;)q(e,G|H&t),t=P(t/128);q(e,H&t)},Z=(new Uint8Array(3e4).length,m&&m.encodeInto,(e,t)=>{const n=e.cbuf.length,s=e.cpos,o=W(n-s,t.length),r=t.length-o;var c,a;e.cbuf.set(t.subarray(0,o),s),e.cpos+=o,r>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array((c=2*n)>(a=r)?c:a),e.cbuf.set(t.subarray(o)),e.cpos=r)}),K=(e,t)=>{X(e,t.byteLength),Z(e,t)};new DataView(new ArrayBuffer(4));const Q=Number.MAX_SAFE_INTEGER,ee=(Number.MIN_SAFE_INTEGER,Number.isInteger,Number.isNaN,Number.parseInt,e=>new Error(e)),te=ee("Unexpected end of array"),ne=ee("Integer out of Range");class se{constructor(e){this.arr=e,this.pos=0}}const oe=e=>((e,t)=>{const n=new Uint8Array(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,n})(e,re(e)),re=e=>{let t=0,n=1;const s=e.arr.length;for(;e.pos<s;){const s=e.arr[e.pos++];if(t+=(s&H)*n,n*=128,s<G)return t;if(t>Q)throw ne}throw te},ce=Math.floor,ae=(Math.ceil,Math.abs,Math.imul,Math.round,Math.log10,Math.log2,Math.log,Math.sqrt,Number.isNaN,Math.pow,Math.sign,128),ie=127,le=String.fromCharCode,he=(String.fromCodePoint,le(65535),"undefined"!=typeof TextEncoder?new TextEncoder:null),ue=he?e=>he.encode(e):e=>{const t=unescape(encodeURIComponent(e)),n=t.length,s=new Uint8Array(n);for(let e=0;e<n;e++)s[e]=t.codePointAt(e);return s};let de="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});de&&1===de.decode(new Uint8Array).length&&(de=null);class fe{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const pe=(e,t)=>{const n=e.cbuf.length;e.cpos===n&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(2*n),e.cpos=0),e.cbuf[e.cpos++]=t},be=(e,t)=>{for(;t>ie;)pe(e,ae|ie&t),t=ce(t/128);pe(e,ie&t)},ge=new Uint8Array(3e4),we=ge.length/3,ye=he&&he.encodeInto?(e,t)=>{if(t.length<we){const n=he.encodeInto(t,ge).written||0;be(e,n);for(let t=0;t<n;t++)pe(e,ge[t])}else me(e,ue(t))}:(e,t)=>{const n=unescape(encodeURIComponent(t)),s=n.length;be(e,s);for(let t=0;t<s;t++)pe(e,n.codePointAt(t))},me=(e,t)=>{be(e,t.byteLength),((e,t)=>{const n=e.cbuf.length,s=e.cpos,o=(r=n-s)<(c=t.length)?r:c;var r,c;const a=t.length-o;e.cbuf.set(t.subarray(0,o),s),e.cpos+=o,a>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(((e,t)=>e>t?e:t)(2*n,a)),e.cbuf.set(t.subarray(o)),e.cpos=a)})(e,t)};new DataView(new ArrayBuffer(4));const ve=Number.MAX_SAFE_INTEGER,Ie=(Number.MIN_SAFE_INTEGER,Number.isInteger,Number.isNaN,Number.parseInt,e=>new Error(e)),Ue=Ie("Unexpected end of array"),_e=Ie("Integer out of Range");class Se{constructor(e){this.arr=e,this.pos=0}}const Ae=e=>((e,t)=>{const n=new Uint8Array(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,n})(e,Me(e)),Ce=e=>e.arr[e.pos++],Me=e=>{let t=0,n=1;const s=e.arr.length;for(;e.pos<s;){const s=e.arr[e.pos++];if(t+=(s&ie)*n,n*=128,s<ae)return t;if(t>ve)throw _e}throw Ue},ke=de?e=>de.decode(Ae(e)):e=>{let t=Me(e);if(0===t)return"";{let n=String.fromCodePoint(Ce(e));if(--t<100)for(;t--;)n+=String.fromCodePoint(Ce(e));else for(;t>0;){const s=t<1e4?t:1e4,o=e.arr.subarray(e.pos,e.pos+s);e.pos+=s,n+=String.fromCodePoint.apply(null,o),t-=s}return decodeURIComponent(escape(n))}},Ee=(e,t)=>{be(e,0);const n=u.encodeStateVector(t);me(e,n)},Ne=(e,t,n)=>{be(e,1),me(e,u.encodeStateAsUpdate(t,n))},Re=(e,t,n)=>{try{u.applyUpdate(t,Ae(e),n)}catch(e){console.error("Caught error while handling a Yjs update",e)}},Oe=Re,Te=Date.now,Le=()=>new Map,je=()=>new Set,xe=Array.from;Array.isArray;class De{constructor(){this._observers=Le()}on(e,t){((e,t,n)=>{let s=e.get(t);return void 0===s&&e.set(t,s=n()),s})(this._observers,e,je).add(t)}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};this.on(e,n)}off(e,t){const n=this._observers.get(e);void 0!==n&&(n.delete(t),0===n.size&&this._observers.delete(e))}emit(e,t){return xe((this._observers.get(e)||Le()).values()).forEach(e=>e(...t))}destroy(){this._observers=Le()}}Object.assign;const Be=Object.keys,$e=(Object.values,e=>Be(e).length),Pe=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),We=(Object.freeze,Symbol("Equality")),Fe=(e,t)=>{if(e===t)return!0;if(null==e||null==t||e.constructor!==t.constructor)return!1;if(null!=e[We])return e[We](t);switch(e.constructor){case ArrayBuffer:e=new Uint8Array(e),t=new Uint8Array(t);case Uint8Array:if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;break;case Set:if(e.size!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;break;case Map:if(e.size!==t.size)return!1;for(const n of e.keys())if(!t.has(n)||!Fe(e.get(n),t.get(n)))return!1;break;case Object:if($e(e)!==$e(t))return!1;for(const n in e)if(!Pe(e,n)||!Fe(e[n],t[n]))return!1;break;case Array:if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!Fe(e[n],t[n]))return!1;break;default:return!1}return!0};class Ge extends De{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const e=Te();null!==this.getLocalState()&&15e3<=e-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const t=[];this.meta.forEach((n,s)=>{s!==this.clientID&&3e4<=e-n.lastUpdated&&this.states.has(s)&&t.push(s)}),t.length>0&&He(this,t,"timeout")},ce(3e3)),e.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){const t=this.clientID,n=this.meta.get(t),s=void 0===n?0:n.clock+1,o=this.states.get(t);null===e?this.states.delete(t):this.states.set(t,e),this.meta.set(t,{clock:s,lastUpdated:Te()});const r=[],c=[],a=[],i=[];null===e?i.push(t):null==o?null!=e&&r.push(t):(c.push(t),Fe(o,e)||a.push(t)),(r.length>0||a.length>0||i.length>0)&&this.emit("change",[{added:r,updated:a,removed:i},"local"]),this.emit("update",[{added:r,updated:c,removed:i},"local"])}setLocalStateField(e,t){const n=this.getLocalState();null!==n&&this.setLocalState({...n,[e]:t})}getStates(){return this.states}}const He=(e,t,n)=>{const s=[];for(let n=0;n<t.length;n++){const o=t[n];if(e.states.has(o)){if(e.states.delete(o),o===e.clientID){const t=e.meta.get(o);e.meta.set(o,{clock:t.clock+1,lastUpdated:Te()})}s.push(o)}}s.length>0&&(e.emit("change",[{added:[],updated:[],removed:s},n]),e.emit("update",[{added:[],updated:[],removed:s},n]))},ze=(e,t,n=e.states)=>{const s=t.length,o=new fe;be(o,s);for(let r=0;r<s;r++){const s=t[r],c=n.get(s)||null,a=e.meta.get(s).clock;be(o,s),be(o,a),ye(o,JSON.stringify(c))}return(e=>{const t=new Uint8Array((e=>{let t=e.cpos;for(let n=0;n<e.bufs.length;n++)t+=e.bufs[n].length;return t})(e));let n=0;for(let s=0;s<e.bufs.length;s++){const o=e.bufs[s];t.set(o,n),n+=o.length}return t.set(new Uint8Array(e.cbuf.buffer,0,e.cpos),n),t})(o)};class Ve{constructor(){this._observers=d()}on(e,t){return f(this._observers,e,p).add(t),t}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};this.on(e,n)}off(e,t){const n=this._observers.get(e);void 0!==n&&(n.delete(t),0===n.size&&this._observers.delete(e))}emit(e,t){return S((this._observers.get(e)||d()).values()).forEach(e=>e(...t))}destroy(){this._observers=d()}}Object.assign,Object.keys,Object.values,Object.freeze;const Je=[];Je[0]=(e,t,n,s,o)=>{X(e,0);const r=((e,t,n,s)=>{const o=Me(e);switch(o){case 0:((e,t,n)=>{Ne(t,n,Ae(e))})(e,t,n);break;case 1:Re(e,n,s);break;case 2:Oe(e,n,s);break;default:throw new Error("Unknown message type")}return o})(t,e,n.doc,n);s&&1===r&&!n.synced&&(n.synced=!0)},Je[3]=(e,t,n,s,o)=>{X(e,1),K(e,ze(n.awareness,Array.from(n.awareness.getStates().keys())))},Je[1]=(e,t,n,s,o)=>{((e,t,n)=>{const s=new Se(t),o=Te(),r=[],c=[],a=[],i=[],l=Me(s);for(let t=0;t<l;t++){const t=Me(s);let n=Me(s);const l=JSON.parse(ke(s)),h=e.meta.get(t),u=e.states.get(t),d=void 0===h?0:h.clock;(d<n||d===n&&null===l&&e.states.has(t))&&(null===l?t===e.clientID&&null!=e.getLocalState()?n++:e.states.delete(t):e.states.set(t,l),e.meta.set(t,{clock:n,lastUpdated:o}),void 0===h&&null!==l?r.push(t):void 0!==h&&null===l?i.push(t):null!==l&&(Fe(l,u)||a.push(t),c.push(t)))}(r.length>0||a.length>0||i.length>0)&&e.emit("change",[{added:r,updated:a,removed:i},n]),(r.length>0||c.length>0||i.length>0)&&e.emit("update",[{added:r,updated:c,removed:i},n])})(n.awareness,oe(t),n)},Je[2]=(e,t,n,s,o)=>{((e,t,n)=>{0===Me(e)&&n(0,ke(e))})(t,n.doc,(e,t)=>Ye(n,t))};const Ye=(e,t)=>console.warn(`Permission denied to access ${e.url}.\n${t}`),qe=(e,t,n)=>{const s=new se(t),o=V(),r=re(s),c=e.messageHandlers[r];return c?c(o,s,e,n,r):console.error("Unable to compute message"),o},Xe=(e,t,n)=>{t===e.ws&&(e.emit("connection-close",[n,e]),e.ws=null,t.close(),e.wsconnecting=!1,e.wsconnected?(e.wsconnected=!1,e.synced=!1,He(e.awareness,Array.from(e.awareness.getStates().keys()).filter(t=>t!==e.doc.clientID),e),e.emit("status",[{status:"disconnected"}])):e.wsUnsuccessfulReconnects++,setTimeout(Ze,W(100*F(2,e.wsUnsuccessfulReconnects),e.maxBackoffTime),e))},Ze=e=>{if(e.shouldConnect&&null===e.ws){const t=new e._WS(e.url,e.protocols);t.binaryType="arraybuffer",e.ws=t,e.wsconnecting=!0,e.wsconnected=!1,e.synced=!1,t.onmessage=n=>{e.wsLastMessageReceived=$();const s=qe(e,new Uint8Array(n.data),!0);J(s)>1&&t.send(Y(s))},t.onerror=t=>{e.emit("connection-error",[t,e])},t.onclose=n=>{Xe(e,t,n)},t.onopen=()=>{e.wsLastMessageReceived=$(),e.wsconnecting=!1,e.wsconnected=!0,e.wsUnsuccessfulReconnects=0,e.emit("status",[{status:"connected"}]);const n=V();if(X(n,0),Ee(n,e.doc),t.send(Y(n)),null!==e.awareness.getLocalState()){const n=V();X(n,1),K(n,ze(e.awareness,[e.doc.clientID])),t.send(Y(n))}},e.emit("status",[{status:"connecting"}])}},Ke=(e,t)=>{const n=e.ws;e.wsconnected&&n&&n.readyState===n.OPEN&&n.send(t),e.bcconnected&&B(e.bcChannel,t,e)};class Qe extends Ve{constructor(e,t,n,{connect:s=!0,awareness:o=new Ge(n),params:r={},protocols:c=[],WebSocketPolyfill:a=WebSocket,resyncInterval:i=-1,maxBackoffTime:l=2500,disableBc:h=!1}={}){for(super();"/"===e[e.length-1];)e=e.slice(0,e.length-1);this.serverUrl=e,this.bcChannel=e+"/"+t,this.maxBackoffTime=l,this.params=r,this.protocols=c,this.roomname=t,this.doc=n,this._WS=a,this.awareness=o,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disableBc=h,this.wsUnsuccessfulReconnects=0,this.messageHandlers=Je.slice(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=s,this._resyncInterval=0,i>0&&(this._resyncInterval=setInterval(()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){const e=V();X(e,0),Ee(e,n),this.ws.send(Y(e))}},i)),this._bcSubscriber=(e,t)=>{if(t!==this){const t=qe(this,new Uint8Array(e),!1);J(t)>1&&B(this.bcChannel,Y(t),this)}},this._updateHandler=(e,t)=>{if(t!==this){const t=V();X(t,0),((e,t)=>{be(e,2),me(e,t)})(t,e),Ke(this,Y(t))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:e,updated:t,removed:n},s)=>{const r=e.concat(t).concat(n),c=V();X(c,1),K(c,ze(o,r)),Ke(this,Y(c))},this._exitHandler=()=>{He(this.awareness,[n.clientID],"app closed")},A&&"undefined"!=typeof process&&process.on("exit",this._exitHandler),o.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval(()=>{this.wsconnected&&3e4<$()-this.wsLastMessageReceived&&Xe(this,this.ws,null)},3e3),s&&this.connect()}get url(){const e=(()=>((e,t)=>{const n=[];for(const s in e)n.push(t(e[s],s));return n})(this.params,(e,t)=>`${encodeURIComponent(t)}=${encodeURIComponent(e)}`).join("&"))();return this.serverUrl+"/"+this.roomname+(0===e.length?"":"?"+e)}get synced(){return this._synced}set synced(e){this._synced!==e&&(this._synced=e,this.emit("synced",[e]),this.emit("sync",[e]))}destroy(){0!==this._resyncInterval&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),A&&"undefined"!=typeof process&&process.off("exit",this._exitHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){if(this.disableBc)return;var e,t;this.bcconnected||(e=this.bcChannel,t=this._bcSubscriber,D(e).subs.add(t),this.bcconnected=!0);const n=V();X(n,0),Ee(n,this.doc),B(this.bcChannel,Y(n),this);const s=V();X(s,0),Ne(s,this.doc),B(this.bcChannel,Y(s),this);const o=V();X(o,3),B(this.bcChannel,Y(o),this);const r=V();X(r,1),K(r,ze(this.awareness,[this.doc.clientID])),B(this.bcChannel,Y(r),this)}disconnectBc(){const e=V();X(e,1),K(e,ze(this.awareness,[this.doc.clientID],new Map)),Ke(this,Y(e)),this.bcconnected&&(((e,t)=>{const n=D(e);n.subs.delete(t)&&0===n.subs.size&&(n.bc.close(),j.delete(e))})(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),null!==this.ws&&Xe(this,this.ws,null)}connect(){this.shouldConnect=!0,this.wsconnected||null!==this.ws||(Ze(this),this.connectBc())}}function et(e,t){return e instanceof Error?e.message:e&&"object"==typeof e&&"data"in e&&e.data&&"object"==typeof e.data&&"error"in e.data?et(e.data.error,t):e&&"object"==typeof e&&"message"in e&&"string"==typeof e.message?e.message:null!=t?t:(0,h.__)("Unknown error","vip-real-time-collaboration")}new a("crypto");class tt extends Error{constructor(e,t){super(t),this.code=e,this.name="WebSocketError"}}class nt{constructor(){this.listeners=new Set}emit(e){this.listeners.forEach(t=>t(e))}on(e){this.listeners.add(e)}off(e){this.listeners.delete(e)}destroy(){this.listeners.clear()}}var st=function(e,t,n,s){return new(n||(n=Promise))(function(o,r){function c(e){try{i(s.next(e))}catch(e){r(e)}}function a(e){try{i(s.throw(e))}catch(e){r(e)}}function i(e){e.done?o(e.value):function(e){return e instanceof n?e:new n(function(t){t(e)})}(e.value).then(c,a)}i((s=s.apply(e,t||[])).next())})};const ot={destroy:()=>{},on:()=>{}},rt=function(){const e=new Map;return(...t)=>{const n=JSON.stringify(t);if(e.has(n))return e.get(n);const s=(()=>function(){if(window.isSecureContext)return window.crypto.randomUUID();throw new Error("Unable to generate UUID outside of secure context in non-development mode!")}())(...t);return e.set(n,s),s}}(),ct=new a("websocket-client");function at(e){switch(e){case 4001:return new tt("connection-expired");case 4002:return new tt("connection-limit-exceeded");default:return new tt("unknown-error")}}function it(e,t,s){let o=0;return function(){return st(this,void 0,void 0,function*(){if(o>0){const e=Math.min(1e3*Math.pow(2,o),15e3);ct.warn(`Attempting to reconnect to WebSocket in ${Math.floor(e/1e3)}s...`),yield new Promise(t=>setTimeout(t,e))}o+=1;try{const o=yield function(e,t){return st(this,void 0,void 0,function*(){const n=yield l()({path:"/vip-rtc/v1/websocket/auth",method:"POST",data:{syncObjectType:e,syncObjectId:t,wpClientId:rt()}});if(!n.token)throw new Error((0,h.__)("No auth token returned","vip-real-time-collaboration"));return n.token})}(t,s);e.params={auth:o},e.connect(),e.shouldConnect=!1,function(e){var t;const s={createNewDoc:!1,room:`${e.roomname}?auth=${null===(t=e.params)||void 0===t?void 0:t.auth}`,provider:"y-websocket",url:n},o=`http://localhost:5173/#/connection=${encodeURIComponent(JSON.stringify(s))}`;ct.info(`Yjs inspector for ${e.roomname}: ${o}`)}(e)}catch(e){ct.error(`${(0,h.__)("Failed to fetch auth token and connect to WebSocket","vip-real-time-collaboration")}: ${et(e)}`)}})}}function lt(e){const t={serverUrl:e,options:{connect:!1}};return function(e){return st(this,arguments,void 0,function*({awareness:e,objectType:n,objectId:o,ydoc:r}){try{if(!(null===o||n.startsWith("postType/")&&parseInt(o,10)))return ct.debug("WebSocket connection skipped for unsupported object",{objectType:n,objectId:o}),ot;const c=`site-${null!=s?s:1}/${n}-${null!=o?o:"collection"}`,a=Object.assign(Object.assign({},t.options),{awareness:e}),i=new Qe(t.serverUrl,c,r,a),l=it(i,n,null!=o?o:"collection"),h=new nt,u=e=>{h.emit({status:"disconnected",error:at(null==e?void 0:e.code)}),l()};return i.on("connection-close",u),i.on("status",e=>{"disconnected"!==e.status&&h.emit({status:e.status})}),yield l(),{destroy:()=>{h.destroy(),i.destroy()},on:(e,t)=>{"status"===e&&h.on(t)}}}catch(e){ct.critical("Failed to create WebSocket connection",{error:e})}return ot})}}(0,t.addFilter)("sync.providers","vip-rtc",()=>n?[lt(n)]:((new a).critical("VIP Real-Time Collaboration WebSocket URL has not been configured. The plugin will not be functional without it."),[]))})();
//# sourceMappingURL=index.js.map